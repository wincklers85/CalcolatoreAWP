<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AWP Manager ‚Äî Anagrafica</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f7fa; --fg:#1b1b1b; --muted:#5d6b7a; --card:#ffffff; --border:#dfe3ea;
  --acc:#007bff; --ok:#2ea043; --warn:#f59e0b; --bad:#ef4444;
  --table-head:#eef2f7; --shadow:0 10px 26px rgba(0,0,0,.08);
}
body.theme-light{}
body.theme-dark{ --bg:#121417; --fg:#e4e7ec; --muted:#9aa3af; --card:#181b20; --border:#2a2f36; --acc:#3399ff; --table-head:#1c2128; --shadow:0 10px 30px rgba(0,0,0,.35) }
body.theme-blue{ --bg:#e9f5ff; --fg:#002b4d; --muted:#335d7a; --card:#ffffff; --border:#cfe6fb; --acc:#0066cc; --table-head:#d9eeff; --shadow:0 12px 28px rgba(0,80,160,.15) }
body.theme-contrast{ --bg:#000; --fg:#ff0; --muted:#ffe766; --card:#0b0b0b; --border:#333; --acc:#ff3333; --table-head:#111; --shadow:0 10px 26px rgba(255,255,0,.12) }

html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

/* NAVBAR */
.navbar{
  position:sticky; top:0; z-index:30;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 16px; background:var(--card); border-bottom:1px solid var(--border);
  backdrop-filter: blur(6px);
}
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--fg)}
.brand img{height:28px}
.navlinks a{ color:var(--fg); text-decoration:none; margin:0 8px; padding:6px 10px; border-radius:8px }
.navlinks a:hover{ background:var(--table-head) }
.navlinks a[aria-current="page"]{ font-weight:700; text-decoration:underline }
.right{display:flex; align-items:center; gap:8px}
select,button,input{ background:var(--card); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-weight:600 }
button.primary{ background:var(--acc); color:#fff; border-color:var(--acc) }

/* LAYOUT */
main{ padding:18px; max-width:1200px; margin:0 auto }
.grid{ display:grid; gap:14px; grid-template-columns:repeat(12,1fr) }
.card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow); margin-bottom:14px }
.card h3{ margin:0 0 10px; font-size:16px }
.pill{ display:inline-block; padding:3px 8px; border:1px solid var(--border); border-radius:999px; background:var(--card); margin-right:6px; font-size:12px; color:var(--muted) }
.controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }

.kpi{ display:flex; gap:14px; flex-wrap:wrap }
.kbox{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px 14px; min-width:140px; box-shadow:var(--shadow) }
.kbox .lbl{ font-size:12px; color:var(--muted) }
.kbox .val{ font-weight:900; font-size:22px }
.bad{ color:var(--bad) } .ok{ color:var(--ok) } .warn{ color:var(--warn) }

.tabs{ display:flex; gap:8px; margin-bottom:8px }
.tab{ padding:8px 12px; border:1px solid var(--border); background:var(--card); border-radius:999px; cursor:pointer; font-weight:700 }
.tab[aria-selected="true"]{ background:var(--table-head) }

table{ width:100%; border-collapse:collapse }
th,td{ padding:10px 12px; border-bottom:1px solid var(--border) }
th{ background:var(--table-head); text-align:left; white-space:nowrap }
tr:hover td{ background:rgba(0,0,0,.03) }
td.bad{ color:var(--bad); font-weight:700 }
td.ok{ color:var(--ok); font-weight:700 }

.meta{ margin-top:6px; font-size:12px; color:var(--muted) }

/* PAGINAZIONE */
.pager{ display:flex; align-items:center; gap:8px; justify-content:flex-end; margin-top:8px }
.pager button{ padding:6px 10px }

/* Loader + Error */
#loader{ position:fixed; inset:0; background:rgba(0,0,0,.08); display:none; align-items:center; justify-content:center; z-index:40 }
.spinner{ width:54px; height:54px; border-radius:50%; border:5px solid rgba(0,0,0,.15); border-top-color:var(--acc); animation:spin .9s linear infinite }
@keyframes spin{ to{ transform:rotate(360deg) } }
#errorBox{ max-width:1200px; margin:10px auto 0; background:#ffecec; border:1px solid #ffb3b3; color:#7a0000; padding:10px 14px; border-radius:10px; display:none; }

footer{ padding:14px; text-align:center; color:var(--muted) }
</style>
</head>
<body>
  <div class="navbar">
    <a class="brand" href="./dashboard.html"><img src="./logo-awp.svg" alt="AWP"><strong>AWP Manager</strong></a>
    <nav class="navlinks">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./letture.html">Letture</a>
      <a href="./manutenzione.html">Manutenzione</a>
      <a href="./anagrafica.html" aria-current="page">Anagrafica</a>
    </nav>
    <div class="right">
      <label for="themeSel" style="font-size:13px;color:var(--muted)">Tema</label>
      <select id="themeSel">
        <option value="theme-light">‚òÄÔ∏è Chiaro AWP</option>
        <option value="theme-dark">üåô Scuro AWP</option>
        <option value="theme-blue">üå§Ô∏è Azzurro AWP</option>
        <option value="theme-contrast">‚ö´ Alto Contrasto</option>
      </select>
      <button id="btnRefresh" class="primary">üîÑ Aggiorna</button>
    </div>
  </div>

  <div id="errorBox"></div>

  <main>
    <div class="card">
      <div class="tabs">
        <button class="tab" id="tabMac" aria-selected="true">Macchine</button>
        <button class="tab" id="tabLoc">Locali</button>
      </div>

      <div class="controls">
        <label>Esattore:
          <select id="selEsattore"><option value="">‚Äî Tutti ‚Äî</option></select>
        </label>
        <label>Stato:
          <select id="selStato">
            <option value="">Tutti</option>
            <option value="ATTIVA">Attive</option>
            <option value="FERIE">Ferie</option>
            <option value="MANUT">Manutenzione</option>
            <option value="BLOCCO">Blocco</option>
            <option value="BLOCCO_DA_DA">Blocco da DA</option>
          </select>
        </label>
        <label>Ordina per:
          <select id="selOrd">
            <option value="ESATTORE,SEDE">Esattore ‚Üí Locale</option>
            <option value="SEDE,ESATTORE">Locale ‚Üí Esattore</option>
            <option value="COMUNE,SEDE">Comune ‚Üí Locale</option>
            <option value="GIORNI_DESC">Giorni mancata lettura (desc)</option>
            <option value="DATA_DESC">Ultima lettura (pi√π recente)</option>
          </select>
        </label>
        <input id="search" placeholder="Cerca locale/comune/CODEID‚Ä¶" />
        <label>Righe/pagina:
          <select id="pageSize">
            <option>25</option><option selected>50</option><option>100</option><option>200</option>
          </select>
        </label>
        <button id="btnApply" class="primary">Applica</button>
        <button id="btnDownload">‚¨áÔ∏è Scarica XLSX</button>
        <span class="pill" id="pillSin">Sinottico: ‚Äî</span>
        <span class="pill" id="pillFoglio">Foglio: ‚Äî</span>
        <span class="pill" id="pillCount">Selezione: ‚Äî</span>
      </div>

      <div class="kpi" id="kpiRow">
        <div class="kbox"><div class="lbl">Totale</div><div class="val" id="kTot">‚Äî</div></div>
        <div class="kbox"><div class="lbl">Attive</div><div class="val ok" id="kAtt">‚Äî</div></div>
        <div class="kbox"><div class="lbl">Ferie</div><div class="val bad" id="kFer">‚Äî</div></div>
        <div class="kbox"><div class="lbl">Manut.</div><div class="val warn" id="kMan">‚Äî</div></div>
        <div class="kbox"><div class="lbl">Blocco</div><div class="val bad" id="kBlo">‚Äî</div></div>
        <div class="kbox"><div class="lbl">Blocco da DA</div><div class="val bad" id="kDa">‚Äî</div></div>
      </div>

      <div class="meta">Anagrafica costruita dal <strong>sinottico pi√π recente</strong> (manifest) unito ai PDV tramite <strong>DENOMIN. SEDE</strong>. Le macchine sono identificate da <strong>CODEID</strong> e, se ripetute, si usa la riga con <em>Data ultima lettura</em> pi√π recente.</div>
    </div>

    <div class="card" id="cardMac">
      <h3>Anagrafica Macchine</h3>
      <div style="overflow:auto">
        <table id="tblMac">
          <thead>
            <tr>
              <th>ESATTORE</th>
              <th>LOCALE</th>
              <th>AWP (CODEID)</th>
              <th>PDA</th>
              <th>ULTIMA LETTURA</th>
              <th>GIORNI</th>
              <th>STATO</th>
              <th>COMUNE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager">
        <button id="prevMac">‚óÄÔ∏é</button>
        <span id="pageInfoMac" class="pill">‚Äî</span>
        <button id="nextMac">‚ñ∂Ô∏é</button>
      </div>
    </div>

    <div class="card" id="cardLoc" style="display:none">
      <h3>Anagrafica Locali</h3>
      <div style="overflow:auto">
        <table id="tblLoc">
          <thead>
            <tr>
              <th>ESATTORE</th>
              <th>LOCALE</th>
              <th>COMUNE</th>
              <th>Totale</th>
              <th>Attive</th>
              <th>Ferie</th>
              <th>Manut.</th>
              <th>Blocco</th>
              <th>Blocco da DA</th>
              <th>Ultima lettura (max)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager">
        <button id="prevLoc">‚óÄÔ∏é</button>
        <span id="pageInfoLoc" class="pill">‚Äî</span>
        <button id="nextLoc">‚ñ∂Ô∏é</button>
      </div>
    </div>
  </main>

  <footer>¬© <span id="year"></span> AWP Manager ‚Äî Anagrafica</footer>

  <div id="loader"><div class="spinner"></div></div>

  <!-- XLSX loader (locale ‚Üí CDN) -->
  <script>
  (function(){
    const urls=['./libs/xlsx.full.min.js','https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js','https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js','https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'];
    function loadOne(u){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=u;s.async=false;s.onload=()=>res();s.onerror=()=>rej();document.head.appendChild(s);});}
    (async()=>{for(const u of urls){try{await loadOne(u); if(window.XLSX) break;}catch(_){}} if(!window.XLSX) alert('Impossibile caricare la libreria XLSX');})();
  })();
  </script>

<script>
(function(){
  /* ===== Helpers generali ===== */
  const $=s=>document.querySelector(s);
  function showLoader(v){$('#loader').style.display=v?'flex':'none';}
  function showError(msg){const b=$('#errorBox');b.textContent=msg;b.style.display='block';alert(msg);}
  function applyTheme(t){document.body.className=t;}
  function initTheme(){const t=localStorage.getItem('awp_theme')||'theme-light';applyTheme(t);$('#themeSel').value=t;}
  $('#themeSel').addEventListener('change',e=>{applyTheme(e.target.value);localStorage.setItem('awp_theme',e.target.value);});

  function normalizeSede(s){return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').replace(/[^\w\s\-&']/g,'').trim().toUpperCase();}
  function pick(r,names){for(const n of names){if(r[n]!=null&&r[n]!=='')return r[n];}return'';}
  function pickCodeId(row){
    const norm=k=>k.toUpperCase().replace(/[^A-Z0-9]/g,''); const keys=Object.keys(row);
    let h=keys.find(k=>norm(k)==='CODEID'); if(h) return String(row[h]??'').trim();
    h=keys.find(k=>/COD(ICE)?ID/i.test(k)); if(h) return String(row[h]??'').trim();
    h=keys.find(k=>/(SERIALE|MATRICOLA|AWP)/i.test(k)); return h?String(row[h]??'').trim():'';
  }
  function parseDateIT(v){
    if(v==null||v==='')return null;
    if(typeof v==='number'||/^[0-9]+$/.test(String(v).trim())){
      const n=Number(v); if(!Number.isNaN(n)&&n>0&&n<2958465){
        const base=new Date(Date.UTC(1899,11,30)); const d=new Date(base.getTime()+n*86400000);
        return new Date(d.getFullYear(),d.getMonth(),d.getDate());
      }
    }
    const s=String(v).trim().replace(/[\/\.]/g,'-');
    const m=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})(?:[ T]\d{1,2}:\d{2}(?::\d{2})?)?$/);
    if(m){const[,gg,mm,yyyy]=m;return new Date(+yyyy,+mm-1,+gg);}
    const d=new Date(s); if(!isNaN(d)) return new Date(d.getFullYear(),d.getMonth(),d.getDate());
    return null;
  }
  function daysDiffFromToday(d){ if(!d) return Infinity; const t=new Date(); t.setHours(0,0,0,0); const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); return Math.floor((t-x)/86400000); }
  function fmtDate(d){if(!d)return'';const gg=String(d.getDate()).padStart(2,'0');const mm=String(d.getMonth()+1).padStart(2,'0');return `${gg}-${mm}-${d.getFullYear()}`;}

  // M.S./FERIE & DESCR.STATO
  function pickMSFerie(row){
    const v=(row['M.S. / FERIE'] ?? row['M.S./ FERIE'] ?? row['M.S./FERIE'] ?? row['MS / FERIE'] ?? row['MS/FERIE'] ?? row['M.S.'] ?? '').toString().trim();
    return v;
  }
  function classifyState(descrStato, msFerie){
    const ms=(msFerie||'').toUpperCase();
    if(/FERIE/.test(ms)) return 'FERIE';
    if(/MANUT/.test(ms) || /M\.S\./.test(ms)) return 'MANUT';
    const s=(descrStato||'').toUpperCase();
    if(/BLOCCO\s*AMMINISTRATIVO/.test(s)) return 'FERIE';
    if(/724\s*IN\s*CORSO/.test(s))       return 'MANUT';
    if(/BLOCCO\s*DA\s*DA/.test(s))       return 'BLOCCO_DA_DA';
    if(/\bBLOCCO\b/.test(s) || /\bBLOCCATA\b/.test(s)) return 'BLOCCO';
    if(/\bATTIVA\b/.test(s))             return 'ATTIVA';
    return 'ATTIVA';
  }

  /* ===== Stato app ===== */
  let latestName='', esattori=[], sedeToEs=new Map();
  let macchine=[]; // per macchina (CODEID unico)
  let locali=[];   // per sede
  // paginazione
  let pageMac=1,pageLoc=1;

  async function fetchJSON(u,l){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error(`Caricamento ${l||u} fallito (${r.status})`);return r.json();}
  async function fetchXLSX_largest(u,l){
    const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error(`Caricamento ${l||u} fallito (${r.status})`);
    const ab=await r.arrayBuffer();const wb=XLSX.read(ab,{type:'array'});
    let best=null,rows=[],len=0;for(const n of wb.SheetNames){const ws=wb.Sheets[n];const arr=XLSX.utils.sheet_to_json(ws,{defval:null});if(arr.length>len){len=arr.length;rows=arr;best=n;}}
    return {rows, sheetName:best||wb.SheetNames[0]};
  }

  async function loadAll(){
    showLoader(true); $('#errorBox').style.display='none';
    try{
      const manifest=await fetchJSON('./Dati/manifest.json','manifest.json');
      if(!manifest.sinottici||!manifest.sinottici.length) throw new Error('manifest.json: lista sinottici vuota');
      latestName=manifest.sinottici[manifest.sinottici.length-1];
      $('#pillSin').textContent='Sinottico: '+latestName;

      try{ esattori=await fetchJSON('./Dati/esattori.json','esattori.json'); }catch(_){ esattori=[]; }
      $('#selEsattore').innerHTML='<option value="">‚Äî Tutti ‚Äî</option>'+esattori.map(e=>`<option value="${String(e).toUpperCase()}">${String(e).toUpperCase()}</option>`).join('');

      const pdv=await fetchXLSX_largest('./Dati/PDV-e-ESATTORI.xlsx','PDV-e-ESATTORI.xlsx');
      sedeToEs=new Map(); for(const r of pdv.rows){ const sede=normalizeSede(r['DENOMIN. SEDE']); const es=(r['ESATTORE']??'').toString().trim().toUpperCase()||'‚Äî'; if(sede) sedeToEs.set(sede,es); }

      const sn=await fetchXLSX_largest('./Dati/'+latestName, latestName);
      $('#pillFoglio').textContent='Foglio: '+sn.sheetName;

      // CODEID ‚Üí riga pi√π recente (salvo anche ms)
      const byCode=new Map();
      for(const row of sn.rows){
        const codeid=pickCodeId(row); if(!codeid) continue;
        const sede  = row['DENOMIN. SEDE'] ?? pick(row,['DENOMIN.SEDE','DENOMINAZIONE SEDE']);
        const stato = String(row['DESCR.STATO'] ?? row['STATO'] ?? '').trim();
        const ms    = pickMSFerie(row);
        const data  = parseDateIT(row['DATA ULTIMA LETTURA VAL.'] ?? pick(row,['DATA ULTIMA LETTURA','ULTIMA LETTURA','DATA']));
        const comune= pick(row,['COMUNE','CITTA','LOCALITA','CITT√Ä']);
        const pda   = pick(row,['PDA','COD.PDA','ID PDA','IDPDA','COD_PDA']);
        const prev=byCode.get(codeid);
        if(!prev || (data && prev.data && data>prev.data) || (!prev?.data && data)){
          byCode.set(codeid,{codeid,sede,stato,ms,data,comune,pda});
        }
      }

      // Macchine normalizzate con categoria e giorni
      macchine=[];
      for(const {codeid,sede,stato,ms,data,comune,pda} of byCode.values()){
        const es     = sedeToEs.get(normalizeSede(sede)) ?? '‚Äî';
        const cat    = classifyState(stato, ms);
        const giorni = daysDiffFromToday(data);
        macchine.push({ ESATTORE:es, SEDE:sede, CODEID:codeid, PDA:pda, DATA:data, GIORNI:giorni, STATO:cat, COMUNE:comune });
      }

      // KPI globali
      const kTot=macchine.length;
      const kAtt=macchine.filter(r=>r.STATO==='ATTIVA').length;
      const kFer=macchine.filter(r=>r.STATO==='FERIE').length;
      const kMan=macchine.filter(r=>r.STATO==='MANUT').length;
      const kBlo=macchine.filter(r=>r.STATO==='BLOCCO').length;
      const kDa =macchine.filter(r=>r.STATO==='BLOCCO_DA_DA').length;
      $('#kTot').textContent=kTot.toLocaleString('it-IT');
      $('#kAtt').textContent=kAtt.toLocaleString('it-IT');
      $('#kFer').textContent=kFer.toLocaleString('it-IT');
      $('#kMan').textContent=kMan.toLocaleString('it-IT');
      $('#kBlo').textContent=kBlo.toLocaleString('it-IT');
      $('#kDa').textContent =kDa .toLocaleString('it-IT');

      // Locali aggregati
      const bySede=new Map();
      for(const r of macchine){
        const key=normalizeSede(r.SEDE);
        if(!bySede.has(key)) bySede.set(key,{ ESATTORE:r.ESATTORE, SEDE:r.SEDE, COMUNE:r.COMUNE, TOT:0, ATTIVA:0, FERIE:0, MANUT:0, BLOCCO:0, BLOCCO_DA_DA:0, MAX:null });
        const a=bySede.get(key);
        a.TOT++; a[r.STATO]=(a[r.STATO]||0)+1;
        if(r.DATA && (!a.MAX || r.DATA>a.MAX)) a.MAX=r.DATA;
        if(!a.ESATTORE && r.ESATTORE) a.ESATTORE=r.ESATTORE;
        if(!a.COMUNE && r.COMUNE) a.COMUNE=r.COMUNE;
      }
      locali=Array.from(bySede.values());

      // render iniziale
      pageMac=1; pageLoc=1;
      render();
    }catch(e){ showError(e.message||'Errore sconosciuto'); }
    finally{ showLoader(false); }
  }

  /* ===== Filtri + ordinamento + paginazione ===== */
  function applyFilters(){
    const esSel=($('#selEsattore').value||'').toUpperCase();
    const stato=$('#selStato').value;
    const q=($('#search').value||'').trim().toUpperCase();
    const ord=$('#selOrd').value;

    const isMac = $('#cardMac').style.display!=='none';

    if(isMac){
      let list=macchine.slice();
      if(esSel) list=list.filter(r=>(r.ESATTORE||'‚Äî').toUpperCase()===esSel);
      if(stato) list=list.filter(r=>r.STATO===stato);
      if(q) list=list.filter(r=>(r.SEDE||'').toUpperCase().includes(q)||(r.COMUNE||'').toUpperCase().includes(q)||(r.CODEID||'').toUpperCase().includes(q));

      list.sort((a,b)=>{
        if(ord==='ESATTORE,SEDE'){ const d=(a.ESATTORE||'').localeCompare(b.ESATTORE||''); if(d!==0) return d; return (a.SEDE||'').localeCompare(b.SEDE||''); }
        if(ord==='SEDE,ESATTORE'){ const d=(a.SEDE||'').localeCompare(b.SEDE||''); if(d!==0) return d; return (a.ESATTORE||'').localeCompare(b.ESATTORE||''); }
        if(ord==='COMUNE,SEDE'){ const d=(a.COMUNE||'').localeCompare(b.COMUNE||''); if(d!==0) return d; return (a.SEDE||'').localeCompare(b.SEDE||''); }
        if(ord==='GIORNI_DESC'){ return (isFinite(b.GIORNI)?b.GIORNI:-1) - (isFinite(a.GIORNI)?a.GIORNI:-1); }
        if(ord==='DATA_DESC'){ return (b.DATA?b.DATA.getTime():0) - (a.DATA?a.DATA.getTime():0); }
        return 0;
      });

      return {type:'MAC', list};
    }else{
      let list=locali.slice();
      if(esSel) list=list.filter(r=>(r.ESATTORE||'‚Äî').toUpperCase()===esSel);
      if(stato) list=list.filter(r=> (stato==='ATTIVA' && r.ATTIVA>0) || (stato==='FERIE'&&r.FERIE>0) || (stato==='MANUT'&&r.MANUT>0) || (stato==='BLOCCO'&&r.BLOCCO>0) || (stato==='BLOCCO_DA_DA'&&r.BLOCCO_DA_DA>0) );
      if(q) list=list.filter(r=>(r.SEDE||'').toUpperCase().includes(q)||(r.COMUNE||'').toUpperCase().includes(q));

      list.sort((a,b)=>{
        if(ord==='ESATTORE,SEDE'){ const d=(a.ESATTORE||'').localeCompare(b.ESATTORE||''); if(d!==0) return d; return (a.SEDE||'').localeCompare(b.SEDE||''); }
        if(ord==='SEDE,ESATTORE'){ const d=(a.SEDE||'').localeCompare(b.SEDE||''); if(d!==0) return d; return (a.ESATTORE||'').localeCompare(b.ESATTORE||''); }
        if(ord==='COMUNE,SEDE'){ const d=(a.COMUNE||'').localeCompare(b.COMUNE||''); if(d!==0) return d; return (a.SEDE||'').localeCompare(b.SEDE||''); }
        if(ord==='GIORNI_DESC'){ return 0; } // non applicabile ai locali
        if(ord==='DATA_DESC'){ return (b.MAX?b.MAX.getTime():0) - (a.MAX?a.MAX.getTime():0); }
        return 0;
      });

      return {type:'LOC', list};
    }
  }

  function paginate(list, page, size){
    const total=list.length; const pages=Math.max(1, Math.ceil(total/size));
    const p=Math.min(Math.max(1,page), pages);
    const start=(p-1)*size; const end=start+size;
    return { slice:list.slice(start,end), page:p, pages, total };
  }

  function render(){
    const res=applyFilters();
    const size=parseInt($('#pageSize').value,10)||50;
    if(res.type==='MAC'){
      const pg=paginate(res.list, pageMac, size);
      renderMac(pg.slice); $('#pageInfoMac').textContent=`Pagina ${pg.page}/${pg.pages} ‚Äî ${pg.total.toLocaleString('it-IT')} righe`; pageMac=pg.page;
      $('#pillCount').textContent=`Selezione: ${res.list.length.toLocaleString('it-IT')} macchine`;
    }else{
      const pg=paginate(res.list, pageLoc, size);
      renderLoc(pg.slice); $('#pageInfoLoc').textContent=`Pagina ${pg.page}/${pg.pages} ‚Äî ${pg.total.toLocaleString('it-IT')} locali`; pageLoc=pg.page;
      $('#pillCount').textContent=`Selezione: ${res.list.length.toLocaleString('it-IT')} locali`;
    }
  }

  function renderMac(list){
    const tb=$('#tblMac tbody'); tb.innerHTML='';
    list.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.ESATTORE||'‚Äî'}</td>
                    <td>${r.SEDE||''}</td>
                    <td>${r.CODEID||''}</td>
                    <td>${r.PDA||''}</td>
                    <td>${fmtDate(r.DATA)}</td>
                    <td class="${r.GIORNI===0?'ok':'bad'}">${isFinite(r.GIORNI)?r.GIORNI:'‚Äî'}</td>
                    <td>${r.STATO}</td>
                    <td>${r.COMUNE||''}</td>`;
      tb.appendChild(tr);
    });
  }

  function renderLoc(list){
    const tb=$('#tblLoc tbody'); tb.innerHTML='';
    list.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.ESATTORE||'‚Äî'}</td>
                    <td>${r.SEDE||''}</td>
                    <td>${r.COMUNE||''}</td>
                    <td>${r.TOT}</td>
                    <td class="ok">${r.ATTIVA||0}</td>
                    <td class="bad">${r.FERIE||0}</td>
                    <td class="warn">${r.MANUT||0}</td>
                    <td class="bad">${r.BLOCCO||0}</td>
                    <td class="bad">${r.BLOCCO_DA_DA||0}</td>
                    <td>${fmtDate(r.MAX)}</td>`;
      tb.appendChild(tr);
    });
  }

  function downloadXLSX(){
    const res=applyFilters();
    if(res.type==='MAC'){
      const headers=['ESATTORE','LOCALE','AWP (CODEID)','PDA','ULTIMA LETTURA','GIORNI','STATO','COMUNE'];
      const data=res.list.map(r=>[r.ESATTORE||'', r.SEDE||'', r.CODEID||'', r.PDA||'', fmtDate(r.DATA), isFinite(r.GIORNI)?r.GIORNI:'', r.STATO, r.COMUNE||'']);
      const ws=XLSX.utils.aoa_to_sheet([headers,...data]); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Macchine'); XLSX.writeFile(wb,'Anagrafica-Macchine.xlsx');
    }else{
      const headers=['ESATTORE','LOCALE','COMUNE','Totale','Attive','Ferie','Manut.','Blocco','Blocco da DA','Ultima lettura (max)'];
      const data=res.list.map(r=>[r.ESATTORE||'', r.SEDE||'', r.COMUNE||'', r.TOT, r.ATTIVA||0, r.FERIE||0, r.MANUT||0, r.BLOCCO||0, r.BLOCCO_DA_DA||0, fmtDate(r.MAX)]);
      const ws=XLSX.utils.aoa_to_sheet([headers,...data]); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Locali'); XLSX.writeFile(wb,'Anagrafica-Locali.xlsx');
    }
  }

  /* ===== UI ===== */
  $('#btnApply').addEventListener('click', ()=>{ pageMac=1; pageLoc=1; render(); });
  $('#btnDownload').addEventListener('click', downloadXLSX);
  $('#btnRefresh').addEventListener('click', loadAll);
  $('#pageSize').addEventListener('change', ()=>{ pageMac=1; pageLoc=1; render(); });
  $('#search').addEventListener('keydown', e=>{ if(e.key==='Enter') { pageMac=1; pageLoc=1; render(); } });

  // Tabs
  $('#tabMac').addEventListener('click', ()=>{
    $('#tabMac').setAttribute('aria-selected','true'); $('#tabLoc').removeAttribute('aria-selected');
    $('#cardMac').style.display='block'; $('#cardLoc').style.display='none';
    render();
  });
  $('#tabLoc').addEventListener('click', ()=>{
    $('#tabLoc').setAttribute('aria-selected','true'); $('#tabMac').removeAttribute('aria-selected');
    $('#cardMac').style.display='none'; $('#cardLoc').style.display='block';
    render();
  });

  // pager
  $('#prevMac').addEventListener('click', ()=>{ pageMac=Math.max(1,pageMac-1); render(); });
  $('#nextMac').addEventListener('click', ()=>{ pageMac=pageMac+1; render(); });
  $('#prevLoc').addEventListener('click', ()=>{ pageLoc=Math.max(1,pageLoc-1); render(); });
  $('#nextLoc').addEventListener('click', ()=>{ pageLoc=pageLoc+1; render(); });

  // boot
  window.addEventListener('load', ()=>{
    document.getElementById('year').textContent=new Date().getFullYear();
    initTheme();
    loadAll();
  });
})();
</script>
</body>
</html>
