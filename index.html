<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AWP Fine Ciclo Â· Analyzer Pro v5</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#f6f8fc; --ink:#0b1220; --muted:#5a6885; --card:#ffffff; --border:#e7ecf5;
    --accent:#2563eb; --accent-2:#3b82f6; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --thead:#f8fafc; --hover:#f3f7ff; --zebra:#fbfdff; --overlay:rgba(0,0,0,.35);
  }
  html[data-theme="dark"]{
    --bg:#0f1220; --ink:#eef1ff; --muted:#9aa3c7; --card:#161a2b; --border:#273057;
    --accent:#5b8cff; --accent-2:#476cff; --ok:#2bd576; --warn:#ffd24a; --bad:#ff8c8c;
    --thead:#1a2040; --hover:#121735; --zebra:#12162e; --overlay:rgba(0,0,0,.55);
  }
  html[data-theme="mint"]{
    --bg:#f2fbf7; --ink:#072018; --muted:#4c7a69; --card:#ffffff; --border:#d7efe4;
    --accent:#10b981; --accent-2:#34d399; --ok:#0ea5a5; --warn:#f59e0b; --bad:#ef4444;
    --thead:#ecfdf5; --hover:#e6fff5; --zebra:#f6fffb; --overlay:rgba(0,0,0,.25);
  }
  html[data-theme="amber"]{
    --bg:#fffaf2; --ink:#201508; --muted:#8b6a3a; --card:#ffffff; --border:#f1e3c8;
    --accent:#f59e0b; --accent-2:#fbbf24; --ok:#22c55e; --warn:#d97706; --bad:#ef4444;
    --thead:#fff4e0; --hover:#fff0d4; --zebra:#fff8ea; --overlay:rgba(0,0,0,.25);
  }

  *{box-sizing:border-box}
  body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--ink); min-height:100vh; display:flex; align-items:center; justify-content:center; }
  .app{ width:min(1300px,96vw); }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px; box-shadow:0 6px 20px rgba(15,23,42,.06); }
  h1{ font-size:24px; margin:0 0 6px; letter-spacing:.2px; }
  .muted{ color:var(--muted); }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .grow{ flex:1; }
  .hidden{ display:none !important; }

  input[type="file"], input[type="password"], input[type="text"], button{
    border:1px solid var(--border); background:#fff0; color:var(--ink);
    padding:11px 13px; border-radius:12px; font-weight:600;
  }
  input[type="text"]::placeholder{ color:#94a3b8; }
  button{ cursor:pointer; background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#fff; border:none; }
  button.secondary{ background:#fff0; color:var(--ink); border:1px solid var(--border); }
  button:hover{ filter:brightness(1.02); }
  .toolbar{ display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; margin-top:12px; }
  .stat{ background:var(--card); border:1px dashed var(--border); border-radius:12px; padding:10px 12px; font-size:13px; }

  table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:14px; font-size:14px; }
  thead th{
    position:sticky; top:0; z-index:2; background:var(--thead);
    text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:.6px; color:var(--muted);
    border-bottom:1px solid var(--border); padding:10px 8px; cursor:pointer;
  }
  tbody td{ padding:10px 8px; border-bottom:1px solid var(--border); }
  tbody tr:nth-child(odd) td{ background:var(--zebra); }
  tbody tr:hover td{ background:var(--hover); }

  .tag{ padding:4px 9px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
  .tag.good{ background:color-mix(in oklab, var(--ok) 15%, transparent); color:var(--ok); border:1px solid color-mix(in oklab, var(--ok) 40%, transparent); }
  .tag.mid{ background:color-mix(in oklab, var(--warn) 15%, transparent); color:var(--warn); border:1px solid color-mix(in oklab, var(--warn) 40%, transparent); }
  .tag.bad{ background:color-mix(in oklab, var(--bad) 15%, transparent); color:var(--bad); border:1px solid color-mix(in oklab, var(--bad) 40%, transparent); }

  /* Splash (PIN) */
  .splash{ position:fixed; inset:0; display:grid; place-items:center; background:radial-gradient(1200px 700px at 50% 0%, var(--thead) 0, var(--bg) 60%, var(--bg) 100%); z-index:5; overflow:hidden;}
  .brand{ font-weight:900; font-size: clamp(28px, 5vw, 48px); letter-spacing:.3px; color:var(--ink); text-align:center; }
  .pinbox{ margin-top:16px; display:flex; gap:10px; justify-content:center; }
  .pinbox input{ width:200px; text-align:center; letter-spacing:6px; font-size:20px; }
  .error{ color:var(--bad); font-weight:700; margin-top:6px; text-align:center; }
  .icon{ position:absolute; font-size:50px; opacity:.15; animation: floaty 12s ease-in-out infinite; filter:drop-shadow(0 2px 6px rgba(0,0,0,.2));}
  .icon:nth-child(1){ top:8%; left:10%; animation-delay:0s; }
  .icon:nth-child(2){ top:20%; right:12%; animation-delay:1.5s; }
  .icon:nth-child(3){ bottom:12%; left:16%; animation-delay:3s; }
  .icon:nth-child(4){ bottom:15%; right:22%; animation-delay:4.5s; }
  @keyframes floaty{ 0%,100%{ transform:translateY(0) rotate(0deg); } 50%{ transform:translateY(-18px) rotate(6deg); } }

  .themebar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .pill{ border:1px solid var(--border); background:var(--card); color:var(--ink); padding:8px 12px; border-radius:999px; cursor:pointer; }

  /* Modal scheda macchina */
  .modal{ position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:10; }
  .modal.in{ display:flex; }
  .modal .panel{ width:min(900px, 95vw); background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; }
  .modal h3{ margin:0 0 8px; }
  .close{ background:#fff0; color:var(--ink); border:1px solid var(--border); padding:6px 10px; border-radius:8px; cursor:pointer; float:right;}
  .grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px 16px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<div class="splash" id="splash">
  <div class="icon">ðŸŽ°</div><div class="icon">ðŸ’¸</div><div class="icon">ðŸ§®</div><div class="icon">ðŸ“Š</div>
  <div class="card" style="text-align:center; max-width:640px;">
    <div class="brand">AWP Fine Ciclo Â· Analyzer Pro</div>
    <div class="muted" style="margin-top:4px; text-align:center;">Accesso riservato</div>
    <div class="pinbox">
      <input type="password" id="pin" maxlength="4" placeholder="PIN" autocomplete="off" />
      <button class="secondary" id="enterBtn">Entra</button>
    </div>
    <div id="pinMsg" class="error" style="display:none;">PIN errato</div>
  </div>
</div>

<div class="app hidden" id="app">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div>
        <h1>Analisi Fine Ciclo</h1>
        <div class="muted">Carica un <b>Sinottico</b> (XLSX/CSV) o seleziona la <b>cartella Dati</b> per lo storico. Payout: <b>65%</b>.</div>
      </div>
      <div class="themebar">
        <span class="muted" style="font-size:12px;">Tema:</span>
        <button class="pill" data-theme="light">Chiaro</button>
        <button class="pill" data-theme="dark">Scuro</button>
        <button class="pill" data-theme="mint">Mint</button>
        <button class="pill" data-theme="amber">Ambra</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <input type="file" id="fileInput" accept=".xlsx,.XLSX,.csv,.CSV" class="grow" />
      <button id="calcBtn">Calcola</button>

      <input type="file" id="dirInput" webkitdirectory directory class="secondary" />
      <button id="scanDirBtn" class="secondary">Importa cartella Dati</button>

      <input type="text" id="search" class="search" placeholder="Cerca modello, sede, indirizzoâ€¦" />
      <button id="exportBtn" class="secondary">Esporta CSV</button>
    </div>

    <div class="toolbar">
      <div class="stat" id="statCount">Macchine: 0</div>
      <div class="stat" id="statGood">Top (residuo OUT &gt; residuo IN): 0</div>
      <div class="stat" id="statWarn">Equilibrate (Â±10%): 0</div>
    </div>

    <table id="resultTable">
      <thead>
        <tr>
          <th data-k="perc_cycle">Percentuale Ciclo</th>
          <th data-k="cycle_idx">Ciclo Corrente</th>
          <th data-k="resid_in">Residuo IN</th>
          <th data-k="resid_out">Residuo OUT</th>
          <th data-k="forecast_date">Fine Ciclo Stimata</th>
          <th data-k="MODELLO">MODELLO</th>
          <th data-k="DENOMIN_SEDE">DENOMIN. SEDE</th>
          <th data-k="SEDE">SEDE</th>
          <th data-k="INDIRIZZO">INDIRIZZO</th>
          <th data-k="PROVINCIA">PROVINCIA</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="footer">
      Residuo OUT negativo â†’ <b>â‚¬0</b>. IN/OUT del sinottico sono divisi per <b>100</b>.
    </div>
  </div>
</div>

<!-- Modal scheda macchina -->
<div class="modal" id="modal">
  <div class="panel">
    <button class="close" id="closeModal">Chiudi</button>
    <h3 id="m_title">Scheda macchina</h3>
    <div class="grid">
      <div><b>Modello</b><div id="m_model"></div></div>
      <div><b>Codice Modello</b><div id="m_code" class="mono"></div></div>
      <div><b>Ciclo</b><div id="m_cycle"></div></div>
      <div><b>Payout (%)</b><div>65%</div></div>
      <div><b>Residuo IN</b><div id="m_resid_in"></div></div>
      <div><b>Residuo OUT</b><div id="m_resid_out"></div></div>
      <div><b>Percentuale Ciclo</b><div id="m_perc"></div></div>
      <div><b>Fine Ciclo Stimata</b><div id="m_forecast"></div></div>
    </div>
    <h4 style="margin-top:14px;">Storico letture</h4>
    <div id="m_history" style="max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:8px; padding:8px;"></div>
  </div>
</div>

<script>
/* ====== SETUP / HELPERS ====== */
const CICLOSLOT = window.CICLOSLOT || __CICLOSLOT__;  // usa mapping giÃ  in pagina, altrimenti sostituisci __CICLOSLOT__ con lâ€™array JSON
const norm = s => (s??"").toString().trim();
const lowerKeys = obj => { const o={}; for(const k in obj){ o[norm(k).toLowerCase()] = obj[k]; } return o; };

/* PIN */
const splash = document.getElementById('splash'), app = document.getElementById('app');
document.getElementById('enterBtn').addEventListener('click', checkPin);
document.getElementById('pin').addEventListener('keydown', e => { if(e.key==='Enter') checkPin(); });
function checkPin(){ if(document.getElementById('pin').value === '2025'){ splash.classList.add('hidden'); app.classList.remove('hidden'); } else { const m=document.getElementById('pinMsg'); m.style.display='block'; setTimeout(()=> m.style.display='none', 1200); }}

/* Tema */
document.querySelectorAll('.pill[data-theme]').forEach(b => b.addEventListener('click', () => { document.documentElement.setAttribute('data-theme', b.dataset.theme); localStorage.setItem('awp_theme', b.dataset.theme); }));
const savedTheme = localStorage.getItem('awp_theme'); if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

/* Lookup CICLOSLOT */
const cicloByCode = (() => { const m=new Map(); (CICLOSLOT||[]).forEach(x => m.set(norm(x.code).toUpperCase(), +x.cycle)); return m; })();
const modelByCode = (() => { const m=new Map(); (CICLOSLOT||[]).forEach(x => m.set(norm(x.code).toUpperCase(), norm(x.model))); return m; })();

/* Lettori file */
function parseCSV(text){
  const first = text.split('\n')[0] || '';
  const delim = (first.split(';').length > first.split(',').length) ? ';' : ',';
  const rows=[]; let i=0,cur='',inq=false,row=[];
  while(i<text.length){ const ch=text[i];
    if(ch==='"'){ if(inq && text[i+1]==='"'){ cur+='"'; i++; } else inq=!inq; }
    else if(ch===delim && !inq){ row.push(cur); cur=''; }
    else if((ch==='\n'||ch==='\r') && !inq){ if(cur.length||row.length){ row.push(cur); rows.push(row);} cur=''; row=[]; if(ch==='\r'&&text[i+1]==='\n') i++; }
    else cur+=ch; i++;
  }
  if(cur.length||row.length){ row.push(cur); rows.push(row); }
  const headers = rows.shift().map(h => norm(h).toLowerCase());
  return rows.map(r => { const o={}; headers.forEach((h,i)=> o[h]=r[i]); return o; });
}
async function readFile(file){
  const buf = await file.arrayBuffer();
  if(/\.xlsx$/i.test(file.name)){ const wb = XLSX.read(new Uint8Array(buf), {type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:false}); return json.map(lowerKeys); }
  if(/\.csv$/i.test(file.name)){ const text = new TextDecoder('utf-8').decode(buf); return parseCSV(text); }
  return null;
}

/* Colonne (esatte) dal Sinottico */
function pickCols(map){
  const keys = Object.keys(map);
  return {
    codeKey: keys.includes('codice modello') ? 'codice modello' : null,
    inKey: keys.includes('cnttotin') ? 'cnttotin' : null,
    outKey: keys.includes('cnttotot') ? 'cnttotot' : null,
    denomSedeKey: keys.includes('denomin. sede') ? 'denomin. sede' : (keys.includes('denominazione sede') ? 'denominazione sede' : null),
    sedeKey: ['sede','localitÃ ','comune','cittÃ ','city'].find(k=> keys.includes(k)),
    indirKey: ['indirizzo','via','indir.','address'].find(k=> keys.includes(k)),
    provKey: ['provincia','prov.','prov'].find(k=> keys.includes(k)),
  };
}

/* Numeri IN/OUT: divisi per 100 */
const parseCnt = v => {
  if (typeof v === 'number') return v/100;
  let s = (v||'').toString().trim();
  if(!s) return 0;
  s = s.replace(/\s+/g, '');
  if (s.includes('.') && s.includes(',')) s = s.replace(/\./g,'').replace(',', '.');
  else if (s.includes(',')) { s = s.replace('.', '').replace(',', '.'); }
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n/100;
};

/* ====== STORICO ====== */
const HIST_KEY = 'awp_history_v1';
let history = {};
try { history = JSON.parse(localStorage.getItem(HIST_KEY) || '{}'); } catch(e){ history={}; }
function pushHistory(code, dateISO, IN, OUT){
  code = (code||'').toUpperCase();
  if(!history[code]) history[code]=[];
  history[code].push({date: dateISO, IN, OUT});
  // dedupe per data
  const seen = new Set(); history[code] = history[code].filter(r => { const k=r.date; if(seen.has(k)) return false; seen.add(k); return true; });
  history[code].sort((a,b)=> new Date(a.date) - new Date(b.date));
}

/* ====== CALCOLO + PREVISIONE ====== */
function buildRows(records, snapshotDateISO){
  const payout = 0.65;
  const rows = [];
  for(const r of records){
    const code = norm(r.code).toUpperCase();
    const C = cicloByCode.get(code);
    if(!C) continue;

    const I = r.IN, V = r.OUT;
    if(snapshotDateISO) pushHistory(code, snapshotDateISO, I, V);

    const cycles_done = Math.floor(I / C);
    const in_cycle = I - cycles_done*C;
    const target_prev = cycles_done * (payout * C);
    let paid_cycle = V - target_prev; if(paid_cycle < 0) paid_cycle = 0;

    const resid_in = in_cycle > 0 ? (C - in_cycle) : C;
    let resid_out = (payout * C) - paid_cycle; if(resid_out < 0) resid_out = 0;

    const perc_cycle = in_cycle > 0 ? (paid_cycle / in_cycle) * 100 : 0;
    const cycle_idx = cycles_done + 1;

    // Previsione fine ciclo: media giornaliera IN sulle ultime 3 letture
    let forecast = 'â€”';
    const h = history[code] || [];
    if(h.length >= 2){
      const last = h.slice(-4); // fino a 3 step
      let sumIn=0, sumDays=0;
      for(let i=1;i<last.length;i++){
        const d1 = new Date(last[i-1].date), d2 = new Date(last[i].date);
        const dt = Math.max(1, (d2 - d1) / (1000*3600*24));
        const dIn = Math.max(0, last[i].IN - last[i-1].IN);
        sumIn += dIn; sumDays += dt;
      }
      const avgInPerDay = sumDays>0 ? (sumIn/sumDays) : 0;
      if(avgInPerDay > 0 && resid_in > 0){
        const daysNeeded = resid_in / avgInPerDay;
        const est = new Date(); est.setDate(est.getDate() + Math.ceil(daysNeeded));
        forecast = est.toISOString().slice(0,10);
      }
    }

    rows.push({
      code,
      MODELLO: modelByCode.get(code) || '',
      DENOMIN_SEDE: r.DENOMIN_SEDE || '',
      SEDE: r.SEDE || '',
      INDIRIZZO: r.INDIRIZZO || '',
      PROVINCIA: r.PROVINCIA || '',
      perc_cycle, cycle_idx, resid_in, resid_out, forecast_date: forecast,
      _delta: resid_out - resid_in,
      _cycle: C, _I: I, _V: V
    });
  }
  return rows;
}

/* ====== UI ====== */
let fullRows = [];

function euro(n){ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n||0); }
function render(rows){
  rows.sort((a,b)=> (b._delta - a._delta) || (b.resid_out - a.resid_out));
  const tb = document.querySelector('#resultTable tbody'); tb.innerHTML='';
  for(const r of rows){
    const tagClass = r.resid_out > r.resid_in ? 'good' : (Math.abs(r.resid_out - r.resid_in) <= 0.1*(r.resid_in||1) ? 'mid' : 'bad');
    const tr = document.createElement('tr'); tr.dataset.code = r.code;
    tr.innerHTML = `
      <td><span class="tag ${tagClass}">${r.perc_cycle ? r.perc_cycle.toFixed(2) : '0.00'}%</span></td>
      <td>${r.cycle_idx}</td>
      <td>${euro(r.resid_in)}</td>
      <td>${euro(r.resid_out)}</td>
      <td>${r.forecast_date}</td>
      <td>${escapeHTML(r.MODELLO)}</td>
      <td>${escapeHTML(r.DENOMIN_SEDE||'')}</td>
      <td>${escapeHTML(r.SEDE||'')}</td>
      <td>${escapeHTML(r.INDIRIZZO||'')}</td>
      <td>${escapeHTML(r.PROVINCIA||'')}</td>
    `;
    tr.addEventListener('click', ()=> openModal(r.code, r));
    tb.appendChild(tr);
  }
  document.getElementById('statCount').textContent = 'Macchine: ' + rows.length;
  const good = rows.filter(r=> r.resid_out > r.resid_in).length;
  const warn = rows.filter(r=> Math.abs(r.resid_out - r.resid_in) <= 0.1*(r.resid_in||1)).length;
  document.getElementById('statGood').textContent = 'Top (residuo OUT > residuo IN): ' + good;
  document.getElementById('statWarn').textContent = 'Equilibrate (Â±10%): ' + warn;
}

document.getElementById('search').addEventListener('input', e=>{
  const q = e.target.value.toLowerCase();
  const filtered = fullRows.filter(r=> [r.MODELLO, r.DENOMIN_SEDE, r.SEDE, r.INDIRIZZO, r.PROVINCIA, r.code].some(x => (x||'').toLowerCase().includes(q)));
  render(filtered);
});

document.querySelectorAll('th[data-k]').forEach(th=>{
  th.addEventListener('click', ()=>{
    const k = th.getAttribute('data-k');
    const isNum = ['perc_cycle','cycle_idx','resid_in','resid_out','_delta'].includes(k);
    const dir = th.dataset.dir === 'asc' ? 'desc' : 'asc';
    th.dataset.dir = dir;
    const arr = [...fullRows];
    arr.sort((a,b)=>{ const A=a[k]??'', B=b[k]??''; if(isNum) return dir==='asc'?(A-B):(B-A); return dir==='asc'?String(A).localeCompare(String(B)):String(B).localeCompare(String(A)); });
    render(arr);
  });
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const rows=[['Percentuale Ciclo','Ciclo Corrente','Residuo IN','Residuo OUT','Fine Ciclo Stimata','MODELLO','DENOMIN. SEDE','SEDE','INDIRIZZO','PROVINCIA']];
  document.querySelectorAll('#resultTable tbody tr').forEach(tr=>{
    const t=tr.querySelectorAll('td');
    rows.push([ t[0].innerText.replace('%',''), t[1].innerText, t[2].innerText, t[3].innerText, t[4].innerText, t[5].innerText, t[6].innerText, t[7].innerText, t[8].innerText, t[9].innerText ]);
  });
  const csv = rows.map(r=> r.map(c=> '"' + String(c).replace(/"/g,'""') + '"').join(';')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='awp_fine_ciclo.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ====== Import: file singolo ====== */
document.getElementById('calcBtn').addEventListener('click', async ()=>{
  const f=document.getElementById('fileInput').files[0]; if(!f) return alert('Seleziona un file.');
  const data=await readFile(f); if(!data||!data.length) return;
  const cols = pickCols(data[0]);
  if(!cols.codeKey||!cols.inKey||!cols.outKey) return alert('Colonne mancanti: CODICE MODELLO, CNTTOTIN, CNTTOTOT.');
  const snapshotDate = new Date(f.lastModified||Date.now()).toISOString().slice(0,10);

  const recs = data.map(row => ({
    code: norm(row[cols.codeKey]),
    IN: parseCnt(row[cols.inKey]),
    OUT: parseCnt(row[cols.outKey]),
    DENOMIN_SEDE: cols.denomSedeKey ? norm(row[cols.denomSedeKey]) : '',
    SEDE: cols.sedeKey ? norm(row[cols.sedeKey]) : '',
    INDIRIZZO: cols.indirKey ? norm(row[cols.indirKey]) : '',
    PROVINCIA: cols.provKey ? norm(row[cols.provKey]) : ''
  }));
  fullRows = buildRows(recs, snapshotDate);
  localStorage.setItem(HIST_KEY, JSON.stringify(history));
  render(fullRows);
});

/* ====== Import: cartella Dati (storico) ====== */
document.getElementById('scanDirBtn').addEventListener('click', async ()=>{
  const files = [...document.getElementById('dirInput').files].filter(f => /\.xlsx$|\.csv$/i.test(f.name));
  if(!files.length) return alert('Seleziona una cartella con file XLSX/CSV.');
  files.sort((a,b)=> (a.name>b.name) ? 1 : -1);

  for(const f of files){
    const data = await readFile(f); if(!data||!data.length) continue;
    const cols = pickCols(data[0]); if(!cols.codeKey||!cols.inKey||!cols.outKey) continue;
    const snapshotDate = new Date(f.lastModified||Date.now()).toISOString().slice(0,10);
    const recs = data.map(row => ({
      code: norm(row[cols.codeKey]),
      IN: parseCnt(row[cols.inKey]),
      OUT: parseCnt(row[cols.outKey]),
      DENOMIN_SEDE: cols.denomSedeKey ? norm(row[cols.denomSedeKey]) : '',
      SEDE: cols.sedeKey ? norm(row[cols.sedeKey]) : '',
      INDIRIZZO: cols.indirKey ? norm(row[cols.indirKey]) : '',
      PROVINCIA: cols.provKey ? norm(row[cols.provKey]) : ''
    }));
    buildRows(recs, snapshotDate); // aggiorna solo history
  }

  // genera lista attuale dallâ€™ultima lettura per codice
  const latest = Object.keys(history).map(code => {
    const h = history[code]; const last = h[h.length-1];
    return { code, IN:last.IN, OUT:last.OUT, DENOMIN_SEDE:'', SEDE:'', INDIRIZZO:'', PROVINCIA:'' };
  });
  fullRows = buildRows(latest, null);
  localStorage.setItem(HIST_KEY, JSON.stringify(history));
  render(fullRows);
});

/* ====== Modal scheda macchina ====== */
const modal = document.getElementById('modal'); document.getElementById('closeModal').addEventListener('click', ()=> modal.classList.remove('in'));
function openModal(code, row){
  document.getElementById('m_title').textContent = 'Scheda macchina â€“ ' + code;
  document.getElementById('m_model').textContent = row.MODELLO || '';
  document.getElementById('m_code').textContent = code;
  document.getElementById('m_cycle').textContent = (row._cycle||'') + ' (partite)';
  document.getElementById('m_resid_in').textContent = euro(row.resid_in);
  document.getElementById('m_resid_out').textContent = euro(row.resid_out);
  document.getElementById('m_perc').textContent = (row.perc_cycle ? row.perc_cycle.toFixed(2) : '0.00') + '%';
  document.getElementById('m_forecast').textContent = row.forecast_date || 'â€”';

  const h = history[code] || [];
  let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr>'
    + '<th style="text-align:left;border-bottom:1px solid var(--border);padding:6px;">Data</th>'
    + '<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">IN</th>'
    + '<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">OUT</th>'
    + '<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">Î”IN</th>'
    + '<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">Î”OUT</th>'
    + '</tr></thead><tbody>';
  for(let i=0;i<h.length;i++){
    const prev = h[i-1]; const dIn = i ? (h[i].IN - prev.IN) : 0; const dOut = i ? (h[i].OUT - prev.OUT) : 0;
    html += `<tr><td style="padding:6px;">${h[i].date}</td><td style="padding:6px;text-align:right;">${euro(h[i].IN)}</td><td style="padding:6px;text-align:right;">${euro(h[i].OUT)}</td><td style="padding:6px;text-align:right;">${euro(dIn)}</td><td style="padding:6px;text-align:right;">${euro(dOut)}</td></tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('m_history').innerHTML = html;
  modal.classList.add('in');
}

function escapeHTML(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
</script>
</body>
</html>
