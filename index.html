<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AWP Analyzer Pro — v3.0</title>

<!-- Librerie -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
  --bg:#f7faff;
  --fg:#102030;
  --acc:#007bff;
  --muted:#708090;
  --card:#fff;
  --border:#d6dbe2;
  --orange:#ff8c00;
  --blue:#007bff;
}

/* === Temi === */
body.theme-bianco  { --bg:#ffffff; --fg:#111; --acc:#007bff; }
body.theme-azzurro { --bg:#e9f3ff; --fg:#001830; --acc:#007bff; }
body.theme-arancio { --bg:#fff7ef; --fg:#352200; --acc:#ff8c00; }
body.theme-windows {
  --bg:#c0c0c0; --fg:#000; --card:#dcdcdc; --border:#808080; --acc:#000080;
  font-family:"MS Sans Serif",Tahoma,sans-serif;
}

/* === Layout === */
body {
  margin:0; background:var(--bg); color:var(--fg);
  font-family:Inter,system-ui,sans-serif;
  transition:background .3s,color .3s;
}
header {
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 20px; border-bottom:2px solid var(--border);
  background:linear-gradient(to bottom,var(--card),var(--bg));
}
h1 { font-size:20px; margin:0; color:var(--acc); }
main { padding:20px; }

/* === Login === */
#loginScreen {
  position:fixed; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background:var(--bg);
}
#loginBox {
  background:var(--card); border:1px solid var(--border);
  padding:30px; border-radius:10px; box-shadow:0 8px 25px rgba(0,0,0,.1);
  width:300px; text-align:center;
}
input[type=text], input[type=password] {
  width:100%; padding:10px; margin:8px 0;
  border:1px solid var(--border); border-radius:5px;
  background:var(--bg); color:var(--fg);
}
button {
  cursor:pointer; border:none; border-radius:6px;
  padding:10px 18px; font-weight:600; color:#fff;
  background:var(--acc); transition:.2s;
}
button:hover { opacity:.9; }
small.version { display:block; margin-top:15px; color:var(--muted); }

/* === Barra caricamento === */
#progressBarContainer {
  position:fixed; bottom:0; left:0; right:0; height:6px; background:#ddd;
}
#progressBar {
  height:100%; width:0%; background:var(--acc); transition:width .3s;
}

/* === Dashboard === */
#dashboard { display:none; }
.card {
  background:var(--card); border:1px solid var(--border);
  border-radius:10px; padding:15px; margin-bottom:15px;
  box-shadow:0 3px 8px rgba(0,0,0,.05);
}
.theme-windows .card { border:2px outset #fff; box-shadow:none; }

/* === Footer === */
footer { text-align:center; padding:10px; font-size:12px; color:var(--muted); }

/* === Animazioni === */
.fadeIn { animation:fadeIn .5s ease-in; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
</style>
</head>
<body class="theme-azzurro">

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginBox" class="fadeIn">
    <h1>AWP Analyzer Pro</h1>
    <input id="username" type="text" placeholder="Utente">
    <input id="password" type="password" placeholder="PIN">
    <button id="btnLogin">Accedi</button>
    <small class="version">Versione 3.0 — Build 2025.11</small>
    <div style="margin-top:10px">
      <select id="themeSelect">
        <option value="azzurro" selected>Azzurro</option>
        <option value="bianco">Bianco</option>
        <option value="arancio">Arancio</option>
        <option value="windows">Windows 95</option>
      </select>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <header>
    <h1>AWP Analyzer Pro — Dashboard</h1>
    <div id="userInfo"></div>
  </header>

  <main>
    <div class="card">
      <h2>Stato caricamento dati</h2>
      <div id="loadStatus">In attesa dei file...</div>
    </div>
    <div class="card">
      <h2>Grafico generale (in arrivo nel Blocco 3)</h2>
      <canvas id="mainChart" width="900" height="320"></canvas>
    </div>
  </main>

  <footer>
    AWP Analyzer Pro v3.0 — © 2025 Stephan Winckler
  </footer>
</div>

<div id="progressBarContainer"><div id="progressBar"></div></div>

<script>
/* ======== BLOCCO 1 JS ======== */

/* === LOGIN con users.json === */
async function doLogin() {
  const u = username.value.trim().toLowerCase();
  const pin = password.value.trim();

  try {
    const res = await fetch('users.json', {cache:'no-store'});
    if(!res.ok) throw new Error("Impossibile leggere users.json");
    const users = await res.json();

    const user = users.find(x => x.user.toLowerCase() === u && x.pin === pin);
    if (!user) { alert("Credenziali non valide"); return; }

    // Controllo scadenza
    if (user.expires) {
      const exp = new Date(user.expires);
      if (exp < new Date()) {
        alert(`Abbonamento scaduto il ${user.expires}`);
        return;
      }
    }

    localStorage.setItem('awp_user', user.user);
    localStorage.setItem('awp_level', user.level);
    startApp(user.user, user.level);

  } catch(err) {
    alert("Errore durante il login: "+err);
  }
}

document.getElementById('btnLogin').onclick = doLogin;

/* === Avvio app === */
function startApp(u, level="Base") {
  loginScreen.style.display='none';
  dashboard.style.display='block';
  userInfo.textContent = `${u} (${level})`;
  loadManifestAndFiles();
}

/* === Cambio tema === */
themeSelect.onchange = e=>{
  document.body.className='theme-'+e.target.value;
  localStorage.setItem('awp_theme', e.target.value);
};
const savedTheme = localStorage.getItem('awp_theme');
if(savedTheme) document.body.className='theme-'+savedTheme;

/* === Barra di progresso === */
function setProgress(p){
  document.getElementById('progressBar').style.width=p+'%';
}

/* === Caricamento progressivo sinottici dal manifest === */
async function loadManifestAndFiles(){
  const loadDiv = document.getElementById('loadStatus');
  setProgress(0);
  try {
    const res = await fetch('manifest.json',{cache:'no-store'});
    const files = await res.json();
    const total = files.length;
    let loaded = 0;
    const allData=[];

    for(const f of files){
      loadDiv.innerHTML = `Caricamento <b>${f}</b> (${++loaded}/${total})...`;
      const part = await readSheetUniversal('Dati/'+f);
      allData.push(...part);
      setProgress(Math.round(loaded/total*100));
      await new Promise(r=>setTimeout(r,100)); // effetto fluido
    }

    loadDiv.innerHTML = `<b>${allData.length}</b> righe caricate da ${total} file.`;
    setProgress(100);
    // In seguito qui verrà chiamato il motore predittivo (Blocco 2)

  } catch(err) {
    loadDiv.innerHTML = "Errore caricamento manifest: " + err;
  }
}

/* === Lettore XLS/XLSX universale === */
async function readSheetUniversal(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error("Impossibile leggere "+url);
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf,{type:'array'});
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws,{defval:'',raw:false});
}

/* === Autologin === */
const lastUser = localStorage.getItem('awp_user');
if(lastUser){ startApp(lastUser, localStorage.getItem('awp_level')||"Base"); }

</script>
</body>
</html>
