<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Calcolatore AWP Analisi Pagamento</title>

  <!-- SheetJS (XLSX parser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1621;
      --panel2:#0c121b;
      --text:#e8eef7;
      --muted:#9fb0c7;
      --border:rgba(255,255,255,.08);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 12px 36px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#ffffff;
      --text:#0b1220;
      --muted:#55657c;
      --border:rgba(10,20,40,.10);
      --accent:#2563eb;
      --accent2:#7c3aed;
      --shadow: 0 10px 28px rgba(12,18,28,.12);
    }
    [data-theme="amber"]{
      --accent:#f59e0b;
      --accent2:#fb7185;
    }
    [data-theme="lime"]{
      --accent:#84cc16;
      --accent2:#22c55e;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(1000px 500px at 110% 10%, rgba(167,139,250,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1300px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--border);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:20;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;gap:12px;align-items:center;min-width:240px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: conic-gradient(from 90deg, var(--accent), var(--accent2), var(--accent));
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .brand h1{font-size:15px;margin:0;line-height:1.1}
    .brand small{display:block;color:var(--muted);font-size:12px;margin-top:3px}
    .top-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      border:1px solid var(--border); background:rgba(255,255,255,.03);
      padding:8px 10px;border-radius:999px; font-size:12px;color:var(--muted)
    }
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer; user-select:none;
      transition:.15s transform,.15s border-color,.15s background;
      font-weight:600; font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{
      border-color:rgba(125,211,252,.30);
      background:linear-gradient(180deg, rgba(125,211,252,.20), rgba(125,211,252,.08));
    }
    .btn.danger{
      border-color:rgba(251,113,133,.35);
      background:linear-gradient(180deg, rgba(251,113,133,.18), rgba(251,113,133,.08));
    }
    .select{
      border:1px solid var(--border); background:rgba(255,255,255,.03);
      padding:10px 12px;border-radius:12px;color:var(--text);
      font-weight:600;font-size:13px;
      outline:none;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
    }
    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 16px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .card-h h2{margin:0;font-size:14px}
    .card-h .hint{color:var(--muted);font-size:12px}
    .card-b{padding:14px 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .input{
      flex:1;min-width:220px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:10px 12px;border-radius:12px;
      color:var(--text);font-weight:600;
      outline:none;
    }
    .toggle{
      display:flex;gap:8px;align-items:center;
      border:1px solid var(--border); background:rgba(255,255,255,.03);
      padding:10px 12px;border-radius:12px;
      color:var(--text); font-weight:700;font-size:13px;
      cursor:pointer; user-select:none;
    }
    .toggle input{accent-color:var(--accent)}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      border:1px solid var(--border);border-radius:14px;padding:10px 12px;
      background:rgba(255,255,255,.03);
    }
    .kpi .lab{font-size:11px;color:var(--muted)}
    .kpi .val{font-size:16px;font-weight:800;margin-top:6px}
    .kpi .sub{font-size:11px;color:var(--muted);margin-top:3px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;text-align:left}
    td{font-size:13px}
    .badge{
      display:inline-flex;align-items:center;gap:7px;
      border:1px solid var(--border);border-radius:999px;
      padding:5px 9px;font-size:12px;font-weight:800;
      background:rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .mono{font-family:var(--mono)}
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .click{cursor:pointer}
    .click:hover{text-decoration:underline}

    .split{
      display:grid;grid-template-columns: 1fr 1fr;gap:10px;
    }
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }

    /* Modal */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:50;
    }
    .modal.on{display:flex}
    .modal .box{
      width:min(1100px,100%);
      max-height:90vh;overflow:auto;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:18px;
      box-shadow:0 24px 70px rgba(0,0,0,.5);
    }
    .modal .box .mh{
      padding:14px 16px;border-bottom:1px solid var(--border);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .modal .box .mh h3{margin:0;font-size:14px}
    .modal .box .mb{padding:14px 16px}
    .x{
      width:40px;height:40px;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);cursor:pointer;
      display:grid;place-items:center;font-weight:900;
    }

    /* Login screen */
    .gate{
      min-height:100vh;display:grid;place-items:center;padding:18px;
    }
    .login{
      width:min(520px,100%);
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .login-h{
      padding:16px 16px;border-bottom:1px solid var(--border);
      display:flex;gap:12px;align-items:center;
    }
    .login-h .logo{width:44px;height:44px;border-radius:16px}
    .login-h h2{margin:0;font-size:16px}
    .login-h p{margin:4px 0 0;color:var(--muted);font-size:12px}
    .login-b{padding:16px}
    .login-b .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 520px){ .login-b .grid2{grid-template-columns:1fr} }
    .err{
      margin-top:10px;
      border:1px solid rgba(251,113,133,.35);
      background:rgba(251,113,133,.10);
      padding:10px 12px;border-radius:14px;
      color:var(--text);font-size:13px;font-weight:700;
      display:none;
    }
    .err.on{display:block}

    /* Chat NOVA */
    .chat{
      display:flex;flex-direction:column;gap:10px;
      height:520px;
    }
    .chatlog{
      flex:1;overflow:auto;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:10px;
    }
    .msg{
      padding:10px 12px;border-radius:14px;
      margin:8px 0;max-width:88%;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      white-space:pre-wrap;
    }
    .msg.me{margin-left:auto;border-color:rgba(125,211,252,.30);background:rgba(125,211,252,.10)}
    .msg.ai{border-color:rgba(167,139,250,.28);background:rgba(167,139,250,.08)}
    .chatbar{display:flex;gap:10px}
    .chatbar input{flex:1}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:8px 10px;border-radius:999px;
      font-size:12px;font-weight:800;color:var(--muted);
      cursor:pointer;user-select:none;
    }
    .chip:hover{border-color:rgba(255,255,255,.18);color:var(--text)}
    .footnote{color:var(--muted);font-size:11px;margin-top:10px}
  </style>
</head>

<body>
<div id="app"></div>

<script>
/* ==============================
   Utils
================================ */
const $ = (q, el=document) => el.querySelector(q);
const $$ = (q, el=document) => [...el.querySelectorAll(q)];

function safeNum(v){
  if(v===null || v===undefined || v==="") return null;
  const n = Number(String(v).replace(",", "."));
  return Number.isFinite(n) ? n : null;
}
function fmt(n){
  if(n===null || n===undefined) return "‚Äî";
  const x = Number(n);
  if(!Number.isFinite(x)) return "‚Äî";
  return x.toLocaleString("it-IT");
}
function fmtPct(x){
  if(x===null || x===undefined) return "‚Äî";
  if(!Number.isFinite(x)) return "‚Äî";
  return (x*100).toFixed(1) + "%";
}
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function median(arr){
  const a = arr.filter(x=>Number.isFinite(x)).slice().sort((x,y)=>x-y);
  if(!a.length) return null;
  const m = Math.floor(a.length/2);
  return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
}
function mad(arr){
  const m = median(arr);
  if(m===null) return null;
  const dev = arr.map(x=>Math.abs(x-m));
  return median(dev);
}
function robustZ(x, m, madVal){
  if(m===null || madVal===null || madVal===0) return 0;
  // 0.6745 makes MAD comparable to std dev on normal dist
  return 0.6745 * (x - m) / madVal;
}
function sigmoid(x){ return 1/(1+Math.exp(-x)); }

function parseDateFromFilename(name){
  // Accept: Sinottico-2025-12-27-0845.xlsx
  //         Sinottico-2025-12-11-0940.xlsx
  //         Sinottico-2025-12-23-0900.xlsx
  const m = String(name).match(/(\d{4})-(\d{2})-(\d{2})-(\d{2})(\d{2})/);
  if(!m) return null;
  const [_,Y,Mo,D,H,Mi]=m;
  const dt = new Date(Number(Y), Number(Mo)-1, Number(D), Number(H), Number(Mi), 0, 0);
  return Number.isNaN(dt.getTime()) ? null : dt;
}
function isoShort(dt){
  if(!dt) return "‚Äî";
  const dd = String(dt.getDate()).padStart(2,"0");
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const yy = dt.getFullYear();
  const hh = String(dt.getHours()).padStart(2,"0");
  const mi = String(dt.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yy} ${hh}:${mi}`;
}

async function fetchJson(path){
  const r = await fetch(path, {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} su ${path}`);
  return await r.json();
}
async function fetchArrayBuffer(path){
  const r = await fetch(path, {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} su ${path}`);
  return await r.arrayBuffer();
}

/* ==============================
   State
================================ */
const STATE = {
  session: null, // {user, level, expires}
  users: [],
  manifest: null,
  ciclos: [], // [{codiceModello,nomeModello,ciclo}]
  cicloByModel: new Map(),
  snapshots: [], // [{file, dt, rows}]
  machines: new Map(), // key: idAWP -> machine object
  modelBaselines: new Map(), // model -> {medianRtp, madRtp}
  ui: {
    theme: localStorage.getItem("sinotticolab_theme") || "dark",
    search: "",
    onlyLikely: false,
    rangeDays: 90,
    showDeltas: true
  }
};

function setTheme(t){
  STATE.ui.theme = t;
  localStorage.setItem("sinotticolab_theme", t);
  document.documentElement.setAttribute("data-theme", t);
}

/* ==============================
   Login
================================ */
function isExpired(expires){
  if(expires===null || expires===undefined || expires==="") return false;
  const dt = new Date(expires + "T00:00:00");
  if(Number.isNaN(dt.getTime())) return false;
  const now = new Date();
  // expires at end of day
  dt.setHours(23,59,59,999);
  return now.getTime() > dt.getTime();
}

async function loadUsers(){
  const users = await fetchJson("users.json");
  if(!Array.isArray(users)) throw new Error("users.json non √® un array");
  STATE.users = users;
}

function renderLogin(){
  setTheme(STATE.ui.theme);

  const root = $("#app");
  root.innerHTML = `
    <div class="gate">
      <div class="login">
        <div class="login-h">
          <div class="logo"></div>
          <div>
            <h2>Calcolatore AWP Analisi Pagamento</h2>
            <p>Accedi per analizzare sinottici e storico macchine.</p>
          </div>
        </div>
        <div class="login-b">
          <div class="grid2">
            <div>
              <div class="small muted" style="margin-bottom:6px">Utente</div>
              <input id="lu" class="input" placeholder="es. user" value="user" autocomplete="username" />
            </div>
            <div>
              <div class="small muted" style="margin-bottom:6px">PIN</div>
              <input id="lp" class="input" placeholder="es. 0000" value="0000" autocomplete="current-password" inputmode="numeric" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="blogin" class="btn primary">üîê Entra</button>
            <select id="theme" class="select" title="Tema">
              <option value="dark">Scuro</option>
              <option value="light">Chiaro</option>
              <option value="amber">Amber</option>
              <option value="lime">Lime</option>
            </select>
          </div>

          <div id="lerr" class="err"></div>

          <div class="footnote">
            Suggerimento: prova <span class="mono">user</span> + <span class="mono">0000</span> (se presente nel tuo users.json).
          </div>
        </div>
      </div>
    </div>
  `;

  $("#theme").value = STATE.ui.theme;
  $("#theme").addEventListener("change", e=> setTheme(e.target.value));

  const doLogin = ()=>{
    const u = ($("#lu").value || "").trim();
    const p = ($("#lp").value || "").trim();
    const err = $("#lerr");

    const found = STATE.users.find(x => String(x.user).toLowerCase()===u.toLowerCase() && String(x.pin)===p);
    if(!found){
      err.textContent = "Utente non trovato o PIN errato.";
      err.classList.add("on");
      return;
    }
    if(isExpired(found.expires)){
      err.textContent = `Accesso scaduto (${found.expires}).`;
      err.classList.add("on");
      return;
    }
    err.classList.remove("on");
    STATE.session = {
      user: found.user,
      level: found.level || "Base",
      expires: found.expires
    };
    localStorage.setItem("sinotticolab_session", JSON.stringify(STATE.session));
    renderAppShell();
    bootLoad();
  };

  $("#blogin").addEventListener("click", doLogin);
  $("#lp").addEventListener("keydown", e=> { if(e.key==="Enter") doLogin(); });
  $("#lu").addEventListener("keydown", e=> { if(e.key==="Enter") doLogin(); });
}

function tryRestoreSession(){
  const s = localStorage.getItem("sinotticolab_session");
  if(!s) return false;
  try{
    const obj = JSON.parse(s);
    if(!obj?.user) return false;
    // validate against users list once loaded
    const found = STATE.users.find(x => x.user===obj.user);
    if(!found) return false;
    if(isExpired(found.expires)) return false;
    STATE.session = {user: found.user, level: found.level || "Base", expires: found.expires};
    return true;
  }catch{ return false; }
}

/* ==============================
   XLSX parsing
================================ */
function normalizeRowKeys(row){
  // Keep as-is; but map known names to stable internal keys
  const get = (k)=> row[k];

  return {
    concess: get("codice concessionario") ?? null,
    eserc: get("esercente") ?? null,
    pda: get("PDA") ?? null,
    pdv: get("PDV") ?? null,
    idAwp: get("id awp") ?? null,
    matricola: get("matricola") ?? null,
    codModel: get("codice modello") ?? null,
    nomeModel: get("modello") ?? null,
    sw: get("software") ?? null,
    totIn: safeNum(get("tot in")),
    totOut: safeNum(get("tot out")),
    totBet: safeNum(get("tot bet")),   // if exists
    totWin: safeNum(get("tot win")),   // if exists
    // Some files may include more columns, we keep raw too:
    raw: row
  };
}

function sheetToJson(workbook){
  const sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  // defval: keep empty cells as ""
  const json = XLSX.utils.sheet_to_json(sheet, {defval:""});
  return json;
}

async function loadOneSinottico(file, baseFolder){
  const path = `${baseFolder}/${file}`;
  const buf = await fetchArrayBuffer(path);
  const wb = XLSX.read(buf, {type:"array"});
  const rows0 = sheetToJson(wb);

  // Ensure header columns are recognized; if not, try to guess by lowercasing keys
  const rows = rows0.map(r=>{
    const rr = {};
    for(const k of Object.keys(r)){
      rr[String(k).trim().toLowerCase()] = r[k];
    }
    return normalizeRowKeys(rr);
  }).filter(r => r.idAwp || r.matricola); // keep only meaningful rows

  const dt = parseDateFromFilename(file) || new Date(0);
  return {file, dt, rows};
}

/* ==============================
   Analysis pipeline
================================ */
function upsertMachineFromRow(row){
  const id = String(row.idAwp || "").trim();
  if(!id) return null;

  const existing = STATE.machines.get(id) || {
    idAwp: id,
    concess: row.concess,
    eserc: row.eserc,
    pda: row.pda,
    pdv: row.pdv,
    matricola: row.matricola,
    codModel: row.codModel,
    nomeModel: row.nomeModel,
    sw: row.sw,
    ciclo: null,
    history: [], // {dt,file,totIn,totOut,raw}
    deltas: [],  // {dtFrom,dtTo,fileTo, dIn, dOut, rtp}
    stats: null
  };

  // keep best-known metadata
  existing.concess = existing.concess || row.concess;
  existing.eserc = existing.eserc || row.eserc;
  existing.pda = existing.pda || row.pda;
  existing.pdv = existing.pdv || row.pdv;
  existing.matricola = existing.matricola || row.matricola;
  existing.codModel = existing.codModel || row.codModel;
  existing.nomeModel = existing.nomeModel || row.nomeModel;
  existing.sw = existing.sw || row.sw;

  // ciclo
  const cm = String(existing.codModel || "").trim();
  if(cm && STATE.cicloByModel.has(cm)) existing.ciclo = STATE.cicloByModel.get(cm);

  STATE.machines.set(id, existing);
  return existing;
}

function buildHistoryFromSnapshots(){
  STATE.machines.clear();

  for(const snap of STATE.snapshots){
    for(const r of snap.rows){
      const m = upsertMachineFromRow(r);
      if(!m) continue;
      m.history.push({
        dt: snap.dt,
        file: snap.file,
        totIn: r.totIn,
        totOut: r.totOut,
        raw: r.raw,
        concess: r.concess,
        eserc: r.eserc,
        pda: r.pda,
        pdv: r.pdv,
        codModel: r.codModel,
        nomeModel: r.nomeModel
      });
    }
  }

  // sort and compute deltas
  for(const m of STATE.machines.values()){
    m.history.sort((a,b)=>a.dt-b.dt);
    m.deltas = [];

    for(let i=1;i<m.history.length;i++){
      const prev = m.history[i-1];
      const cur  = m.history[i];
      const dIn  = (cur.totIn!==null && prev.totIn!==null) ? (cur.totIn - prev.totIn) : null;
      const dOut = (cur.totOut!==null && prev.totOut!==null) ? (cur.totOut - prev.totOut) : null;

      // handle resets/rollovers: ignore negative deltas
      const dIn2  = (dIn!==null && dIn>=0) ? dIn : null;
      const dOut2 = (dOut!==null && dOut>=0) ? dOut : null;
      const rtp   = (dIn2!==null && dOut2!==null && dIn2>0) ? (dOut2/dIn2) : null;

      m.deltas.push({
        dtFrom: prev.dt, dtTo: cur.dt, fileTo: cur.file,
        dIn: dIn2, dOut: dOut2, rtp
      });
    }
  }
}

function computeModelBaselines(){
  STATE.modelBaselines.clear();

  // collect rtp per model across all machines and all deltas (filter garbage)
  const map = new Map(); // model -> [rtp]
  for(const m of STATE.machines.values()){
    const model = String(m.codModel || "").trim();
    if(!model) continue;
    for(const d of m.deltas){
      if(d.rtp===null) continue;
      if(d.dIn<200) continue;      // ignore tiny intervals
      if(d.rtp<0 || d.rtp>3) continue; // sanity
      if(!map.has(model)) map.set(model, []);
      map.get(model).push(d.rtp);
    }
  }
  for(const [model, arr] of map.entries()){
    const med = median(arr);
    const md  = mad(arr);
    STATE.modelBaselines.set(model, {medianRtp: med, madRtp: md});
  }
}

function computeMachineStats(){
  for(const m of STATE.machines.values()){
    const model = String(m.codModel || "").trim();
    const base = STATE.modelBaselines.get(model) || {medianRtp:null, madRtp:null};

    const deltas = m.deltas.filter(x=>x.rtp!==null && x.dIn!==null && x.dIn>0);
    const last = deltas.length ? deltas[deltas.length-1] : null;

    // recent window
    const lastN = deltas.slice(-6);
    const rtpRecent = lastN.length ? (lastN.reduce((s,x)=>s+x.rtp,0)/lastN.length) : null;

    // robust z-score vs model baseline
    const z = (rtpRecent!==null) ? robustZ(rtpRecent, base.medianRtp, base.madRtp) : 0;

    // payout-ish heuristics:
    // - high recent RTP compared to baseline
    // - big out spike on last interval
    // - consistency: 2-3 consecutive high RTPs
    let spike = 0;
    if(last && base.medianRtp!==null && last.dIn && last.dIn>0 && last.rtp!==null){
      const zLast = robustZ(last.rtp, base.medianRtp, base.madRtp);
      spike = clamp(sigmoid(zLast) , 0, 1);
    }

    const highCount = lastN.filter(x=>{
      if(base.medianRtp===null || base.madRtp===null || x.rtp===null) return false;
      return robustZ(x.rtp, base.medianRtp, base.madRtp) > 1.2;
    }).length;

    const consistency = clamp(highCount/6, 0, 1);

    // cycle progress (informativo, non ‚Äúmagico‚Äù)
    let cycleProgress = null;
    if(m.ciclo && m.history.length){
      const h = m.history[m.history.length-1];
      if(Number.isFinite(h.totIn)){
        cycleProgress = (h.totIn % m.ciclo) / m.ciclo;
      }
    }

    // PayScore 0..100
    // z -> 0..1, spike -> 0..1, consistency -> 0..1
    const z01 = clamp(sigmoid(z), 0, 1);
    const score = Math.round(100 * clamp(0.55*z01 + 0.30*spike + 0.15*consistency, 0, 1));

    let label = "Neutra";
    let sev = "warn";
    if(score>=75){ label="Probabile pagamento"; sev="good"; }
    else if(score<=35){ label="Poco probabile"; sev="bad"; }

    m.stats = {
      baseMedian: base.medianRtp,
      rtpRecent,
      last,
      score,
      label,
      sev,
      cycleProgress
    };
  }
}

function rebuildAll(){
  buildHistoryFromSnapshots();
  computeModelBaselines();
  computeMachineStats();
}

/* ==============================
   App UI
================================ */
function renderAppShell(){
  setTheme(STATE.ui.theme);

  const root = $("#app");
  root.innerHTML = `
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>SinotticoLab <span class="muted">|</span> Analisi AWP</h1>
            <small id="sessionInfo"></small>
          </div>
        </div>

        <div class="top-actions">
          <span class="pill" id="loadPill">Pronto</span>

          <select id="theme" class="select" title="Tema">
            <option value="dark">Scuro</option>
            <option value="light">Chiaro</option>
            <option value="amber">Amber</option>
            <option value="lime">Lime</option>
          </select>

          <button class="btn primary" id="btnAnalyze">üß† Analizza sinottici</button>
          <button class="btn" id="btnChat">üí¨ NOVA</button>
          <button class="btn danger" id="btnLogout">üö™ Esci</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card-h">
            <div>
              <h2>Macchine</h2>
              <div class="hint">Ricerca, filtri e stato ‚Äúpagamento‚Äù con PayScore.</div>
            </div>
            <div class="row">
              <label class="toggle"><input type="checkbox" id="onlyLikely"> Solo probabile pagamento</label>
            </div>
          </div>
          <div class="card-b">
            <div class="row">
              <input class="input" id="search" placeholder="Cerca per esercente, PDV, PDA, ID AWP, modello..." />
              <select class="select" id="range">
                <option value="30">Ultimi 30 giorni</option>
                <option value="90">Ultimi 90 giorni</option>
                <option value="365">Ultimi 365 giorni</option>
                <option value="99999">Tutto</option>
              </select>
            </div>

            <div class="kpis">
              <div class="kpi"><div class="lab">Sinottici caricati</div><div class="val" id="kSin">‚Äî</div><div class="sub" id="kSinSub">‚Äî</div></div>
              <div class="kpi"><div class="lab">Macchine uniche</div><div class="val" id="kMac">‚Äî</div><div class="sub">ID AWP distinti</div></div>
              <div class="kpi"><div class="lab">Probabile pagamento</div><div class="val" id="kPay">‚Äî</div><div class="sub">PayScore ‚â• 75</div></div>
              <div class="kpi"><div class="lab">Modelli</div><div class="val" id="kMod">‚Äî</div><div class="sub">Codici modello distinti</div></div>
            </div>

            <div style="margin-top:12px;overflow:auto;border-radius:14px;border:1px solid var(--border)">
              <table>
                <thead>
                  <tr>
                    <th>Stato</th>
                    <th>Esercente / PDV</th>
                    <th>ID AWP</th>
                    <th>Modello</th>
                    <th>Ultimo Œî</th>
                    <th>RTP recente</th>
                    <th>Ciclo</th>
                    <th>PayScore</th>
                  </tr>
                </thead>
                <tbody id="tbl"></tbody>
              </table>
            </div>

            <div class="small muted" style="margin-top:10px">
              Nota: il PayScore √® una stima basata sui tuoi storici (deltas IN/OUT) e baseline per modello, non una ‚Äúcertezza matematica‚Äù.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <div>
              <h2>Diagnostica caricamento</h2>
              <div class="hint">Se non vedi macchine, qui trovi l‚Äôerrore vero.</div>
            </div>
          </div>
          <div class="card-b">
            <div class="split">
              <div>
                <div class="small muted">Manifest</div>
                <pre id="dbgManifest" class="mono" style="white-space:pre-wrap;margin:8px 0 0;padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.02);min-height:120px"></pre>
              </div>
              <div>
                <div class="small muted">Log</div>
                <pre id="dbgLog" class="mono" style="white-space:pre-wrap;margin:8px 0 0;padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.02);min-height:120px"></pre>
              </div>
            </div>

            <div style="margin-top:12px" class="row">
              <button class="btn" id="btnQuickSelfTest">üß™ Self-test (fetch xlsx + parse)</button>
            </div>

            <div class="footnote">
              Se GitHub ha rinominato la cartella (Dati/dati) o c‚Äô√® un 404, lo vedi qui subito.
            </div>
          </div>
        </div>
      </div>

      <!-- Machine modal -->
      <div class="modal" id="mModal">
        <div class="box">
          <div class="mh">
            <div>
              <h3 id="mTitle">Macchina</h3>
              <div class="small muted" id="mSub">‚Äî</div>
            </div>
            <div class="x" id="mClose">‚úï</div>
          </div>
          <div class="mb">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="row">
                <label class="toggle"><input type="checkbox" id="showDeltas" checked> Mostra deltas (Œî)</label>
              </div>
              <div class="row">
                <button class="btn" data-range="30">30g</button>
                <button class="btn" data-range="90">90g</button>
                <button class="btn" data-range="99999">Tutto</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <canvas id="mChart" height="120"></canvas>
            </div>

            <div style="margin-top:12px;overflow:auto;border-radius:14px;border:1px solid var(--border)">
              <table>
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>File</th>
                    <th>Tot IN</th>
                    <th>Tot OUT</th>
                    <th>Œî IN</th>
                    <th>Œî OUT</th>
                    <th>RTP Œî</th>
                    <th>PDA</th>
                    <th>PDV</th>
                  </tr>
                </thead>
                <tbody id="mTable"></tbody>
              </table>
            </div>

            <div class="small muted" style="margin-top:10px">
              Suggerimento: usa ‚ÄúMostra deltas‚Äù per capire gli stacchi reali tra un sinottico e l‚Äôaltro.
            </div>
          </div>
        </div>
      </div>

      <!-- Chat modal -->
      <div class="modal" id="cModal">
        <div class="box">
          <div class="mh">
            <div>
              <h3>N.O.V.A. (Neural Operational Virtual Analyst)</h3>
              <div class="small muted">Chat interna: risponde usando SOLO i dati del programma.</div>
            </div>
            <div class="x" id="cClose">‚úï</div>
          </div>
          <div class="mb">
            <div class="chat">
              <div class="chatlog" id="chatlog"></div>
              <div class="chatbar">
                <input id="chatin" class="input" placeholder="Esempi: 'quale macchina √® in pagamento?' / 'quando paga 12345?' / 'mostrami marim'">
                <button class="btn primary" id="chatsend">Invia</button>
              </div>
              <div class="chips">
                <div class="chip" data-q="Quale macchina √® in pagamento?">Quale √® in pagamento?</div>
                <div class="chip" data-q="Mostrami le top 10 per PayScore">Top 10 PayScore</div>
                <div class="chip" data-q="Cerca modello MARIM">Cerca modello</div>
                <div class="chip" data-q="Spiegami PayScore e come lo calcoli">Cos‚Äô√® PayScore?</div>
              </div>
              <div class="footnote">
                NOVA: se chiedi cose fuori contesto (meteo, politica, ecc) ti riporta su domande AWP/sinottici.
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  `;

  $("#sessionInfo").textContent = `Utente: ${STATE.session.user} ‚Ä¢ Livello: ${STATE.session.level}${STATE.session.expires ? " ‚Ä¢ Scadenza: "+STATE.session.expires : ""}`;

  $("#theme").value = STATE.ui.theme;
  $("#theme").addEventListener("change", e=> setTheme(e.target.value));

  $("#btnLogout").addEventListener("click", ()=>{
    localStorage.removeItem("sinotticolab_session");
    STATE.session = null;
    renderLogin();
  });

  $("#btnAnalyze").addEventListener("click", bootLoad);

  $("#search").value = STATE.ui.search;
  $("#search").addEventListener("input", e=>{
    STATE.ui.search = e.target.value;
    renderTable();
  });

  $("#onlyLikely").checked = STATE.ui.onlyLikely;
  $("#onlyLikely").addEventListener("change", e=>{
    STATE.ui.onlyLikely = e.target.checked;
    renderTable();
  });

  $("#range").value = String(STATE.ui.rangeDays);
  $("#range").addEventListener("change", e=>{
    STATE.ui.rangeDays = Number(e.target.value);
    renderTable();
  });

  // Modals
  $("#mClose").addEventListener("click", ()=> $("#mModal").classList.remove("on"));
  $("#mModal").addEventListener("click", e=> { if(e.target.id==="mModal") $("#mModal").classList.remove("on"); });

  $("#btnChat").addEventListener("click", ()=>{
    $("#cModal").classList.add("on");
    novaHello();
  });
  $("#cClose").addEventListener("click", ()=> $("#cModal").classList.remove("on"));
  $("#cModal").addEventListener("click", e=> { if(e.target.id==="cModal") $("#cModal").classList.remove("on"); });

  $("#chatsend").addEventListener("click", novaSend);
  $("#chatin").addEventListener("keydown", e=> { if(e.key==="Enter") novaSend(); });
  $$(".chip").forEach(ch=>{
    ch.addEventListener("click", ()=>{
      $("#chatin").value = ch.dataset.q;
      novaSend();
    });
  });

  $("#btnQuickSelfTest").addEventListener("click", quickSelfTest);

  renderKPIs();
  renderTable();
}

function logLine(s){
  const el = $("#dbgLog");
  if(!el) return;
  el.textContent += (el.textContent ? "\n" : "") + s;
}
function setPill(t, mood=""){
  const p = $("#loadPill");
  if(!p) return;
  p.textContent = t;
  p.style.borderColor = mood==="good" ? "rgba(52,211,153,.35)" : mood==="bad" ? "rgba(251,113,133,.35)" : "var(--border)";
  p.style.background = mood==="good" ? "rgba(52,211,153,.10)" : mood==="bad" ? "rgba(251,113,133,.10)" : "rgba(255,255,255,.03)";
  p.style.color = mood==="good" ? "var(--text)" : mood==="bad" ? "var(--text)" : "var(--muted)";
}

function renderKPIs(){
  const sinCount = STATE.snapshots.length;
  const machines = [...STATE.machines.values()];
  const macCount = machines.length;
  const payCount = machines.filter(m=>m.stats && m.stats.score>=75).length;
  const modCount = new Set(machines.map(m=>String(m.codModel||"").trim()).filter(Boolean)).size;

  $("#kSin").textContent = fmt(sinCount);
  const dates = STATE.snapshots.map(s=>s.dt).filter(d=>d && d.getTime()>0).sort((a,b)=>a-b);
  $("#kSinSub").textContent = dates.length ? `Da ${isoShort(dates[0])} a ${isoShort(dates[dates.length-1])}` : "‚Äî";
  $("#kMac").textContent = fmt(macCount);
  $("#kPay").textContent = fmt(payCount);
  $("#kMod").textContent = fmt(modCount);
}

function machineMatches(m, q){
  if(!q) return true;
  q = q.toLowerCase();
  const fields = [
    m.eserc, m.pda, m.pdv, m.idAwp, m.matricola, m.codModel, m.nomeModel, m.concess
  ].map(x=>String(x||"").toLowerCase());
  return fields.some(x=>x.includes(q));
}

function sevDot(sev){
  if(sev==="good") return `<span class="badge"><span class="dot good"></span>Pagamento</span>`;
  if(sev==="bad") return `<span class="badge"><span class="dot bad"></span>Poco</span>`;
  return `<span class="badge"><span class="dot warn"></span>Neutra</span>`;
}

function renderTable(){
  const tb = $("#tbl");
  if(!tb) return;

  const q = STATE.ui.search.trim().toLowerCase();
  const now = new Date();
  const cutoff = new Date(now.getTime() - (STATE.ui.rangeDays*24*3600*1000));

  let list = [...STATE.machines.values()].filter(m=>{
    // must have at least one history record in range
    const inRange = m.history.some(h=>h.dt >= cutoff);
    if(!inRange) return false;
    if(!machineMatches(m, q)) return false;
    if(STATE.ui.onlyLikely && (!m.stats || m.stats.score<75)) return false;
    return true;
  });

  // sort by PayScore desc then recent activity
  list.sort((a,b)=>{
    const sa = a.stats?.score ?? -1;
    const sb = b.stats?.score ?? -1;
    if(sb!==sa) return sb-sa;
    const da = a.stats?.last?.dtTo?.getTime?.() ?? 0;
    const db = b.stats?.last?.dtTo?.getTime?.() ?? 0;
    return db-da;
  });

  const rows = list.map(m=>{
    const st = m.stats || {score:null, sev:"warn", rtpRecent:null, last:null, cycleProgress:null};
    const last = st.last;
    const lastStr = last ? `ŒîIN ${fmt(last.dIn)}\nŒîOUT ${fmt(last.dOut)}` : "‚Äî";
    const rtp = st.rtpRecent;
    const cyc = m.ciclo ? `${fmt(m.ciclo)}${st.cycleProgress!==null ? ` (${Math.round(st.cycleProgress*100)}%)` : ""}` : "‚Äî";

    return `
      <tr>
        <td>${sevDot(st.sev)}<div class="small muted" style="margin-top:6px">${st.label || "‚Äî"}</div></td>
        <td>
          <div style="font-weight:900">${m.eserc || "‚Äî"}</div>
          <div class="small muted">PDV: <span class="mono">${m.pdv || "‚Äî"}</span> ‚Ä¢ PDA: <span class="mono">${m.pda || "‚Äî"}</span></div>
        </td>
        <td class="mono click" data-open="${m.idAwp}">${m.idAwp}</td>
        <td>
          <div style="font-weight:900">${m.nomeModel || "‚Äî"}</div>
          <div class="small muted">Mod: <span class="mono">${m.codModel || "‚Äî"}</span></div>
        </td>
        <td class="mono">${lastStr.replaceAll("\n","<br>")}</td>
        <td><span class="badge">${fmtPct(rtp)}</span><div class="small muted" style="margin-top:6px">baseline: ${fmtPct(st.baseMedian)}</div></td>
        <td class="mono">${cyc}</td>
        <td><span class="badge">${st.score!==null ? st.score : "‚Äî"}</span></td>
      </tr>
    `;
  }).join("");

  tb.innerHTML = rows || `<tr><td colspan="8" class="muted">Nessuna macchina trovata con i filtri attuali.</td></tr>`;

  // open handlers
  $$('[data-open]').forEach(el=>{
    el.addEventListener("click", ()=> openMachine(el.dataset.open));
  });

  renderKPIs();
}

/* ==============================
   Machine modal + chart
================================ */
let machineChart = null;
function openMachine(id){
  const m = STATE.machines.get(String(id));
  if(!m) return;

  $("#mModal").classList.add("on");
  $("#mTitle").textContent = `ID AWP ${m.idAwp} ‚Ä¢ ${m.eserc || "‚Äî"}`;
  $("#mSub").textContent = `PDV ${m.pdv || "‚Äî"} ‚Ä¢ PDA ${m.pda || "‚Äî"} ‚Ä¢ Modello ${m.nomeModel || "‚Äî"} (${m.codModel || "‚Äî"}) ‚Ä¢ PayScore ${m.stats?.score ?? "‚Äî"}`;

  // default from global
  $("#showDeltas").checked = STATE.ui.showDeltas;

  const rangeBtns = $$('#mModal [data-range]');
  rangeBtns.forEach(b=>{
    b.onclick = ()=> renderMachineDetails(m, Number(b.dataset.range), $("#showDeltas").checked);
  });
  $("#showDeltas").onchange = ()=>{
    STATE.ui.showDeltas = $("#showDeltas").checked;
    renderMachineDetails(m, 99999, $("#showDeltas").checked);
  };

  renderMachineDetails(m, 99999, $("#showDeltas").checked);
}

function renderMachineDetails(m, rangeDays, showDeltas){
  const now = new Date();
  const cutoff = new Date(now.getTime() - (rangeDays*24*3600*1000));

  const hist = m.history.filter(h=>h.dt>=cutoff);
  const deltas = m.deltas.filter(d=>d.dtTo>=cutoff);

  // Table
  const mapDeltaByTo = new Map(deltas.map(d=>[d.fileTo, d]));
  $("#mTable").innerHTML = hist.map(h=>{
    const d = mapDeltaByTo.get(h.file) || null;
    return `
      <tr>
        <td>${isoShort(h.dt)}</td>
        <td class="mono">${h.file}</td>
        <td class="mono">${fmt(h.totIn)}</td>
        <td class="mono">${fmt(h.totOut)}</td>
        <td class="mono">${d ? fmt(d.dIn) : "‚Äî"}</td>
        <td class="mono">${d ? fmt(d.dOut) : "‚Äî"}</td>
        <td>${d && d.rtp!==null ? `<span class="badge">${fmtPct(d.rtp)}</span>` : "‚Äî"}</td>
        <td class="mono">${h.pda || m.pda || "‚Äî"}</td>
        <td class="mono">${h.pdv || m.pdv || "‚Äî"}</td>
      </tr>
    `;
  }).join("");

  // Chart
  const labels = hist.map(h=> isoShort(h.dt));
  const totIn = hist.map(h=> h.totIn ?? null);
  const totOut = hist.map(h=> h.totOut ?? null);

  const dIn = hist.map(h=>{
    const d = mapDeltaByTo.get(h.file);
    return d ? d.dIn : null;
  });
  const dOut = hist.map(h=>{
    const d = mapDeltaByTo.get(h.file);
    return d ? d.dOut : null;
  });

  const ctx = $("#mChart").getContext("2d");
  if(machineChart) machineChart.destroy();

  const datasets = showDeltas ? [
    {label:"Œî IN", data:dIn, borderWidth:2, tension:.25},
    {label:"Œî OUT", data:dOut, borderWidth:2, tension:.25},
  ] : [
    {label:"Tot IN", data:totIn, borderWidth:2, tension:.25},
    {label:"Tot OUT", data:totOut, borderWidth:2, tension:.25},
  ];

  machineChart = new Chart(ctx, {
    type:"line",
    data:{labels, datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:"index", intersect:false},
      plugins:{
        legend:{labels:{color:getComputedStyle(document.documentElement).getPropertyValue("--text")}},
        tooltip:{callbacks:{
          label:(ctx)=>{
            const v = ctx.parsed.y;
            if(v===null || v===undefined) return `${ctx.dataset.label}: ‚Äî`;
            return `${ctx.dataset.label}: ${fmt(v)}`;
          }
        }}
      },
      scales:{
        x:{ticks:{color:getComputedStyle(document.documentElement).getPropertyValue("--muted"), maxRotation:0, autoSkip:true}},
        y:{ticks:{color:getComputedStyle(document.documentElement).getPropertyValue("--muted")}}
      }
    }
  });
}

/* ==============================
   NOVA chat (rule-based + data retrieval)
================================ */
function chatAdd(text, who="ai"){
  const log = $("#chatlog");
  const div = document.createElement("div");
  div.className = "msg " + (who==="me" ? "me":"ai");
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function novaHello(){
  const log = $("#chatlog");
  if(log.dataset.helloDone==="1") return;
  log.dataset.helloDone="1";
  chatAdd("Ciao, sono NOVA.\nPosso rispondere usando i sinottici caricati.\nEsempi:\n- 'quale macchina √® in pagamento?'\n- 'quando paga 12345?'\n- 'mostrami marim'\n- 'top 10 payscore'\n\nDimmi cosa ti serve.", "ai");
}

function topMachines(n=10){
  const list = [...STATE.machines.values()].filter(m=>m.stats && m.stats.score!==null);
  list.sort((a,b)=> (b.stats.score - a.stats.score));
  return list.slice(0,n);
}

function findMachineByIdOrFuzzy(q){
  q = q.trim();
  if(!q) return null;
  if(STATE.machines.has(q)) return STATE.machines.get(q);
  // try contains
  const list = [...STATE.machines.values()].filter(m=>{
    return String(m.idAwp).includes(q) || String(m.matricola||"").includes(q);
  });
  if(list.length===1) return list[0];
  return null;
}

function novaAnswer(queryRaw){
  const q = (queryRaw||"").trim();
  const low = q.toLowerCase();

  // out-of-scope guardrails
  const scopeHints = ["awp","macchina","sinottico","payscore","pagamento","rtp","modello","pdv","pda","id"];
  const looksInScope = scopeHints.some(w=>low.includes(w)) || /\d{3,}/.test(low);
  if(!looksInScope){
    return "Io posso aiutarti solo con richieste legate ai sinottici AWP.\nProva con: 'quale macchina √® in pagamento?', 'quando paga 12345?', 'mostrami marim', 'top 10 payscore'.";
  }

  // "quale √® in pagamento"
  if(low.includes("quale") && low.includes("pag") || low.includes("in pagamento")){
    const best = topMachines(10).filter(m=>m.stats.score>=75);
    if(!best.length){
      const top = topMachines(10);
      if(!top.length) return "Non ho ancora dati analizzati. Premi 'Analizza sinottici' prima.";
      return "Nessuna macchina supera la soglia 'Probabile pagamento' (PayScore ‚â• 75).\nTop attuali:\n" +
        top.map((m,i)=>`${i+1}) ${m.idAwp} ‚Ä¢ ${m.eserc||"‚Äî"} ‚Ä¢ ${m.nomeModel||"‚Äî"} ‚Ä¢ PayScore ${m.stats.score}`).join("\n");
    }
    return "Le pi√π probabili (PayScore ‚â• 75):\n" +
      best.map((m,i)=>`${i+1}) ${m.idAwp} ‚Ä¢ ${m.eserc||"‚Äî"} ‚Ä¢ ${m.nomeModel||"‚Äî"} ‚Ä¢ PayScore ${m.stats.score}`).join("\n") +
      "\n\nVuoi che apro una macchina? Scrivi: 'apri 12345'.";
  }

  // top 10
  if(low.includes("top") && (low.includes("10") || low.includes("payscore"))){
    const top = topMachines(10);
    if(!top.length) return "Non ho dati analizzati. Premi 'Analizza sinottici'.";
    return "Top 10 PayScore:\n" + top.map((m,i)=>`${i+1}) ${m.idAwp} ‚Ä¢ ${m.eserc||"‚Äî"} ‚Ä¢ ${m.nomeModel||"‚Äî"} ‚Ä¢ ${m.stats.score}`).join("\n");
  }

  // open machine
  if(low.startsWith("apri ")){
    const id = q.slice(5).trim();
    const m = findMachineByIdOrFuzzy(id);
    if(!m) return "Non trovo quella macchina. Prova con un ID AWP esatto.";
    // side effect: open modal
    openMachine(m.idAwp);
    return `Ok, apro la macchina ${m.idAwp}.`;
  }

  // "quando paga X"
  if(low.includes("quando") && low.includes("pag")){
    const id = (q.match(/(\d{3,})/)||[])[1];
    if(!id) return "Dimmi l'ID AWP. Esempio: 'quando paga 12345'.";
    const m = findMachineByIdOrFuzzy(id);
    if(!m) return "Non trovo quell'ID AWP nei dati analizzati.";
    const st = m.stats;
    if(!st) return "Ho la macchina ma non ho statistiche: premi 'Analizza sinottici'.";
    let extra = "";
    if(m.ciclo && st.cycleProgress!==null){
      extra = `\nCiclo: ${fmt(m.ciclo)} ‚Ä¢ avanzamento IN (informativo): ${Math.round(st.cycleProgress*100)}%`;
    }
    const last = st.last ? `\nUltimo Œî: IN ${fmt(st.last.dIn)} ‚Ä¢ OUT ${fmt(st.last.dOut)} ‚Ä¢ RTP ${fmtPct(st.last.rtp)}` : "";
    return `Macchina ${m.idAwp} (${m.nomeModel||"‚Äî"})\nPayScore: ${st.score} (${st.label})\nRTP recente: ${fmtPct(st.rtpRecent)} ‚Ä¢ baseline modello: ${fmtPct(st.baseMedian)}${last}${extra}\n\nVuoi che la apro? Scrivi: 'apri ${m.idAwp}'.`;
  }

  // model search
  if(low.includes("mostra") || low.includes("cerca") || low.includes("modello")){
    const term = low.replace("mostrami","").replace("mostra","").replace("cerca","").replace("modello","").trim();
    if(!term) return "Dimmi cosa cercare. Esempio: 'mostrami marim'.";
    const list = [...STATE.machines.values()].filter(m=>String(m.nomeModel||"").toLowerCase().includes(term) || String(m.codModel||"").includes(term));
    if(!list.length) return "Nessun risultato per: " + term;
    list.sort((a,b)=>(b.stats?.score??-1)-(a.stats?.score??-1));
    return `Trovate ${list.length} macchine per '${term}'. Prime 10:\n` +
      list.slice(0,10).map((m,i)=>`${i+1}) ${m.idAwp} ‚Ä¢ ${m.eserc||"‚Äî"} ‚Ä¢ PayScore ${m.stats?.score ?? "‚Äî"}`).join("\n");
  }

  // explain PayScore
  if(low.includes("payscore") && (low.includes("spiega") || low.includes("cos") || low.includes("calcoli"))){
    return "PayScore (0..100) usa solo i tuoi storici:\n- calcola i Œî IN/OUT tra sinottici\n- stima RTP per intervallo (ŒîOUT/ŒîIN)\n- crea una baseline per ogni modello (mediana + MAD)\n- confronta l'RTP recente della macchina con la baseline (robust z-score)\n- aggiunge 'spike' sull'ultimo intervallo e un po' di consistenza\n\nSoglia: ‚â•75 = 'Probabile pagamento'.";
  }

  return "Ho capito il tema (AWP/sinottici) ma non la richiesta precisa.\nProva con: 'quale macchina √® in pagamento?', 'quando paga 12345?', 'mostrami marim', 'top 10 payscore'.";
}

function novaSend(){
  const input = $("#chatin");
  const q = (input.value || "").trim();
  if(!q) return;
  input.value = "";
  chatAdd(q, "me");
  const ans = novaAnswer(q);
  chatAdd(ans, "ai");
}

/* ==============================
   Loader
================================ */
async function loadManifestAndCicli(){
  // manifest
  const man = await fetchJson("manifest.json");
  STATE.manifest = man;
  $("#dbgManifest").textContent = JSON.stringify(man, null, 2);

  // cicloslot
  const ciclos = await fetchJson("cicloslot.json");
  STATE.ciclos = Array.isArray(ciclos) ? ciclos : [];
  STATE.cicloByModel = new Map();
  for(const c of STATE.ciclos){
    const key = String(c.codiceModello||"").trim();
    const ciclo = safeNum(c.ciclo);
    if(key && ciclo) STATE.cicloByModel.set(key, ciclo);
  }
}

async function bootLoad(){
  try{
    $("#dbgLog").textContent = "";
    setPill("Carico manifest...", "");

    await loadManifestAndCicli();
    logLine("OK: manifest.json e cicloslot.json caricati.");

    const files = Array.isArray(STATE.manifest?.sinottici) ? STATE.manifest.sinottici : [];
    if(!files.length){
      setPill("Manifest vuoto", "bad");
      logLine("ERRORE: manifest.json non contiene 'sinottici' (array) o √® vuoto.");
      STATE.snapshots = [];
      STATE.machines.clear();
      renderKPIs(); renderTable();
      return;
    }

    // Sort by date from filename when possible
    const sorted = files.slice().sort((a,b)=>{
      const da = parseDateFromFilename(a)?.getTime?.() ?? 0;
      const db = parseDateFromFilename(b)?.getTime?.() ?? 0;
      return da-db;
    });

    // try base folders
    const foldersToTry = ["Dati", "dati", "DATI"];
    let chosenFolder = null;
    let testErr = null;

    for(const f of foldersToTry){
      try{
        setPill(`Test path ${f}/...`, "");
        // test first file
        await fetchArrayBuffer(`${f}/${sorted[0]}`);
        chosenFolder = f;
        break;
      }catch(e){
        testErr = e;
        logLine(`Path ${f}/ non ok: ${String(e.message||e)}`);
      }
    }

    if(!chosenFolder){
      setPill("404 sinottici", "bad");
      logLine("ERRORE: Non riesco a leggere i file .xlsx. Controlla che la cartella sia 'Dati/' e i nomi corrispondano al manifest.");
      if(testErr) logLine("Ultimo errore: " + String(testErr.message||testErr));
      return;
    }

    logLine(`Cartella sinottici: ${chosenFolder}/`);
    setPill("Carico sinottici...", "");

    // Load all snapshots (in RAM)
    const snaps = [];
    for(let i=0;i<sorted.length;i++){
      const file = sorted[i];
      setPill(`Carico ${i+1}/${sorted.length}`, "");
      try{
        const snap = await loadOneSinottico(file, chosenFolder);
        snaps.push(snap);
        logLine(`OK: ${file} (${snap.rows.length} righe)`);
      }catch(e){
        logLine(`ERRORE su ${file}: ${String(e.message||e)}`);
      }
    }

    STATE.snapshots = snaps;
    if(!STATE.snapshots.length){
      setPill("Nessun sinottico valido", "bad");
      logLine("ERRORE: nessun file √® stato parsato correttamente.");
      STATE.machines.clear();
      renderKPIs(); renderTable();
      return;
    }

    setPill("Analizzo...", "");
    rebuildAll();

    const macCount = STATE.machines.size;
    if(macCount===0){
      setPill("0 macchine", "bad");
      logLine("ERRORE: snapshots parsati ma nessuna macchina trovata. Probabile mismatch colonne / header.");
      logLine("Controllo: nei tuoi XLSX le colonne devono includere 'id awp' e 'tot in/out'.");
    }else{
      setPill("OK", "good");
      logLine(`Analisi completata. Macchine: ${macCount}`);
    }

    renderKPIs();
    renderTable();

  }catch(e){
    setPill("Errore", "bad");
    logLine("ERRORE FATALE: " + String(e.message||e));
    console.error(e);
  }
}

async function quickSelfTest(){
  $("#dbgLog").textContent = "";
  try{
    setPill("Self-test...", "");
    await loadManifestAndCicli();
    const files = Array.isArray(STATE.manifest?.sinottici) ? STATE.manifest.sinottici : [];
    if(!files.length) throw new Error("manifest.json non contiene sinottici.");

    const file = files[0];
    logLine("Primo file da manifest: " + file);

    const foldersToTry = ["Dati","dati","DATI"];
    let okFolder=null;
    for(const f of foldersToTry){
      try{
        const snap = await loadOneSinottico(file, f);
        okFolder=f;
        logLine(`OK fetch+parse da ${f}/${file} righe=${snap.rows.length}`);
        logLine("Esempio riga (keys normalizzate): " + JSON.stringify(snap.rows[0], null, 2));
        break;
      }catch(e){
        logLine(`NO ${f}/${file}: ${String(e.message||e)}`);
      }
    }
    if(!okFolder) throw new Error("Nessun folder valido (Dati/dati).");
    setPill("Self-test OK", "good");
  }catch(e){
    setPill("Self-test KO", "bad");
    logLine("Self-test errore: " + String(e.message||e));
  }
}

/* ==============================
   Boot
================================ */
(async function(){
  document.documentElement.setAttribute("data-theme", STATE.ui.theme);

  try{
    await loadUsers();
    if(tryRestoreSession()){
      renderAppShell();
      bootLoad();
    }else{
      renderLogin();
    }
  }catch(e){
    // If users.json fails, show a friendly login error screen with debug
    const root = $("#app");
    root.innerHTML = `
      <div class="gate">
        <div class="login">
          <div class="login-h">
            <div class="logo"></div>
            <div>
              <h2>Errore caricamento</h2>
              <p>Non riesco a leggere <span class="mono">users.json</span>.</p>
            </div>
          </div>
          <div class="login-b">
            <div class="err on">Dettaglio: ${String(e.message||e)}</div>
            <div class="footnote">Controlla che users.json sia nella stessa cartella di index.html e pubblico su GitHub Pages.</div>
          </div>
        </div>
      </div>
    `;
  }
})();
</script>
</body>
</html>
