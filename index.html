<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AWP Analyzer</title>

  <!-- Dipendenze client-only (GitHub Pages ok) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <link rel="stylesheet" href="./assets/styles.css" />
</head>

<body>
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">AWP</div>
        <div>
          AWP Analyzer
          <small>Sinottici • Storico • Predizione • Modelli</small>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="pill" id="pillStatus" title="Stato sessione">
        <span class="dot" id="dotStatus"></span>
        <span id="txtStatus">Non autenticato</span>
      </div>

      <button class="btn small" id="btnLogout" style="display:none">Esci</button>
    </div>
  </div>

  <div class="wrap">

    <!-- BANNER ULTIMO SINOTTICO -->
    <div class="card" id="cardBanner" style="display:none; margin-bottom:14px">
      <div class="bd" style="display:flex; align-items:center; gap:10px; justify-content:space-between; flex-wrap:wrap">
        <div class="row" style="gap:10px">
          <span class="badge" id="bannerBadge">
            <span class="dot" id="bannerDot"></span>
            <b id="bannerTitle">Stato sinottico</b>
          </span>
          <span class="muted" id="bannerSub">—</span>
        </div>
        <div class="row" style="gap:8px">
          <span class="badge mono" id="bannerFile">—</span>
          <button class="btn small" id="btnReload">Ricarica</button>
        </div>
      </div>
    </div>

    <!-- VIEW: LOGIN -->
    <div class="view active" id="viewLogin">
      <div class="grid">

        <div class="card">
          <div class="hd">
            <h2>Accesso</h2>
            <div class="sub" id="loginStatus">Self-check…</div>
          </div>

          <div class="bd">
            <div class="split">
              <div class="field">
                <label for="loginUser">Utente</label>
                <input
                  class="input"
                  id="loginUser"
                  type="text"
                  placeholder="Inserisci nome utente"
                  autocomplete="username"
                />
                <div class="muted" style="font-size:12px">Gli utenti sono in <b>./Dati/users.json</b>.</div>
              </div>

              <div class="field">
                <label for="loginPin">PIN</label>
                <input
                  class="input"
                  id="loginPin"
                  type="password"
                  placeholder="Inserisci PIN (4 cifre)"
                  inputmode="numeric"
                  pattern="[0-9]{4}"
                  autocomplete="current-password"
                />
                <div class="muted" style="font-size:12px">Il PIN non viene mostrato a schermo.</div>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="btnLogin">Entra</button>
              <button class="btn" id="btnSelfTest">Self-test</button>

              <span class="badge"><span class="dot" id="dotUsers"></span><span id="usersInfo">users.json: …</span></span>
              <span class="badge"><span class="dot" id="dotManifest"></span><span id="manifestInfo">manifest.json: …</span></span>
              <span class="badge"><span class="dot" id="dotXLSX"></span><span id="xlsxInfo">XLSX: …</span></span>
            </div>

            <div id="loginError" class="footer-note" style="color:var(--bad); display:none"></div>

            <div class="footer-note">
              Requisiti: cartella <b>/Dati/</b> (D maiuscola), file: manifest.json, cicloslot.json, users.json e sinottici .xlsx
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Assistente</h2>
            <div class="sub">online dopo login</div>
          </div>
          <div class="bd">
            <div class="chat" style="height:340px">
              <div class="chatlog" id="chatlogLogin"></div>
              <div class="footer-note">
                Dopo l’accesso potrai chiedere predizioni e statistiche (in base ai dati reali).
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- VIEW: MAIN -->
    <div class="view" id="viewMain">

      <div class="grid">

        <!-- LEFT -->
        <div class="card" id="cardMain">
          <div class="hd">
            <h2>Dashboard</h2>
            <div class="sub" id="subMain">Pronto</div>
          </div>

          <div class="bd">

            <div class="row">
              <button class="btn primary" id="btnAnalyzeAll">Analizza tutti i sinottici</button>
              <button class="btn" id="btnReset">Reset (RAM)</button>

              <span class="badge"><span class="dot" id="dotData"></span><span id="dataInfo">Dati: non caricati</span></span>
              <span class="badge"><span class="dot" id="dotHist"></span><span id="histInfo">Storico: 0</span></span>
            </div>

            <div style="height:12px"></div>

            <div class="split">
              <div class="field">
                <label for="qSearch">Cerca</label>
                <input class="input" id="qSearch" placeholder="locale, comune, modello, codeid, pda…" />
              </div>
              <div class="field">
                <label for="qFilter">Filtro</label>
                <select id="qFilter" class="input">
                  <option value="all">Tutte</option>
                  <option value="likely">Probabile pagamento (Top)</option>
                  <option value="active">Solo attive (E)</option>
                  <option value="stale">Non aggiornate (NoLink alto)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <span class="badge"><b id="countMachines">0</b>&nbsp;macchine</span>
              <span class="badge"><b id="countLocals">0</b>&nbsp;locali</span>
              <span class="badge"><b id="countModels">0</b>&nbsp;modelli</span>
              <span class="badge"><b id="countFiles">0</b>&nbsp;sinottici</span>
            </div>

            <div style="height:12px"></div>

            <!-- TABELLA MACCHINE (IMPORTANTISSIMA) -->
            <div style="max-height:520px; overflow:auto; border-radius:14px; border:1px solid var(--line)">
              <table class="table" id="tblMachines">
                <thead>
                  <tr>
                    <th style="min-width:220px">Locale</th>
                    <th>Comune</th>
                    <th>Modello</th>
                    <th class="mono">CODEID</th>
                    <th>PDA</th>
                    <th>Stato</th>
                    <th style="min-width:180px">Predizione</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="footer-note">
              Clicca una riga per aprire la scheda macchina (storico, predizione e confronto con macchine uguali).
            </div>
          </div>
        </div>

        <!-- RIGHT CHAT -->
        <div class="card" id="cardChat">
          <div class="hd">
            <h2 id="assistantName">Assistente</h2>
            <div class="sub">domande sui dati</div>
          </div>
          <div class="bd">
            <div class="chat">
              <div class="chatlog" id="chatlog"></div>
              <div class="chatbar">
                <input class="input" id="chatInput" placeholder="Es: top pagamenti • dettagli 123… • modello X stats" />
                <button class="btn primary" id="chatSend">Invia</button>
              </div>
              <div class="footer-note">
                Suggerimenti: “top pagamenti”, “cerca Molini”, “dettagli &lt;CODEID&gt;”, “modello &lt;codice&gt;”
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- MODELS COLLAPSIBLE -->
      <div style="height:16px"></div>
      <div class="card" id="cardModels">
        <div class="hd">
          <h2>Modelli</h2>
          <div class="sub">statistiche & fingerprint</div>
          <button class="btn small" id="btnToggleModels" style="margin-left:auto">Apri</button>
        </div>
        <div class="bd" id="modelsPanel" style="display:none">
          <div class="row" style="margin-bottom:10px">
            <span class="badge">Totale modelli: <b id="modelsCount">0</b></span>
            <span class="badge">Macchine con storico: <b id="modelsActive">0</b></span>
            <span class="badge">Punti analizzati: <b id="modelsPoints">0</b></span>
          </div>

          <div style="max-height:360px; overflow:auto; border-radius:14px; border:1px solid var(--line)">
            <table class="table" id="tblModels">
              <thead>
                <tr>
                  <th class="mono">MODELLO</th>
                  <th>Macchine</th>
                  <th>Con storico</th>
                  <th>Ciclo stimato (IN)</th>
                  <th>Payout mediano</th>
                  <th>Volatilità</th>
                  <th>Campioni</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="footer-note">
            “Fingerprint” = ciclo stimato + volatilità + pattern payout. Migliora con più sinottici.
          </div>
        </div>
      </div>

      <!-- DETAILS + CHART -->
      <div style="height:16px"></div>
      <div class="grid">

        <div class="card">
          <div class="hd">
            <h2 id="detailsTitle">Dettagli</h2>
            <div class="sub" id="detailsSub">Seleziona una macchina</div>
          </div>
          <div class="bd" id="detailsBody">
            <div class="kpis">
              <div class="kpi"><div class="label">Tip</div><div class="value" style="font-size:14px">Clicca una riga</div><div class="hint">Apre il modal scheda macchina</div></div>
              <div class="kpi"><div class="label">Predizione</div><div class="value" style="font-size:14px">IN rimanente + ETA</div><div class="hint">stimati su storico e modello</div></div>
              <div class="kpi"><div class="label">Coorte</div><div class="value" style="font-size:14px">Macchine uguali</div><div class="hint">confronto tra locali</div></div>
              <div class="kpi"><div class="label">Diagnosi</div><div class="value" style="font-size:14px">Admin only</div><div class="hint">parametri vitali e check</div></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Grafico</h2>
            <div class="sub" id="chartSub">Seleziona una macchina</div>
          </div>
          <div class="bd">
            <div class="row" style="margin-bottom:10px">
              <span class="badge">Vista:</span>
              <button class="btn small" id="btnChartIN">IN (Δ)</button>
              <button class="btn small" id="btnChartOUT">OUT (Δ)</button>
              <button class="btn small" id="btnChartPct">%</button>
              <span class="badge">Punti: <b id="chartPoints">0</b></span>
              <span class="badge">Limite:</span>
              <select id="chartLimit" class="input" style="min-width:120px">
                <option value="60">60</option>
                <option value="120" selected>120</option>
                <option value="250">250</option>
                <option value="999999">Tutto</option>
              </select>
            </div>
            <canvas id="chart" height="160"></canvas>
            <div class="footer-note">Il grafico mostra i delta tra letture consecutive.</div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <!-- MODAL: Scheda Macchina -->
  <div class="modal" id="machineModal" style="display:none">
    <div class="modal-backdrop" data-close="1"></div>

    <div class="modal-card">
      <div class="modal-hd">
        <div>
          <div class="modal-title" id="mmTitle">Scheda macchina</div>
          <div class="modal-sub" id="mmSub">—</div>
        </div>
        <button class="btn small" id="mmClose">Chiudi</button>
      </div>

      <div class="modal-bd">
        <div class="kpis" id="mmKpis"></div>

        <div style="height:10px"></div>

        <div class="split">
          <div>
            <h3 class="h3">Predizione</h3>
            <div id="mmPredict" class="panel"></div>
          </div>
          <div>
            <h3 class="h3">Macchine uguali (altri locali)</h3>
            <div id="mmPeers" class="panel"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <h3 class="h3">Storico (ultime letture)</h3>
        <div style="max-height:260px; overflow:auto; border-radius:14px; border:1px solid var(--line)">
          <table class="table" id="mmHist">
            <thead>
              <tr>
                <th>Data</th>
                <th>ΔIN</th>
                <th>ΔOUT</th>
                <th>%</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="height:12px"></div>
        <h3 class="h3">Fingerprint modello (“algoritmo” estratto)</h3>
        <div id="mmAlgo" class="panel"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <b id="toastTitle">Info</b>
    <small id="toastMsg">…</small>
  </div>

  <!-- App -->
  <script type="module" src="./assets/app.js"></script>
</body>
</html>
