<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calcolatore AWP analisi pagamento</title>

  <!-- Libs CDN (GitHub Pages OK) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --border: rgba(255,255,255,.14);
      --accent: #7dd3fc;
      --good: #34d399;
      --warn: #fbbf24;
      --bad: #fb7185;
      --chip: rgba(255,255,255,.08);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    /* Themes */
    [data-theme="light"]{
      --bg: #f5f7fb;
      --panel: rgba(0,0,0,.05);
      --panel2: rgba(0,0,0,.07);
      --text: rgba(0,0,0,.88);
      --muted: rgba(0,0,0,.60);
      --border: rgba(0,0,0,.12);
      --accent: #2563eb;
      --chip: rgba(0,0,0,.06);
      --shadow: 0 14px 40px rgba(25,35,60,.16);
    }
    [data-theme="amber"]{ --accent:#f59e0b; }
    [data-theme="lime"]{ --accent:#84cc16; }
    [data-theme="ocean"]{ --accent:#22c55e; }
    [data-theme="dark"]{ --accent:#7dd3fc; }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 15% 10%, rgba(125,211,252,.10), transparent 55%),
                  radial-gradient(900px 700px at 85% 20%, rgba(132,204,22,.08), transparent 55%),
                  radial-gradient(900px 700px at 50% 100%, rgba(245,158,11,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{ color:var(--accent); text-decoration:none; }

    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,0));
      border-bottom:1px solid var(--border);
    }
    [data-theme="light"] .topbar{
      background: linear-gradient(to bottom, rgba(255,255,255,.75), rgba(255,255,255,0));
    }
    .topbar-inner{
      max-width:1300px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:38px;height:38px;
      border-radius:14px;
      background: linear-gradient(135deg, var(--accent), rgba(255,255,255,.08));
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
      font-weight:800;
      letter-spacing:.5px;
      color:#001018;
    }
    [data-theme="light"] .logo{ color:#fff; }
    .title{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .title b{ font-size:14px; letter-spacing:.2px; }
    .title span{ font-size:12px; color:var(--muted); }

    .pillrow{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: var(--chip);
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip b{ color:var(--text); font-weight:650; }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:13px;
      transition: transform .06s ease, background .2s ease, border .2s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--accent), rgba(255,255,255,.10));
      border-color: rgba(255,255,255,.18);
      color:#081019;
    }
    [data-theme="light"] .btn.primary{ color:#fff; }
    .btn.small{ padding:8px 10px; border-radius:11px; font-size:12px; }
    .btn.ghost{ background: transparent; }
    .btn.danger{ border-color: rgba(251,113,133,.35); }

    .container{
      width:100%;
      max-width:1300px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      gap:14px;
      grid-template-columns: 420px 1fr;
    }
    @media (max-width: 1100px){
      .container{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(to bottom, var(--panel), transparent 130%);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .card-title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card-title b{ font-size:13px; letter-spacing:.2px; }
    .card-title span{ font-size:12px; color:var(--muted); }
    .card-body{ padding:14px; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 620px){
      .grid2, .grid3{ grid-template-columns: 1fr; }
    }

    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background: rgba(255,255,255,.85);
      color:#111827;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .mono{ font-family: var(--mono); }

    .status{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .bar{
      height:10px;
      width:100%;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,.05);
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), rgba(255,255,255,.16));
      border-radius:999px;
      transition: width .2s ease;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      font-size:12px;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    .table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      background: rgba(255,255,255,.03);
      position:sticky;
      top:0;
      z-index:1;
    }
    .scroll{
      max-height: 56vh;
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 14px;
    }

    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.good{ border-color: rgba(52,211,153,.35); color: rgba(52,211,153,.95); }
    .badge.warn{ border-color: rgba(251,191,36,.40); color: rgba(251,191,36,.95); }
    .badge.bad{ border-color: rgba(251,113,133,.42); color: rgba(251,113,133,.95); }

    .row-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Login overlay */
    .overlay{
      position:fixed;
      inset:0;
      background: radial-gradient(1000px 600px at 20% 10%, rgba(125,211,252,.18), transparent 55%),
                  radial-gradient(800px 600px at 80% 20%, rgba(132,204,22,.14), transparent 55%),
                  rgba(0,0,0,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .login{
      width:min(520px, 100%);
      border:1px solid var(--border);
      border-radius: 22px;
      background: linear-gradient(to bottom, var(--panel), rgba(0,0,0,.35));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .login-head{
      padding:18px 18px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .login-head b{ font-size:14px; }
    .login-head span{ font-size:12px; color:var(--muted); }
    .login-body{ padding:18px; display:flex; flex-direction:column; gap:10px; }
    .hint{ font-size:12px; color:var(--muted); }
    .error{ color: rgba(251,113,133,.95); font-size:12px; min-height:16px; }

    /* Chat */
    .chatbox{
      display:flex;
      flex-direction:column;
      gap:10px;
      height: 56vh;
    }
    .chatlog{
      flex:1;
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 14px;
      padding:12px;
      background: rgba(255,255,255,.03);
    }
    .msg{
      display:flex;
      gap:10px;
      margin-bottom:10px;
      align-items:flex-start;
    }
    .avatar{
      width:34px;height:34px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent), rgba(255,255,255,.10));
      display:grid;place-items:center;
      color:#061018;
      font-weight:900;
      flex:0 0 auto;
    }
    .bubble{
      border:1px solid var(--border);
      border-radius: 16px;
      padding:10px 12px;
      background: rgba(255,255,255,.05);
      width:100%;
    }
    .bubble b{ display:block; font-size:12px; margin-bottom:4px; color:var(--muted); }
    .bubble p{ margin:0; font-size:13px; white-space:pre-wrap; }
    .chatrow{ display:flex; gap:8px; }
    .chatrow textarea{ min-height:44px; max-height:120px; }
    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .kpi .badge{ background: rgba(255,255,255,.04); }
    .muted{ color:var(--muted); }
  </style>
</head>

<body>
<div class="app" id="app" data-theme="dark">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">AWP</div>
        <div class="title">
          <b>Calcolatore AWP analisi pagamento</b>
          <span id="subTitle">Pronto a caricare sinottici‚Ä¶</span>
        </div>
      </div>

      <div class="pillrow">
        <div class="chip"><span>Utente</span> <b id="chipUser">-</b></div>
        <div class="chip"><span>Livello</span> <b id="chipLevel">-</b></div>
        <div class="chip"><span>Sinottici</span> <b id="chipFiles">0</b></div>
        <div class="chip"><span>Macchine</span> <b id="chipMachines">0</b></div>
        <select id="themeSelect" title="Tema" style="width:auto; min-width:140px;">
          <option value="dark">Scuro</option>
          <option value="light">Chiaro</option>
          <option value="amber">Amber</option>
          <option value="lime">Lime</option>
          <option value="ocean">Ocean</option>
        </select>
        <button class="btn small ghost" id="btnLogout">Logout</button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="container">

    <!-- LEFT: controls + list -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">
          <b>Analisi sinottici</b>
          <span>Carica da <span class="mono">manifest.json</span> e legge gli <span class="mono">xlsx</span> in <span class="mono">/Dati</span>.</span>
        </div>
        <div class="row-actions">
          <button class="btn small" id="btnLoad">Analizza tutti</button>
          <button class="btn small" id="btnOnlyLatest">Solo ultimo</button>
        </div>
      </div>

      <div class="card-body">
        <div class="status">
          <div class="bar"><i id="barFill"></i></div>
          <div id="statusLine">In attesa‚Ä¶</div>
        </div>

        <div style="height:12px"></div>

        <div class="grid2">
          <div>
            <label class="muted" style="font-size:12px">Filtro (id macchina / pdv / esercente / comune)</label>
            <input id="filterText" placeholder="Es: 12345, PDV 4012, BAR FORTINI‚Ä¶" />
          </div>
          <div>
            <label class="muted" style="font-size:12px">Mostra</label>
            <select id="filterMode">
              <option value="all">Tutte</option>
              <option value="paysoon">In pagamento / vicine</option>
              <option value="bad">Critiche</option>
              <option value="top">Top rendimento</option>
            </select>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="kpi">
          <span class="badge good" id="kpiPay">Pagamento: 0</span>
          <span class="badge warn" id="kpiNear">Vicino: 0</span>
          <span class="badge bad" id="kpiBad">Critiche: 0</span>
        </div>

        <div style="height:12px"></div>

        <div class="scroll" id="machineScroll">
          <table class="table" id="machineTable">
            <thead>
              <tr>
                <th style="width:110px">CODEID</th>
                <th>PDV / Esercente</th>
                <th style="width:150px">Stima</th>
                <th style="width:86px"></th>
              </tr>
            </thead>
            <tbody id="machineTbody">
              <tr><td colspan="4" class="muted">Nessun dato ancora. Premi ‚ÄúAnalizza tutti‚Äù.</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- RIGHT: details + chart + chat -->
    <div style="display:grid; gap:14px;">

      <div class="card">
        <div class="card-head">
          <div class="card-title">
            <b>Dettaglio macchina</b>
            <span id="detailSubtitle">Seleziona una macchina dalla lista.</span>
          </div>
          <div class="row-actions">
            <select id="rangeSelect" style="width:auto; min-width:170px;">
              <option value="30">Grafico: ultimi 30 punti</option>
              <option value="60">Grafico: ultimi 60 punti</option>
              <option value="120" selected>Grafico: ultimi 120 punti</option>
              <option value="all">Grafico: tutto (ridotto)</option>
            </select>
            <button class="btn small" id="btnExportMachine">Esporta JSON</button>
          </div>
        </div>
        <div class="card-body">
          <div class="grid3">
            <div class="card" style="box-shadow:none; border-radius:14px">
              <div class="card-body" style="padding:12px">
                <div class="muted" style="font-size:12px">CODEID</div>
                <div class="mono" style="font-size:15px; font-weight:800" id="d_codeid">-</div>
              </div>
            </div>
            <div class="card" style="box-shadow:none; border-radius:14px">
              <div class="card-body" style="padding:12px">
                <div class="muted" style="font-size:12px">PDV / PDA</div>
                <div class="mono" style="font-size:13px; font-weight:800" id="d_pdv">-</div>
              </div>
            </div>
            <div class="card" style="box-shadow:none; border-radius:14px">
              <div class="card-body" style="padding:12px">
                <div class="muted" style="font-size:12px">Ciclo stimato</div>
                <div class="mono" style="font-size:13px; font-weight:800" id="d_cycle">-</div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="grid2">
            <div>
              <div class="muted" style="font-size:12px; margin-bottom:6px">Indicatori</div>
              <div class="kpi">
                <span class="badge" id="d_net">NET: -</span>
                <span class="badge" id="d_res">Residuo: -</span>
                <span class="badge" id="d_when">Quando paga: -</span>
              </div>
              <div style="height:10px"></div>
              <div class="muted" style="font-size:12px">Note</div>
              <div id="d_note" style="font-size:13px; line-height:1.35; color:var(--muted)">
                -
              </div>
            </div>

            <div>
              <div class="muted" style="font-size:12px; margin-bottom:6px">Ultime letture (top)</div>
              <div class="scroll" style="max-height:180px">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>IN</th>
                      <th>OUT</th>
                      <th>NET</th>
                    </tr>
                  </thead>
                  <tbody id="d_lastRows">
                    <tr><td colspan="4" class="muted">-</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="box-shadow:none; border-radius:14px">
            <div class="card-body" style="padding:12px">
              <canvas id="machineChart" height="120"></canvas>
              <div class="muted" style="font-size:12px; margin-top:8px">
                Suggerimento: ‚Äútutto‚Äù mostra comunque un grafico ridotto per restare leggibile.
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="card-title">
            <b>Chat IA: N.E.U.R.A.</b>
            <span>Neural Extractor for Unified Revenue Analysis (solo dati del programma)</span>
          </div>
          <div class="row-actions">
            <button class="btn small" id="btnChatExamples">Esempi</button>
            <button class="btn small ghost" id="btnChatClear">Pulisci</button>
          </div>
        </div>

        <div class="card-body">
          <div class="chatbox">
            <div class="chatlog" id="chatLog"></div>
            <div class="chatrow">
              <textarea id="chatInput" placeholder="Es: quali macchine sono in pagamento? / quando paga 12345 / cerca pdv 4012"></textarea>
              <button class="btn primary" id="btnChatSend">Invia</button>
            </div>
            <div class="hint">N.E.U.R.A. risponde solo su AWP/sinottici. Se chiedi altro, ti riporta ‚Äúdentro il programma‚Äù. üß≠</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LOGIN OVERLAY -->
  <div class="overlay" id="loginOverlay">
    <div class="login">
      <div class="login-head">
        <div style="display:flex; flex-direction:column; gap:4px">
          <b>Accesso</b>
          <span class="muted">Inserisci le credenziali per continuare.</span>
        </div>
        <select id="loginTheme" style="width:auto; min-width:150px;">
          <option value="dark">Tema: Scuro</option>
          <option value="light">Tema: Chiaro</option>
          <option value="amber">Tema: Amber</option>
          <option value="lime">Tema: Lime</option>
          <option value="ocean">Tema: Ocean</option>
        </select>
      </div>
      <div class="login-body">
        <div class="grid2">
          <div>
            <label class="muted" style="font-size:12px">User</label>
            <input id="loginUser" placeholder="user" value="user"/>
          </div>
          <div>
            <label class="muted" style="font-size:12px">PIN</label>
            <input id="loginPin" placeholder="0000" value="0000" />
          </div>
        </div>

        <div class="error" id="loginError"></div>

        <button class="btn primary" id="btnLogin">Entra</button>

        <div class="hint">
          Suggerimento: dopo l‚Äôaccesso premi <b>Analizza tutti</b> per vedere le macchine.
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* =========================================================
   SINOTTICO LAB - Single file app
   ========================================================= */

const App = (() => {

  // --- State in RAM ---
  const state = {
    user: null,
    users: [],
    level: null,
    expires: null,

    manifest: null,
    sinottici: [], // filenames from manifest

    cicloslot: [], // from cicloslot.json

    // historyByMachine: CODEID -> array of points {ts, dateStr, in, out, net, pdv, pda, esercente, comune, ...raw}
    historyByMachine: new Map(),

    // latest snapshot summary for list
    summary: [],

    selectedCodeId: null,

    // chart
    chart: null,
  };

  // --- DOM ---
  const $ = (id) => document.getElementById(id);

  const el = {
    app: $("app"),
    subTitle: $("subTitle"),
    chipUser: $("chipUser"),
    chipLevel: $("chipLevel"),
    chipFiles: $("chipFiles"),
    chipMachines: $("chipMachines"),

    themeSelect: $("themeSelect"),
    btnLogout: $("btnLogout"),

    btnLoad: $("btnLoad"),
    btnOnlyLatest: $("btnOnlyLatest"),
    statusLine: $("statusLine"),
    barFill: $("barFill"),

    filterText: $("filterText"),
    filterMode: $("filterMode"),
    machineTbody: $("machineTbody"),

    kpiPay: $("kpiPay"),
    kpiNear: $("kpiNear"),
    kpiBad: $("kpiBad"),

    // details
    detailSubtitle: $("detailSubtitle"),
    rangeSelect: $("rangeSelect"),
    btnExportMachine: $("btnExportMachine"),

    d_codeid: $("d_codeid"),
    d_pdv: $("d_pdv"),
    d_cycle: $("d_cycle"),
    d_net: $("d_net"),
    d_res: $("d_res"),
    d_when: $("d_when"),
    d_note: $("d_note"),
    d_lastRows: $("d_lastRows"),
    chartCanvas: $("machineChart"),

    // chat
    chatLog: $("chatLog"),
    chatInput: $("chatInput"),
    btnChatSend: $("btnChatSend"),
    btnChatClear: $("btnChatClear"),
    btnChatExamples: $("btnChatExamples"),

    // login
    loginOverlay: $("loginOverlay"),
    loginUser: $("loginUser"),
    loginPin: $("loginPin"),
    btnLogin: $("btnLogin"),
    loginError: $("loginError"),
    loginTheme: $("loginTheme"),
  };

  // --- Utils ---
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function setTheme(theme){
    el.app.setAttribute("data-theme", theme);
    el.themeSelect.value = theme;
    el.loginTheme.value = theme;
    localStorage.setItem("awp_theme", theme);
  }

  function fmtEuroFromCents(v){
    if (v == null || isNaN(v)) return "-";
    const eur = Number(v) / 100;
    return eur.toLocaleString("it-IT", { style:"currency", currency:"EUR" });
  }

  function safeUpper(s){
    return (s ?? "").toString().trim().toUpperCase();
  }

  function parseDateFromFilename(fn){
    // examples:
    // Sinottico-2025-12-23-0900.xlsx
    // Sinottico-2025-10-10-14:30.xlsx
    // Sinottico-2025-10-07.xlsx
    const m = fn.match(/(\d{4})-(\d{2})-(\d{2})(?:-(\d{2})(?::?(\d{2}))?)?/);
    if (!m) return null;
    const y=+m[1], mo=+m[2], d=+m[3];
    const hh = m[4] ? +m[4] : 0;
    const mm = m[5] ? +m[5] : 0;
    const dt = new Date(Date.UTC(y, mo-1, d, hh, mm, 0));
    return dt;
  }

  function dateStr(ts){
    const d = new Date(ts);
    return d.toLocaleString("it-IT", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }

  function setProgress(pct, label){
    el.barFill.style.width = Math.max(0, Math.min(100, pct)) + "%";
    el.statusLine.textContent = label;
  }

  function normNumber(v){
    if (v === null || v === undefined) return null;
    if (typeof v === "number") return v;
    const s = (""+v).replace(/\./g,"").replace(",",".").trim();
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function normalizeHeader(h){
    return safeUpper(h).replace(/\s+/g," ").trim();
  }

  function findCycleForModel(model){
    if (!model) return null;
    const m = safeUpper(model);
    // cicloslot.json uses keys: MODELLO, CICLO, ...
    const row = state.cicloslot.find(r => safeUpper(r.MODELLO) === m);
    return row ? normNumber(row.CICLO) : null;
  }

  function computePredictionForMachine(codeid){
    const hist = state.historyByMachine.get(codeid) || [];
    if (hist.length < 2){
      return { label:"Dati insufficienti", cls:"warn", score:0.45, cycle:null, resid:null, eta:null, note:"Servono pi√π sinottici per una stima affidabile." };
    }

    // sort by time
    const arr = hist.slice().sort((a,b)=>a.ts-b.ts);

    const last = arr[arr.length-1];
    const model = last.MODELLO || last.MODELLO_APP || last.MODEL || null;
    const cycle = findCycleForModel(model);

    // NET is IN-OUT in cents
    const nets = arr.map(p => p.net);
    const deltas = [];
    for (let i=1;i<arr.length;i++){
      deltas.push(arr[i].net - arr[i-1].net);
    }

    // Detect payout-like reset: big negative delta compared to typical
    const absD = deltas.map(x=>Math.abs(x)).sort((a,b)=>a-b);
    const medAbs = absD[Math.floor(absD.length*0.5)] || 0;
    const thr = Math.max( (medAbs*8), 200000 ); // at least 2000‚Ç¨ in cents threshold for a reset
    let lastResetIdx = -1;
    for (let i=deltas.length-1;i>=0;i--){
      if (deltas[i] < -thr){
        lastResetIdx = i+1;
        break;
      }
    }

    const sinceReset = (lastResetIdx >= 0) ? arr.slice(lastResetIdx) : arr.slice(-Math.min(20,arr.length));
    const netStart = sinceReset[0].net;
    const netNow = last.net;
    const netSince = netNow - netStart;

    // Trend (cents per day) using last N points
    const tail = arr.slice(-Math.min(12,arr.length));
    const t0 = tail[0].ts, t1 = tail[tail.length-1].ts;
    const days = Math.max( (t1 - t0) / (1000*60*60*24), 0.2);
    const netGrowth = (tail[tail.length-1].net - tail[0].net) / days; // cents/day

    // Residual logic
    let resid = null;
    let etaDays = null;
    let score = 0.5;
    let note = "";

    if (cycle && cycle > 0){
      // Interpret cycle in cents if it looks like euro? In your data CICLO seems like euros, we convert to cents if small.
      // Heuristic: if cycle < 1e7 treat as euro and convert to cents. (1e7 cents=100k‚Ç¨)
      let cycleCents = cycle;
      if (cycle < 1000000) cycleCents = Math.round(cycle * 100); // euro -> cents

      // We use modulo cycle: where within the cycle we are.
      const within = ((netNow % cycleCents) + cycleCents) % cycleCents;
      resid = cycleCents - within;

      // Also use since last reset estimate; choose the "more consistent" one:
      let resid2 = cycleCents - (((netSince % cycleCents) + cycleCents) % cycleCents);
      // pick the smaller one (closer)
      resid = Math.min(resid, resid2);

      if (netGrowth > 1){
        etaDays = resid / netGrowth;
      }

      // Score and label:
      // If residual < 8% cycle -> near
      const nearPct = resid / cycleCents;
      if (nearPct < 0.04){
        score = 0.90;
        note = "Molto vicino alla soglia stimata del ciclo.";
      } else if (nearPct < 0.10){
        score = 0.74;
        note = "Vicino alla soglia stimata del ciclo.";
      } else {
        score = 0.52;
        note = "Non sembra vicino al ciclo (stima), ma dipende dall‚Äôandamento reale.";
      }

      // If reset recently, boost confidence
      if (lastResetIdx >= 0) score = Math.min(0.97, score + 0.06);

    } else {
      // No cycle info: rely on reset detection and slope
      if (lastResetIdx >= 0){
        score = 0.62;
        note = "Ciclo non trovato: uso gli ‚Äòreset‚Äô nello storico per stimare i pagamenti.";
      } else {
        score = 0.50;
        note = "Ciclo non trovato e nessun reset evidente: stima debole.";
      }
    }

    // Convert to label classes
    let cls = "warn";
    let label = "Da monitorare";
    if (score >= 0.84){ cls="good"; label="In pagamento / molto vicina"; }
    else if (score >= 0.70){ cls="warn"; label="Vicina al pagamento"; }
    else if (score < 0.50){ cls="bad"; label="Critica / incerta"; }

    // If growth is negative or zero, warn
    if (netGrowth <= 0){
      cls = "bad";
      label = "Trend anomalo";
      note = "Il NET non sta crescendo (o sta scendendo). Potrebbe esserci stato un pagamento o letture irregolari.";
    }

    return {
      label, cls, score,
      cycle: cycle,
      resid: resid,
      etaDays: etaDays,
      note: note,
      lastReset: lastResetIdx >= 0 ? arr[lastResetIdx].ts : null
    };
  }

  function renderSummaryTable(){
    const q = el.filterText.value.trim().toUpperCase();
    const mode = el.filterMode.value;

    let rows = state.summary.slice();

    // filter mode
    if (mode === "paysoon"){
      rows = rows.filter(r => r.pred && r.pred.score >= 0.70);
    } else if (mode === "bad"){
      rows = rows.filter(r => r.pred && r.pred.score < 0.50);
    } else if (mode === "top"){
      // top by last net growth (approx) or net
      rows.sort((a,b)=> (b.lastNet ?? 0) - (a.lastNet ?? 0));
      rows = rows.slice(0, 120);
    }

    // text filter
    if (q){
      rows = rows.filter(r => {
        const hay = [
          r.codeid, r.pdv, r.pda, r.esercente, r.comune, r.provincia, r.modello
        ].map(x => (x ?? "").toString().toUpperCase()).join(" | ");
        return hay.includes(q);
      });
    }

    // KPIs
    let pay=0, near=0, bad=0;
    for (const r of state.summary){
      const s = r.pred?.score ?? 0;
      if (s >= 0.84) pay++;
      else if (s >= 0.70) near++;
      else if (s < 0.50) bad++;
    }
    el.kpiPay.textContent = "Pagamento: " + pay;
    el.kpiNear.textContent = "Vicino: " + near;
    el.kpiBad.textContent = "Critiche: " + bad;

    // render
    el.machineTbody.innerHTML = "";
    if (!rows.length){
      el.machineTbody.innerHTML = `<tr><td colspan="4" class="muted">Nessun risultato con questi filtri.</td></tr>`;
      return;
    }

    for (const r of rows){
      const pred = r.pred || {label:"-", cls:"warn"};
      const badge = `<span class="badge ${pred.cls}">${pred.label}</span>`;

      const pdv = r.pdv ? `PDV ${r.pdv}` : "-";
      const pda = r.pda ? `PDA ${r.pda}` : "";
      const es = r.esercente ? r.esercente : "-";
      const loc = [r.comune, r.provincia].filter(Boolean).join(" ");
      const line2 = [es, loc].filter(Boolean).join(" ¬∑ ");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono" style="font-weight:800">${r.codeid}</td>
        <td>
          <div class="mono" style="font-weight:800">${pdv}${pda?(" ¬∑ "+pda):""}</div>
          <div class="muted" style="margin-top:4px">${line2}</div>
          <div class="muted" style="margin-top:4px; font-size:11px">${r.modello ? ("Modello: "+r.modello) : ""}</div>
        </td>
        <td>${badge}<div class="muted" style="margin-top:6px; font-size:11px">NET: ${fmtEuroFromCents(r.lastNet)}</div></td>
        <td style="text-align:right">
          <button class="btn small" data-open="${r.codeid}">Apri</button>
        </td>
      `;
      el.machineTbody.appendChild(tr);
    }

    // bind open
    el.machineTbody.querySelectorAll("[data-open]").forEach(btn=>{
      btn.addEventListener("click", () => openMachine(btn.getAttribute("data-open")));
    });
  }

  function downsample(points, maxPoints){
    if (points.length <= maxPoints) return points;
    const step = points.length / maxPoints;
    const out = [];
    for (let i=0;i<maxPoints;i++){
      out.push(points[Math.floor(i*step)]);
    }
    // ensure last is included
    out[out.length-1] = points[points.length-1];
    return out;
  }

  function openMachine(codeid){
    state.selectedCodeId = codeid;
    const hist = (state.historyByMachine.get(codeid) || []).slice().sort((a,b)=>a.ts-b.ts);
    if (!hist.length) return;

    const last = hist[hist.length-1];
    const pred = computePredictionForMachine(codeid);

    el.detailSubtitle.textContent = `Storico: ${hist.length} letture`;

    el.d_codeid.textContent = codeid;
    const pdv = last.PDV ?? last.PDV_TOT ?? last.PDV_CODE ?? last.PDV_NUM ?? last["PDV"] ?? null;
    const pda = last.PDA ?? last["PDA"] ?? null;
    el.d_pdv.textContent = `${pdv ? ("PDV "+pdv) : "-"}${pda ? (" / PDA "+pda) : ""}`;

    // cycle display
    el.d_cycle.textContent = pred.cycle ? (pred.cycle.toString()) : "N/D";

    el.d_net.textContent = `NET: ${fmtEuroFromCents(last.net)}`;
    el.d_res.textContent = `Residuo: ${pred.resid != null ? fmtEuroFromCents(pred.resid) : "N/D"}`;

    let whenTxt = "N/D";
    if (pred.etaDays != null && isFinite(pred.etaDays)){
      if (pred.etaDays < 0.6) whenTxt = "molto presto";
      else if (pred.etaDays < 2) whenTxt = "1-2 giorni";
      else whenTxt = `${Math.round(pred.etaDays)} giorni (stima)`;
    }
    el.d_when.textContent = `Quando paga: ${whenTxt}`;

    const noteParts = [];
    noteParts.push(pred.note || "");
    if (pred.lastReset){
      noteParts.push(`Ultimo ‚Äúreset‚Äù rilevato: ${dateStr(pred.lastReset)}.`);
    }
    el.d_note.textContent = noteParts.filter(Boolean).join(" ");

    // last rows table
    const tail = hist.slice(-10).reverse();
    el.d_lastRows.innerHTML = tail.map(p => `
      <tr>
        <td class="mono">${dateStr(p.ts)}</td>
        <td class="mono">${fmtEuroFromCents(p.in)}</td>
        <td class="mono">${fmtEuroFromCents(p.out)}</td>
        <td class="mono" style="font-weight:800">${fmtEuroFromCents(p.net)}</td>
      </tr>
    `).join("");

    // chart points
    const range = el.rangeSelect.value;
    let pts = hist;
    if (range !== "all"){
      const n = parseInt(range,10);
      pts = hist.slice(-n);
    } else {
      pts = downsample(hist, 220);
    }

    renderChart(pts);
  }

  function renderChart(points){
    const labels = points.map(p => {
      const d = new Date(p.ts);
      return d.toLocaleDateString("it-IT", {month:"2-digit", day:"2-digit"}) + " " +
             d.toLocaleTimeString("it-IT", {hour:"2-digit", minute:"2-digit"});
    });

    const netData = points.map(p => Math.round((p.net ?? 0) / 100)); // in ‚Ç¨
    const inData = points.map(p => Math.round((p.in ?? 0) / 100));
    const outData = points.map(p => Math.round((p.out ?? 0) / 100));

    if (state.chart){
      state.chart.destroy();
      state.chart = null;
    }

    state.chart = new Chart(el.chartCanvas, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "NET (‚Ç¨)", data: netData, borderWidth: 2, tension: .22, pointRadius: 0 },
          { label: "IN (‚Ç¨)", data: inData, borderWidth: 1, tension: .22, pointRadius: 0 },
          { label: "OUT (‚Ç¨)", data: outData, borderWidth: 1, tension: .22, pointRadius: 0 },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') } },
          tooltip: { mode: "index", intersect: false }
        },
        scales: {
          x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted'), maxTicksLimit: 10 } },
          y: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted') } },
        },
        interaction: { mode:"index", intersect:false },
      }
    });
  }

  // --- XLSX parsing (robust header search) ---
  function sheetToJsonWithHeaderSearch(workbook){
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];

    // Convert to 2D array
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: null });

    // Find header row index: look for CODEID and at least a couple of known columns
    const known = ["CODEID", "CNTTOTIN", "CNTTOTOUT", "CODICEID", "TOTIN", "TOTOUT"];
    let headerRowIdx = -1;

    for (let i=0;i<Math.min(rows.length, 30);i++){
      const row = rows[i].map(x => normalizeHeader(x));
      const hasCode = row.includes("CODEID") || row.includes("CODICEID");
      const hits = known.filter(k => row.includes(k)).length;
      if (hasCode && hits >= 2){
        headerRowIdx = i;
        break;
      }
    }

    if (headerRowIdx === -1){
      // fallback: assume first row
      headerRowIdx = 0;
    }

    const header = rows[headerRowIdx].map(h => normalizeHeader(h));
    const dataRows = rows.slice(headerRowIdx + 1);

    // Map rows to objects
    const out = [];
    for (const r of dataRows){
      if (!r || r.every(x => x === null || x === "")) continue;
      const obj = {};
      for (let c=0;c<header.length;c++){
        const key = header[c] || ("COL_"+c);
        obj[key] = r[c];
      }
      out.push(obj);
    }
    return out;
  }

  function extractMachineRow(raw){
    // Normalize keys we care about
    const codeid = raw.CODEID ?? raw.CODICEID ?? raw["CODEID"] ?? raw["CODICEID"];
    if (!codeid) return null;

    const inC = normNumber(raw.CNTTOTIN ?? raw.TOTIN ?? raw["CNTTOTIN"] ?? raw["TOTIN"]);
    const outC = normNumber(raw.CNTTOTOUT ?? raw.TOTOUT ?? raw["CNTTOTOUT"] ?? raw["TOTOUT"]);

    // Most sinottici use cents in these totals; keep as number in cents
    // If sometimes they're in euro, we can detect: if < 500000 and looks like euro, convert to cents
    const inCents = (inC != null && inC < 500000 && Number.isInteger(inC) === false) ? Math.round(inC*100) : (inC != null ? Math.round(inC) : null);
    const outCents = (outC != null && outC < 500000 && Number.isInteger(outC) === false) ? Math.round(outC*100) : (outC != null ? Math.round(outC) : null);

    const net = (inCents != null && outCents != null) ? (inCents - outCents) : null;

    // Optional fields
    const pdv = raw.PDV ?? raw["PDV"];
    const pda = raw.PDA ?? raw["PDA"];
    const esercente = raw.ESERCENTE ?? raw["ESERCENTE"];
    const comune = raw.COMUNE ?? raw["COMUNE"];
    const provincia = raw.PROVINCIA ?? raw["PROVINCIA"];
    const modello = raw.MODELLO ?? raw["MODELLO"];

    // keep raw for extra details
    return {
      codeid: (""+codeid).trim(),
      in: inCents,
      out: outCents,
      net,
      PDV: pdv,
      PDA: pda,
      ESERCENTE: esercente,
      COMUNE: comune,
      PROVINCIA: provincia,
      MODELLO: modello,
      _raw: raw
    };
  }

  async function fetchJson(path){
    const res = await fetch(path, { cache:"no-store" });
    if (!res.ok) throw new Error(`Impossibile leggere ${path} (${res.status})`);
    return await res.json();
  }

  async function fetchArrayBuffer(path){
    const res = await fetch(path, { cache:"no-store" });
    if (!res.ok) throw new Error(`Impossibile scaricare ${path} (${res.status})`);
    return await res.arrayBuffer();
  }

  // --- Loading pipeline ---
  async function loadConfig(){
    // Load cicloslot + manifest + users
    // (paths are relative to index.html)
    const [users, manifest, ciclos] = await Promise.all([
      fetchJson("./users.json"),
      fetchJson("./manifest.json"),
      fetchJson("./cicloslot.json").catch(() => [])
    ]);

    state.users = Array.isArray(users) ? users : [];
    state.manifest = manifest || {};
    state.cicloslot = Array.isArray(ciclos) ? ciclos : [];

    const list = state.manifest.sinottici || state.manifest.files || [];
    state.sinottici = Array.isArray(list) ? list : [];

    el.chipFiles.textContent = state.sinottici.length.toString();
  }

  function todayISO(){
    // use local time
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function validateLogin(user, pin){
    const u = state.users.find(x => (x.user ?? "").toLowerCase() === (user ?? "").toLowerCase());
    if (!u) return { ok:false, msg:"Utente non trovato." };
    if ((u.pin ?? "") !== (pin ?? "")) return { ok:false, msg:"PIN errato." };

    if (u.expires){
      // expires in YYYY-MM-DD
      const exp = new Date(u.expires + "T23:59:59");
      if (isNaN(exp.getTime())) return { ok:false, msg:"Scadenza utente non valida nel file users.json." };
      if (Date.now() > exp.getTime()){
        return { ok:false, msg:`Utente scaduto (${u.expires}).` };
      }
    }

    return { ok:true, user:u.user, level:u.level ?? "Base", expires:u.expires ?? null };
  }

  function showLogin(show){
    el.loginOverlay.style.display = show ? "flex" : "none";
  }

  function setUserChip(){
    el.chipUser.textContent = state.user || "-";
    el.chipLevel.textContent = state.level || "-";
  }

  function clearData(){
    state.historyByMachine.clear();
    state.summary = [];
    state.selectedCodeId = null;
    el.chipMachines.textContent = "0";
    el.machineTbody.innerHTML = `<tr><td colspan="4" class="muted">Nessun dato ancora. Premi ‚ÄúAnalizza tutti‚Äù.</td></tr>`;
    el.detailSubtitle.textContent = "Seleziona una macchina dalla lista.";
    el.d_codeid.textContent = "-";
    el.d_pdv.textContent = "-";
    el.d_cycle.textContent = "-";
    el.d_net.textContent = "NET: -";
    el.d_res.textContent = "Residuo: -";
    el.d_when.textContent = "Quando paga: -";
    el.d_note.textContent = "-";
    el.d_lastRows.innerHTML = `<tr><td colspan="4" class="muted">-</td></tr>`;
    if (state.chart){ state.chart.destroy(); state.chart = null; }
  }

  async function analyzeSinottici({onlyLatest=false}={}){
    clearData();

    if (!state.sinottici.length){
      setProgress(0, "manifest.json non contiene sinottici.");
      return;
    }

    // choose list
    let files = state.sinottici.slice();
    files = files.filter(f => (f || "").toLowerCase().endsWith(".xlsx"));
    files.sort((a,b)=>{
      const da = parseDateFromFilename(a)?.getTime() ?? 0;
      const db = parseDateFromFilename(b)?.getTime() ?? 0;
      return da - db;
    });

    if (onlyLatest){
      files = [files[files.length-1]];
    }

    el.subTitle.textContent = onlyLatest ? "Analisi ultimo sinottico‚Ä¶" : "Analisi completa in corso‚Ä¶";
    setProgress(2, "Scarico e analizzo i sinottici‚Ä¶");

    const total = files.length;
    let done = 0;

    for (const fn of files){
      done++;
      const ts = parseDateFromFilename(fn)?.getTime() ?? Date.now();
      const path = "./Dati/" + fn;

      setProgress(Math.round((done-1)/total*100), `Carico ${fn} (${done}/${total})`);

      let buf;
      try{
        buf = await fetchArrayBuffer(path);
      }catch(err){
        // skip but log
        console.warn("Skip file", fn, err);
        continue;
      }

      let wb;
      try{
        wb = XLSX.read(buf, { type:"array" });
      }catch(err){
        console.warn("XLSX read failed", fn, err);
        continue;
      }

      let jsonRows;
      try{
        jsonRows = sheetToJsonWithHeaderSearch(wb);
      }catch(err){
        console.warn("sheet parse failed", fn, err);
        continue;
      }

      // Extract each machine
      for (const raw of jsonRows){
        const m = extractMachineRow(raw);
        if (!m) continue;

        const point = {
          ts,
          dateStr: dateStr(ts),
          in: m.in,
          out: m.out,
          net: m.net,
          PDV: m.PDV,
          PDA: m.PDA,
          ESERCENTE: m.ESERCENTE,
          COMUNE: m.COMUNE,
          PROVINCIA: m.PROVINCIA,
          MODELLO: m.MODELLO,
          ...m._raw // keep everything for later queries
        };

        const codeid = m.codeid;
        if (!state.historyByMachine.has(codeid)){
          state.historyByMachine.set(codeid, []);
        }
        state.historyByMachine.get(codeid).push(point);
      }

      // avoid freezing UI
      if (done % 2 === 0) await sleep(10);
    }

    // Build summary from latest point per machine
    setProgress(96, "Creo la lista macchine e calcolo le stime‚Ä¶");

    const summary = [];
    for (const [codeid, hist] of state.historyByMachine.entries()){
      const arr = hist.slice().sort((a,b)=>a.ts-b.ts);
      const last = arr[arr.length-1];
      const pred = computePredictionForMachine(codeid);

      summary.push({
        codeid,
        pdv: last.PDV ?? last["PDV"] ?? null,
        pda: last.PDA ?? last["PDA"] ?? null,
        esercente: last.ESERCENTE ?? last["ESERCENTE"] ?? null,
        comune: last.COMUNE ?? last["COMUNE"] ?? null,
        provincia: last.PROVINCIA ?? last["PROVINCIA"] ?? null,
        modello: last.MODELLO ?? last["MODELLO"] ?? null,
        lastNet: last.net ?? 0,
        pred
      });
    }

    // Sort by "closest to payment" first
    summary.sort((a,b)=> (b.pred?.score ?? 0) - (a.pred?.score ?? 0));

    state.summary = summary;

    el.chipMachines.textContent = summary.length.toString();
    el.subTitle.textContent = `Caricati ${summary.length} CODEID da ${total} sinottici`;

    setProgress(100, `Fatto. Trovate ${summary.length} macchine.`);
    renderSummaryTable();

    // auto open first if any
    if (summary.length){
      openMachine(summary[0].codeid);
    } else {
      // if no machines -> likely parsing mismatch
      chatSay("N.E.U.R.A.", "Non vedo macchine estratte. Di solito significa: header non trovato oppure colonne diverse.\n\nDimmi se nei tuoi sinottici le colonne si chiamano ancora CODEID/CNTTOTIN/CNTTOTOUT. Se vuoi, incollami qui la prima riga (header) del file e lo adatto al 100%.");
    }
  }

  // --- Chat IA (NEURA) ---
  function chatAppend(who, text){
    const wrap = document.createElement("div");
    wrap.className = "msg";

    const av = document.createElement("div");
    av.className = "avatar";
    av.textContent = who === "TU" ? "TU" : "N";

    const bub = document.createElement("div");
    bub.className = "bubble";
    bub.innerHTML = `<b>${who}</b><p>${escapeHtml(text)}</p>`;

    wrap.appendChild(av);
    wrap.appendChild(bub);

    el.chatLog.appendChild(wrap);
    el.chatLog.scrollTop = el.chatLog.scrollHeight;
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function chatSay(who, text){ chatAppend(who, text); }

  function neuraHelp(){
    return [
      "Puoi chiedermi cose tipo:",
      "‚Ä¢ quali macchine sono in pagamento",
      "‚Ä¢ quali sono le pi√π vicine",
      "‚Ä¢ quando paga 12345",
      "‚Ä¢ apri 12345",
      "‚Ä¢ cerca pdv 4012",
      "‚Ä¢ cerca esercente fortini",
      "‚Ä¢ top 10 vicine",
    ].join("\n");
  }

  function parseCodeIdFromText(t){
    const m = t.match(/\b(\d{4,10})\b/);
    return m ? m[1] : null;
  }

  function listByScore(minScore, maxItems=20){
    const rows = state.summary.filter(r => (r.pred?.score ?? 0) >= minScore);
    const top = rows.slice(0, maxItems);
    if (!top.length) return "Nessuna trovata con questi criteri.";
    return top.map((r,i)=>{
      const s = r.pred?.score ?? 0;
      const pdv = r.pdv ? `PDV ${r.pdv}` : "-";
      return `${i+1}) ${r.codeid} ¬∑ ${pdv} ¬∑ ${r.pred.label} (score ${s.toFixed(2)})`;
    }).join("\n");
  }

  function searchSummary(query){
    const q = query.toUpperCase();
    const rows = state.summary.filter(r=>{
      const hay = [
        r.codeid, r.pdv, r.pda, r.esercente, r.comune, r.provincia, r.modello
      ].map(x => (x ?? "").toString().toUpperCase()).join(" | ");
      return hay.includes(q);
    });
    return rows.slice(0, 25);
  }

  function neuraRespond(text){
    const t = (text ?? "").trim();
    if (!t) return;

    // Guard rails: if no data loaded
    if (!state.summary.length){
      chatSay("N.E.U.R.A.", "Prima devo analizzare i sinottici. Premi ‚ÄúAnalizza tutti‚Äù.");
      return;
    }

    const low = t.toLowerCase();

    // commands
    if (low.includes("esempi") || low.includes("aiuto") || low === "?"){
      chatSay("N.E.U.R.A.", neuraHelp());
      return;
    }

    if (low.includes("in pagamento") || low.includes("pagamento")){
      // "quali macchine sono in pagamento"
      chatSay("N.E.U.R.A.", "Ecco le pi√π probabili ‚Äòin pagamento / molto vicine‚Äô:\n\n" + listByScore(0.84, 20));
      return;
    }

    if (low.includes("pi√π vicine") || low.includes("vicine") || low.includes("top")){
      // top N
      const nMatch = low.match(/\btop\s+(\d{1,2})\b/);
      const n = nMatch ? Math.min(30, parseInt(nMatch[1],10)) : 15;
      chatSay("N.E.U.R.A.", `Top ${n} pi√π vicine:\n\n` + listByScore(0.70, n));
      return;
    }

    if (low.includes("cerca")){
      const q = t.replace(/cerca/i,"").trim();
      if (!q){
        chatSay("N.E.U.R.A.", "Dimmi cosa cercare (CODEID, PDV, esercente, comune‚Ä¶).");
        return;
      }
      const found = searchSummary(q);
      if (!found.length){
        chatSay("N.E.U.R.A.", `Nessun risultato per ‚Äú${q}‚Äù.`);
        return;
      }
      chatSay("N.E.U.R.A.", `Trovate ${found.length} (mostro max 25):\n\n` + found.map((r,i)=>`${i+1}) ${r.codeid} ¬∑ ${r.pdv?("PDV "+r.pdv):"-"} ¬∑ ${r.esercente??"-"}`).join("\n"));
      return;
    }

    if (low.includes("apri")){
      const code = parseCodeIdFromText(t);
      if (!code){
        chatSay("N.E.U.R.A.", "Scrivi: apri 12345 (con un CODEID).");
        return;
      }
      if (!state.historyByMachine.has(code)){
        chatSay("N.E.U.R.A.", `Non trovo il CODEID ${code}.`);
        return;
      }
      openMachine(code);
      chatSay("N.E.U.R.A.", `Aperta macchina ${code}.`);
      return;
    }

    if (low.includes("quando paga") || low.includes("quando") && low.includes("paga")){
      const code = parseCodeIdFromText(t) || state.selectedCodeId;
      if (!code){
        chatSay("N.E.U.R.A.", "Dimmi il CODEID. Esempio: quando paga 12345");
        return;
      }
      if (!state.historyByMachine.has(code)){
        chatSay("N.E.U.R.A.", `Non trovo il CODEID ${code}.`);
        return;
      }
      const pred = computePredictionForMachine(code);
      const resid = pred.resid != null ? fmtEuroFromCents(pred.resid) : "N/D";
      let whenTxt = "N/D";
      if (pred.etaDays != null && isFinite(pred.etaDays)){
        whenTxt = pred.etaDays < 0.6 ? "molto presto" : `${Math.round(pred.etaDays)} giorni (stima)`;
      }
      chatSay("N.E.U.R.A.", `Macchina ${code}\n‚Ä¢ Stato: ${pred.label}\n‚Ä¢ Residuo stimato: ${resid}\n‚Ä¢ Quando paga: ${whenTxt}\n\nNota: ${pred.note || "‚Äî"}`);
      openMachine(code);
      return;
    }

    // If user just writes a number -> open machine
    const codeGuess = parseCodeIdFromText(t);
    if (codeGuess && state.historyByMachine.has(codeGuess)){
      openMachine(codeGuess);
      chatSay("N.E.U.R.A.", `Apro ${codeGuess}. Se vuoi: ‚Äúquando paga ${codeGuess}‚Äù.`);
      return;
    }

    // Otherwise: out-of-scope fallback
    chatSay("N.E.U.R.A.", "Io lavoro solo sui dati AWP del programma.\n\nProva cos√¨:\n‚Ä¢ ‚Äúquali macchine sono in pagamento‚Äù\n‚Ä¢ ‚Äúquando paga 12345‚Äù\n‚Ä¢ ‚Äúcerca pdv 4012‚Äù\n‚Ä¢ ‚Äúapri 12345‚Äù");
  }

  // --- Export ---
  function exportSelectedMachine(){
    const code = state.selectedCodeId;
    if (!code){
      alert("Seleziona una macchina prima.");
      return;
    }
    const hist = (state.historyByMachine.get(code) || []).slice().sort((a,b)=>a.ts-b.ts);
    const blob = new Blob([JSON.stringify({codeid:code, history:hist}, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `machine-${code}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // --- Events ---
  function bindEvents(){
    el.themeSelect.addEventListener("change", () => setTheme(el.themeSelect.value));
    el.loginTheme.addEventListener("change", () => setTheme(el.loginTheme.value));

    el.btnLogout.addEventListener("click", () => {
      localStorage.removeItem("awp_session");
      state.user = null; state.level = null; state.expires = null;
      setUserChip();
      showLogin(true);
      clearData();
      el.subTitle.textContent = "Disconnesso.";
    });

    el.btnLogin.addEventListener("click", () => {
      el.loginError.textContent = "";
      const user = el.loginUser.value.trim();
      const pin = el.loginPin.value.trim();
      const r = validateLogin(user, pin);
      if (!r.ok){
        el.loginError.textContent = r.msg;
        return;
      }
      state.user = r.user;
      state.level = r.level;
      state.expires = r.expires;

      localStorage.setItem("awp_session", JSON.stringify({user:state.user, level:state.level, expires:state.expires}));
      setUserChip();
      showLogin(false);
      el.subTitle.textContent = "Accesso OK. Premi ‚ÄúAnalizza tutti‚Äù.";
      chatSay("N.E.U.R.A.", `Ciao ${state.user}! üëã\nPremi ‚ÄúAnalizza tutti‚Äù e poi chiedimi: ‚Äúquali macchine sono in pagamento‚Äù.`);
    });

    el.btnLoad.addEventListener("click", () => analyzeSinottici({onlyLatest:false}));
    el.btnOnlyLatest.addEventListener("click", () => analyzeSinottici({onlyLatest:true}));

    el.filterText.addEventListener("input", () => renderSummaryTable());
    el.filterMode.addEventListener("change", () => renderSummaryTable());

    el.rangeSelect.addEventListener("change", () => {
      if (state.selectedCodeId) openMachine(state.selectedCodeId);
    });

    el.btnExportMachine.addEventListener("click", exportSelectedMachine);

    el.btnChatSend.addEventListener("click", () => {
      const t = el.chatInput.value.trim();
      if (!t) return;
      el.chatInput.value = "";
      chatAppend("TU", t);
      neuraRespond(t);
    });

    el.chatInput.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter"){
        el.btnChatSend.click();
      }
    });

    el.btnChatClear.addEventListener("click", () => {
      el.chatLog.innerHTML = "";
      chatSay("N.E.U.R.A.", "Pulito. Se vuoi esempi digita ‚Äúaiuto‚Äù.");
    });

    el.btnChatExamples.addEventListener("click", () => {
      chatSay("N.E.U.R.A.", neuraHelp());
    });
  }

  // --- Init ---
  async function init(){
    // theme
    const savedTheme = localStorage.getItem("awp_theme") || "dark";
    setTheme(savedTheme);

    // load config
    try{
      await loadConfig();
      el.subTitle.textContent = `Config OK. Sinottici trovati in manifest: ${state.sinottici.length}.`;
    }catch(err){
      console.error(err);
      el.subTitle.textContent = "Errore caricamento config (users/manifest/cicloslot).";
      setProgress(0, "Errore: controlla che users.json, manifest.json, cicloslot.json siano nella root.");
      chatSay("N.E.U.R.A.", "Errore: non riesco a leggere users.json / manifest.json / cicloslot.json.\nControlla che siano nella root del repo (stessa cartella di index.html).");
      return;
    }

    // session restore
    const sessRaw = localStorage.getItem("awp_session");
    if (sessRaw){
      try{
        const s = JSON.parse(sessRaw);
        const r = validateLogin(s.user, (state.users.find(u => u.user===s.user)?.pin ?? "")); // soft
        // Better: require manual login if we can't validate pin. We'll just accept username+level for session.
        state.user = s.user;
        state.level = s.level;
        state.expires = s.expires;
        setUserChip();
        showLogin(false);
        el.subTitle.textContent = "Sessione ripristinata. Premi ‚ÄúAnalizza tutti‚Äù.";
      }catch{
        showLogin(true);
      }
    } else {
      showLogin(true);
    }

    bindEvents();
  }

  return { init };
})();

window.addEventListener("load", App.init);
</script>
</body>
</html>
