<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calcolatore AWP | Analisi Pagamento</title>

  <!-- SheetJS (XLSX parser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <link rel="stylesheet" href="./assets/styles.css" />
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">AWP</div>
        <div>
          Calcolatore AWP | Analisi Pagamento
          <small>Storici sinottici • correlazioni modello • AWIS</small>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="pill" id="pillUpdate">
        <span class="dot" id="dotUpdate"></span>
        <span id="txtUpdate">Carico ultimo sinottico…</span>
      </div>

      <div class="pill" id="pillStatus">
        <span class="dot" id="dotStatus"></span>
        <span id="txtStatus">Non autenticato</span>
      </div>

      <button class="btn small" id="btnLogout" style="display:none">Esci</button>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <div class="view active" id="viewLogin">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Accesso</h2>
            <div class="sub" id="loginStatus">Caricamento…</div>
          </div>

          <div class="bd">
            <div class="split">
              <div class="field">
                <label>Utente</label>
                <input class="input" id="loginUser" placeholder="es. Admin" autocomplete="username" />
              </div>
              <div class="field">
                <label>PIN</label>
                <input class="input" id="loginPin" placeholder="es. 7410" inputmode="numeric" autocomplete="current-password" />
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="btnLogin">Entra</button>
              <button class="btn" id="btnSelfTest">Self-test</button>

              <span class="badge"><span class="dot" id="dotUsers"></span><span id="usersInfo">users.json: …</span></span>
              <span class="badge"><span class="dot" id="dotManifest"></span><span id="manifestInfo">manifest.json: …</span></span>
              <span class="badge"><span class="dot" id="dotXLSX"></span><span id="xlsxInfo">XLSX: …</span></span>
            </div>

            <div class="footer-note">
              File richiesti in <b>/Dati/</b> (D maiuscola): users.json, manifest.json, cicloslot.json e i sinottici .xlsx.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Info rapido</h2>
            <div class="sub">Cartella /Dati/</div>
          </div>
          <div class="bd">
            <div class="kpi">
              <div class="label">Percorso dati</div>
              <div class="value" style="font-family:var(--mono); font-size:14px">./Dati/</div>
              <div class="hint">Compatibile GitHub Pages (URL relativo)</div>
            </div>

            <div class="kpi" style="margin-top:12px">
              <div class="label">Modalità utente</div>
              <div class="value">Admin / Abbonato</div>
              <div class="hint">Abbonato scaduto: accesso limitato con richiesta rinnovo.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="view" id="viewMain">
      <div class="grid">

        <!-- LEFT -->
        <div class="card" id="cardDashboard">
          <div class="hd">
            <h2>Dashboard AWP</h2>
            <div class="sub" id="subMain">Pronto</div>
          </div>

          <div class="bd">
            <div class="row">
              <button class="btn primary" id="btnAnalyzeAll">Analizza tutti i sinottici</button>
              <button class="btn" id="btnClearCache">Reset sessione</button>

              <span class="badge"><span class="dot" id="dotData"></span><span id="dataInfo">Dati: non caricati</span></span>
              <span class="badge"><span class="dot" id="dotHist"></span><span id="histInfo">Storico: 0 letture</span></span>
            </div>

            <div style="height:12px"></div>

            <div class="split">
              <div class="field">
                <label>Cerca (locale, modello, codeid, pda, comune…)</label>
                <input class="input" id="qSearch" placeholder="es. Molini, 7767..., PDA..." />
              </div>
              <div class="field">
                <label>Filtro rapido</label>
                <select id="qFilter">
                  <option value="all">Tutte</option>
                  <option value="likely">Probabile pagamento (Top)</option>
                  <option value="active">Solo attive (E)</option>
                  <option value="stale">Non aggiorna (GG mancato colleg.)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <span class="badge"><b id="countMachines">0</b>&nbsp;macchine</span>
              <span class="badge"><b id="countLocals">0</b>&nbsp;locali</span>
              <span class="badge"><b id="countModels">0</b>&nbsp;modelli</span>
              <span class="badge"><b id="countFiles">0</b>&nbsp;sinottici</span>
            </div>

            <div style="height:12px"></div>

            <div style="max-height:520px; overflow:auto; border-radius:14px; border:1px solid var(--line)">
              <table class="table" id="tblMachines">
                <thead>
                  <tr>
                    <th style="min-width:220px">Locale</th>
                    <th>Modello</th>
                    <th class="mono">CODEID</th>
                    <th>PDA</th>
                    <th>Stato</th>
                    <th style="min-width:140px">Prob. pagamento</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="footer-note">
              “Prob. pagamento” = euristica basata su ciclo + trend storico + %OUT.
              È una stima, non una garanzia.
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card" id="cardRight">
          <div class="hd">
            <h2 id="rightTitle">AWIS | Assistente</h2>
            <div class="sub" id="rightSub">domande sui dati</div>
          </div>
          <div class="bd">
            <div class="chat" id="awisBlock">
              <div class="chatlog" id="chatlog"></div>
              <div class="chatbar">
                <input class="input" id="chatInput" placeholder="Es: quali macchine sono in pagamento? / quando paga CODEID 776...?" />
                <button class="btn primary" id="chatSend">Invia</button>
              </div>
              <div class="footer-note">AWIS usa SOLO i dati caricati.</div>
            </div>

            <!-- PROFILE / RENEW (for expired abbonato) -->
            <div id="renewBlock" style="display:none">
              <div class="kpis">
                <div class="kpi">
                  <div class="label">Profilo</div>
                  <div class="value" id="profileUser">—</div>
                  <div class="hint" id="profileInfo">—</div>
                </div>
                <div class="kpi">
                  <div class="label">Stato abbonamento</div>
                  <div class="value" style="color:var(--bad)">Scaduto</div>
                  <div class="hint">Accesso limitato.</div>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="card" style="box-shadow:none">
                <div class="hd" style="border:none; padding:0 0 10px 0">
                  <h2 style="font-size:14px; margin:0">Richiesta rinnovo</h2>
                </div>
                <div class="bd" style="padding:0">
                  <div class="footer-note" style="margin:0 0 10px 0">
                    Premi il pulsante per inviare una mail di richiesta rinnovo.
                  </div>
                  <button class="btn primary" id="btnRenewEmail">Invia richiesta via email</button>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>

      <!-- DETAILS + CHART -->
      <div style="height:16px"></div>

      <div class="grid">

        <div class="card" id="cardDetails">
          <div class="hd">
            <h2 id="detailsTitle">Dettagli</h2>
            <div class="sub" id="detailsSub">Seleziona una macchina o un locale</div>
          </div>
          <div class="bd" id="detailsBody">
            <div class="kpis">
              <div class="kpi"><div class="label">Suggerimento</div><div class="value" style="font-size:14px">Seleziona una riga</div><div class="hint">Aprirai scheda macchina / locale.</div></div>
              <div class="kpi"><div class="label">Storico</div><div class="value" style="font-size:14px">Deduplicato</div><div class="hint">Stessa data lettura = 1 punto.</div></div>
              <div class="kpi"><div class="label">Cache</div><div class="value" style="font-size:14px">Sessione</div><div class="hint">Salvo login in localStorage.</div></div>
              <div class="kpi"><div class="label">Parsing date</div><div class="value" style="font-size:14px">DD/MM/YYYY HH:mm</div><div class="hint">Compatibile 2026+</div></div>
            </div>
          </div>
        </div>

        <div class="card" id="cardChart">
          <div class="hd">
            <h2>Grafico</h2>
            <div class="sub" id="chartSub">Seleziona una macchina</div>
          </div>
          <div class="bd">
            <div class="row" style="margin-bottom:10px">
              <span class="badge">Vista:</span>
              <button class="btn small" id="btnChartIN">IN (Δ)</button>
              <button class="btn small" id="btnChartOUT">OUT (Δ)</button>
              <button class="btn small" id="btnChartPct">%</button>
              <span class="badge">Punti: <b id="chartPoints">0</b></span>
              <span class="badge">Limite: <b id="chartLimitLabel">120</b></span>
              <select id="chartLimit" class="input" style="min-width:120px">
                <option value="60">60</option>
                <option value="120" selected>120</option>
                <option value="250">250</option>
                <option value="999999">Tutto</option>
              </select>
            </div>
            <canvas id="chart" height="160"></canvas>
            <div class="footer-note">Grafico sui delta tra letture consecutive.</div>
          </div>
        </div>

      </div>

      <!-- ADMIN -->
      <div style="height:16px"></div>

      <div class="card" id="adminPanel" style="display:none">
        <div class="hd">
          <h2>Admin • Diagnostica e Utenti</h2>
          <div class="sub">visibile solo a Admin</div>
        </div>
        <div class="bd" id="adminBody">
          <!-- injected by JS -->
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">
    <b id="toastTitle">Info</b>
    <small id="toastMsg">…</small>
  </div>

  <script src="./assets/app.js"></script>
</body>
</html>
