<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Calcolatore AWP analisi pagamento</title>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020; --panel:#111a33; --panel2:#0e1630;
      --text:#eaf0ff; --muted:#a9b6df; --line:rgba(255,255,255,.12);
      --accent:#7aa7ff; --good:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --chip:#1b2a57;
      --shadow: 0 16px 50px rgba(0,0,0,.35);
      --radius:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    [data-theme="light"]{
      --bg:#f6f8ff; --panel:#ffffff; --panel2:#f1f4ff;
      --text:#121a33; --muted:#4c5a82; --line:rgba(10,20,60,.12);
      --accent:#2b5bff; --chip:#e9eeff;
      --shadow: 0 16px 50px rgba(20,40,120,.10);
    }
    [data-theme="amber"]{
      --bg:#0d0a05; --panel:#17110a; --panel2:#140f08;
      --text:#fff3da; --muted:#d7c3a1; --line:rgba(255,214,153,.16);
      --accent:#ffb000; --chip:#24190d;
    }
    [data-theme="lime"]{
      --bg:#071008; --panel:#0d1c10; --panel2:#0a160c;
      --text:#eaffea; --muted:#b6d8b9; --line:rgba(200,255,210,.14);
      --accent:#77ff77; --chip:#102616;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:radial-gradient(1200px 600px at 10% -10%, rgba(122,167,255,.22), transparent 55%),
      radial-gradient(900px 500px at 95% 0%, rgba(251,191,36,.12), transparent 55%),
      var(--bg); color:var(--text);}
    a{color:inherit}
    .wrap{max-width:1250px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);
      position:sticky;top:12px;z-index:10;backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:conic-gradient(from 210deg, var(--accent), rgba(255,255,255,.10), var(--accent));
      box-shadow:0 10px 25px rgba(0,0,0,.25);
      display:grid;place-items:center;
      border:1px solid var(--line);
    }
    .logo b{font-size:14px;letter-spacing:.6px}
    .brand h1{font-size:14px;margin:0;line-height:1.15}
    .brand .sub{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn, button{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.03));
      color:var(--text);
      border-radius:12px;padding:10px 12px;
      cursor:pointer;
      transition:transform .06s ease, border-color .2s ease, background .2s ease;
      font-weight:650;
    }
    .btn:hover, button:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.22)}
    .btn:active, button:active{transform:translateY(0px)}
    select,input{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:12px;padding:10px 12px;
      outline:none;
    }
    input::placeholder{color:rgba(170,190,230,.65)}
    .grid{display:grid;grid-template-columns: 420px 1fr; gap:14px; margin-top:14px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .card .hd h2{font-size:13px;margin:0}
    .card .bd{padding:12px 14px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stack{display:flex;flex-direction:column;gap:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:6px 10px;border-radius:999px;
      background:var(--chip);border:1px solid var(--line);
      font-size:12px;color:var(--muted)
    }
    .pill{
      padding:7px 10px;border-radius:999px;font-size:12px;
      border:1px solid var(--line);background:rgba(255,255,255,.04)
    }
    .pill.good{color:var(--good);border-color:rgba(74,222,128,.35)}
    .pill.warn{color:var(--warn);border-color:rgba(251,191,36,.35)}
    .pill.bad{color:var(--bad);border-color:rgba(251,113,133,.35)}
    .table{
      width:100%;border-collapse:separate;border-spacing:0;
      overflow:hidden;border:1px solid var(--line);border-radius:14px;
    }
    .table th,.table td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:12px;vertical-align:top}
    .table th{background:rgba(255,255,255,.04);text-align:left;color:var(--muted);font-weight:750}
    .table tr:hover td{background:rgba(255,255,255,.03)}
    .table tr:last-child td{border-bottom:none}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:900px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.03)
    }
    .kpi .box .t{font-size:11px;color:var(--muted)}
    .kpi .box .v{font-size:15px;font-weight:850;margin-top:4px}
    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;line-height:1.35;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      padding:10px;border-radius:14px;
      max-height:180px;overflow:auto;white-space:pre-wrap;
    }
    .divider{height:1px;background:var(--line);margin:10px 0}
    .login{
      min-height:100vh;display:grid;place-items:center;padding:20px
    }
    .login .panel{
      width:min(520px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .login .panel .top{
      padding:18px 18px 12px 18px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;gap:12px
    }
    .login .panel .top h1{font-size:16px;margin:0}
    .login .panel .top .muted{font-size:12px}
    .login .panel .body{padding:18px}
    .login .hint{font-size:12px;color:var(--muted);margin-top:10px}
    .chatbox{
      display:flex;flex-direction:column;gap:10px;
    }
    .chatlog{
      height:220px;overflow:auto;border:1px solid var(--line);
      border-radius:14px;padding:10px;background:rgba(255,255,255,.03)
    }
    .msg{display:flex;gap:8px;margin:6px 0}
    .msg .who{min-width:54px;font-weight:850;font-size:12px;color:var(--muted)}
    .msg .txt{font-size:12px;white-space:pre-wrap}
  </style>
</head>

<body>
<div id="app"></div>

<script>
/* =========================================================
   SinotticoLab - tutto in RAM, solo cache impostazioni
   ========================================================= */

const SETTINGS_KEY = "sinotticolab_settings_v3";
const state = {
  settings: {
    theme: "dark",
    folderOverride: "",     // se vuoi forzare: "Dati" oppure "dati"
    maxFilesToLoad: 9999,
    downsamplePoints: 180,  // grafico leggibile
  },
  user: null,
  users: [],
  manifest: null,
  folder: null,        // "Dati" / "dati" / "DATI"
  sinottici: [],       // [{name,url,dt,rowsRaw,rowsNorm}]
  machines: new Map(), // key = CODEID -> machine object with timeline
  cicloByModel: new Map(), // codiceModello -> ciclo
  selectedCodeid: null,
  lastLoadedAt: null,
};

function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
    state.settings = {...state.settings, ...s};
  }catch(e){}
  document.documentElement.setAttribute("data-theme", state.settings.theme || "dark");
}
function saveSettings(){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings));
}
function log(msg){
  const el = document.getElementById("log");
  const ts = new Date().toLocaleTimeString();
  const line = `[${ts}] ${msg}\n`;
  if(el){ el.textContent += line; el.scrollTop = el.scrollHeight; }
  console.log(msg);
}
function money(n){
  if(n==null || Number.isNaN(n)) return "‚Äî";
  return new Intl.NumberFormat("it-IT",{maximumFractionDigits:0}).format(n);
}
function money2(n){
  if(n==null || Number.isNaN(n)) return "‚Äî";
  return new Intl.NumberFormat("it-IT",{minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
}
function pct(n){
  if(n==null || Number.isNaN(n)) return "‚Äî";
  return (n*100).toFixed(2) + "%";
}
function safeUpper(s){ return (s ?? "").toString().trim().toUpperCase(); }
function normHeader(s){
  return safeUpper(s)
    .replaceAll("√Ä","A").replaceAll("√à","E").replaceAll("√å","I").replaceAll("√í","O").replaceAll("√ô","U")
    .replace(/[.\-_/()]/g," ")
    .replace(/\s+/g," ")
    .trim();
}
function parseDateLoose(v){
  if(v==null || v==="") return null;
  if(v instanceof Date) return v;
  if(typeof v === "number"){
    // Excel serial date
    // SheetJS often parses date fields as numbers; use SSF?
    // We'll attempt: Excel epoch 1899-12-30
    const d = new Date(Math.round((v - 25569) * 86400 * 1000));
    if(!isNaN(d)) return d;
  }
  const s = v.toString().trim();
  // dd/mm/yyyy hh:mm
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){
    const dd=+m[1], mm=+m[2]-1, yyyy=+(m[3].length===2?("20"+m[3]):m[3]);
    const hh=+(m[4]||0), mi=+(m[5]||0), ss=+(m[6]||0);
    const d=new Date(yyyy,mm,dd,hh,mi,ss);
    return isNaN(d)?null:d;
  }
  const d = new Date(s);
  return isNaN(d)?null:d;
}
function toEuroFromCentsish(v){
  if(v==null || v==="") return null;
  const n = typeof v==="number" ? v : parseFloat(v.toString().replace(/\./g,"").replace(",","."));
  if(Number.isNaN(n)) return null;
  // Nel sinottico gli ultimi 2 zeri sono centesimi: dividiamo per 100
  return n / 100.0;
}
function toNum(v){
  if(v==null || v==="") return null;
  const n = typeof v==="number" ? v : parseFloat(v.toString().replace(/\./g,"").replace(",","."));
  return Number.isNaN(n) ? null : n;
}

/* =========================================================
   Loader file JSON (GitHub Pages)
   ========================================================= */
async function fetchJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} su ${url}`);
  return await r.json();
}
async function fetchArrayBuffer(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} su ${url}`);
  return await r.arrayBuffer();
}

/* =========================================================
   Login / Users
   ========================================================= */
async function loadUsers(){
  // prova users.json nella root
  const users = await fetchJSON("users.json");
  state.users = Array.isArray(users) ? users : (users.users || []);
  log(`Users caricati: ${state.users.length}`);
}
function validateLogin(user, pin){
  const u = state.users.find(x => (x.user||"").toString()===user);
  if(!u) return {ok:false, msg:"Utente non trovato"};
  if((u.pin||"").toString() !== pin) return {ok:false, msg:"PIN errato"};
  if(u.expires){
    const exp = parseDateLoose(u.expires);
    if(exp && exp < new Date()) return {ok:false, msg:`Account scaduto (${u.expires})`};
  }
  return {ok:true, user:{user:u.user, level:u.level||"Base", expires:u.expires||null}};
}

/* =========================================================
   Manifest + Folder detection
   ========================================================= */
function parseManifestList(man){
  // supporta pi√π formati: array, {files:[]}, {sinottici:[]}
  if(Array.isArray(man)) return man;
  if(man?.files && Array.isArray(man.files)) return man.files;
  if(man?.sinottici && Array.isArray(man.sinottici)) return man.sinottici;
  if(man?.list && Array.isArray(man.list)) return man.list;
  // se √® oggetto { "Sinottico-...xlsx": "..."} -> keys
  if(man && typeof man==="object") return Object.keys(man);
  return [];
}
async function detectFolder(list){
  // se user forza folder, usalo
  const forced = (state.settings.folderOverride||"").trim();
  if(forced){
    log(`Folder override: ${forced}`);
    return forced;
  }

  const candidates = ["dati","Dati","DATI"];
  const probe = list?.[0];
  if(!probe) return "Dati";

  for(const c of candidates){
    const url = `${c}/${probe}`;
    try{
      const r = await fetch(url, {method:"HEAD", cache:"no-store"});
      if(r.ok){
        log(`Folder valido trovato: ${c} (probe: ${url})`);
        return c;
      } else {
        log(`NO ${url}: HTTP ${r.status}`);
      }
    }catch(e){
      log(`NO ${url}: ${e.message}`);
    }
  }
  // fallback: prova a vedere se esiste la cartella (non sempre possibile)
  log(`Self-test errore: Nessun folder valido (Dati/dati). User√≤ "Dati" come fallback.`);
  return "Dati";
}

/* =========================================================
   Ciclo Slot
   ========================================================= */
async function loadCicloSlot(){
  const data = await fetchJSON("cicloslot.json");
  const arr = Array.isArray(data) ? data : (data?.items || []);
  state.cicloByModel.clear();
  for(const x of arr){
    const code = (x.codiceModello ?? x.CODICE_MODELLO ?? "").toString().trim();
    const ciclo = toNum(x.ciclo ?? x.CICLO);
    if(code && ciclo) state.cicloByModel.set(code, ciclo);
  }
  log(`cicloslot: modelli con ciclo = ${state.cicloByModel.size}`);
}

/* =========================================================
   XLSX parsing + mapping colonne
   ========================================================= */
function buildColumnMap(headers){
  // headers: array string originali
  const normToIdx = new Map();
  headers.forEach((h,i)=> normToIdx.set(normHeader(h), i));

  const want = {
    CODEID: ["CODEID"],
    CODEID_PROVV: ["CODEID PROVV","CODEID PROVVISORIO","CODEID PROVV."],
    DESCR_STATO: ["DESCR STATO","DESCR. STATO","STATO"],
    DATA_ATTIVAZIONE: ["DATA ATTIVAZIONE"],
    DATA_ULTIMO_COLLEGAMENTO: ["DATA ULTIMO COLLEGAMENTO"],
    GG_MANCATO_COLLEGAMENTO: ["GG MANCATO COLLEGAMENTO"],
    GG_DECADENZA: ["GG DECADENZA"],
    DATA_ULTIMA_LETTURA_VAL: ["DATA ULTIMA LETTURA VAL","DATA ULTIMA LETTURA VAL.","DATA ULTIMA LETTURA"],
    CNTTOTIN: ["CNTTOTIN","CNT TOT IN","CNTTOT IN"],
    CNTTOTOUT: ["CNTTOTOT","CNTTOTOUT","CNT TOT OUT","CNTTOT OT","CNTTOTOUT EURO"],
    MS_FERIE: ["M S FERIE","M.S. FERIE","M S / FERIE","M.S. / FERIE"],
    MAC_PDA: ["MACADDRESS PDA","MAC ADDRESS PDA","MAC PDA"],
    CODICE_SEDE: ["CODICE SEDE"],
    CODICE_PDV_AAMS: ["CODICE PDV AAMS","CODICE PDV"],
    DENOMIN_SEDE: ["DENOMIN SEDE","DENOMIN. SEDE","DENOMINAZIONE SEDE"],
    INDIRIZZO: ["INDIRIZZO"],
    PROVINCIA: ["PROVINCIA"],
    COMUNE: ["COMUNE"],
    CODICE_IS_ESERCENTE: ["CODICE IS ESERCENTE","CODICE ESERCENTE"],
    PRATICA_AMMINISTRATIVA: ["PRATICA AMMINISTRATIVA"],
    STATO_PRATICA: ["STATO PRATICA"],
    DATA_RILASCIO_NOE: ["DATA RILASCIO N O E","DATA RILASCIO N.O.E.","DATA RILASCIO NOE"],
    CODICE_MODELLO: ["CODICE MODELLO"],
    MODELLO: ["MODELLO"],
    OUT_PCT: ["% OUT","OUT %","PERCENTUALE OUT","PCT OUT"],
    EM: ["E M","E/M","E M ","ESERCIZIO MAGAZZINO"],
    NOE: ["NOE"],
    INCASSO_GIORNALIERO: ["INCASSO GIORNALIERO"],
    MEDIA_INCASSO: ["MEDIA INCASSO GG ESERCIZIO","MEDIA INCASSO","MEDIA INCASSO GG"],
    WARNING: ["WARNING"],
    IR_AWP: ["IR AWP","IRAWP"],
  };

  const out = {};
  for(const key of Object.keys(want)){
    out[key] = null;
    for(const candidate of want[key]){
      const idx = normToIdx.get(normHeader(candidate));
      if(idx!=null){ out[key]=idx; break; }
    }
  }
  return out;
}

function parseXlsxRows(arrayBuffer){
  if(typeof XLSX === "undefined") throw new Error("Libreria XLSX non caricata (SheetJS).");
  const wb = XLSX.read(arrayBuffer, {type:"array"});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  // header:1 returns array of arrays
  const aoa = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});
  if(!aoa || aoa.length<2) return {headers:[], rows:[]};
  const headers = aoa[0].map(x=> (x??"").toString().trim());
  const rows = aoa.slice(1);
  return {headers, rows};
}

function normalizeRow(row, col){
  // row = array values
  const get = (k)=> {
    const idx = col[k];
    if(idx==null) return "";
    return row[idx];
  };

  const codeid = (get("CODEID") ?? "").toString().trim();
  if(!codeid) return null;

  const cntIn = toEuroFromCentsish(get("CNTTOTIN"));
  const cntOut = toEuroFromCentsish(get("CNTTOTOUT"));
  const outPct = (() => {
    const v = get("OUT_PCT");
    if(v==null || v==="") return null;
    const s = v.toString().replace("%","").trim();
    const n = parseFloat(s.replace(",","."));
    if(Number.isNaN(n)) return null;
    return n/100.0;
  })();

  const codiceModello = (get("CODICE_MODELLO") ?? "").toString().trim();
  const ciclo = state.cicloByModel.get(codiceModello) ?? null;

  const dUlt = parseDateLoose(get("DATA_ULTIMA_LETTURA_VAL"));
  const dColl = parseDateLoose(get("DATA_ULTIMO_COLLEGAMENTO"));
  const dAtt = parseDateLoose(get("DATA_ATTIVAZIONE"));

  const denom = (get("DENOMIN_SEDE") ?? "").toString().trim();
  const comune = (get("COMUNE") ?? "").toString().trim();
  const prov = (get("PROVINCIA") ?? "").toString().trim();

  const ratioOut = (cntIn!=null && cntIn>0 && cntOut!=null) ? (cntOut/cntIn) : null;

  const faseCiclo = (ciclo && cntIn!=null) ? ((cntIn % ciclo)/ciclo) : null;

  const target = outPct ?? 0.65; // default
  const expectedOut = (cntIn!=null) ? cntIn*target : null;
  const diffOut = (expectedOut!=null && cntOut!=null) ? (expectedOut - cntOut) : null; // positivo = sotto target

  return {
    CODEID: codeid,
    CODEID_PROVV: (get("CODEID_PROVV") ?? "").toString().trim(),
    DESCR_STATO: (get("DESCR_STATO") ?? "").toString().trim(),
    DATA_ATTIVAZIONE: dAtt,
    DATA_ULTIMO_COLLEGAMENTO: dColl,
    GG_MANCATO_COLLEGAMENTO: toNum(get("GG_MANCATO_COLLEGAMENTO")),
    GG_DECADENZA: toNum(get("GG_DECADENZA")),
    DATA_ULTIMA_LETTURA_VAL: dUlt,
    CNTTOTIN: cntIn,
    CNTTOTOUT: cntOut,
    MS_FERIE: (get("MS_FERIE") ?? "").toString().trim(),
    MAC_PDA: (get("MAC_PDA") ?? "").toString().trim(),
    CODICE_SEDE: (get("CODICE_SEDE") ?? "").toString().trim(),
    CODICE_PDV_AAMS: (get("CODICE_PDV_AAMS") ?? "").toString().trim(),
    DENOMIN_SEDE: denom,
    INDIRIZZO: (get("INDIRIZZO") ?? "").toString().trim(),
    PROVINCIA: prov,
    COMUNE: comune,
    CODICE_IS_ESERCENTE: (get("CODICE_IS_ESERCENTE") ?? "").toString().trim(),
    PRATICA_AMMINISTRATIVA: (get("PRATICA_AMMINISTRATIVA") ?? "").toString().trim(),
    STATO_PRATICA: (get("STATO_PRATICA") ?? "").toString().trim(),
    DATA_RILASCIO_NOE: parseDateLoose(get("DATA_RILASCIO_NOE")),
    CODICE_MODELLO: codiceModello,
    MODELLO: (get("MODELLO") ?? "").toString().trim(),
    OUT_PCT: outPct,
    E_M: (get("EM") ?? "").toString().trim(),
    NOE: (get("NOE") ?? "").toString().trim(),
    INCASSO_GIORNALIERO: toEuroFromCentsish(get("INCASSO_GIORNALIERO")),
    MEDIA_INCASSO: toEuroFromCentsish(get("MEDIA_INCASSO")),
    WARNING: (get("WARNING") ?? "").toString().trim(),
    IR_AWP: (get("IR_AWP") ?? "").toString().trim(),

    ratioOut,
    ciclo,
    faseCiclo,
    target,
    expectedOut,
    diffOut
  };
}

/* =========================================================
   Aggregazione storico + predizione
   ========================================================= */
function ensureMachine(codeid){
  if(!state.machines.has(codeid)){
    state.machines.set(codeid, {
      codeid,
      last: null,
      timeline: [], // [{t, in, out, ratio, diffOut, ...}]
      meta: {},
      score: 0,
      scoreLabel: "‚Äî",
      scoreClass: "warn"
    });
  }
  return state.machines.get(codeid);
}

function computeScore(machine){
  const tl = machine.timeline.slice().filter(p=>p.t && p.in!=null && p.out!=null)
    .sort((a,b)=>a.t-b.t);

  if(tl.length<2){
    machine.score = 0.25;
    machine.scoreLabel = "Pochi dati";
    machine.scoreClass = "warn";
    return;
  }

  const last = tl[tl.length-1];
  const prev = tl[tl.length-2];

  const dIn = (last.in - prev.in);
  const dOut = (last.out - prev.out);

  // segnali:
  // - fase ciclo alta (se c'√® ciclo)
  // - sotto target (diffOut positivo)
  // - poca uscita recente ma ingresso recente (accumulo)
  // - storico: media ratio vs target
  let s = 0.15;

  if(last.faseCiclo!=null){
    // spinge quando > 0.80
    s += clamp((last.faseCiclo - 0.75) * 1.3, -0.15, 0.35);
  }

  if(last.diffOut!=null && last.ciclo){
    // normalizza su 10% del ciclo
    const denom = Math.max(1, last.ciclo * 0.10);
    s += clamp((last.diffOut / denom) * 0.35, -0.25, 0.35);
  } else if(last.diffOut!=null){
    s += clamp((last.diffOut / 5000) * 0.15, -0.10, 0.18);
  }

  if(dIn!=null && dOut!=null){
    // se entra ma non esce (recentemente), aumenta
    const imbalance = (dIn - dOut);
    s += clamp((imbalance / 800) * 0.20, -0.20, 0.25);
    // se ha appena pagato tanto, abbassa
    if(dOut > dIn*0.95 && dOut > 200){
      s -= 0.22;
    }
  }

  // stabilizza con ratio globale
  const ratio = last.ratioOut;
  if(ratio!=null){
    const delta = (last.target - ratio); // positivo = sotto
    s += clamp(delta * 0.40, -0.15, 0.20);
  }

  // clamp 0..1
  s = clamp(s, 0.02, 0.98);

  machine.score = s;
  if(s >= 0.72){ machine.scoreLabel="Alta"; machine.scoreClass="good"; }
  else if(s >= 0.50){ machine.scoreLabel="Media"; machine.scoreClass="warn"; }
  else { machine.scoreLabel="Bassa"; machine.scoreClass="bad"; }
}

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

/* =========================================================
   Caricamento sinottici da manifest + analisi
   ========================================================= */
function parseSinotticoDateFromName(name){
  // tenta: Sinottico-YYYY-MM-DD-HHMM.xlsx oppure Sinottico-YYYY-MM-DD.xlsx
  const m = name.match(/(\d{4})-(\d{2})-(\d{2})(?:-(\d{2})(\d{2}))?/);
  if(!m) return null;
  const y=+m[1], mo=+m[2]-1, d=+m[3], hh=+(m[4]||0), mm=+(m[5]||0);
  const dt = new Date(y,mo,d,hh,mm,0);
  return isNaN(dt)?null:dt;
}

async function loadManifest(){
  state.manifest = await fetchJSON("manifest.json");
  const list = parseManifestList(state.manifest)
    .filter(x => (x||"").toString().toLowerCase().endsWith(".xlsx"))
    .map(x => x.toString());

  if(!list.length) throw new Error("manifest.json non contiene file .xlsx (lista vuota).");

  // ordina (pi√π vecchio -> pi√π nuovo) se possibile
  list.sort((a,b)=>{
    const da = parseSinotticoDateFromName(a)?.getTime() ?? 0;
    const db = parseSinotticoDateFromName(b)?.getTime() ?? 0;
    return da - db;
  });

  log(`Manifest: sinottici trovati = ${list.length}`);
  return list;
}

async function analyzeAll(){
  state.sinottici = [];
  state.machines.clear();

  const list = await loadManifest();
  const folder = await detectFolder(list);
  state.folder = folder;

  const maxN = Math.min(list.length, state.settings.maxFilesToLoad || 9999);

  for(let i=0;i<maxN;i++){
    const name = list[i];
    const url = `${folder}/${name}`;
    try{
      log(`Carico XLSX: ${url}`);
      const buf = await fetchArrayBuffer(url);
      const {headers, rows} = parseXlsxRows(buf);
      if(!headers.length){
        log(`WARN: ${name} -> nessuna header`);
        continue;
      }
      const col = buildColumnMap(headers);

      // sanity check: CODEID e CNTTOTIN/OUT devono esserci
      if(col.CODEID==null){
        log(`ERRORE mapping: in ${name} non trovo colonna CODEID. Header[0..6]=${headers.slice(0,7).join(" | ")}`);
      }
      if(col.CNTTOTIN==null || col.CNTTOTOUT==null){
        log(`ERRORE mapping: in ${name} non trovo CNTTOTIN o CNTTOTOUT.`);
      }

      const dtFile = parseSinotticoDateFromName(name);

      let parsedCount = 0;
      for(const r of rows){
        const nr = normalizeRow(r, col);
        if(!nr) continue;

        // usa data ultima lettura se presente, altrimenti data dal nome file
        const t = nr.DATA_ULTIMA_LETTURA_VAL || dtFile || null;
        const m = ensureMachine(nr.CODEID);

        // meta: prendiamo dall'ultima riga utile (sovrascrive con info aggiornate)
        m.meta = {
          denom: nr.DENOMIN_SEDE,
          comune: nr.COMUNE,
          provincia: nr.PROVINCIA,
          indirizzo: nr.INDIRIZZO,
          modello: nr.MODELLO,
          codiceModello: nr.CODICE_MODELLO,
          codicePDV: nr.CODICE_PDV_AAMS,
          codiceSede: nr.CODICE_SEDE,
          macPDA: nr.MAC_PDA,
          outPct: nr.OUT_PCT,
          stato: nr.DESCR_STATO,
          em: nr.E_M,
          noe: nr.NOE
        };

        m.timeline.push({
          t,
          in: nr.CNTTOTIN,
          out: nr.CNTTOTOUT,
          ratioOut: nr.ratioOut,
          target: nr.target,
          diffOut: nr.diffOut,
          ciclo: nr.ciclo,
          faseCiclo: nr.faseCiclo,
          incassoGiornaliero: nr.INCASSO_GIORNALIERO,
          mediaIncasso: nr.MEDIA_INCASSO
        });

        parsedCount++;
      }

      // aggiorna score per tutte
      for(const m of state.machines.values()) computeScore(m);

      state.sinottici.push({name, url, dt: dtFile, rowsParsed: parsedCount});
      log(`OK ${name}: righe AWP parse = ${parsedCount}`);

    }catch(e){
      log(`ERRORE su ${url}: ${e.message}`);
    }
  }

  state.lastLoadedAt = new Date();
  renderMain();
}

/* =========================================================
   UI: login + main
   ========================================================= */
function renderLogin(){
  const app = document.getElementById("app");
  app.innerHTML = `
    <div class="login">
      <div class="panel">
        <div class="top">
          <div class="logo"><b>AWP</b></div>
          <div>
            <h1>Calcolatore AWP analisi pagamento</h1>
            <div class="muted">Accesso richiesto</div>
          </div>
        </div>
        <div class="body stack">
          <div class="row">
            <input id="u" placeholder="User (esempio: user)" style="flex:1;min-width:180px" value="user"/>
            <input id="p" placeholder="PIN (esempio: 0000)" style="width:170px" value="0000"/>
          </div>
          <div class="row">
            <button id="btnLogin" style="flex:1">Entra</button>
          </div>
          <div id="loginMsg" class="hint"></div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between">
            <div class="muted">Tema</div>
            <select id="themeSel">
              <option value="dark">Scuro</option>
              <option value="light">Chiaro</option>
              <option value="amber">Amber</option>
              <option value="lime">Lime</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  `;

  const themeSel = document.getElementById("themeSel");
  themeSel.value = state.settings.theme || "dark";
  themeSel.onchange = () => {
    state.settings.theme = themeSel.value;
    saveSettings();
    document.documentElement.setAttribute("data-theme", state.settings.theme);
  };

  document.getElementById("btnLogin").onclick = async () => {
    const user = document.getElementById("u").value.trim();
    const pin = document.getElementById("p").value.trim();
    const res = validateLogin(user, pin);
    const msg = document.getElementById("loginMsg");
    if(!res.ok){
      msg.textContent = "‚ùå " + res.msg;
      return;
    }
    state.user = res.user;
    msg.textContent = "‚úÖ Accesso OK (" + state.user.level + ")";
    renderMain();
  };
}

function renderMain(){
  const app = document.getElementById("app");

  const userInfo = state.user ? `${state.user.user} ¬∑ ${state.user.level}${state.user.expires?` ¬∑ scade ${state.user.expires}`:""}` : "‚Äî";
  const folderInfo = state.folder ? `Cartella: ${state.folder}` : "Cartella: ‚Äî";
  const last = state.lastLoadedAt ? state.lastLoadedAt.toLocaleString() : "‚Äî";

  app.innerHTML = `
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo"><b>LAB</b></div>
          <div>
            <h1>SinotticoLab</h1>
            <div class="sub">${userInfo} ¬∑ ${folderInfo} ¬∑ Ultima analisi: ${last}</div>
          </div>
        </div>
        <div class="actions">
          <select id="themeSel">
            <option value="dark">Scuro</option>
            <option value="light">Chiaro</option>
            <option value="amber">Amber</option>
            <option value="lime">Lime</option>
          </select>
          <input id="folderOverride" placeholder="Folder override (es. Dati)" style="width:220px"/>
          <button id="btnAnalyze">Analizza tutti i sinottici</button>
          <button id="btnLogout">Esci</button>
        </div>
      </div>

      <div class="grid">
        <div class="stack">

          <div class="card">
            <div class="hd">
              <h2>Caricamento & Log</h2>
              <span class="chip">XLSX: ${typeof XLSX !== "undefined" ? "OK" : "NO"}</span>
            </div>
            <div class="bd stack">
              <div class="row">
                <input id="search" placeholder="Cerca: locale, comune, modello, CODEID, PDV..." style="flex:1"/>
              </div>
              <div class="row">
                <select id="filterScore">
                  <option value="all">Tutte</option>
                  <option value="high">Prob. pagamento alta</option>
                  <option value="mid">Prob. pagamento media</option>
                  <option value="low">Prob. pagamento bassa</option>
                </select>

                <select id="filterComune" style="flex:1;min-width:170px">
                  <option value="">Tutti i comuni</option>
                </select>
              </div>

              <div class="log" id="log"></div>

              <div class="row">
                <span class="chip">Macchine: <b id="countMachines">0</b></span>
                <span class="chip">Sinottici letti: <b id="countFiles">0</b></span>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <h2>Lista AWP</h2>
              <span class="muted" style="font-size:12px">Click per dettagli</span>
            </div>
            <div class="bd" style="padding:0">
              <div style="max-height:520px;overflow:auto">
                <table class="table" id="tblMachines">
                  <thead>
                    <tr>
                      <th>Prob.</th>
                      <th>Locale</th>
                      <th>Comune</th>
                      <th>Modello</th>
                      <th>IN</th>
                      <th>OUT%</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>

        <div class="stack">

          <div class="card">
            <div class="hd">
              <h2>Dettaglio macchina</h2>
              <span class="muted" id="selTitle">Nessuna selezionata</span>
            </div>
            <div class="bd stack">
              <div class="kpi">
                <div class="box"><div class="t">CODEID</div><div class="v" id="k_codeid">‚Äî</div></div>
                <div class="box"><div class="t">Locale</div><div class="v" id="k_locale">‚Äî</div></div>
                <div class="box"><div class="t">IN totale</div><div class="v" id="k_in">‚Äî</div></div>
                <div class="box"><div class="t">OUT totale</div><div class="v" id="k_out">‚Äî</div></div>
              </div>

              <div class="row">
                <span class="pill" id="pillScore">‚Äî</span>
                <span class="chip" id="k_model">Modello: ‚Äî</span>
                <span class="chip" id="k_ciclo">Ciclo: ‚Äî</span>
                <span class="chip" id="k_pdv">PDV: ‚Äî</span>
                <span class="chip" id="k_pda">PDA: ‚Äî</span>
              </div>

              <div class="row">
                <label class="muted" style="font-size:12px">Punti grafico</label>
                <input type="range" id="rangePts" min="60" max="600" value="${state.settings.downsamplePoints}" style="flex:1"/>
                <span class="chip"><span id="rangePtsVal">${state.settings.downsamplePoints}</span></span>
              </div>

              <canvas id="chart" height="120"></canvas>

              <div class="divider"></div>

              <div class="row" style="justify-content:space-between">
                <h2 style="font-size:13px;margin:0">Storico (ultime righe)</h2>
                <button id="btnExportCSV">Esporta CSV (solo macchina)</button>
              </div>

              <div style="max-height:260px;overflow:auto">
                <table class="table" id="tblHistory">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>IN</th>
                      <th>OUT</th>
                      <th>OUT%</th>
                      <th>Diff vs Target</th>
                      <th>Fase ciclo</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

            </div>
          </div>

          <div class="card">
            <div class="hd">
              <h2>Chat IA (S.A.G.A.)</h2>
              <span class="muted" style="font-size:12px">Guida e interrogazione dati</span>
            </div>
            <div class="bd chatbox">
              <div class="chatlog" id="chatlog"></div>
              <div class="row">
                <input id="chatin" placeholder="Es: quale macchina √® in pagamento? / quando paga questa macchina?" style="flex:1"/>
                <button id="chatsend">Invia</button>
              </div>
              <div class="muted" style="font-size:12px">
                S.A.G.A. risponde solo su dati del programma (sinottici, macchine, cicli). Se chiedi altro ti reindirizza. üß©
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  `;

  // set theme UI
  const themeSel = document.getElementById("themeSel");
  themeSel.value = state.settings.theme || "dark";
  themeSel.onchange = () => {
    state.settings.theme = themeSel.value;
    saveSettings();
    document.documentElement.setAttribute("data-theme", state.settings.theme);
  };

  // folder override
  const folderOverride = document.getElementById("folderOverride");
  folderOverride.value = state.settings.folderOverride || "";
  folderOverride.onchange = () => {
    state.settings.folderOverride = folderOverride.value.trim();
    saveSettings();
  };

  document.getElementById("btnLogout").onclick = () => {
    state.user = null;
    renderLogin();
  };

  document.getElementById("btnAnalyze").onclick = async () => {
    document.getElementById("log").textContent = "";
    log("Avvio analisi completa‚Ä¶");
    try{
      await loadCicloSlot();
      await analyzeAll();
      log("Analisi completata ‚úÖ");
    }catch(e){
      log("ERRORE: " + e.message);
    }finally{
      refreshList();
    }
  };

  // range pts
  const rangePts = document.getElementById("rangePts");
  rangePts.oninput = () => {
    document.getElementById("rangePtsVal").textContent = rangePts.value;
  };
  rangePts.onchange = () => {
    state.settings.downsamplePoints = parseInt(rangePts.value,10);
    saveSettings();
    if(state.selectedCodeid) showMachine(state.selectedCodeid);
  };

  // filters
  document.getElementById("search").oninput = refreshList;
  document.getElementById("filterScore").onchange = refreshList;
  document.getElementById("filterComune").onchange = refreshList;

  // chat
  setupChat();

  refreshList();
}

function refreshComuneOptions(){
  const sel = document.getElementById("filterComune");
  if(!sel) return;
  const comuni = new Set();
  for(const m of state.machines.values()){
    if(m.meta?.comune) comuni.add(m.meta.comune);
  }
  const sorted = [...comuni].sort((a,b)=>a.localeCompare(b));
  const cur = sel.value;
  sel.innerHTML = `<option value="">Tutti i comuni</option>` + sorted.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  sel.value = cur;
}

function refreshList(){
  const tbody = document.querySelector("#tblMachines tbody");
  if(!tbody) return;

  document.getElementById("countMachines").textContent = state.machines.size;
  document.getElementById("countFiles").textContent = state.sinottici.length;

  refreshComuneOptions();

  const q = (document.getElementById("search")?.value || "").trim().toLowerCase();
  const fScore = document.getElementById("filterScore")?.value || "all";
  const fComune = document.getElementById("filterComune")?.value || "";

  const items = [...state.machines.values()];

  // sort by score desc
  items.sort((a,b)=> (b.score||0) - (a.score||0));

  const filtered = items.filter(m=>{
    if(fComune && (m.meta?.comune||"") !== fComune) return false;
    if(fScore==="high" && (m.score||0) < 0.72) return false;
    if(fScore==="mid" && !((m.score||0) >= 0.50 && (m.score||0) < 0.72)) return false;
    if(fScore==="low" && (m.score||0) >= 0.50) return false;

    if(!q) return true;
    const hay = [
      m.codeid,
      m.meta?.denom,
      m.meta?.comune,
      m.meta?.provincia,
      m.meta?.modello,
      m.meta?.codicePDV,
      m.meta?.codiceSede,
      m.meta?.macPDA
    ].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  });

  tbody.innerHTML = filtered.slice(0, 5000).map(m=>{
    const last = latestPoint(m);
    const inTot = last?.in ?? null;
    const ratio = last?.ratioOut ?? null;
    const scoreClass = m.scoreClass || "warn";
    const scoreTxt = m.scoreLabel || "‚Äî";
    return `
      <tr data-codeid="${escapeAttr(m.codeid)}" style="cursor:pointer">
        <td><span class="pill ${scoreClass}">${scoreTxt}</span></td>
        <td>${escapeHtml(m.meta?.denom || "‚Äî")}</td>
        <td>${escapeHtml(m.meta?.comune || "‚Äî")}</td>
        <td>${escapeHtml(m.meta?.modello || "‚Äî")}</td>
        <td>${money(inTot)}</td>
        <td>${ratio!=null ? pct(ratio) : "‚Äî"}</td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("tr").forEach(tr=>{
    tr.onclick = ()=> {
      const codeid = tr.getAttribute("data-codeid");
      showMachine(codeid);
    };
  });

  // se nessuna selezionata, seleziona la prima
  if(!state.selectedCodeid && filtered.length){
    showMachine(filtered[0].codeid);
  }
}

function latestPoint(machine){
  const tl = (machine.timeline||[]).filter(p=>p.t && p.in!=null && p.out!=null);
  if(!tl.length) return null;
  tl.sort((a,b)=>a.t-b.t);
  return tl[tl.length-1];
}

let chartInstance = null;
function downsampleSeries(points, maxPts){
  if(points.length <= maxPts) return points;
  const step = Math.ceil(points.length / maxPts);
  const out = [];
  for(let i=0;i<points.length;i+=step) out.push(points[i]);
  return out;
}

function showMachine(codeid){
  state.selectedCodeid = codeid;
  const m = state.machines.get(codeid);
  if(!m) return;

  document.getElementById("selTitle").textContent = codeid;
  document.getElementById("k_codeid").textContent = codeid;
  document.getElementById("k_locale").textContent = m.meta?.denom || "‚Äî";

  const last = latestPoint(m);
  document.getElementById("k_in").textContent = money(last?.in);
  document.getElementById("k_out").textContent = money(last?.out);

  const pill = document.getElementById("pillScore");
  pill.className = `pill ${m.scoreClass||"warn"}`;
  pill.textContent = `Prob. pagamento: ${m.scoreLabel||"‚Äî"} (${Math.round((m.score||0)*100)}%)`;

  document.getElementById("k_model").textContent = `Modello: ${m.meta?.modello || "‚Äî"} (${m.meta?.codiceModello || "‚Äî"})`;
  document.getElementById("k_ciclo").textContent = `Ciclo: ${last?.ciclo ? money(last.ciclo) : "‚Äî"}`;
  document.getElementById("k_pdv").textContent = `PDV: ${m.meta?.codicePDV || "‚Äî"} ¬∑ Sede: ${m.meta?.codiceSede || "‚Äî"}`;
  document.getElementById("k_pda").textContent = `PDA: ${m.meta?.macPDA || "‚Äî"} ¬∑ NOE: ${m.meta?.noe || "‚Äî"}`;

  // build chart series
  let tl = (m.timeline||[]).filter(p=>p.t && p.in!=null && p.out!=null)
    .sort((a,b)=>a.t-b.t);

  const maxPts = state.settings.downsamplePoints || 180;
  tl = downsampleSeries(tl, maxPts);

  const labels = tl.map(p => p.t.toLocaleString());
  const serieIn = tl.map(p => p.in);
  const serieOut = tl.map(p => p.out);
  const serieRatio = tl.map(p => p.ratioOut!=null ? (p.ratioOut*100) : null);

  const ctx = document.getElementById("chart").getContext("2d");
  if(chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {label:"CNTTOTIN (‚Ç¨)", data: serieIn, yAxisID:"y", tension:.25, pointRadius:0, borderWidth:2},
        {label:"CNTTOTOUT (‚Ç¨)", data: serieOut, yAxisID:"y", tension:.25, pointRadius:0, borderWidth:2},
        {label:"OUT% (calcolata)", data: serieRatio, yAxisID:"y2", tension:.25, pointRadius:0, borderWidth:2},
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{labels:{color:getComputedStyle(document.documentElement).getPropertyValue("--muted")}},
        tooltip:{mode:"index", intersect:false}
      },
      interaction:{mode:"index", intersect:false},
      scales:{
        x:{ticks:{color:getComputedStyle(document.documentElement).getPropertyValue("--muted"), maxRotation:0, autoSkip:true}},
        y:{ticks:{color:getComputedStyle(document.documentElement).getPropertyValue("--muted")}, grid:{color:getComputedStyle(document.documentElement).getPropertyValue("--line")}},
        y2:{position:"right", min:0, max:100, ticks:{color:getComputedStyle(document.documentElement).getPropertyValue("--muted")}, grid:{display:false}}
      }
    }
  });

  // history table (ultime 80 righe)
  const tbody = document.querySelector("#tblHistory tbody");
  const full = (m.timeline||[]).filter(p=>p.t && p.in!=null && p.out!=null).sort((a,b)=>b.t-a.t);
  tbody.innerHTML = full.slice(0, 80).map(p=>{
    const diff = (p.diffOut!=null) ? money2(p.diffOut) : "‚Äî";
    const fase = (p.faseCiclo!=null) ? (p.faseCiclo*100).toFixed(1)+"%" : "‚Äî";
    const ratio = (p.ratioOut!=null) ? (p.ratioOut*100).toFixed(2)+"%" : "‚Äî";
    return `
      <tr>
        <td>${p.t.toLocaleString()}</td>
        <td>${money(p.in)}</td>
        <td>${money(p.out)}</td>
        <td>${ratio}</td>
        <td>${diff}</td>
        <td>${fase}</td>
      </tr>
    `;
  }).join("");

  // export CSV
  document.getElementById("btnExportCSV").onclick = ()=>{
    exportMachineCSV(m);
  };
}

function exportMachineCSV(m){
  const rows = (m.timeline||[]).filter(p=>p.t && p.in!=null && p.out!=null).sort((a,b)=>a.t-b.t);
  const head = ["date","in_eur","out_eur","out_pct_calc","target_pct","diff_out_eur","ciclo","fase_ciclo"];
  const lines = [head.join(",")];
  for(const p of rows){
    const outPctCalc = p.ratioOut!=null ? (p.ratioOut*100).toFixed(4) : "";
    const tgt = p.target!=null ? (p.target*100).toFixed(4) : "";
    const diff = p.diffOut!=null ? p.diffOut.toFixed(2) : "";
    const ciclo = p.ciclo!=null ? p.ciclo : "";
    const fase = p.faseCiclo!=null ? p.faseCiclo.toFixed(6) : "";
    lines.push([
      `"${p.t.toISOString()}"`,
      p.in?.toFixed(2) ?? "",
      p.out?.toFixed(2) ?? "",
      outPctCalc,
      tgt,
      diff,
      ciclo,
      fase
    ].join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `awp_${m.codeid}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* =========================================================
   Chat IA locale: S.A.G.A.
   ========================================================= */
function setupChat(){
  const logEl = document.getElementById("chatlog");
  const input = document.getElementById("chatin");
  const send = document.getElementById("chatsend");

  logEl.innerHTML = "";
  chatSay("S.A.G.A.", "Ciao! Posso rispondere su sinottici, macchine e cicli.\nEsempi:\n- ‚Äúquale macchina √® in pagamento?‚Äù\n- ‚Äúquando paga questa macchina?‚Äù\n- ‚Äúcerca CODEID 123‚Ä¶‚Äù\n- ‚Äútop 10 pagamenti probabili‚Äù");

  const go = ()=>{
    const t = input.value.trim();
    if(!t) return;
    chatSay("Tu", t);
    input.value="";
    const ans = sagaRespond(t);
    chatSay("S.A.G.A.", ans);
  };
  send.onclick = go;
  input.onkeydown = (e)=>{ if(e.key==="Enter") go(); };

  function chatSay(who, txt){
    const div = document.createElement("div");
    div.className="msg";
    div.innerHTML = `<div class="who">${escapeHtml(who)}</div><div class="txt">${escapeHtml(txt)}</div>`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }
}

function sagaRespond(text){
  const t = text.toLowerCase();

  if(state.machines.size===0){
    return "Prima devo analizzare i sinottici. Premi ‚ÄúAnalizza tutti i sinottici‚Äù.";
  }

  // helper: top list
  const topMachines = (n=10)=> {
    const arr = [...state.machines.values()].sort((a,b)=>(b.score||0)-(a.score||0)).slice(0,n);
    return arr.map((m,i)=>{
      const last = latestPoint(m);
      return `${i+1}) ${m.meta?.denom||"‚Äî"} ¬∑ ${m.meta?.comune||"‚Äî"} ¬∑ ${m.meta?.modello||"‚Äî"} ¬∑ CODEID ${m.codeid} ¬∑ Prob ${Math.round((m.score||0)*100)}% ¬∑ IN ${money(last?.in)} ¬∑ OUT% ${last?.ratioOut!=null?pct(last.ratioOut):"‚Äî"}`;
    }).join("\n");
  };

  // ‚Äútop 10‚Äù
  if(t.includes("top") || t.includes("migliori") || t.includes("pi√π in pagamento") || t.includes("in pagamento")){
    // se chiede "quale macchina √® in pagamento" -> top 10
    return "Ecco le macchine con probabilit√† pi√π alta (stima):\n" + topMachines(10) +
      "\n\nSe vuoi, dimmi: ‚Äúseleziona CODEID ...‚Äù";
  }

  // cerca CODEID
  const mCode = t.match(/codeid\s*([0-9]+)/i);
  if(mCode){
    const codeid = mCode[1];
    if(state.machines.has(codeid)){
      state.selectedCodeid = codeid;
      showMachine(codeid);
      return `Ho selezionato CODEID ${codeid}. Vuoi che stimi ‚Äúquando paga‚Äù basandomi su fase ciclo e scarto rispetto al target?`;
    }
    return `Non trovo CODEID ${codeid} nei sinottici caricati. Controlla che sia presente nei file analizzati.`;
  }

  // ‚Äúseleziona ...‚Äù
  const mSel = t.match(/seleziona\s*([0-9]+)/i);
  if(mSel){
    const codeid = mSel[1];
    if(state.machines.has(codeid)){
      state.selectedCodeid = codeid;
      showMachine(codeid);
      return `Selezionata ${codeid}.`;
    }
    return `Non ho trovato ${codeid}.`;
  }

  // quando paga questa macchina / questa
  if(t.includes("quando") && (t.includes("paga") || t.includes("pagare"))){
    const codeid = state.selectedCodeid;
    if(!codeid) return "Dimmi quale macchina: ad esempio ‚ÄúCODEID 123‚Ä¶‚Äù oppure cliccala dalla lista.";
    const m = state.machines.get(codeid);
    const last = latestPoint(m);
    if(!last) return "Per questa macchina non ho abbastanza dati validi.";

    const fase = last.faseCiclo!=null ? (last.faseCiclo*100).toFixed(1)+"%" : "‚Äî";
    const diff = last.diffOut!=null ? money2(last.diffOut) : "‚Äî";
    const ciclo = last.ciclo!=null ? money(last.ciclo) : "‚Äî";

    return [
      `Stima per CODEID ${codeid} (euristica):`,
      `- Probabilit√†: ${Math.round((m.score||0)*100)}% (${m.scoreLabel})`,
      `- Fase ciclo: ${fase} (ciclo: ${ciclo})`,
      `- Scarto vs target (${Math.round((last.target||0.65)*100)}%): ${diff} ‚Ç¨ (positivo = sotto target)`,
      "",
      `Interpretazione rapida:`,
      `- Se fase ciclo √® alta e la macchina √® sotto target, la probabilit√† sale.`,
      `- Se ha appena pagato tanto nello step recente, la probabilit√† scende.`,
      "",
      `Vuoi che ti mostri anche le ultime 10 variazioni (ŒîIN/ŒîOUT) per capire il ritmo?`
    ].join("\n");
  }

  // richiesta locale generica
  if(t.includes("ai") || t.includes("ia") || t.includes("neural") || t.includes("algoritmo")){
    return "Io qui sono S.A.G.A.: non posso ‚Äúscoprire‚Äù l‚Äôalgoritmo reale della scheda, ma posso stimare pattern usando:\n- storico IN/OUT\n- % OUT\n- ciclo da cicloslot\n- fase ciclo e scarto dal target\n\nDimmi che analisi vuoi: ‚Äútop 10‚Äù, ‚Äúquando paga questa macchina‚Äù, oppure ‚Äúcerca CODEID ‚Ä¶‚Äù.";
  }

  // fallback
  return "Posso aiutarti solo su sinottici/macchine/cicli.\nProva con:\n- ‚Äúquale macchina √® in pagamento?‚Äù\n- ‚Äútop 10‚Äù\n- ‚Äúquando paga questa macchina?‚Äù\n- ‚ÄúCODEID 123‚Ä¶‚Äù";
}

/* =========================================================
   Helpers escape
   ========================================================= */
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('"',"&quot;"); }

/* =========================================================
   Boot
   ========================================================= */
(async function init(){
  loadSettings();
  try{
    await loadUsers();
  }catch(e){
    console.error(e);
    // se users.json manca, facciamo comunque vedere login ma non entrer√†
  }
  renderLogin();
})();
</script>
</body>
</html>
