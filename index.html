<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AWP Fine Ciclo Â· Analyzer Pro</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#f6f8fc; --ink:#0b1220; --muted:#5a6885; --card:#ffffff; --border:#e7ecf5;
    --accent:#2563eb; --accent-2:#3b82f6; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --thead:#f8fafc; --hover:#f3f7ff; --zebra:#fbfdff; --overlay:rgba(0,0,0,.35);
  }
  html[data-theme="dark"]{
    --bg:#0f1220; --ink:#eef1ff; --muted:#9aa3c7; --card:#161a2b; --border:#273057;
    --accent:#5b8cff; --accent-2:#476cff; --ok:#2bd576; --warn:#ffd24a; --bad:#ff8c8c;
    --thead:#1a2040; --hover:#121735; --zebra:#12162e; --overlay:rgba(0,0,0,.55);
  }
  html[data-theme="mint"]{
    --bg:#f2fbf7; --ink:#072018; --muted:#4c7a69; --card:#ffffff; --border:#d7efe4;
    --accent:#10b981; --accent-2:#34d399; --ok:#0ea5a5; --warn:#f59e0b; --bad:#ef4444;
    --thead:#ecfdf5; --hover:#e6fff5; --zebra:#f6fffb; --overlay:rgba(0,0,0,.25);
  }
  html[data-theme="amber"]{
    --bg:#fffaf2; --ink:#201508; --muted:#8b6a3a; --card:#ffffff; --border:#f1e3c8;
    --accent:#f59e0b; --accent-2:#fbbf24; --ok:#22c55e; --warn:#d97706; --bad:#ef4444;
    --thead:#fff4e0; --hover:#fff0d4; --zebra:#fff8ea; --overlay:rgba(0,0,0,.25);
  }

  *{box-sizing:border-box}
  body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--ink); min-height:100vh; display:flex; align-items:center; justify-content:center; }
  .app{ width:min(1300px,96vw); }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px; box-shadow:0 6px 20px rgba(15,23,42,.06); }
  h1{ font-size:24px; margin:0 0 6px; letter-spacing:.2px; }
  .muted{ color:var(--muted); }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .toolbar{ display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; margin-top:12px; }
  .stat{ background:var(--card); border:1px dashed var(--border); border-radius:12px; padding:10px 12px; font-size:13px; }

  table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:14px; font-size:14px; }
  thead th{ position:sticky; top:0; z-index:2; background:var(--thead); text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:.6px; color:var(--muted); border-bottom:1px solid var(--border); padding:10px 8px; cursor:pointer; }
  tbody td{ padding:10px 8px; border-bottom:1px solid var(--border); }
  tbody tr:nth-child(odd) td{ background:var(--zebra); }
  tbody tr:hover td{ background:var(--hover); }

  .tag{ padding:4px 9px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
  .tag.good{ background:color-mix(in oklab, var(--ok) 15%, transparent); color:var(--ok); border:1px solid color-mix(in oklab, var(--ok) 40%, transparent); }
  .tag.mid{ background:color-mix(in oklab, var(--warn) 15%, transparent); color:var(--warn); border:1px solid color-mix(in oklab, var(--warn) 40%, transparent); }
  .tag.bad{ background:color-mix(in oklab, var(--bad) 15%, transparent); color:var(--bad); border:1px solid color-mix(in oklab, var(--bad) 40%, transparent); }

  .badge{ padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; border:1px solid var(--border); }
  .badge.base{ background:#fff0; color:#6b7280; }
  .badge.sub{ background:#e7f6ed; color:#0b7a42; border-color:#bfe8d2; }
  .badge.admin{ background:#eef2ff; color:#3730a3; border-color:#c7d2fe; }

  /* Splash (Login) */
  .splash{ position:fixed; inset:0; display:grid; place-items:center; background:radial-gradient(1200px 700px at 50% 0%, var(--thead) 0, var(--bg) 60%, var(--bg) 100%); z-index:5; overflow:hidden;}
  .brand{ font-weight:900; font-size: clamp(28px, 5vw, 48px); letter-spacing:.3px; color:var(--ink); text-align:center; }
  .pinbox{ margin-top:16px; display:grid; gap:10px; justify-items:center; }
  .pinbox input{ width:240px; text-align:center; letter-spacing:2px; font-size:18px; }
  .error{ color:var(--bad); font-weight:700; margin-top:6px; text-align:center; }
  .icon{ position:absolute; font-size:50px; opacity:.15; animation: floaty 12s ease-in-out infinite; filter:drop-shadow(0 2px 6px rgba(0,0,0,.2));}
  .icon:nth-child(1){ top:8%; left:10%; animation-delay:0s; }
  .icon:nth-child(2){ top:20%; right:12%; animation-delay:1.5s; }
  .icon:nth-child(3){ bottom:12%; left:16%; animation-delay:3s; }
  .icon:nth-child(4){ bottom:15%; right:22%; animation-delay:4.5s; }
  @keyframes floaty{ 0%,100%{ transform:translateY(0) rotate(0deg);} 50%{ transform:translateY(-18px) rotate(6deg);} }

  .themebar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  /* Admin overlay */
  .overlay{ position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:10; }
  .overlay.in{ display:flex; }
  .panel{ width:min(900px, 95vw); background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; }
  .close{ background:#fff0; color:var(--ink); border:1px solid var(--border); padding:6px 10px; border-radius:8px; cursor:pointer; float:right;}
</style>
</head>
<body>
<!-- CICLOSLOT integrato (metti qui il tuo array; se [] userÃ  /Dati/cicloslot.xlsx) -->
<script type="application/json" id="cicloslot-json">[]</script>

<!-- Splash / Login -->
<div class="splash" id="splash">
  <div class="icon">ðŸŽ°</div><div class="icon">ðŸ’¸</div><div class="icon">ðŸ§®</div><div class="icon">ðŸ“Š</div>
  <div class="card" style="text-align:center; max-width:640px;">
    <div class="brand">AWP Fine Ciclo Â· Analyzer Pro</div>
    <div class="muted" style="margin-top:4px;">Accesso riservato</div>
    <div class="pinbox">
      <input type="text" id="user" placeholder="User" autocomplete="off" />
      <input type="password" id="pin" maxlength="8" placeholder="PIN" autocomplete="off" />
      <button class="secondary" id="enterBtn" type="button">Entra</button>
    </div>
    <div id="pinMsg" class="error" style="display:none;">Credenziali errate o non abilitate</div>
  </div>
</div>

<!-- App -->
<div class="app hidden" id="app">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div>
        <h1>Analisi Fine Ciclo</h1>
        <div class="muted">Caricamento automatico da <b>/Dati/</b>. Payout: <b>65%</b>.</div>
        <div id="lastRead" class="muted" style="margin-top:4px;"></div>
      </div>
      <div style="text-align:right;">
        <div class="themebar">
          <span class="muted" style="font-size:12px;">Tema:</span>
          <button class="pill" data-theme="light">Chiaro</button>
          <button class="pill" data-theme="dark">Scuro</button>
          <button class="pill" data-theme="mint">Mint</button>
          <button class="pill" data-theme="amber">Ambra</button>
        </div>
        <div id="who" style="margin-top:8px; font-size:13px;"></div>
        <div id="expireWarn" class="error" style="display:none;">Abbonamento scaduto: accesso in modalitÃ  Base. Contatta lâ€™amministratore per il rinnovo.</div>
        <div id="adminBar" class="row" style="justify-content:flex-end; margin-top:8px; display:none;">
          <button class="secondary" id="btnUsers" type="button">Gestione utenti</button>
        </div>
      </div>
    </div>

    <div class="toolbar" id="statsBar">
      <div class="stat" id="statStatus">Stato: in attesa datiâ€¦</div>
      <div class="stat" id="statCount">Macchine: 0</div>
      <div class="stat" id="statGood">Top (residuo OUT &gt; residuo IN): 0</div>
      <div class="stat" id="statWarn">Equilibrate (Â±10%): 0</div>
    </div>

    <table id="resultTable">
      <thead>
        <tr id="theadRow">
          <th data-k="perc_cycle" class="col-calc">Percentuale Ciclo</th>
          <th data-k="cycle_idx" class="col-calc">Ciclo Corrente</th>
          <th data-k="resid_in" class="col-calc">Residuo IN</th>
          <th data-k="resid_out" class="col-calc">Residuo OUT</th>
          <th data-k="forecast_date" class="col-calc">Fine Ciclo Stimata</th>
          <th data-k="MODELLO">MODELLO</th>
          <th data-k="DENOMIN_SEDE">DENOMIN. SEDE</th>
          <th data-k="SEDE">SEDE</th>
          <th data-k="INDIRIZZO">INDIRIZZO</th>
          <th data-k="PROVINCIA">PROVINCIA</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="muted" id="footNote" style="margin-top:8px;">Residuo OUT negativo â†’ <b>â‚¬0</b>. IN/OUT divisi per <b>100</b>.</div>
  </div>
</div>

<!-- Overlay Admin: lista utenti -->
<div class="overlay" id="ovUsers">
  <div class="panel">
    <button class="close" id="closeUsers">Chiudi</button>
    <h3 style="margin:0 0 10px;">Utenti (solo Admin)</h3>
    <div id="usersList" style="max-height:60vh; overflow:auto;"></div>
  </div>
</div>

<!-- Modal scheda macchina -->
<div class="overlay" id="modal">
  <div class="panel">
    <button class="close" id="closeModal">Chiudi</button>
    <h3 id="m_title" style="margin:0 0 8px;">Scheda macchina</h3>
    <div class="grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px 16px;">
      <div><b>Modello</b><div id="m_model"></div></div>
      <div><b>Codice Modello</b><div id="m_code" style="font-family:ui-monospace,Menlo,Consolas,monospace;"></div></div>
      <div><b>Ciclo</b><div id="m_cycle"></div></div>
      <div><b>Payout (%)</b><div>65%</div></div>
      <div><b>Residuo IN</b><div id="m_resid_in"></div></div>
      <div><b>Residuo OUT</b><div id="m_resid_out"></div></div>
      <div><b>Percentuale Ciclo</b><div id="m_perc"></div></div>
      <div><b>Fine Ciclo Stimata</b><div id="m_forecast"></div></div>
    </div>
    <h4 style="margin-top:14px;">Storico letture</h4>
    <div id="m_history" style="max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:8px; padding:8px;"></div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const norm = s => (s??"").toString().trim();
const lowerKeys = obj => { const o={}; for(const k in obj){ o[norm(k).toLowerCase()] = obj[k]; } return o; };
const normalize = (s) => (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim();
const todayISO = ()=> new Date().toISOString().slice(0,10);
function toast(msg){ const d=document.createElement('div'); d.textContent=msg; d.style.cssText='position:fixed;bottom:12px;left:12px;right:12px;padding:10px 14px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:10px;z-index:9999;font-weight:700'; document.body.appendChild(d); setTimeout(()=>d.remove(),4500); }
window.addEventListener('error', e=> toast('Errore: ' + (e.message||'sconosciuto')));

/* ===== Tema ===== */
document.querySelectorAll('.pill[data-theme]').forEach(b=> b.addEventListener('click',()=>{document.documentElement.setAttribute('data-theme', b.dataset.theme); localStorage.setItem('awp_theme', b.dataset.theme);})); 
const savedTheme=localStorage.getItem('awp_theme'); if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

/* ===== Login (users.json) ===== */
let CURRENT_USER = null; // {user, level, expires}
document.getElementById('enterBtn').addEventListener('click', auth);
document.getElementById('pin').addEventListener('keydown', e=>{ if(e.key==='Enter') auth(); });

async function auth(){
  const u = norm(document.getElementById('user').value).toLowerCase();
  const p = norm(document.getElementById('pin').value);
  let list = [];
  try{
    const res = await fetch('Dati/users.json', {cache:'no-store'});
    if(!res.ok) throw new Error('users.json non trovato');
    list = await res.json();
  }catch(e){
    toast('Errore lettura Dati/users.json'); return;
  }
  const found = list.find(x => (x.user||'').toLowerCase()===u && String(x.pin)===p);
  if(!found){ showLoginError(); return; }

  let level = (found.level||'Base').trim();
  const exp = found.expires ? String(found.expires) : null;
  const now = todayISO();

  let expired = false;
  if(exp && exp < now){
    // downgrade a Base
    level = 'Base';
    expired = true;
  }

  CURRENT_USER = { user: found.user, level, expires: exp, expiredFlag: expired, _raw: found };
  document.getElementById('splash').style.display='none';
  document.getElementById('app').classList.remove('hidden');
  setupRoleUI();
  initAuto(); // avvia caricamento dati
}

function showLoginError(){
  const m=document.getElementById('pinMsg'); m.style.display='block'; setTimeout(()=> m.style.display='none',1500);
}

function setupRoleUI(){
  const who = document.getElementById('who');
  const eb = document.getElementById('expireWarn');
  const adminBar = document.getElementById('adminBar');

  const lvl = (CURRENT_USER.level||'Base').toLowerCase();
  const badge = lvl==='admin' ? '<span class="badge admin">Admin</span>' :
                 lvl==='abbonato' ? '<span class="badge sub">Abbonato</span>' :
                 '<span class="badge base">Base</span>';

  who.innerHTML = `Utente: <b>${CURRENT_USER.user}</b> Â· ${badge} Â· Scadenza: <b>${CURRENT_USER.expires ? CURRENT_USER.expires : 'â€”'}</b>`;
  eb.style.display = CURRENT_USER.expiredFlag ? 'block' : 'none';
  adminBar.style.display = (lvl==='admin') ? 'flex' : 'none';

  // Vista Base: nascondi colonne calcoli + barre statistiche + modale dettagli
  const showCalcs = (lvl==='abbonato' || lvl==='admin');
  document.querySelectorAll('.col-calc').forEach(el => el.style.display = showCalcs ? '' : 'none');
  document.getElementById('statsBar').style.display = showCalcs ? 'flex' : 'none';
  document.getElementById('footNote').style.display = showCalcs ? 'block' : 'none';

  // Apri overlay Admin utenti
  if (lvl==='admin'){
    document.getElementById('btnUsers').onclick = openUsersOverlay;
  }
}

/* ===== CICLOSLOT: inline JSON o fallback /Dati/cicloslot.xlsx ===== */
let CICLOSLOT=[]; try{ const el=document.getElementById('cicloslot-json'); if(el && el.textContent.trim()) CICLOSLOT=JSON.parse(el.textContent);}catch(e){}
function buildCicloMaps(arr){ const byCode=new Map(), model=new Map(); arr.forEach(x=>{ const code=norm(x.code||x['codice modello']).toUpperCase(); const cyc=+x.cycle||+x.ciclo||+x['ciclo partite']||+x['partite per ciclo']; if(code&&cyc){ byCode.set(code,cyc); model.set(code, norm(x.model||x.modello||'')); }}); return {byCode, model}; }
function buildCicloByModel(arr){ const m=new Map(); arr.forEach(x=>{ const mk=normalize(x.model||x.modello||''); const cyc=+x.cycle||+x.ciclo||+x['ciclo partite']||+x['partite per ciclo']; if(mk&&cyc>0) m.set(mk,cyc);}); return m; }
let CICLO = buildCicloMaps(CICLOSLOT);
let CICLO_BY_MODEL = buildCicloByModel(CICLOSLOT);

/* ===== Lettori XLSX ===== */
async function fetchXLSX(url){
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('Fetch fallito: '+url);
  const buf=await res.arrayBuffer();
  const wb=XLSX.read(new Uint8Array(buf),{type:'array'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const json=XLSX.utils.sheet_to_json(ws,{defval:'',raw:false});
  return json.map(lowerKeys);
}

/* ===== Colonne Sinottico (alias + typo robusti) ===== */
function pickCols(map){
  const keys=Object.keys(map);
  const pickOne = arr => arr.find(k=> keys.includes(k));
  return {
    codeKey: keys.includes('codice modello') ? 'codice modello' : null,
    inKey:   keys.includes('cnttotin') ? 'cnttotin' : null,
    outKey:  keys.includes('cnttotot') ? 'cnttotot' : null,
    modelloKey: pickOne(['modello','descrizione modello','model','desc modello','descr. modello']),
    denomSedeKey: pickOne(['denomin. sede','denominazione sede','denom. sede','denominazione','denonim. sede','denonimazione sede']),
    sedeKey: pickOne(['sede','localitÃ ','localita','comune','cittÃ ','citta','city']),
    indirKey: pickOne(['indirizzo','indirizzo sede','via','via/piazza','indir.','address','indirizzo completo']),
    provKey: pickOne(['provincia','prov.','prov','sigla provincia'])
  };
}

/* ===== Parse contatori Ã·100 ===== */
const parseCnt = v => { if(typeof v==='number') return v/100; let s=(v||'').toString().trim(); if(!s) return 0; s=s.replace(/\s+/g,''); if (s.includes('.') && s.includes(',')) s=s.replace(/\./g,'').replace(',', '.'); else if (s.includes(',')) s=s.replace('.', '').replace(',', '.'); const n=parseFloat(s); return isNaN(n)?0:n/100; };

/* ===== Storico & previsioni ===== */
const payout=0.65;
const HIST_KEY='awp_history_v1';
let history={}; try{ history=JSON.parse(localStorage.getItem(HIST_KEY)||'{}'); }catch(e){ history={}; }
function pushHistory(code,dateISO,IN,OUT){ code=(code||'').toUpperCase(); if(!history[code]) history[code]=[]; history[code].push({date:dateISO, IN, OUT}); const seen=new Set(); history[code]=history[code].filter(r=>{const k=r.date; if(seen.has(k)) return false; seen.add(k); return true;}); history[code].sort((a,b)=> new Date(a.date)-new Date(b.date)); }
function forecastDate(code,resid_in){ const h=history[code]||[]; if(h.length<2) return 'â€”'; const last=h.slice(-4); let sumIn=0,sumDays=0; for(let i=1;i<last.length;i++){ const d1=new Date(last[i-1].date), d2=new Date(last[i].date); const dt=Math.max(1,(d2-d1)/(1000*3600*24)); const dIn=Math.max(0,last[i].IN-last[i-1].IN); sumIn+=dIn; sumDays+=dt; } const avg=sumDays>0?(sumIn/sumDays):0; if(avg<=0||resid_in<=0) return 'â€”'; const days=Math.ceil(resid_in/avg); const est=new Date(); est.setDate(est.getDate()+days); return est.toISOString().slice(0,10); }
function euro(n){ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n||0); }

/* ===== Build righe (con fallback per MODELLO) + stats ===== */
let latestSnapshot = 'â€”';
function buildRows(records, snapshotDate){
  const out=[]; let total=0,mapped=0,skipped=0;
  for(const r of records){
    total++;
    const code=norm(r.code).toUpperCase();
    const modelNameRaw=r.MODELLO||'';
    const modelKey=normalize(modelNameRaw);
    let C = CICLO.byCode.get(code);
    if(!C) C = CICLO_BY_MODEL.get(modelKey);
    // Se utente Ã¨ Base, i calcoli non servono -> comunque teniamo C per sapere se mostrare scheda
    if(!C){ skipped++; continue; }
    mapped++;

    const I=r.IN, V=r.OUT;
    if(snapshotDate) { pushHistory(code, snapshotDate, I, V); latestSnapshot = snapshotDate; }

    // Se utente Base, non calcoliamo nulla (evitiamo di esporre numeri di strategia)
    let row = {
      code,
      MODELLO: modelNameRaw || (CICLO.model.get(code)||''),
      DENOMIN_SEDE: r.DENOMIN_SEDE||'',
      SEDE: r.SEDE||'',
      INDIRIZZO: r.INDIRIZZO||'',
      PROVINCIA: r.PROVINCIA||'',
      _cycle: C, _I: I, _V: V
    };

    const lvl = (CURRENT_USER?.level||'Base').toLowerCase();
    if(lvl==='abbonato' || lvl==='admin'){
      const cycles_done=Math.floor(I/C);
      const in_cycle=I - cycles_done*C;
      const target_prev=cycles_done*(payout*C);
      let paid_cycle=V - target_prev; if(paid_cycle<0) paid_cycle=0;
      const resid_in = in_cycle>0? (C-in_cycle):C;
      let resid_out = (payout*C) - paid_cycle; if(resid_out<0) resid_out=0;
      const perc_cycle = in_cycle>0? (paid_cycle/in_cycle)*100 : 0;
      const cycle_idx = cycles_done+1;
      const fDate = forecastDate(code,resid_in);
      Object.assign(row, {
        perc_cycle, cycle_idx, resid_in, resid_out, forecast_date:fDate,
        _delta: resid_out-resid_in
      });
    }

    out.push(row);
  }
  const stat=document.getElementById('statStatus');
  if(stat) stat.innerHTML = `Stato: pronto âœ… Â· Lette: ${total} Â· Mappate: ${mapped} Â· Scartate: ${skipped}`;
  if(latestSnapshot && latestSnapshot !== 'â€”'){
    document.getElementById('lastRead').innerHTML = `Ultima lettura: <b>${latestSnapshot}</b>`;
  }
  return out;
}

/* ===== UI ===== */
let fullRows=[];
function render(rows){
  const lvl = (CURRENT_USER?.level||'Base').toLowerCase();

  if(lvl==='abbonato' || lvl==='admin'){
    rows.sort((a,b)=> (b._delta - a._delta) || (b.resid_out - a.resid_out));
  }else{
    // Base: ordina alfabetico per sede o modello
    rows.sort((a,b)=> String(a.DENOMIN_SEDE||a.SEDE||a.MODELLO).localeCompare(String(b.DENOMIN_SEDE||b.SEDE||b.MODELLO)));
  }

  const tb=document.querySelector('#resultTable tbody'); tb.innerHTML='';
  for(const r of rows){
    const tr=document.createElement('tr'); tr.dataset.code=r.code;
    if(lvl==='abbonato' || lvl==='admin'){
      const tagClass = (r.resid_out>r.resid_in) ? 'good' : (Math.abs((r.resid_out||0)-(r.resid_in||0)) <= 0.1*((r.resid_in||1)) ? 'mid' : 'bad');
      tr.innerHTML=`
        <td class="col-calc"><span class="tag ${tagClass}">${r.perc_cycle!=null ? r.perc_cycle.toFixed(2) : '0.00'}%</span></td>
        <td class="col-calc">${r.cycle_idx ?? ''}</td>
        <td class="col-calc">${r.resid_in!=null ? euro(r.resid_in) : ''}</td>
        <td class="col-calc">${r.resid_out!=null ? euro(r.resid_out) : ''}</td>
        <td class="col-calc">${r.forecast_date ?? ''}</td>
        <td>${escapeHTML(r.MODELLO||'')}</td>
        <td>${escapeHTML(r.DENOMIN_SEDE||'')}</td>
        <td>${escapeHTML(r.SEDE||'')}</td>
        <td>${escapeHTML(r.INDIRIZZO||'')}</td>
        <td>${escapeHTML(r.PROVINCIA||'')}</td>
      `;
      tr.addEventListener('click', ()=> openModal(r.code,r));
    } else {
      // Base: solo lista, niente click su scheda
      tr.innerHTML=`
        <td class="col-calc" style="display:none"></td>
        <td class="col-calc" style="display:none"></td>
        <td class="col-calc" style="display:none"></td>
        <td class="col-calc" style="display:none"></td>
        <td class="col-calc" style="display:none"></td>
        <td>${escapeHTML(r.MODELLO||'')}</td>
        <td>${escapeHTML(r.DENOMIN_SEDE||'')}</td>
        <td>${escapeHTML(r.SEDE||'')}</td>
        <td>${escapeHTML(r.INDIRIZZO||'')}</td>
        <td>${escapeHTML(r.PROVINCIA||'')}</td>
      `;
    }
    tb.appendChild(tr);
  }
  document.getElementById('statCount').textContent='Macchine: '+rows.length;
  if(!(lvl==='abbonato' || lvl==='admin')){
    document.getElementById('statGood').textContent='Top: â€”';
    document.getElementById('statWarn').textContent='Equilibrate: â€”';
  }else{
    const good=rows.filter(r=> (r.resid_out>r.resid_in)).length;
    const warn=rows.filter(r=> Math.abs((r.resid_out||0)-(r.resid_in||0)) <= 0.1*(r.resid_in||1)).length;
    document.getElementById('statGood').textContent='Top (residuo OUT > residuo IN): '+good;
    document.getElementById('statWarn').textContent='Equilibrate (Â±10%): '+warn;
  }
}
document.querySelectorAll('th[data-k]').forEach(th=>{
  th.addEventListener('click', ()=>{
    const k=th.getAttribute('data-k');
    const lvl=(CURRENT_USER?.level||'Base').toLowerCase();
    const isNum=['perc_cycle','cycle_idx','resid_in','resid_out','_delta'].includes(k);
    const dir=th.dataset.dir==='asc'?'desc':'asc'; th.dataset.dir=dir;
    const arr=[...fullRows];
    arr.sort((a,b)=>{ const A=a[k]??'', B=b[k]??''; if(isNum) return dir==='asc'?(A-B):(B-A); return dir==='asc'?String(A).localeCompare(String(B)):String(B).localeCompare(String(A)); });
    // Base: se sort su colonne nascoste, non cambia granchÃ©, ma non fa danni
    render(arr);
  });
});
const modal=document.getElementById('modal'); document.getElementById('closeModal').addEventListener('click',()=> modal.classList.remove('in'));
function openModal(code,row){
  const lvl=(CURRENT_USER?.level||'Base').toLowerCase();
  if(!(lvl==='abbonato'||lvl==='admin')) return; // Base non apre
  document.getElementById('m_title').textContent='Scheda macchina â€“ '+code;
  document.getElementById('m_model').textContent=row.MODELLO||'';
  document.getElementById('m_code').textContent=code;
  document.getElementById('m_cycle').textContent=(row._cycle||'')+' (partite)';
  document.getElementById('m_resid_in').textContent=row.resid_in!=null?euro(row.resid_in):'â€”';
  document.getElementById('m_resid_out').textContent=row.resid_out!=null?euro(row.resid_out):'â€”';
  document.getElementById('m_perc').textContent=(row.perc_cycle!=null?row.perc_cycle.toFixed(2):'â€”')+'%';
  document.getElementById('m_forecast').textContent=row.forecast_date||'â€”';
  const h=history[code]||[];
  let html='<table style="width:100%;border-collapse:collapse;"><thead><tr>'
    +'<th style="text-align:left;border-bottom:1px solid var(--border);padding:6px;">Data</th>'
    +'<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">IN</th>'
    +'<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">OUT</th>'
    +'<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">Î”IN</th>'
    +'<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">Î”OUT</th>'
    +'</tr></thead><tbody>';
  for(let i=0;i<h.length;i++){
    const prev=h[i-1]; const dIn=i? (h[i].IN-prev.IN):0; const dOut=i? (h[i].OUT-prev.OUT):0;
    html += `<tr><td style="padding:6px;">${h[i].date}</td><td style="padding:6px;text-align:right;">${euro(h[i].IN)}</td><td style="padding:6px;text-align:right;">${euro(h[i].OUT)}</td><td style="padding:6px;text-align:right;">${euro(dIn)}</td><td style="padding:6px;text-align:right;">${euro(dOut)}</td></tr>`;
  }
  html+='</tbody></table>';
  document.getElementById('m_history').innerHTML=html;
  modal.classList.add('in');
}

/* ===== Admin: Overlay utenti ===== */
const ovUsers=document.getElementById('ovUsers');
document.getElementById('closeUsers').addEventListener('click', ()=> ovUsers.classList.remove('in'));
async function openUsersOverlay(){
  if((CURRENT_USER?.level||'').toLowerCase()!=='admin') return;
  try{
    const res = await fetch('Dati/users.json', {cache:'no-store'});
    if(!res.ok) throw new Error('users.json non trovato');
    const users = await res.json();
    const today = todayISO();
    let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr>'
      +'<th style="text-align:left;border-bottom:1px solid var(--border);padding:6px;">User</th>'
      +'<th style="text-align:left;border-bottom:1px solid var(--border);padding:6px;">Livello</th>'
      +'<th style="text-align:left;border-bottom:1px solid var(--border);padding:6px;">Scadenza</th>'
      +'<th style="text-align:left;border-bottom:1px solid var(--border);padding:6px;">Stato</th>'
      +'</tr></thead><tbody>';
    for(const u of users){
      const exp = u.expires || 'â€”';
      const expired = (u.expires && u.expires < today);
      const lvl = u.level || 'Base';
      const effLvl = expired ? 'Base (scaduto)' : lvl;
      const stato = expired ? 'Scaduto' : 'Attivo';
      html += `<tr>
        <td style="padding:6px;">${u.user}</td>
        <td style="padding:6px;">${effLvl}</td>
        <td style="padding:6px;">${exp}</td>
        <td style="padding:6px;">${stato}</td>
      </tr>`;
    }
    html += '</tbody></table>';
    document.getElementById('usersList').innerHTML = html;
    ovUsers.classList.add('in');
  }catch(e){
    toast('Impossibile leggere users.json');
  }
}

/* ===== INIT AUTO: carica CICLOSLOT (se serve) + manifest + sinottici ===== */
async function initAuto(){
  try{
    const status = (m)=> document.getElementById('statStatus').textContent = m;

    status('Stato: caricamento CICLOSLOTâ€¦');
    if(CICLOSLOT.length===0){
      try{
        const cicloRows = await fetchXLSX('Dati/cicloslot.xlsx');
        const mapped = cicloRows.map(r=>({code:r['codice modello']||r.code, model:r.modello||r.model||'', cycle:+(r.ciclo||r.cycle||r['ciclo partite']||r['partite per ciclo']||0)})).filter(x=> x.code && x.cycle>0);
        CICLO = buildCicloMaps(mapped);
        CICLO_BY_MODEL = buildCicloByModel(mapped);
      }catch(e){
        toast('Impossibile leggere /Dati/cicloslot.xlsx e nessun CICLOSLOT integrato.');
        status('Stato: errore CICLOSLOT');
        return;
      }
    } else {
      CICLO = buildCicloMaps(CICLOSLOT);
      CICLO_BY_MODEL = buildCicloByModel(CICLOSLOT);
    }

    status('Stato: caricamento manifestâ€¦');
    let lista = [];
    try{
      const res = await fetch('Dati/manifest.json', {cache:'no-store'});
      if(res.ok){ const j = await res.json(); lista = Array.isArray(j.sinottici) ? j.sinottici : []; }
    }catch(e){}
    if(!lista.length){ status('Stato: manifest mancante (crea /Dati/manifest.json)'); return; }

    latestSnapshot = 'â€”';
    for(const name of lista){
      try{
        status('Stato: leggo '+name+'â€¦');
        const data = await fetchXLSX('Dati/'+name);
        if(!data.length) continue;
        const cols = pickCols(data[0]); if(!cols.codeKey||!cols.inKey||!cols.outKey) continue;
        const m = name.match(/\d{4}-\d{2}-\d{2}/); const snapshotDate = m ? m[0] : new Date().toISOString().slice(0,10);
        const recs = data.map(r=>({
          code: norm(r[cols.codeKey]),
          IN: parseCnt(r[cols.inKey]),
          OUT: parseCnt(r[cols.outKey]),
          MODELLO: cols.modelloKey ? norm(r[cols.modelloKey]) : '',
          DENOMIN_SEDE: cols.denomSedeKey ? norm(r[cols.denomSedeKey]) : '',
          SEDE: cols.sedeKey ? norm(r[cols.sedeKey]) : '',
          INDIRIZZO: cols.indirKey ? norm(r[cols.indirKey]) : '',
          PROVINCIA: cols.provKey ? norm(r[cols.provKey]) : ''
        }));
        buildRows(recs, snapshotDate); // aggiorna solo storico
      }catch(e){ console.warn(e); }
    }

    const latest = Object.keys(history).map(code=>{ const h=history[code]; const last=h[h.length-1]; return {code, IN:last.IN, OUT:last.OUT, MODELLO:'', DENOMIN_SEDE:'', SEDE:'', INDIRIZZO:'', PROVINCIA:''}; });
    fullRows = buildRows(latest, null);
    localStorage.setItem(HIST_KEY, JSON.stringify(history));
    render(fullRows);
    status('Stato: pronto âœ…');
  }catch(err){ console.error(err); document.getElementById('statStatus').textContent='Stato: errore'; toast('Errore di inizializzazione'); }
}

/* Utils */
function escapeHTML(s){ return (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
</script>
</body>
</html>
