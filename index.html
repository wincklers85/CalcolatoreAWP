<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AWP Analyzer Ultra v3</title>

  <link rel="stylesheet" href="./assets/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <!-- Top bar -->
  <header class="topbar">
    <button class="iconbtn" id="btnBurger" aria-label="Menu">☰</button>

    <div class="brand">
      <div class="brand-title">AWP Analyzer Ultra V3</div>
      <div class="brand-sub">Sinottici • Cicli • Storico • Diagnostica</div>
    </div>

    <div class="spacer"></div>

    <!-- Bubble ultimo aggiornamento (da manifest + nome file) -->
    <div class="bubble" id="bubbleUpdate">
      <span class="dot" id="bubbleDot"></span>
      <span id="bubbleText">Caricamento…</span>
    </div>

    <div class="userpill" id="userPill" style="display:none">
      <span id="userName"></span>
      <span class="sep">•</span>
      <span id="userLevel"></span>
      <button class="linkbtn" id="btnLogout" title="Esci">Esci</button>
    </div>
  </header>

  <!-- Side menu -->
  <aside class="sidemenu" id="sidemenu" aria-hidden="true">
    <div class="menuhd">
      <div class="menutitle">Menu</div>
      <button class="iconbtn" id="btnCloseMenu" aria-label="Chiudi">✕</button>
    </div>

    <nav class="menulinks">
      <button class="menubtn active" data-view="viewDashboard">Dashboard</button>
      <button class="menubtn" data-view="viewModels">Modelli</button>
      <button class="menubtn" data-view="viewAI">Assistente</button>
      <button class="menubtn" data-view="viewAdmin" id="btnAdminView" style="display:none">Admin</button>
      <button class="menubtn" data-view="viewProfile">Profilo</button>
    </nav>

    <div class="menuftr">
      <div class="muted small" id="menuHint">—</div>
    </div>
  </aside>

  <div class="backdrop" id="backdrop"></div>

  <!-- Main -->
  <main class="wrap">
    <!-- LOGIN VIEW -->
    <section class="view active" id="viewLogin">
      <div class="card login">
        <h2>Accesso</h2>
        <p class="muted">Inserisci username e PIN. Nessun placeholder “pericoloso”.</p>

        <div class="grid2">
          <div>
            <label>Username</label>
            <input id="loginUser" autocomplete="username" placeholder="Es. NomeUtente" />
          </div>
          <div>
            <label>PIN</label>
            <input id="loginPin" type="password" inputmode="numeric" autocomplete="current-password" placeholder="••••" />
          </div>
        </div>

        <div class="row between wrapgap">
          <button class="btn" id="btnLogin">Entra</button>
          <div class="muted" id="loginMsg">—</div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD VIEW -->
    <section class="view" id="viewDashboard">
      <div class="row between wrapgap">
        <h2 class="h2">Dashboard</h2>
        <div class="row wrapgap">
          <button class="btn" id="btnLoadLast3">Carica ultimi 3</button>
          <button class="btn secondary" id="btnLoadAll">Carica tutti</button>
        </div>
      </div>

      <div class="card">
        <div class="row between wrapgap">
          <div class="row wrapgap">
            <div class="kpi">
              <div class="kpiLabel">Macchine</div>
              <div class="kpiValue" id="kpiMachines">—</div>
            </div>
            <div class="kpi">
              <div class="kpiLabel">Locali</div>
              <div class="kpiValue" id="kpiLocales">—</div>
            </div>
            <div class="kpi">
              <div class="kpiLabel">Match ciclo</div>
              <div class="kpiValue" id="kpiCycleMatch">—</div>
            </div>
          </div>

          <div class="progressWrap">
            <div class="muted small" id="progressText">—</div>
            <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
          </div>
        </div>

        <div class="row wrapgap" style="margin-top:10px">
          <input id="filterText" class="input" placeholder="Filtra per locale, comune, modello, codeid…" />
          <select id="sortBy" class="input">
            <option value="activityDesc">Ordina: Attività ↓</option>
            <option value="phaseDesc">Ordina: Fase ciclo ↓</option>
            <option value="recency">Ordina: Aggiornamento</option>
            <option value="locale">Ordina: Locale A→Z</option>
          </select>
        </div>

        <div class="tableWrap">
          <table class="table" id="tblMachines">
            <thead>
              <tr>
                <th>Agg</th>
                <th>Locale</th>
                <th>Comune</th>
                <th>Modello</th>
                <th>CODEID</th>
                <th>PDA</th>
                <th>Fase ciclo</th>
                <th>Attività</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="muted small" id="dataHint" style="margin-top:10px">—</div>
      </div>
    </section>

    <!-- MODELS VIEW -->
    <section class="view" id="viewModels">
      <div class="row between wrapgap">
        <h2 class="h2">Modelli</h2>
        <div class="muted">Da <code>cicloslot.json</code></div>
      </div>

      <div class="card">
        <div class="tableWrap">
          <table class="table" id="tblModels">
            <thead>
              <tr>
                <th>Codice Modello</th>
                <th>Nome</th>
                <th>Ciclo (€ IN)</th>
                <th>Payout</th>
                <th>Macchine viste</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- AI VIEW -->
    <section class="view" id="viewAI">
      <div class="row between wrapgap">
        <h2 class="h2">Assistente</h2>
        <div class="muted">Risponde solo sui dati caricati.</div>
      </div>

      <div class="card chat">
        <div class="chatlog" id="chatLog"></div>
        <div class="row wrapgap">
          <input id="chatInput" class="input" placeholder="Es: perché questa slot è arancione? / confronta modello / anomalie…" />
          <button class="btn" id="btnChatSend">Invia</button>
        </div>
      </div>
    </section>

    <!-- ADMIN VIEW -->
    <section class="view" id="viewAdmin">
      <div class="row between wrapgap">
        <h2 class="h2">Admin</h2>
        <div class="muted">Utenti + diagnostica</div>
      </div>

      <div class="card">
        <h3 class="h3">Utenti</h3>
        <div class="tableWrap">
          <table class="table" id="tblUsers">
            <thead>
              <tr>
                <th>User</th><th>Level</th><th>Expires</th><th>Stato</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <hr class="hr" />

        <h3 class="h3">Diagnostica</h3>
        <div class="diag" id="diagBox">—</div>
      </div>
    </section>

    <!-- PROFILE VIEW -->
    <section class="view" id="viewProfile">
      <div class="row between wrapgap">
        <h2 class="h2">Profilo</h2>
        <div class="muted">Gestione abbonamento</div>
      </div>

      <div class="card">
        <div id="profileBox">—</div>
      </div>
    </section>
  </main>

  <!-- SLOT MODAL -->
  <div class="modalBackdrop" id="modalBackdrop"></div>
  <div class="modal" id="slotModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modalHd">
      <div>
        <div class="modalTitle" id="modalTitle">Slot</div>
        <div class="muted small" id="modalSubtitle">—</div>
      </div>
      <button class="iconbtn" id="btnCloseModal" aria-label="Chiudi">✕</button>
    </div>

    <div class="modalBody">
      <div class="grid2">
        <div class="card inner">
          <h3 class="h3">Scheda tecnica</h3>
          <div class="kv" id="kvTech">—</div>
        </div>

        <div class="card inner">
          <h3 class="h3">Storico (ΔOUT)</h3>
          <canvas id="chartOut" height="160"></canvas>
          <div class="muted small" id="chartHint">—</div>
        </div>
      </div>

      <div class="card inner" style="margin-top:12px">
        <h3 class="h3">Analisi</h3>
        <div class="kv" id="kvAnalysis">—</div>
      </div>
    </div>
  </div>

  <script type="module" src="./assets/app.js"></script>
</body>
</html>
