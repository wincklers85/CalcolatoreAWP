<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calcolatore AWP | Analisi Pagamento</title>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <link rel="stylesheet" href="./assets/app.css" />
</head>
<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">AWP</div>
        <div>
          Calcolatore AWP | Analisi Pagamento
          <small>Storici sinottici, correlazioni modello, schede locali, AWIS</small>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="pill" id="pillUpdate">
        <span class="dot" id="dotUpdate"></span>
        <span id="txtUpdate">Ultimo sinottico: —</span>
      </div>

      <div class="pill" id="pillStatus">
        <span class="dot" id="dotStatus"></span>
        <span id="txtStatus">Non autenticato</span>
      </div>

      <button class="btn small" id="btnLogout" style="display:none" title="Esci">Esci</button>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <div class="view active" id="viewLogin">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Accesso</h2>
            <div class="sub" id="loginStatus">Caricamento…</div>
          </div>
          <div class="bd">
            <div class="split">
              <div class="field">
                <label>Utente</label>
                <input class="input" id="loginUser" placeholder="es. Username" autocomplete="username" />
              </div>
              <div class="field">
                <label>PIN</label>
                <input class="input" id="loginPin" placeholder="es. PIN" inputmode="numeric" autocomplete="current-password" />
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="btnLogin">Entra</button>
              <button class="btn" id="btnSelfTest">Self-test</button>

              <span class="badge"><span class="dot" id="dotUsers"></span><span id="usersInfo">users.json: …</span></span>
              <span class="badge"><span class="dot" id="dotManifest"></span><span id="manifestInfo">manifest.json: …</span></span>
              <span class="badge"><span class="dot" id="dotXLSX"></span><span id="xlsxInfo">XLSX: …</span></span>
            </div>

            <div class="footer-note">
              Tutti i file devono essere in <b>/Dati/</b> (D maiuscola): users.json, manifest.json, cicloslot.json e i sinottici .xlsx.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Info rapido</h2>
            <div class="sub">Cartella /Dati/</div>
          </div>
          <div class="bd">
            <div class="kpi">
              <div class="label">Percorso dati</div>
              <div class="value mono" style="font-size:14px">./Dati/</div>
              <div class="hint">Compatibile GitHub Pages (URL relativo)</div>
            </div>

            <div class="kpi" style="margin-top:12px">
              <div class="label">Modalità</div>
              <div class="value">Admin / Abbonato / Scaduto</div>
              <div class="hint">Scaduto entra ma vede solo banner aggiornamento + profilo rinnovo.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- EXPIRED VIEW -->
    <div class="view" id="viewExpired">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Account scaduto</h2>
            <div class="sub">Accesso limitato</div>
          </div>
          <div class="bd">
            <div class="kpis">
              <div class="kpi">
                <div class="label">Stato</div>
                <div class="value" style="font-size:16px">Scaduto</div>
                <div class="hint" id="expiredHint">—</div>
              </div>
              <div class="kpi">
                <div class="label">Ultimo sinottico</div>
                <div class="value" style="font-size:16px" id="expiredLast">—</div>
                <div class="hint">Vedi il banner in alto.</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="card" style="box-shadow:none">
              <div class="hd" style="border:none; padding:0 0 10px 0">
                <h2 style="font-size:14px; margin:0">Profilo</h2>
              </div>
              <div class="bd" style="padding:0">
                <div class="kpi">
                  <div class="label">Utente</div>
                  <div class="value" style="font-size:16px" id="expiredUser">—</div>
                  <div class="hint">Per riattivare l’accesso, invia richiesta.</div>
                </div>

                <div class="row" style="margin-top:12px">
                  <a class="btn primary" id="btnRenewMail" href="#">Richiedi rinnovo via email</a>
                  <button class="btn" id="btnBackLogin">Esci</button>
                </div>

                <div class="footer-note">
                  L’email verrà inviata a <b>wincklers85@googlemail.com</b> con oggetto e dettagli precompilati.
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Ultimo aggiornamento</h2>
            <div class="sub">solo lettura</div>
          </div>
          <div class="bd">
            <div class="kpi">
              <div class="label">Suggerimento</div>
              <div class="value" style="font-size:14px">Se ti serve l’accesso completo</div>
              <div class="hint">Chiedi rinnovo e indica il tuo utente.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="view" id="viewMain">
      <div class="grid">

        <!-- LEFT -->
        <div class="card">
          <div class="hd">
            <h2>Dashboard AWP</h2>
            <div class="sub" id="subMain">Pronto</div>
          </div>
          <div class="bd">
            <div class="row">
              <button class="btn primary" id="btnAnalyzeAll">Analizza tutti i sinottici</button>
              <button class="btn" id="btnClearCache">Reset cache</button>

              <span class="badge"><span class="dot" id="dotData"></span><span id="dataInfo">Dati: non caricati</span></span>
              <span class="badge"><span class="dot" id="dotHist"></span><span id="histInfo">Storico: 0 letture</span></span>
            </div>

            <div style="height:12px"></div>

            <div class="split">
              <div class="field">
                <label>Cerca (locale, modello, codeid, pda, comune…)</label>
                <input class="input" id="qSearch" placeholder="es. Molini, 7767..., PDA..." />
              </div>
              <div class="field">
                <label>Filtro rapido</label>
                <select id="qFilter">
                  <option value="all">Tutte</option>
                  <option value="likely">Probabile pagamento (Top)</option>
                  <option value="active">Solo attive (E)</option>
                  <option value="stale">Non aggiorna (≥3gg no link)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <span class="badge"><b id="countMachines">0</b>&nbsp;macchine</span>
              <span class="badge"><b id="countLocals">0</b>&nbsp;locali</span>
              <span class="badge"><b id="countModels">0</b>&nbsp;modelli</span>
              <span class="badge"><b id="countFiles">0</b>&nbsp;sinottici</span>
            </div>

            <div style="height:12px"></div>

            <div style="max-height:520px; overflow:auto; border-radius:14px; border:1px solid var(--line)">
              <table class="table" id="tblMachines">
                <thead>
                  <tr>
                    <th style="min-width:220px">Locale</th>
                    <th>Modello</th>
                    <th class="mono">CODEID</th>
                    <th>PDA</th>
                    <th>Stato</th>
                    <th style="min-width:140px">Prob. pagamento</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="footer-note">
              “Prob. pagamento” = scoring basato su ciclo (cicloslot) + trend storico (ΔIN/ΔOUT) + allineamento payout.
              È una stima.
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <div class="hd">
            <h2>AWIS | Assistente</h2>
            <div class="sub">domande sui dati</div>
          </div>
          <div class="bd">
            <div class="chat">
              <div class="chatlog" id="chatlog"></div>
              <div class="chatbar">
                <input class="input" id="chatInput" placeholder="Es: quali macchine sono in pagamento? / quando paga CODEID ...? / spiega CNTTOTIN" />
                <button class="btn primary" id="chatSend">Invia</button>
              </div>
              <div class="footer-note">
                AWIS usa i dati caricati.
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- DETAILS -->
      <div style="height:16px"></div>
      <div class="grid">

        <div class="card">
          <div class="hd">
            <h2 id="detailsTitle">Dettagli</h2>
            <div class="sub" id="detailsSub">Seleziona una macchina o un locale</div>
          </div>
          <div class="bd" id="detailsBody">
            <div class="kpis">
              <div class="kpi"><div class="label">Suggerimento</div><div class="value" style="font-size:14px">Seleziona una riga</div><div class="hint">Aprirai scheda macchina / locale.</div></div>
              <div class="kpi"><div class="label">Tip</div><div class="value" style="font-size:14px">Clicca: Locale / PDA / Comune</div><div class="hint">Filtri e schede correlate.</div></div>
              <div class="kpi"><div class="label">Storico</div><div class="value" style="font-size:14px">Deduplicato</div><div class="hint">Stessa data lettura = 1 punto.</div></div>
              <div class="kpi"><div class="label">Gestione</div><div class="value" style="font-size:14px">Tutto in RAM</div><div class="hint">Sessione in localStorage.</div></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Grafico</h2>
            <div class="sub" id="chartSub">Seleziona una macchina</div>
          </div>
          <div class="bd">
            <div class="row" style="margin-bottom:10px">
              <span class="badge">Vista:</span>
              <button class="btn small" id="btnChartIN">IN (Δ)</button>
              <button class="btn small" id="btnChartOUT">OUT (Δ)</button>
              <button class="btn small" id="btnChartPct">%</button>
              <span class="badge">Punti: <b id="chartPoints">0</b></span>
              <span class="badge">Limite: <b id="chartLimitLabel">120</b></span>
              <select id="chartLimit" class="input" style="min-width:120px">
                <option value="60">60</option>
                <option value="120" selected>120</option>
                <option value="250">250</option>
                <option value="999999">Tutto</option>
              </select>
            </div>
            <canvas id="chart" height="160"></canvas>
            <div class="footer-note">Il grafico mostra i <b>delta</b> tra letture consecutive (non i contatori assoluti).</div>
          </div>
        </div>

      </div>

      <!-- ADMIN PANEL -->
      <div style="height:16px"></div>
      <div class="card" id="adminPanel" style="display:none">
        <div class="hd">
          <h2>Admin | Diagnostica & Utenti</h2>
          <div class="sub">visibile solo admin</div>
        </div>
        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <div class="label">Utenti caricati</div>
              <div class="value" id="adminUsersCount">0</div>
              <div class="hint">Da ./Dati/users.json</div>
            </div>
            <div class="kpi">
              <div class="label">Sinottici in manifest</div>
              <div class="value" id="adminManifestCount">0</div>
              <div class="hint">Da ./Dati/manifest.json</div>
            </div>
            <div class="kpi">
              <div class="label">Macchine (snapshot)</div>
              <div class="value" id="adminMachinesCount">0</div>
              <div class="hint">Dopo analisi</div>
            </div>
            <div class="kpi">
              <div class="label">Storico (punti)</div>
              <div class="value" id="adminHistoryCount">0</div>
              <div class="hint">Deduplicato</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <details class="accordion" open>
            <summary>Lista utenti (read-only)</summary>
            <div class="acc-body">
              <div style="max-height:260px; overflow:auto; border-radius:14px; border:1px solid var(--line)">
                <table class="table" id="tblUsers">
                  <thead>
                    <tr>
                      <th>Utente</th>
                      <th>Livello</th>
                      <th>Scadenza</th>
                      <th>Stato</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="footer-note">
                Nota: su GitHub Pages non puoi “salvare” nuovi utenti lato server. Questo pannello è diagnostico.
              </div>
            </div>
          </details>

          <details class="accordion">
            <summary>Log diagnostico</summary>
            <div class="acc-body">
              <pre class="logbox" id="diagLog">Pronto.</pre>
            </div>
          </details>

        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">
    <b id="toastTitle">Info</b>
    <small id="toastMsg">…</small>
  </div>

  <script type="module" src="./assets/app.js"></script>
  <!-- MODAL: Scheda Macchina -->
<div class="modal" id="machineModal" style="display:none">
  <div class="modal-backdrop" data-close="1"></div>

  <div class="modal-card">
    <div class="modal-hd">
      <div>
        <div class="modal-title" id="mmTitle">Scheda macchina</div>
        <div class="modal-sub" id="mmSub">—</div>
      </div>
      <button class="btn small" id="mmClose">Chiudi</button>
    </div>

    <div class="modal-bd">
      <div class="kpis" id="mmKpis"></div>

      <div style="height:10px"></div>

      <div class="split">
        <div>
          <h3 class="h3">Predizione</h3>
          <div id="mmPredict" class="panel"></div>
        </div>
        <div>
          <h3 class="h3">Macchine uguali (altri locali)</h3>
          <div id="mmPeers" class="panel"></div>
        </div>
      </div>

      <div style="height:12px"></div>

      <h3 class="h3">Storico (ultime letture)</h3>
      <div style="max-height:260px; overflow:auto; border-radius:14px; border:1px solid var(--line)">
        <table class="table" id="mmHist">
          <thead>
            <tr>
              <th>Data</th>
              <th>ΔIN</th>
              <th>ΔOUT</th>
              <th>%</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="height:12px"></div>
      <h3 class="h3">Fingerprint modello (“algoritmo” estratto)</h3>
      <div id="mmAlgo" class="panel"></div>
    </div>
  </div>
</div>
</body>
</html>
