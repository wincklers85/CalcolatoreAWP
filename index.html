<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AWP Analyzer Pro ‚Äî v3.2</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
  --bg:#f7faff; --fg:#102030; --acc:#007bff; --muted:#708090;
  --card:#fff; --border:#d6dbe2; --orange:#ff8c00; --blue:#007bff;
}
/* Temi */
body.theme-bianco  {--bg:#fff;--fg:#111;--acc:#007bff;}
body.theme-azzurro {--bg:#e9f3ff;--fg:#001830;--acc:#007bff;}
body.theme-arancio {--bg:#fff7ef;--fg:#352200;--acc:#ff8c00;}
body.theme-windows {
  --bg:#c0c0c0;--fg:#000;--card:#dcdcdc;--border:#808080;--acc:#000080;
  font-family:"MS Sans Serif",Tahoma,sans-serif;
}

/* Layout base */
body{margin:0;background:var(--bg);color:var(--fg);
  font-family:Inter,system-ui,sans-serif;
  transition:background .3s,color .3s;}
header{display:flex;justify-content:space-between;align-items:center;
  padding:12px 20px;border-bottom:2px solid var(--border);
  background:linear-gradient(to bottom,var(--card),var(--bg));position:relative;}
h1{font-size:20px;margin:0;color:var(--acc);}main{padding:20px;}

/* Login */
#loginScreen{position:fixed;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;background:var(--bg);}
#loginBox{background:var(--card);border:1px solid var(--border);padding:30px;
  border-radius:10px;box-shadow:0 8px 25px rgba(0,0,0,.1);width:300px;text-align:center;}
input[type=text],input[type=password]{width:100%;padding:10px;margin:8px 0;
  border:1px solid var(--border);border-radius:5px;background:var(--bg);color:var(--fg);}
button{cursor:pointer;border:none;border-radius:6px;padding:10px 18px;
  font-weight:600;color:#fff;background:var(--acc);transition:.2s;}
button:hover{opacity:.9;}
small.version{display:block;margin-top:15px;color:var(--muted);}
#loginError{color:red;margin-top:8px;}

/* Caricamento */
#progressBarContainer{position:fixed;bottom:0;left:0;right:0;height:6px;background:#ddd;}
#progressBar{height:100%;width:0%;background:var(--acc);transition:width .3s;}

/* Dashboard */
#dashboard{display:none;}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:15px;margin-bottom:15px;box-shadow:0 3px 8px rgba(0,0,0,.05);}
.theme-windows .card{border:2px outset #fff;box-shadow:none;}
footer{text-align:center;padding:10px;font-size:12px;color:var(--muted);}
.fadeIn{animation:fadeIn .5s ease-in;}@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}

/* Menu utente */
#userMenu{position:absolute;right:20px;top:50px;background:var(--card);
  border:1px solid var(--border);border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.15);
  display:none;flex-direction:column;min-width:220px;z-index:50;}
#userMenu div{padding:10px;cursor:pointer;}
#userMenu div:hover{background:var(--acc);color:#fff;}
#userMenu input[type=number]{width:80px;padding:5px;margin-left:6px;}
</style>
</head>
<body class="theme-azzurro">

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginBox" class="fadeIn">
    <h1>AWP Analyzer Pro</h1>
    <input id="username" type="text" placeholder="Utente">
    <input id="password" type="password" placeholder="PIN">
    <button id="btnLogin">Accedi</button>
    <small class="version">Versione 3.2 ‚Äî Build 2025.11</small>
    <div style="margin-top:10px">
      <select id="themeSelect">
        <option value="azzurro" selected>Azzurro</option>
        <option value="bianco">Bianco</option>
        <option value="arancio">Arancio</option>
        <option value="windows">Windows 95</option>
      </select>
    </div>
    <div id="loginError"></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <header>
    <h1>AWP Analyzer Pro ‚Äî Dashboard</h1>
    <div id="userInfo" style="cursor:pointer;"></div>
    <div id="userMenu" class="fadeIn">
      <div><b>‚öôÔ∏è Impostazioni Utente</b></div>
      <div>
        ‚è± Timeout login (ore): 
        <input type="number" id="timeoutInput" min="1" max="168">
      </div>
      <div>
        üé® Tema:
        <select id="themeSelectMenu">
          <option value="azzurro">Azzurro</option>
          <option value="bianco">Bianco</option>
          <option value="arancio">Arancio</option>
          <option value="windows">Windows 95</option>
        </select>
      </div>
      <div id="logoutBtn" style="color:#d00;font-weight:600;">üö™ Logout</div>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>Stato caricamento dati</h2>
      <div id="loadStatus">In attesa dei file...</div>
    </div>

    <div class="card">
      <h2>Grafico generale (arriva nel BLOCCO 3)</h2>
      <canvas id="mainChart" width="900" height="320"></canvas>
    </div>
  </main>

  <footer>AWP Analyzer Pro v3.2 ‚Äî ¬© 2025 Stephan Winckler</footer>
</div>

<div id="progressBarContainer"><div id="progressBar"></div></div>

<script>
/* === LOGIN da Dati/users.json === */
async function doLogin(){
  const u=username.value.trim().toLowerCase();
  const pin=password.value.trim();
  try{
    const res=await fetch('Dati/users.json',{cache:'no-store'});
    if(!res.ok)throw new Error(`Impossibile leggere Dati/users.json (HTTP ${res.status})`);
    const users=await res.json();
    const user=users.find(x=>x.user.toLowerCase()===u&&x.pin===pin);
    if(!user){loginError.textContent="Credenziali non valide";return;}
    if(user.expires){
      const exp=new Date(user.expires);
      if(exp<new Date()){loginError.textContent="Abbonamento scaduto: "+user.expires;return;}
    }
    localStorage.setItem('awp_user',user.user);
    localStorage.setItem('awp_level',user.level);
    localStorage.setItem('awp_lastLogin',Date.now().toString());
    startApp(user.user,user.level);
  }catch(err){loginError.textContent="Errore: "+err.message;}
}
btnLogin.onclick=doLogin;

/* === Gestione sessione e logout === */
function startApp(u,level="Base"){
  loginScreen.style.display='none';
  dashboard.style.display='block';
  userInfo.textContent=`${u} (${level})`;
  timeoutInput.value=getSessionHours();
  themeSelectMenu.value=getTheme();
  loadManifestAndFiles();
}

function logout(){
  localStorage.removeItem('awp_user');
  localStorage.removeItem('awp_level');
  localStorage.removeItem('awp_lastLogin');
  loginScreen.style.display='flex';
  dashboard.style.display='none';
  username.value='';password.value='';
}

/* === Menu utente === */
userInfo.onclick=()=>{
  userMenu.style.display=(userMenu.style.display==='flex')?'none':'flex';
};
logoutBtn.onclick=logout;
document.addEventListener('click',e=>{
  if(!userMenu.contains(e.target)&&e.target!==userInfo)userMenu.style.display='none';
});

/* Timeout personalizzabile */
timeoutInput.onchange=()=>{
  const hrs=Math.max(1,Math.min(168,timeoutInput.value));
  localStorage.setItem('awp_sessionHours',hrs);
};

/* Tema nel menu */
themeSelectMenu.onchange=e=>{
  setTheme(e.target.value);
  localStorage.setItem('awp_theme',e.target.value);
};
function setTheme(th){
  document.body.className='theme-'+th;
}
function getTheme(){
  return localStorage.getItem('awp_theme')||'azzurro';
}
setTheme(getTheme());

/* Gestione sessione automatica */
function getSessionHours(){
  return parseInt(localStorage.getItem('awp_sessionHours')||'24');
}
const lastUser=localStorage.getItem('awp_user');
const lastLogin=parseInt(localStorage.getItem('awp_lastLogin')||'0');
const now=Date.now();
const limit=getSessionHours()*60*60*1000;
if(lastUser&&(now-lastLogin<limit)){
  startApp(lastUser,localStorage.getItem('awp_level')||'Base');
}else{
  logout();
}

/* === Barra di progresso === */
function setProgress(v){progressBar.style.width=v+"%";}

/* === Caricamento sinottici === */
async function loadManifestAndFiles(){
  const div=document.getElementById('loadStatus');
  setProgress(0);
  try{
    const res=await fetch('Dati/manifest.json',{cache:'no-store'});
    if(!res.ok)throw new Error("Manifest non trovato o accesso negato");
    const manifest=await res.json();
    const files=Array.isArray(manifest)?manifest:(manifest.sinottici||[]);
    if(!files.length)throw new Error("Nessun file trovato nel manifest");
    let done=0,total=files.length,all=[];
    for(const f of files){
      div.innerHTML=`Carico <b>${f}</b> (${done+1}/${total})...`;
      const part=await readXLS(`Dati/${f}`);
      all.push(...part);done++;
      setProgress(Math.round(done/total*100));
      await new Promise(r=>setTimeout(r,50));
    }
    div.innerHTML=`Caricate ${all.length} righe da ${total} file ‚úî`;
  }catch(e){div.innerHTML="Errore: "+e.message;}
}

/* === Lettura Excel === */
async function readXLS(url){
  const res=await fetch(url);
  if(!res.ok)throw new Error("File mancante: "+url);
  const buf=await res.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'});
  return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:'',raw:false});
}
  /* === BLOCCO 2 ‚Äî Analisi e Previsioni Slot === */

/**
 * Dopo il caricamento di tutti i file, viene chiamata questa funzione.
 * Riceve un array con tutte le righe aggregate dai sinottici.
 */
async function analizzaDatiSlot(allData) {
  const areaAnalisi = document.createElement('div');
  areaAnalisi.className = 'card';
  areaAnalisi.innerHTML = "<h2>Analisi Predittiva Slot</h2><div id='resultGrid'></div>";
  document.querySelector('main').appendChild(areaAnalisi);

  const grid = document.getElementById('resultGrid');
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = 'repeat(auto-fit,minmax(240px,1fr))';
  grid.style.gap = '10px';

  // Raggruppa per N¬∞ macchina o nome
  const macchine = {};
  for (const r of allData) {
    const id = r["N¬∞"] || r["MATRICOLA"] || r["MACHINE"] || "Sconosciuta";
    if (!macchine[id]) macchine[id] = [];
    macchine[id].push(r);
  }

  // Calcola metriche per ciascuna macchina
  for (const id of Object.keys(macchine)) {
    const rows = macchine[id];
    const numerici = rows.map(r => ({
      in: parseFloat(r.CNTTOTIN || r.IN || 0),
      out: parseFloat(r.CNTTOTOUT || r.OUT || 0)
    })).filter(x => x.in > 0);

    if (numerici.length < 2) continue;

    const IN = numerici.map(x => x.in);
    const OUT = numerici.map(x => x.out);
    const diff = numerici.map((x, i) => x.in - x.out);
    const totaleIn = IN[IN.length - 1] - IN[0];
    const totaleOut = OUT[OUT.length - 1] - OUT[0];
    const payout = totaleOut / (totaleIn || 1) * 100;
    const varianza = Math.sqrt(diff.map(x => (x - (totaleIn - totaleOut) / diff.length) ** 2)
                                .reduce((a, b) => a + b, 0) / diff.length);
    const trend = diff[diff.length - 1] - diff[0];

    // Valutazione predittiva
    let stato = '';
    let colore = '';
    let prob = 0;
    if (payout < 60 && trend > 0) { stato = 'üí∞ Alta probabilit√† di pagamento'; colore = '#00a000'; prob = 0.9; }
    else if (payout < 80) { stato = 'üü° Potenziale medio'; colore = '#ffaa00'; prob = 0.6; }
    else if (payout < 100) { stato = 'üü† Paga poco probabile'; colore = '#cc6600'; prob = 0.3; }
    else { stato = 'üî¥ Ciclo scarico o appena pagato'; colore = '#cc0000'; prob = 0.1; }

    // Crea box visivo
    const box = document.createElement('div');
    box.style.border = `2px solid ${colore}`;
    box.style.borderRadius = '8px';
    box.style.padding = '10px';
    box.style.background = 'var(--card)';
    box.innerHTML = `
      <b>${id}</b><br>
      Payout medio: ${payout.toFixed(1)}%<br>
      Variazione ciclo: ${trend.toFixed(0)} crediti<br>
      <b style="color:${colore}">${stato}</b>
      <canvas id="chart_${id}" width="200" height="80"></canvas>
    `;
    grid.appendChild(box);

    // Disegno grafico rapido
    const ctx = box.querySelector('canvas').getContext('2d');
    ctx.lineWidth = 2;

    // Linea verde IN
    ctx.strokeStyle = 'green';
    ctx.beginPath();
    for (let i = 0; i < IN.length; i++) {
      const x = (i / (IN.length - 1)) * 200;
      const y = 80 - (IN[i] - IN[0]) / (IN[IN.length - 1] - IN[0] || 1) * 80;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Linea blu OUT
    ctx.strokeStyle = 'blue';
    ctx.beginPath();
    for (let i = 0; i < OUT.length; i++) {
      const x = (i / (OUT.length - 1)) * 200;
      const y = 80 - (OUT[i] - OUT[0]) / (OUT[OUT.length - 1] - OUT[0] || 1) * 80;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Previsione (linee tratteggiate)
    const previsioni = 10;
    const lastIn = IN[IN.length - 1];
    const lastOut = OUT[OUT.length - 1];
    const deltaIn = (IN[IN.length - 1] - IN[IN.length - 5]) / 5;
    const deltaOut = (OUT[OUT.length - 1] - OUT[OUT.length - 5]) / 5;

    ctx.setLineDash([4, 3]);
    ctx.strokeStyle = 'red';
    ctx.beginPath();
    ctx.moveTo(200, 80 - (IN[IN.length - 1] - IN[0]) / (IN[IN.length - 1] - IN[0] || 1) * 80);
    ctx.lineTo(200 + 20, 80 - ((lastIn + deltaIn * previsioni) - IN[0]) / (IN[IN.length - 1] - IN[0] || 1) * 80);
    ctx.stroke();

    ctx.strokeStyle = 'gold';
    ctx.beginPath();
    ctx.moveTo(200, 80 - (OUT[OUT.length - 1] - OUT[0]) / (OUT[OUT.length - 1] - OUT[0] || 1) * 80);
    ctx.lineTo(200 + 20, 80 - ((lastOut + deltaOut * previsioni) - OUT[0]) / (OUT[OUT.length - 1] - OUT[0] || 1) * 80);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  areaAnalisi.scrollIntoView({ behavior: 'smooth' });
}

/* Integra il motore al termine del caricamento */
const oldLoad = loadManifestAndFiles;
loadManifestAndFiles = async function () {
  const div = document.getElementById('loadStatus');
  setProgress(0);
  try {
    const res = await fetch('Dati/manifest.json', { cache: 'no-store' });
    if (!res.ok) throw new Error("Manifest non trovato o accesso negato");
    const manifest = await res.json();
    const files = Array.isArray(manifest) ? manifest : (manifest.sinottici || []);
    if (!files.length) throw new Error("Nessun file trovato nel manifest");
    let done = 0, total = files.length, all = [];
    for (const f of files) {
      div.innerHTML = `Carico <b>${f}</b> (${done + 1}/${total})...`;
      const part = await readXLS(`Dati/${f}`);
      all.push(...part); done++;
      setProgress(Math.round(done / total * 100));
      await new Promise(r => setTimeout(r, 50));
    }
    div.innerHTML = `Caricate ${all.length} righe da ${total} file ‚úî`;
    // Avvia l‚Äôanalisi
    analizzaDatiSlot(all);
  } catch (e) {
    div.innerHTML = "Errore: " + e.message;
  }
};
  /* === BLOCCO 3 ‚Äî Grafico Avanzato & Filtri === */

// Carica Chart.js
const chartScript = document.createElement("script");
chartScript.src = "https://cdn.jsdelivr.net/npm/chart.js";
document.head.appendChild(chartScript);

chartScript.onload = () => {
  console.log("Chart.js caricato ‚úî");
};

// Contenitore principale
const graficoCard = document.createElement("div");
graficoCard.className = "card";
graficoCard.innerHTML = `
  <h2>üìà Analisi Temporale e Previsioni</h2>
  <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;">
    <select id="slotSelect" style="padding:6px;border:1px solid var(--border);border-radius:6px;">
      <option value="all">Tutte le macchine</option>
    </select>
    <div style="flex:1"></div>
    <button class="periodBtn" data-p="7">Settimana</button>
    <button class="periodBtn" data-p="30">Mese</button>
    <button class="periodBtn" data-p="365">Anno</button>
    <button class="periodBtn" data-p="all">Tutto</button>
    <button class="periodBtn" data-p="forecast">Previsioni</button>
  </div>
  <canvas id="graficoGenerale" height="350"></canvas>
`;
document.querySelector("main").appendChild(graficoCard);

// Variabili globali
let chart;
let currentData = [];
let slotList = [];

// Ricostruisci i dati aggregati per grafico grande
async function preparaDatiPerGrafico(allData) {
  // Ricava colonna tempo
  const groupByDay = {};
  for (const r of allData) {
    const dateRaw = r["DATA LETTURA"] || r["DATA"] || r["DATE"] || "";
    const d = new Date(dateRaw);
    if (isNaN(d)) continue;
    const key = d.toISOString().substring(0, 10);
    const inVal = parseFloat(r.CNTTOTIN || r.IN || 0);
    const outVal = parseFloat(r.CNTTOTOUT || r.OUT || 0);
    if (!groupByDay[key]) groupByDay[key] = { in: 0, out: 0 };
    groupByDay[key].in += inVal;
    groupByDay[key].out += outVal;
  }

  const points = Object.keys(groupByDay)
    .sort()
    .map(k => ({
      date: k,
      in: groupByDay[k].in,
      out: groupByDay[k].out
    }));

  currentData = points;
  slotList = [...new Set(allData.map(r => r["N¬∞"] || r["MATRICOLA"] || "Sconosciuta"))];
  aggiornaSelectSlot();
  disegnaGrafico("all", "all");
}

// Aggiorna menu a tendina con macchine
function aggiornaSelectSlot() {
  const sel = document.getElementById("slotSelect");
  slotList.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
  sel.onchange = () => disegnaGrafico(sel.value, "all");
}

// Funzione per disegnare/aggiornare grafico
function disegnaGrafico(slot, periodo) {
  if (!window.Chart || !currentData.length) return;
  const ctx = document.getElementById("graficoGenerale").getContext("2d");

  // Filtro periodo
  let dati = [...currentData];
  if (periodo !== "all" && periodo !== "forecast") {
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - parseInt(periodo));
    dati = dati.filter(p => new Date(p.date) >= cutoff);
  }

  const labels = dati.map(p => p.date);
  const inData = dati.map(p => p.in);
  const outData = dati.map(p => p.out);

  // Calcolo forecast base (lineare)
  const steps = 10;
  const lastIn = inData[inData.length - 1];
  const lastOut = outData[outData.length - 1];
  const deltaIn = (lastIn - inData[inData.length - 5]) / 5;
  const deltaOut = (lastOut - outData[outData.length - 5]) / 5;
  const forecastLabels = [];
  const forecastIn = [];
  const forecastOut = [];

  for (let i = 1; i <= steps; i++) {
    const future = new Date(labels[labels.length - 1]);
    future.setDate(future.getDate() + i);
    forecastLabels.push(future.toISOString().substring(0, 10));
    forecastIn.push(lastIn + deltaIn * i);
    forecastOut.push(lastOut + deltaOut * i);
  }

  const datasets = [
    {
      label: "IN",
      data: inData,
      borderColor: "green",
      fill: false,
      tension: 0.1
    },
    {
      label: "OUT",
      data: outData,
      borderColor: "blue",
      fill: false,
      tension: 0.1
    }
  ];

  if (periodo === "forecast") {
    datasets.push({
      label: "Forecast IN",
      data: forecastIn,
      borderColor: "red",
      borderDash: [4, 3],
      fill: false
    });
    datasets.push({
      label: "Forecast OUT",
      data: forecastOut,
      borderColor: "gold",
      borderDash: [4, 3],
      fill: false
    });
  }

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: { labels: [...labels, ...(periodo === "forecast" ? forecastLabels : [])], datasets },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "var(--fg)" } },
        title: { display: false }
      },
      scales: {
        x: { ticks: { color: "var(--fg)" } },
        y: { ticks: { color: "var(--fg)" }, beginAtZero: true }
      }
    }
  });
}

// Collega bottoni periodo
document.querySelectorAll(".periodBtn").forEach(btn => {
  btn.onclick = () => {
    const p = btn.dataset.p;
    const slot = document.getElementById("slotSelect").value;
    disegnaGrafico(slot, p);
  };
});

// Integra con BLOCCO 2
const oldAnalizza = analizzaDatiSlot;
analizzaDatiSlot = async function (allData) {
  await oldAnalizza(allData);
  preparaDatiPerGrafico(allData);
};
  /* === BLOCCO 4 ‚Äî Report & Filtri Intelligenti === */

function creaSezioneReport() {
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>üìä Report & Filtri Intelligenti</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
      <input id="searchInput" type="text" placeholder="Cerca slot per nome o matricola"
        style="flex:2;padding:8px;border:1px solid var(--border);border-radius:6px;">
      <label>Payout min % <input id="payoutMin" type="number" value="0"
        style="width:70px;margin-left:5px;padding:5px;"></label>
      <label>max % <input id="payoutMax" type="number" value="200"
        style="width:70px;margin-left:5px;padding:5px;"></label>
      <button id="applyFilter" style="background:var(--acc);color:#fff;border:none;
        border-radius:6px;padding:8px 14px;cursor:pointer;">Filtra</button>
      <button id="exportCSV" style="background:var(--orange);color:#fff;border:none;
        border-radius:6px;padding:8px 14px;cursor:pointer;">Esporta CSV</button>
    </div>
    <div id="reportSummary"
      style="font-weight:600;margin-bottom:6px;color:var(--muted);"></div>
    <div id="reportTable"
      style="overflow-x:auto;max-height:400px;border-top:1px solid var(--border);"></div>
  `;
  document.querySelector("main").appendChild(card);
}

let analisiGlobale = [];

/* Popola la tabella riepilogativa */
function aggiornaReport(lista) {
  const tableDiv = document.getElementById("reportTable");
  if (!lista.length) {
    tableDiv.innerHTML = "<i>Nessuna slot corrispondente ai criteri.</i>";
    return;
  }

  const hot = lista.filter(x => x.status.includes("Alta")).length;
  const mid = lista.filter(x => x.status.includes("medio")).length;
  const cold = lista.filter(x => x.status.includes("poco") || x.status.includes("scarico")).length;

  document.getElementById("reportSummary").textContent =
    `üî• Calde: ${hot} | üü° Medie: ${mid} | ‚ùÑÔ∏è Fredde: ${cold} | Totale: ${lista.length}`;

  let html = `
    <table style="width:100%;border-collapse:collapse;">
      <thead style="background:var(--bg);position:sticky;top:0;">
        <tr>
          <th style="text-align:left;padding:6px;">Slot</th>
          <th>Payout %</th>
          <th>Trend Crediti</th>
          <th>Probabilit√†</th>
          <th>Stato</th>
        </tr>
      </thead><tbody>`;
  lista.forEach(x => {
    html += `
      <tr>
        <td style="padding:6px;">${x.id}</td>
        <td style="text-align:center;">${x.payout.toFixed(1)}</td>
        <td style="text-align:center;">${x.trend.toFixed(0)}</td>
        <td style="text-align:center;">${(x.prob * 100).toFixed(0)}%</td>
        <td style="text-align:center;">${x.status}</td>
      </tr>`;
  });
  html += "</tbody></table>";
  tableDiv.innerHTML = html;
}

/* Applica i filtri e aggiorna */
function applicaFiltri() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const min = parseFloat(document.getElementById("payoutMin").value || 0);
  const max = parseFloat(document.getElementById("payoutMax").value || 200);
  const filtrati = analisiGlobale.filter(
    x =>
      (!q || x.id.toLowerCase().includes(q)) &&
      x.payout >= min && x.payout <= max
  );
  aggiornaReport(filtrati);
}

/* Esporta CSV */
function esportaCSV() {
  if (!analisiGlobale.length) return;
  let csv = "Slot,Payout%,Trend,Probabilit√†,Stato\n";
  analisiGlobale.forEach(x => {
    csv += `${x.id},${x.payout.toFixed(1)},${x.trend.toFixed(0)},${(x.prob*100).toFixed(0)}%,${x.status}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "report_awp.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* Integra con BLOCCO 2 & 3 */
const oldAnalizza2 = analizzaDatiSlot;
analizzaDatiSlot = async function (allData) {
  await oldAnalizza2(allData);
  creaSezioneReport();

  // Ricrea i dati globali sintetici per il report
  const macchine = {};
  for (const r of allData) {
    const id = r["N¬∞"] || r["MATRICOLA"] || "Sconosciuta";
    if (!macchine[id]) macchine[id] = [];
    macchine[id].push(r);
  }

  analisiGlobale = [];
  for (const id of Object.keys(macchine)) {
    const rows = macchine[id];
    const IN = rows.map(x => parseFloat(x.CNTTOTIN || x.IN || 0));
    const OUT = rows.map(x => parseFloat(x.CNTTOTOUT || x.OUT || 0));
    if (IN.length < 2 || OUT.length < 2) continue;

    const payout = ((OUT[OUT.length - 1] - OUT[0]) /
      ((IN[IN.length - 1] - IN[0]) || 1)) * 100;
    const trend = (IN[IN.length - 1] - OUT[OUT.length - 1]) -
                  (IN[0] - OUT[0]);

    let status = "Neutro", prob = 0.5;
    if (payout < 60 && trend > 0) { status = "Alta probabilit√†"; prob = 0.9; }
    else if (payout < 80) { status = "Media"; prob = 0.6; }
    else if (payout < 100) { status = "Bassa"; prob = 0.3; }
    else { status = "Scarico"; prob = 0.1; }

    analisiGlobale.push({ id, payout, trend, prob, status });
  }

  aggiornaReport(analisiGlobale);

  document.getElementById("applyFilter").onclick = applicaFiltri;
  document.getElementById("exportCSV").onclick = esportaCSV;
  document.getElementById("searchInput").oninput = applicaFiltri;
}
</script>
</body>
</html>
