<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calcolatore AWP - Analisi Pagamento</title>

  <!-- SheetJS (XLSX parser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js"></script>
  <!-- Chart.js for readable charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius: 14px;

      --accent:#2563eb; /* default blue */
      --accent2:#1d4ed8;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;

      --chip:#eef2ff;
      --chipText:#1e3a8a;
    }
    [data-accent="amber"]{ --accent:#d97706; --accent2:#b45309; --chip:#fffbeb; --chipText:#92400e;}
    [data-accent="lime"]{ --accent:#65a30d; --accent2:#4d7c0f; --chip:#f7fee7; --chipText:#365314;}
    [data-accent="violet"]{ --accent:#7c3aed; --accent2:#6d28d9; --chip:#f5f3ff; --chipText:#4c1d95;}
    [data-accent="teal"]{ --accent:#0f766e; --accent2:#115e59; --chip:#f0fdfa; --chipText:#134e4a;}

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(246,247,251,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      padding:12px 16px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:800;
      letter-spacing:.2px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 30px rgba(37,99,235,.25);
      display:grid; place-items:center;
      color:white; font-weight:900;
    }
    .brand small{ display:block; font-weight:600; color:var(--muted); letter-spacing:0; }
    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: 0 6px 16px rgba(17,24,39,.06);
    }
    .btn.primary{
      background:var(--accent);
      color:white;
      border-color:transparent;
      box-shadow:0 10px 22px rgba(37,99,235,.25);
    }
    .btn:active{ transform: translateY(1px); }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--muted);
      font-weight:700;
      font-size:13px;
      display:flex; gap:8px; align-items:center;
    }

    .wrap{
      max-width:1200px; margin:0 auto;
      padding:16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media(min-width: 980px){
      .grid.two{ grid-template-columns: 1.2fr .8fr; }
      .grid.three{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card-title{
      font-weight:900;
      letter-spacing:.2px;
    }
    .card-sub{
      margin-top:4px;
      color:var(--muted);
      font-weight:600;
      font-size:13px;
      line-height:1.3;
    }
    .card-body{ padding:14px; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .grow{ flex:1; }
    .input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:700;
      outline:none;
    }
    .input:focus{ border-color: rgba(37,99,235,.35); box-shadow: 0 0 0 4px rgba(37,99,235,.10); }

    .select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(min-width: 760px){
      .kpi{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg,#fff, #fbfbff);
    }
    .kpi .label{ color:var(--muted); font-weight:800; font-size:12px; letter-spacing:.2px;}
    .kpi .value{ font-size:22px; font-weight:950; margin-top:6px;}
    .kpi .hint{ color:var(--muted); font-weight:700; font-size:12px; margin-top:4px;}

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px;
      border-radius:999px;
      background:var(--chip);
      color:var(--chipText);
      font-weight:900;
      font-size:12px;
    }

    .tablewrap{ overflow:auto; border:1px solid var(--line); border-radius:14px; }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:13px;
      white-space: nowrap;
    }
    th{
      position:sticky; top:0; z-index:1;
      background:#fafafa;
      font-weight:950;
      letter-spacing:.2px;
    }
    tr:hover td{ background:#fbfbff; }
    .link{
      color:var(--accent);
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
    }
    .muted{ color:var(--muted); font-weight:700; }
    .tag{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      border:1px solid var(--line);
      background:#fff;
    }
    .tag.good{ color:var(--good); border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.06); }
    .tag.warn{ color:var(--warn); border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.08); }
    .tag.bad{ color:var(--bad); border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.07); }

    .toast{
      position:fixed; right:14px; bottom:14px;
      background:var(--card);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius:14px;
      padding:12px 14px;
      max-width:min(520px, calc(100vw - 28px));
      display:none;
      z-index:50;
    }
    .toast.show{ display:block; }
    .toast b{ font-weight:950; }
    .toast p{ margin:6px 0 0; color:var(--muted); font-weight:700; line-height:1.35; }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:40;
    }
    .modal.show{ display:flex; }
    .modal .panel{
      width:min(1100px, 100%);
      max-height: 90vh;
      overflow:auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.22);
    }
    .panel-head{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      position:sticky; top:0;
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
    }
    .panel-title{ font-weight:950; }
    .panel-sub{ color:var(--muted); font-weight:700; font-size:13px; margin-top:4px; }
    .panel-body{ padding:14px; }

    /* Login */
    .login-wrap{
      min-height: calc(100vh - 68px);
      display:grid;
      place-items:center;
    }
    .login-card{
      width:min(520px, 100%);
    }
    .hero{
      padding:16px 14px 0;
      display:flex; gap:12px; align-items:center;
    }
    .hero h1{ margin:0; font-size:20px; font-weight:950; letter-spacing:.2px; }
    .hero p{ margin:6px 0 0; color:var(--muted); font-weight:700; }

    /* Assistant */
    .chat{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    .chatlog{
      height: 320px;
      overflow:auto;
      padding:12px;
      background: linear-gradient(180deg, #fff, #fbfbff);
    }
    .msg{
      margin:8px 0;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .bubble{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      max-width: 86%;
      font-weight:700;
      line-height:1.35;
    }
    .me .bubble{
      margin-left:auto;
      background: rgba(37,99,235,.06);
      border-color: rgba(37,99,235,.16);
    }
    .bot .bubble{
      background:#fff;
    }
    .chatbar{
      display:flex; gap:10px;
      padding:12px;
      border-top:1px solid var(--line);
      background:#fff;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">AWP</div>
        <div>
          <div>Calcolatore AWP</div>
          <small>Analisi pagamento e gestionale sinottici</small>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="sessionPill" style="display:none;">
          <span id="sessionUser">—</span>
          <span class="muted">·</span>
          <span id="sessionLevel">—</span>
        </div>

        <select class="select" id="accentSelect" title="Colore interfaccia">
          <option value="blue">Blu</option>
          <option value="amber">Amber</option>
          <option value="lime">Lime</option>
          <option value="violet">Violet</option>
          <option value="teal">Teal</option>
        </select>

        <button class="btn" id="btnLogout" style="display:none;">Esci</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="app">
    <!-- LOGIN -->
    <div id="viewLogin" class="login-wrap" style="display:none;">
      <div class="card login-card">
        <div class="hero">
          <div class="logo" style="width:46px;height:46px;border-radius:16px;">A</div>
          <div>
            <h1>Calcolatore AWP</h1>
            <p>Analisi pagamento da sinottici e gestione locali/PDA.</p>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="grow">
              <label class="muted">Utente</label>
              <input id="loginUser" class="input" placeholder="Es. user" autocomplete="username" />
            </div>
            <div class="grow">
              <label class="muted">PIN</label>
              <input id="loginPin" class="input" placeholder="Es. 0000" autocomplete="current-password" inputmode="numeric" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <button class="btn primary" id="btnLogin">Entra</button>
            <span class="muted" id="loginStatus">Caricamento utenti…</span>
          </div>
          <div style="margin-top:12px" class="muted">
            I file dati sono letti da <b>/Dati/</b> (GitHub). Tutto gira nel browser.
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div id="viewMain" style="display:none;">
      <div class="grid two">
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Dashboard AWP</div>
              <div class="card-sub">
                Carica i sinottici da <b>Dati/manifest.json</b> e analizza tutte le macchine.
              </div>
            </div>
            <div class="row">
              <button class="btn primary" id="btnAnalyze">Analizza tutti i sinottici</button>
            </div>
          </div>

          <div class="card-body">
            <div class="kpi">
              <div class="box">
                <div class="label">Sinottici</div>
                <div class="value" id="kpiFiles">0</div>
                <div class="hint" id="kpiFilesHint">—</div>
              </div>
              <div class="box">
                <div class="label">Macchine uniche</div>
                <div class="value" id="kpiMachines">0</div>
                <div class="hint">per CODEID</div>
              </div>
              <div class="box">
                <div class="label">Letture (storico)</div>
                <div class="value" id="kpiReads">0</div>
                <div class="hint">deduplicate per lettura</div>
              </div>
              <div class="box">
                <div class="label">In pagamento (stima)</div>
                <div class="value" id="kpiPaying">0</div>
                <div class="hint">probabilità alta</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="row">
              <input id="searchBox" class="input" placeholder="Cerca per locale, modello, comune, provincia, pda, codeid…" />
              <select id="filterPay" class="select">
                <option value="all">Tutte</option>
                <option value="paying">Prob. pagamento alta</option>
                <option value="notpaying">Prob. pagamento bassa</option>
              </select>
              <select id="filterState" class="select">
                <option value="all">Stato: tutti</option>
                <option value="ATTIVA">ATTIVA</option>
                <option value="MANUTENZIONE">MANUTENZIONE</option>
                <option value="BLOCCATA">BLOCCATA</option>
                <option value="FERIE">FERIE</option>
              </select>
            </div>

            <div style="height:12px"></div>

            <div class="tablewrap">
              <table id="machinesTable">
                <thead>
                  <tr>
                    <th>Locale</th>
                    <th>Comune</th>
                    <th>Prov.</th>
                    <th>Modello</th>
                    <th>CODEID</th>
                    <th>PDA</th>
                    <th>Ultima lettura</th>
                    <th>IN (€)</th>
                    <th>OUT (€)</th>
                    <th>Δ IN</th>
                    <th>Δ OUT</th>
                    <th>Ciclo</th>
                    <th>Posizione ciclo</th>
                    <th>Prob. pagamento</th>
                    <th>Stato</th>
                  </tr>
                </thead>
                <tbody id="machinesTbody">
                  <tr><td colspan="15" class="muted">Premi “Analizza tutti i sinottici” per popolare la lista.</td></tr>
                </tbody>
              </table>
            </div>

            <div style="height:10px"></div>
            <div class="muted" id="loadLog">—</div>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Assistente A.W.I.S.E.</div>
              <div class="card-sub">Capisce domande “umane” e usa i dati caricati. Offline, quindi niente magie: solo logica + dataset.</div>
            </div>
            <span class="chip">A.W.I.S.E.</span>
          </div>
          <div class="card-body">
            <div class="chat">
              <div class="chatlog" id="chatLog"></div>
              <div class="chatbar">
                <input id="chatInput" class="input" placeholder='Es. "quando paga la MARIM FIRE al Bar Fortini?"' />
                <button class="btn primary" id="chatSend">Invia</button>
              </div>
            </div>
            <div style="height:10px"></div>
            <div class="muted">
              Suggerimenti: “spiegami NOE”, “quali sono in pagamento a Sanremo”, “scheda locale Bar X”.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MACHINE MODAL -->
  <div class="modal" id="modalMachine">
    <div class="panel">
      <div class="panel-head">
        <div>
          <div class="panel-title" id="mTitle">Macchina</div>
          <div class="panel-sub" id="mSub">—</div>
        </div>
        <div class="row">
          <button class="btn" id="mClose">Chiudi</button>
        </div>
      </div>
      <div class="panel-body" id="mBody">
        <!-- filled by JS -->
      </div>
    </div>
  </div>

  <!-- LIST MODAL -->
  <div class="modal" id="modalList">
    <div class="panel">
      <div class="panel-head">
        <div>
          <div class="panel-title" id="lTitle">Lista</div>
          <div class="panel-sub" id="lSub">—</div>
        </div>
        <div class="row">
          <button class="btn" id="lClose">Chiudi</button>
        </div>
      </div>
      <div class="panel-body" id="lBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">
    <b id="toastTitle">Info</b>
    <p id="toastMsg">—</p>
  </div>

<script>
/* =========================================================
   CALCOLATORE AWP - Single file
   Path corretto per GitHub Pages: NON usare "/Dati/.."
   Usare "Dati/.." relativo.
========================================================= */

(function(){
  // ---------- Helpers ----------
  const $ = (q)=>document.querySelector(q);
  const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
  const fmtEUR = (n)=> (isFinite(n)? n.toLocaleString("it-IT",{minimumFractionDigits:0, maximumFractionDigits:0}) : "—");
  const fmtNum = (n)=> (isFinite(n)? n.toLocaleString("it-IT") : "—");
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  function toast(title,msg){
    $("#toastTitle").textContent = title;
    $("#toastMsg").textContent = msg;
    const t = $("#toast");
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>t.classList.remove("show"), 4200);
  }

  // ---------- Config paths ----------
  // IMPORTANT: relative path. Works on:
  // https://user.github.io/Repo/  AND local server.
  const PATH = {
    users: "Dati/users.json",
    manifest: "Dati/manifest.json",
    cicloslot: "Dati/cicloslot.json",
    sinottico: (name)=> `Dati/${encodeURIComponent(name)}`
  };

  // ---------- State in RAM ----------
  const S = {
    users: [],
    session: null, // {user, level, expires}
    manifest: {sinottici:[]},
    ciclos: [], // mapping modello->ciclo
    byCodeId: new Map(), // CODEID -> machine object
    machineList: [], // derived list for table
    filesLoaded: 0,
    readsTotal: 0,
    payingCount: 0,
    analyzing: false
  };

  // ---------- Accent preference ----------
  const savedAccent = localStorage.getItem("awp_accent") || "blue";
  document.documentElement.dataset.accent = savedAccent;
  $("#accentSelect").value = savedAccent;
  $("#accentSelect").addEventListener("change", ()=>{
    const v = $("#accentSelect").value;
    document.documentElement.dataset.accent = v;
    localStorage.setItem("awp_accent", v);
  });

  // ---------- Session persistence ----------
  function loadSession(){
    try{
      const raw = localStorage.getItem("awp_session");
      if(!raw) return null;
      const s = JSON.parse(raw);
      if(!s || !s.user) return null;
      // expiry check
      if(s.expires){
        const exp = new Date(s.expires + "T00:00:00");
        if(isFinite(exp) && exp < new Date()){
          localStorage.removeItem("awp_session");
          return null;
        }
      }
      return s;
    }catch{ return null; }
  }
  function saveSession(sess){
    localStorage.setItem("awp_session", JSON.stringify(sess));
  }
  function clearSession(){
    localStorage.removeItem("awp_session");
  }

  // ---------- Fetch JSON with better errors ----------
  async function fetchJSON(url){
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok){
      throw new Error(`HTTP ${res.status} su ${url}`);
    }
    return await res.json();
  }

  // ---------- Load base data ----------
  async function boot(){
    // Check external libs
    if(typeof XLSX === "undefined"){
      toast("Errore", "Libreria XLSX non caricata. Verifica connessione o blocco CDN.");
      $("#loginStatus").textContent = "Errore: XLSX non caricato.";
      return;
    }

    try{
      S.users = await fetchJSON(PATH.users);
      $("#loginStatus").textContent = "Utenti caricati.";
    }catch(err){
      $("#loginStatus").textContent = "Errore caricamento utenti.";
      toast("Errore", `Non riesco a leggere ${PATH.users}. Hai usato path assoluto nel codice? Dettaglio: ${err.message}`);
    }

    // Auto session
    const sess = loadSession();
    if(sess){
      S.session = sess;
      showMain();
      return;
    }
    showLogin();
  }

  // ---------- Views ----------
  function showLogin(){
    $("#viewLogin").style.display = "grid";
    $("#viewMain").style.display = "none";
    $("#btnLogout").style.display = "none";
    $("#sessionPill").style.display = "none";
  }
  function showMain(){
    $("#viewLogin").style.display = "none";
    $("#viewMain").style.display = "block";
    $("#btnLogout").style.display = "inline-flex";
    $("#sessionPill").style.display = "flex";
    $("#sessionUser").textContent = S.session?.user || "—";
    $("#sessionLevel").textContent = S.session?.level || "—";
    awiseHello();
  }

  // ---------- Login ----------
  $("#btnLogin").addEventListener("click", doLogin);
  $("#loginPin").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  $("#loginUser").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

  function normalizeUser(u){ return (u||"").trim().toLowerCase(); }

  function doLogin(){
    const user = normalizeUser($("#loginUser").value);
    const pin = ($("#loginPin").value||"").trim();

    if(!user || !pin){
      toast("Login", "Inserisci utente e PIN.");
      return;
    }
    const found = (S.users||[]).find(x => normalizeUser(x.user)===user && String(x.pin).trim()===pin);
    if(!found){
      toast("Login", "Utente non trovato o PIN errato.");
      return;
    }
    // expiry
    if(found.expires){
      const exp = new Date(found.expires + "T00:00:00");
      if(isFinite(exp) && exp < new Date()){
        toast("Login", "Utente scaduto (abbonamento terminato).");
        return;
      }
    }

    S.session = { user: found.user, level: found.level, expires: found.expires || null };
    saveSession(S.session);
    toast("Accesso", `Benvenuto ${found.user} (${found.level})`);
    showMain();
  }

  $("#btnLogout").addEventListener("click", ()=>{
    clearSession();
    S.session = null;
    toast("Sessione", "Sei uscito.");
    showLogin();
  });

  // ---------- Analysis Pipeline ----------
  $("#btnAnalyze").addEventListener("click", analyzeAll);

  async function analyzeAll(){
    if(S.analyzing) return;
    S.analyzing = true;
    $("#loadLog").textContent = "Avvio analisi…";

    try{
      // load manifest & ciclos
      S.manifest = await fetchJSON(PATH.manifest);
      S.ciclos = await fetchJSON(PATH.cicloslot);

      const files = (S.manifest?.sinottici || []).slice();
      $("#kpiFiles").textContent = String(files.length);
      $("#kpiFilesHint").textContent = files.length ? `Da manifest.json` : "manifest vuoto";

      if(!files.length){
        toast("Manifest", "Nessun sinottico in manifest.json.");
        S.analyzing = false;
        return;
      }

      // reset RAM datasets
      S.byCodeId.clear();
      S.machineList = [];
      S.filesLoaded = 0;
      S.readsTotal = 0;
      S.payingCount = 0;

      // load with concurrency
      const concurrency = 3;
      let i = 0;

      async function worker(id){
        while(i < files.length){
          const idx = i++;
          const fname = files[idx];
          $("#loadLog").textContent = `Carico (${idx+1}/${files.length}) ${fname}…`;
          try{
            await loadOneSinottico(fname);
            S.filesLoaded++;
          }catch(err){
            console.warn("Load fail", fname, err);
          }
          await sleep(10);
        }
      }

      const workers = Array.from({length:concurrency}, (_,k)=>worker(k));
      await Promise.all(workers);

      // finalize list
      buildMachineList();
      renderTable();

      $("#kpiMachines").textContent = String(S.byCodeId.size);
      $("#kpiReads").textContent = String(S.readsTotal);
      $("#kpiPaying").textContent = String(S.payingCount);

      toast("Analisi completata", `Letti ${S.filesLoaded}/${files.length} sinottici. Macchine: ${S.byCodeId.size}.`);
      $("#loadLog").textContent = `OK. Sinottici letti: ${S.filesLoaded}/${files.length}. Macchine: ${S.byCodeId.size}. Letture: ${S.readsTotal}.`;
    }catch(err){
      toast("Errore", err.message);
      $("#loadLog").textContent = `Errore: ${err.message}`;
    }finally{
      S.analyzing = false;
    }
  }

  // ---------- XLSX parsing ----------
  function toNumberEuroFromCounters(v){
    // CNT fields: last 2 digits are cents to remove
    if(v===null || v===undefined || v==="") return NaN;
    const s = String(v).replace(/\s/g,"").replace(/\./g,"").replace(/,/g,"");
    if(!/^\d+$/.test(s)) return NaN;
    const n = parseInt(s,10);
    return Math.floor(n/100); // remove cents
  }

  function toText(v){
    if(v===null || v===undefined) return "";
    return String(v).trim();
  }

  function parseDateTime(value){
    // Excel can provide Date object, ISO, or string
    if(value instanceof Date && isFinite(value)) return value;
    const s = toText(value);
    if(!s) return null;
    // Try Italian formats: "28/12/2025 09:20" etc
    // Or "2025-12-28 09:20"
    let d = new Date(s);
    if(isFinite(d)) return d;

    // dd/mm/yyyy hh:mm
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
    if(m){
      const dd = parseInt(m[1],10);
      const mm = parseInt(m[2],10)-1;
      const yy = parseInt(m[3],10);
      const hh = m[4]? parseInt(m[4],10):0;
      const mi = m[5]? parseInt(m[5],10):0;
      const dt = new Date(yy,mm,dd,hh,mi,0);
      return isFinite(dt)? dt : null;
    }
    return null;
  }

  function normalizeHeader(h){
    return toText(h)
      .toUpperCase()
      .replace(/\s+/g," ")
      .replace(/[’']/g,"'")
      .replace(/\./g,".")
      .trim();
  }

  const COL = {
    CODEID: ["CODEID"],
    CODEID_PROVV: ["CODEID PROVV","CODEID PROVV."],
    DESCR_STATO: ["DESCR. STATO","DESCR STATO","STATO"],
    DATA_ATTIVAZIONE: ["DATA ATTIVAZIONE"],
    DATA_ULTIMO_COLLEGAMENTO: ["DATA ULTIMO COLLEGAMENTO"],
    GG_MANCATO_COLLEGAMENTO: ["GG MANCATO COLLEGAMENTO"],
    GG_DECADENZA: ["GG DECADENZA"],
    DATA_ULTIMA_LETTURA: ["DATA ULTIMA LETTURA VAL.","DATA ULTIMA LETTURA VAL", "DATA ULTIMA LETTURA"],
    CNTTOTIN: ["CNTTOTIN"],
    CNTTOTOT: ["CNTTOTOT","CNTTOTOUT","CNTTOTO T","CNTTOTOT."],
    MS_FERIE: ["M.S. / FERIE","M.S./ FERIE","M.S./FERIE"],
    MAC_PDA: ["MACADDRESS PDA","MACADDRESS", "MAC PDA", "PDA"],
    CODICE_SEDE: ["CODICE SEDE"],
    CODICE_PDV_AAMS: ["CODICE PDV AAMS","PDV AAMS","CODICE PDV"],
    DENOM_SEDE: ["DENOMIN. SEDE","DENOMIN SEDE","DENOMINAZIONE SEDE","SEDE"],
    INDIRIZZO: ["INDIRIZZO"],
    PROVINCIA: ["PROVINCIA","PROV."],
    COMUNE: ["COMUNE"],
    CODICE_IS_ESERCENTE: ["CODICE IS ESERCENTE","IS ESERCENTE"],
    PRATICA_AMM: ["PRATICA AMMINISTRATIVA"],
    STATO_PRATICA: ["STATO PRATICA"],
    DATA_RILASCIO_NOE: ["DATA RILASCIO N.O.E.","DATA RILASCIO NOE"],
    CODICE_MODELLO: ["CODICE MODELLO"],
    MODELLO: ["MODELLO"],
    PERC_OUT: ["% OUT","%OUT"],
    EM: ["E/M"],
    NOE: ["NOE"],
    INCASSO_GIORNALIERO: ["INCASSO GIORNALIERO"],
    MEDIA_INCASSO: ["MEDIA INCASSO GG ESERCIZIO"],
    WARNING: ["WARNING"],
    IR_AWP: ["IR AWP"]
  };

  function buildHeaderMap(headers){
    const map = {};
    const norm = headers.map(normalizeHeader);

    function findKey(possibles){
      for(const p of possibles){
        const target = normalizeHeader(p);
        const idx = norm.indexOf(target);
        if(idx>=0) return idx;
      }
      return -1;
    }

    for(const k of Object.keys(COL)){
      const idx = findKey(COL[k]);
      map[k] = idx;
    }
    return map;
  }

  async function loadOneSinottico(filename){
    const url = PATH.sinottico(filename);
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status} su ${url}`);
    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab, {type:"array"});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});
    if(rows.length < 2) return;

    const headers = rows[0];
    const H = buildHeaderMap(headers);

    // sanity check: must have CODEID and DATA_ULTIMA_LETTURA
    if(H.CODEID < 0){
      console.warn("No CODEID in", filename, headers);
      return;
    }

    for(let r=1; r<rows.length; r++){
      const row = rows[r];
      const codeid = toText(row[H.CODEID]);
      if(!codeid) continue;

      const rec = extractRecord(row, H, filename);
      upsertRecord(rec);
    }
  }

  function extractRecord(row, H, filename){
    const get = (key)=> (H[key]>=0 ? row[H[key]] : "");
    const codeid = toText(get("CODEID"));

    const lastRead = parseDateTime(get("DATA_ULTIMA_LETTURA"));
    const inEuro = toNumberEuroFromCounters(get("CNTTOTIN"));
    const outEuro = toNumberEuroFromCounters(get("CNTTOTOT"));

    const record = {
      sourceFile: filename,
      codeid,
      codeidProvv: toText(get("CODEID_PROVV")),
      stato: toText(get("DESCR_STATO")).toUpperCase(),
      dataAttivazione: parseDateTime(get("DATA_ATTIVAZIONE")),
      dataUltimoColleg: parseDateTime(get("DATA_ULTIMO_COLLEGAMENTO")),
      ggMancato: Number(toText(get("GG_MANCATO_COLLEGAMENTO")) || NaN),
      ggDecadenza: Number(toText(get("GG_DECADENZA")) || NaN),
      lastRead,
      cntIn: inEuro,
      cntOut: outEuro,
      msFerie: toText(get("MS_FERIE")),
      pdaMac: toText(get("MAC_PDA")),
      codiceSede: toText(get("CODICE_SEDE")),
      codicePDV: toText(get("CODICE_PDV_AAMS")),
      denominSede: toText(get("DENOM_SEDE")),
      indirizzo: toText(get("INDIRIZZO")),
      provincia: toText(get("PROVINCIA")).toUpperCase(),
      comune: toText(get("COMUNE")),
      codiceISEsercente: toText(get("CODICE_IS_ESERCENTE")),
      praticaAmm: toText(get("PRATICA_AMM")),
      statoPratica: toText(get("STATO_PRATICA")),
      dataRilascioNOE: parseDateTime(get("DATA_RILASCIO_NOE")),
      codiceModello: toText(get("CODICE_MODELLO")),
      modello: toText(get("MODELLO")),
      percOut: Number(String(get("PERC_OUT")).replace("%","").replace(",",".") || NaN),
      em: toText(get("EM")),
      noe: toText(get("NOE")),
      incassoGiornaliero: Number(String(get("INCASSO_GIORNALIERO")).replace(",",".") || NaN),
      mediaIncasso: Number(String(get("MEDIA_INCASSO")).replace(",",".") || NaN),
      warning: toText(get("WARNING")),
      irAwp: toText(get("IR_AWP"))
    };

    return record;
  }

  function cicloFor(codiceModello){
    if(!codiceModello) return null;
    const x = S.ciclos.find(c => String(c.codiceModello) === String(codiceModello));
    return x ? Number(x.ciclo) : null;
  }

  function upsertRecord(rec){
    // Dedup rule: same machine + same lastRead + same in/out -> ignore
    const keyRead = [
      rec.lastRead ? rec.lastRead.toISOString() : "noDate",
      isFinite(rec.cntIn) ? rec.cntIn : "NaN",
      isFinite(rec.cntOut) ? rec.cntOut : "NaN"
    ].join("|");

    let m = S.byCodeId.get(rec.codeid);
    if(!m){
      m = {
        codeid: rec.codeid,
        codiceModello: rec.codiceModello,
        modello: rec.modello,
        ciclo: cicloFor(rec.codiceModello),
        locale: rec.denominSede,
        comune: rec.comune,
        provincia: rec.provincia,
        indirizzo: rec.indirizzo,
        codiceSede: rec.codiceSede,
        codicePDV: rec.codicePDV,
        pdaMac: rec.pdaMac,
        noe: rec.noe,
        stato: rec.stato,
        warning: rec.warning,
        em: rec.em,
        percOut: rec.percOut,
        history: [],
        _dedup: new Set()
      };
      S.byCodeId.set(rec.codeid, m);
    }

    // update “static-ish” fields if empty
    if(!m.modello && rec.modello) m.modello = rec.modello;
    if(!m.codiceModello && rec.codiceModello) m.codiceModello = rec.codiceModello;
    if(!m.ciclo) m.ciclo = cicloFor(m.codiceModello);

    if(!m.locale && rec.denominSede) m.locale = rec.denominSede;
    if(!m.comune && rec.comune) m.comune = rec.comune;
    if(!m.provincia && rec.provincia) m.provincia = rec.provincia;
    if(!m.indirizzo && rec.indirizzo) m.indirizzo = rec.indirizzo;

    if(!m.codiceSede && rec.codiceSede) m.codiceSede = rec.codiceSede;
    if(!m.codicePDV && rec.codicePDV) m.codicePDV = rec.codicePDV;
    if(!m.pdaMac && rec.pdaMac) m.pdaMac = rec.pdaMac;
    if(!m.noe && rec.noe) m.noe = rec.noe;

    // keep latest status
    if(rec.stato) m.stato = rec.stato;
    if(rec.warning) m.warning = rec.warning;
    if(rec.em) m.em = rec.em;
    if(isFinite(rec.percOut)) m.percOut = rec.percOut;

    // dedup
    if(m._dedup.has(keyRead)) return;
    m._dedup.add(keyRead);

    // push history entry
    m.history.push({
      t: rec.lastRead ? rec.lastRead.getTime() : null,
      iso: rec.lastRead ? rec.lastRead.toISOString() : null,
      in: rec.cntIn,
      out: rec.cntOut,
      incassoGiornaliero: rec.incassoGiornaliero,
      mediaIncasso: rec.mediaIncasso,
      stato: rec.stato,
      pdaMac: rec.pdaMac || m.pdaMac || "",
      locale: rec.denominSede || m.locale || "",
      comune: rec.comune || m.comune || "",
      provincia: rec.provincia || m.provincia || "",
      sourceFile: rec.sourceFile
    });

    // sort by time (nulls at end)
    m.history.sort((a,b)=>{
      if(a.t===null && b.t===null) return 0;
      if(a.t===null) return 1;
      if(b.t===null) return -1;
      return a.t - b.t;
    });

    S.readsTotal++;
  }

  // ---------- Derived list & “payment probability” ----------
  function buildMachineList(){
    S.machineList = [];

    for(const m of S.byCodeId.values()){
      const h = m.history.filter(x => x.t!==null);

      // latest
      const last = h.length ? h[h.length-1] : null;
      const prev = h.length>=2 ? h[h.length-2] : null;

      const inLast = last?.in;
      const outLast = last?.out;

      const dIn = (last && prev && isFinite(last.in) && isFinite(prev.in)) ? (last.in - prev.in) : NaN;
      const dOut = (last && prev && isFinite(last.out) && isFinite(prev.out)) ? (last.out - prev.out) : NaN;

      // ciclo position estimate: (IN - OUT) mod ciclo (very rough)
      const ciclo = m.ciclo || null;
      let pos = null;
      if(ciclo && isFinite(inLast) && isFinite(outLast)){
        const net = Math.max(0, (inLast - outLast));
        pos = net % ciclo;
      }

      // “probabilità pagamento” (robusta ma onesta):
      // - usa posizione nel ciclo (se disponibile)
      // - confronta variabilità ΔOUT vs ΔIN
      // - confronta pattern modello: distribuzione pos su tutte le macchine stesso modello
      const pay = paymentScore(m, pos);

      S.machineList.push({
        codeid: m.codeid,
        locale: m.locale || "",
        comune: m.comune || "",
        provincia: m.provincia || "",
        modello: m.modello || "",
        codiceModello: m.codiceModello || "",
        pda: (last?.pdaMac || m.pdaMac || ""),
        lastRead: last?.iso || "",
        in: inLast,
        out: outLast,
        dIn, dOut,
        ciclo,
        pos,
        payScore: pay.score,
        payLabel: pay.label,
        stato: m.stato || ""
      });
    }

    // count paying
    S.payingCount = S.machineList.filter(x=>x.payScore>=0.72).length;

    // Sort: paying first, then by lastRead desc
    S.machineList.sort((a,b)=>{
      if(b.payScore !== a.payScore) return b.payScore - a.payScore;
      return String(b.lastRead).localeCompare(String(a.lastRead));
    });
  }

  function paymentScore(machine, pos){
    const h = machine.history.filter(x=>x.t!==null);
    const ciclo = machine.ciclo;

    // fallback if too little data
    if(h.length < 2){
      return {score:0.40, label:"Dati insufficienti"};
    }

    const last = h[h.length-1];
    const prev = h[h.length-2];

    const dIn = (isFinite(last.in) && isFinite(prev.in)) ? (last.in - prev.in) : 0;
    const dOut = (isFinite(last.out) && isFinite(prev.out)) ? (last.out - prev.out) : 0;

    // base score
    let score = 0.50;

    // If ciclo known, the closer to end, the higher.
    if(ciclo && pos!==null){
      const ratio = pos / ciclo; // 0..1
      // emphasize last 20%
      score += Math.max(0, (ratio - 0.80)) * 1.8; // up to +0.36
      // mid-late 60..80%
      score += Math.max(0, Math.min(0.80, ratio) - 0.60) * 0.35; // up to +0.07
    }

    // If ΔOUT spikes relative to ΔIN -> suggests payout event happened
    if(dOut > 0 && dIn > 0){
      const rel = dOut / dIn; // >0
      if(rel > 0.75) score += 0.12;
      else if(rel < 0.35) score -= 0.06;
    }

    // Model correlation: compare current pos distribution among same model
    if(ciclo && pos!==null){
      const same = [];
      for(const m2 of S.byCodeId.values()){
        if(String(m2.codiceModello) !== String(machine.codiceModello)) continue;
        const h2 = m2.history.filter(x=>x.t!==null);
        if(!h2.length) continue;
        const last2 = h2[h2.length-1];
        if(!isFinite(last2.in) || !isFinite(last2.out) || !m2.ciclo) continue;
        const net = Math.max(0,(last2.in-last2.out));
        const p2 = net % m2.ciclo;
        same.push(p2 / m2.ciclo);
      }
      if(same.length >= 6){
        // percentile of current ratio within same-model ratios
        const r = pos / ciclo;
        const sorted = same.slice().sort((a,b)=>a-b);
        const idx = sorted.findIndex(x => x >= r);
        const pct = idx<0 ? 1 : idx / sorted.length;
        // higher percentile -> closer to "late cycle" relative to others
        score += (pct - 0.5) * 0.14; // -0.07 .. +0.07
      }
    }

    // clamp
    score = Math.max(0.05, Math.min(0.98, score));

    let label = "Media";
    if(score >= 0.72) label = "Alta";
    else if(score <= 0.38) label = "Bassa";

    return {score, label};
  }

  // ---------- Render table + filters ----------
  $("#searchBox").addEventListener("input", renderTable);
  $("#filterPay").addEventListener("change", renderTable);
  $("#filterState").addEventListener("change", renderTable);

  function renderTable(){
    const q = ($("#searchBox").value||"").trim().toLowerCase();
    const fp = $("#filterPay").value;
    const fs = $("#filterState").value;

    const tb = $("#machinesTbody");
    tb.innerHTML = "";

    if(!S.machineList.length){
      tb.innerHTML = `<tr><td colspan="15" class="muted">Nessun dato. Premi “Analizza tutti i sinottici”.</td></tr>`;
      return;
    }

    let list = S.machineList.slice();

    if(q){
      list = list.filter(x=>{
        const hay = [
          x.locale, x.comune, x.provincia, x.modello, x.codeid, x.pda, x.codiceModello
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }
    if(fp==="paying") list = list.filter(x=>x.payScore>=0.72);
    if(fp==="notpaying") list = list.filter(x=>x.payScore<0.72);

    if(fs!=="all"){
      list = list.filter(x => (x.stato||"").toUpperCase().includes(fs));
    }

    if(!list.length){
      tb.innerHTML = `<tr><td colspan="15" class="muted">Nessun risultato con questi filtri.</td></tr>`;
      return;
    }

    // keep table responsive: show top 800 rows for safety
    const maxRows = 800;
    const show = list.slice(0,maxRows);

    for(const x of show){
      const tr = el("tr");
      tr.append(
        tdLink(x.locale || "—", ()=>openLocale(x.locale)),
        tdLink(x.comune || "—", ()=>openList("Comune", x.comune, (m)=> (m.comune||"")===(x.comune||""))),
        tdLink(x.provincia || "—", ()=>openList("Provincia", x.provincia, (m)=> (m.provincia||"")===(x.provincia||""))),
        tdLink(x.modello || "—", ()=>openMachine(x.codeid)),
        tdMono(x.codeid),
        tdLink(x.pda || "—", ()=>openList("PDA", x.pda, (m)=> latestPda(m) === (x.pda||""))),
        tdMono(x.lastRead ? x.lastRead.replace("T"," ").slice(0,16) : "—"),
        tdNum(x.in),
        tdNum(x.out),
        tdDelta(x.dIn),
        tdDelta(x.dOut),
        tdMono(x.ciclo ? fmtNum(x.ciclo) : "—"),
        tdMono(x.pos!==null ? `${fmtNum(x.pos)} / ${fmtNum(x.ciclo||0)}` : "—"),
        tdPay(x.payScore, x.payLabel),
        tdTagState(x.stato)
      );
      tr.addEventListener("click",(e)=>{
        // If user clicked links, they already handled.
        // otherwise open machine detail:
        if(e.target.classList.contains("link")) return;
        openMachine(x.codeid);
      });
      tb.appendChild(tr);
    }

    if(list.length > maxRows){
      const tr = el("tr");
      tr.innerHTML = `<td colspan="15" class="muted">Mostro ${maxRows} righe su ${list.length} (per prestazioni). Usa i filtri per restringere.</td>`;
      tb.appendChild(tr);
    }
  }

  function tdMono(text){
    const td = el("td");
    td.textContent = text;
    td.style.fontFamily = "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
    td.style.fontWeight = "800";
    return td;
  }
  function tdNum(n){
    const td = el("td");
    td.textContent = isFinite(n) ? fmtEUR(n) : "—";
    td.style.fontWeight = "900";
    return td;
  }
  function tdDelta(n){
    const td = el("td");
    if(!isFinite(n)){ td.textContent="—"; td.className="muted"; return td; }
    td.textContent = (n>=0? "+":"") + fmtEUR(n);
    td.style.fontWeight = "950";
    td.style.color = n>0 ? "var(--text)" : "var(--muted)";
    return td;
  }
  function tdLink(text, fn){
    const td = el("td");
    const a = el("span",{className:"link", textContent: text});
    a.addEventListener("click",(e)=>{ e.stopPropagation(); fn(); });
    td.appendChild(a);
    return td;
  }
  function tdPay(score,label){
    const td = el("td");
    const tag = el("span",{className:"tag " + (score>=0.72?"good": score<=0.38?"bad":"warn")});
    tag.textContent = `${label} (${Math.round(score*100)}%)`;
    td.appendChild(tag);
    return td;
  }
  function tdTagState(stato){
    const td = el("td");
    const s = (stato||"").toUpperCase();
    let cls = "warn";
    if(s.includes("ATT")) cls="good";
    if(s.includes("BLOCC")) cls="bad";
    const tag = el("span",{className:"tag "+cls});
    tag.textContent = stato || "—";
    td.appendChild(tag);
    return td;
  }

  function latestPda(machine){
    const h = machine.history.filter(x=>x.t!==null);
    if(!h.length) return machine.pdaMac || "";
    return h[h.length-1].pdaMac || machine.pdaMac || "";
  }

  // ---------- Machine modal ----------
  let chartInstance = null;

  $("#mClose").addEventListener("click", ()=>$("#modalMachine").classList.remove("show"));

  function openMachine(codeid){
    const m = S.byCodeId.get(codeid);
    if(!m){ toast("Macchina", "Non trovata."); return; }

    $("#mTitle").textContent = `${m.modello || "Macchina"} · ${m.codeid}`;
    $("#mSub").textContent = `${m.locale || "—"} · ${m.comune || "—"} (${m.provincia || "—"})`;

    const h = m.history.filter(x=>x.t!==null);
    const last = h.length ? h[h.length-1] : null;
    const ciclo = m.ciclo || null;
    let pos = null;
    if(ciclo && last && isFinite(last.in) && isFinite(last.out)){
      const net = Math.max(0,(last.in-last.out));
      pos = net % ciclo;
    }
    const pay = paymentScore(m, pos);

    // build details
    const root = el("div");

    // header chips
    const chips = el("div",{className:"row"});
    chips.append(
      chip("Locale", m.locale || "—", ()=>openLocale(m.locale)),
      chip("Comune", m.comune || "—", ()=>openList("Comune", m.comune, (x)=> (x.comune||"")===(m.comune||""))),
      chip("Provincia", m.provincia || "—", ()=>openList("Provincia", m.provincia, (x)=> (x.provincia||"")===(m.provincia||""))),
      chip("PDA", latestPda(m) || "—", ()=>openList("PDA", latestPda(m), (x)=> latestPda(x) === latestPda(m))),
    );
    root.appendChild(chips);

    // KPI
    const box = el("div",{className:"kpi", style:"margin-top:12px"});
    box.append(
      kpiBox("Ultima lettura", last?.iso ? last.iso.replace("T"," ").slice(0,16) : "—", "DATA ULTIMA LETTURA VAL."),
      kpiBox("IN totale", isFinite(last?.in)? fmtEUR(last.in) : "—", "CNTTOTIN (€/100)"),
      kpiBox("OUT totale", isFinite(last?.out)? fmtEUR(last.out) : "—", "CNTTOTOT (€/100)"),
      kpiBox("Prob. pagamento", `${pay.label} (${Math.round(pay.score*100)}%)`, ciclo ? `ciclo ${fmtNum(ciclo)}` : "ciclo non noto")
    );
    root.appendChild(box);

    // Detail grid
    const det = el("div",{className:"grid two", style:"margin-top:12px"});
    det.appendChild(detailCard("Anagrafica", [
      ["CODEID", m.codeid],
      ["CODEID PROVV", (m.history[0]?.codeidProvv)||"—"],
      ["CODICE MODELLO", m.codiceModello || "—"],
      ["MODELLO", m.modello || "—"],
      ["NOE", m.noe || "—"],
      ["E/M", m.em || "—"],
      ["% OUT", isFinite(m.percOut)? (m.percOut+"%") : "—"],
      ["STATO", m.stato || "—"],
      ["WARNING", m.warning || "—"],
      ["CODICE SEDE", m.codiceSede || "—"],
      ["CODICE PDV AAMS", m.codicePDV || "—"]
    ]));

    det.appendChild(detailCard("Dati locale", [
      ["DENOMIN. SEDE", m.locale || "—"],
      ["INDIRIZZO", m.indirizzo || "—"],
      ["COMUNE", m.comune || "—"],
      ["PROVINCIA", m.provincia || "—"],
      ["PDA (MACADDRESS)", latestPda(m) || "—"]
    ]));
    root.appendChild(det);

    // Chart
    const chartCard = el("div",{className:"card", style:"margin-top:12px"});
    chartCard.appendChild(el("div",{className:"card-head", innerHTML: `<div><div class="card-title">Storico contatori</div><div class="card-sub">Grafico decimato per leggibilità (mantiene trend e punti chiave).</div></div>`}));
    const cb = el("div",{className:"card-body"});
    const canvas = el("canvas");
    cb.appendChild(canvas);
    chartCard.appendChild(cb);
    root.appendChild(chartCard);

    // Table history (last N but with option all)
    const histCard = el("div",{className:"card", style:"margin-top:12px"});
    histCard.appendChild(el("div",{className:"card-head", innerHTML:`<div><div class="card-title">Letture</div><div class="card-sub">Deduplicate: stesso timestamp e stessi contatori non viene duplicato.</div></div>`}));
    const hb = el("div",{className:"card-body"});

    const limit = 120;
    const show = h.length > limit ? h.slice(h.length-limit) : h.slice();
    hb.appendChild(buildHistoryTable(show, h.length > limit ? `Mostro ultime ${limit} su ${h.length}` : `Totale letture: ${h.length}`));
    histCard.appendChild(hb);
    root.appendChild(histCard);

    $("#mBody").innerHTML = "";
    $("#mBody").appendChild(root);
    $("#modalMachine").classList.add("show");

    renderHistoryChart(canvas, h);
  }

  function chip(label, value, onClick){
    const c = el("span",{className:"chip"});
    c.innerHTML = `<span style="opacity:.75">${label}:</span> <span>${escapeHtml(value)}</span>`;
    if(onClick){
      c.style.cursor = "pointer";
      c.addEventListener("click",(e)=>{ e.stopPropagation(); onClick(); });
    }
    return c;
  }
  function kpiBox(label, value, hint){
    const b = el("div",{className:"box"});
    b.append(
      el("div",{className:"label", textContent: label}),
      el("div",{className:"value", textContent: value}),
      el("div",{className:"hint", textContent: hint})
    );
    return b;
  }

  function detailCard(title, pairs){
    const c = el("div",{className:"card"});
    c.appendChild(el("div",{className:"card-head", innerHTML:`<div><div class="card-title">${escapeHtml(title)}</div><div class="card-sub">Tocca le voci cliccabili per filtrare.</div></div>`}));
    const b = el("div",{className:"card-body"});
    const tw = el("div",{className:"tablewrap"});
    const t = el("table",{style:"min-width: 520px"});
    t.innerHTML = `<thead><tr><th>Campo</th><th>Valore</th></tr></thead>`;
    const tb = el("tbody");
    for(const [k,v] of pairs){
      const tr = el("tr");
      tr.appendChild(el("td",{textContent:k, className:"muted"}));
      const tdv = el("td");
      tdv.textContent = v ?? "—";
      tdv.style.fontWeight="900";
      tr.appendChild(tdv);
      tb.appendChild(tr);
    }
    t.appendChild(tb);
    tw.appendChild(t);
    b.appendChild(tw);
    c.appendChild(b);
    return c;
  }

  function buildHistoryTable(rows, caption){
    const wrap = el("div");
    wrap.appendChild(el("div",{className:"muted", textContent: caption, style:"margin-bottom:8px"}));
    const tw = el("div",{className:"tablewrap"});
    const t = el("table",{style:"min-width: 980px"});
    t.innerHTML = `<thead><tr>
      <th>DATA ULTIMA LETTURA</th>
      <th>IN</th>
      <th>OUT</th>
      <th>NET (IN-OUT)</th>
      <th>PDA</th>
      <th>FILE</th>
    </tr></thead>`;
    const tb = el("tbody");
    for(const r of rows){
      const tr = el("tr");
      tr.append(
        tdMono(r.iso ? r.iso.replace("T"," ").slice(0,16) : "—"),
        tdNum(r.in),
        tdNum(r.out),
        tdNum(isFinite(r.in)&&isFinite(r.out)? (r.in-r.out) : NaN),
        tdMono(r.pdaMac || "—"),
        tdMono(r.sourceFile || "—")
      );
      tb.appendChild(tr);
    }
    t.appendChild(tb);
    tw.appendChild(t);
    wrap.appendChild(tw);
    return wrap;
  }

  function renderHistoryChart(canvas, history){
    if(chartInstance){
      chartInstance.destroy();
      chartInstance = null;
    }
    const h = history.filter(x=>x.t!==null && isFinite(x.in) && isFinite(x.out));
    if(h.length < 2){
      canvas.parentElement.innerHTML = `<div class="muted">Storico insufficiente per un grafico leggibile.</div>`;
      return;
    }

    // Decimation: keep first, last, and sample evenly up to 240 points
    const maxPts = 240;
    let sampled = h;
    if(h.length > maxPts){
      const step = Math.ceil(h.length / maxPts);
      sampled = [];
      for(let i=0; i<h.length; i+=step) sampled.push(h[i]);
      if(sampled[sampled.length-1] !== h[h.length-1]) sampled.push(h[h.length-1]);
    }

    const labels = sampled.map(x=>{
      const d = new Date(x.t);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${dd}/${mm} ${hh}:${mi}`;
    });

    const dataIn = sampled.map(x=>x.in);
    const dataOut = sampled.map(x=>x.out);
    const dataNet = sampled.map(x=>x.in - x.out);

    chartInstance = new Chart(canvas.getContext("2d"),{
      type:"line",
      data:{
        labels,
        datasets:[
          {label:"IN", data:dataIn, borderWidth:2, pointRadius:0, tension:0.22},
          {label:"OUT", data:dataOut, borderWidth:2, pointRadius:0, tension:0.22},
          {label:"NET (IN-OUT)", data:dataNet, borderWidth:2, pointRadius:0, tension:0.22}
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:true, labels:{boxWidth:12, font:{weight:"700"}}},
          tooltip:{mode:"index", intersect:false}
        },
        interaction:{mode:"index", intersect:false},
        scales:{
          x:{ticks:{maxRotation:0, autoSkip:true, maxTicksLimit:10}},
          y:{ticks:{callback:(v)=>fmtEUR(v)}}
        }
      }
    });
    canvas.style.height = "320px";
  }

  // ---------- List & Locale modal ----------
  $("#lClose").addEventListener("click", ()=>$("#modalList").classList.remove("show"));

  function openList(kind, value, predicate){
    const matches = [];
    for(const m of S.byCodeId.values()){
      if(predicate(m)) matches.push(m);
    }
    matches.sort((a,b)=> String(a.locale||"").localeCompare(String(b.locale||"")));

    $("#lTitle").textContent = `${kind}: ${value || "—"}`;
    $("#lSub").textContent = `Macchine: ${matches.length}`;

    const body = el("div");

    const tw = el("div",{className:"tablewrap"});
    const t = el("table",{style:"min-width: 980px"});
    t.innerHTML = `<thead><tr>
      <th>Locale</th><th>Comune</th><th>Prov</th><th>Modello</th><th>CODEID</th><th>PDA</th><th>Ultima lettura</th><th>IN</th><th>OUT</th>
    </tr></thead>`;
    const tb = el("tbody");

    for(const m of matches){
      const h = m.history.filter(x=>x.t!==null);
      const last = h.length ? h[h.length-1] : null;
      const tr = el("tr");
      tr.append(
        tdLink(m.locale||"—", ()=>openLocale(m.locale)),
        tdMono(m.comune||"—"),
        tdMono(m.provincia||"—"),
        tdLink(m.modello||"—", ()=>openMachine(m.codeid)),
        tdMono(m.codeid),
        tdMono(latestPda(m)||"—"),
        tdMono(last?.iso ? last.iso.replace("T"," ").slice(0,16) : "—"),
        tdNum(last?.in),
        tdNum(last?.out),
      );
      tb.appendChild(tr);
    }
    t.appendChild(tb);
    tw.appendChild(t);
    body.appendChild(tw);

    $("#lBody").innerHTML = "";
    $("#lBody").appendChild(body);
    $("#modalList").classList.add("show");
  }

  function openLocale(localeName){
    if(!localeName){
      toast("Locale", "Nome locale mancante.");
      return;
    }
    // Find all machines with same locale (exact match)
    const machines = [];
    for(const m of S.byCodeId.values()){
      if((m.locale||"") === localeName) machines.push(m);
    }
    machines.sort((a,b)=> String(latestPda(a)).localeCompare(String(latestPda(b))) || String(a.modello||"").localeCompare(String(b.modello||"")));

    $("#lTitle").textContent = `Scheda locale: ${localeName}`;
    $("#lSub").textContent = `Macchine: ${machines.length}`;

    // Group by PDA
    const byPda = new Map();
    for(const m of machines){
      const p = latestPda(m) || "—";
      if(!byPda.has(p)) byPda.set(p, []);
      byPda.get(p).push(m);
    }

    // Totals by day/week/month from available history
    const now = new Date();
    const dayAgo = now.getTime() - 24*3600*1000;
    const weekAgo = now.getTime() - 7*24*3600*1000;
    const monthAgo = now.getTime() - 30*24*3600*1000;

    function sumDeltaSince(ts){
      let sum = 0;
      for(const m of machines){
        const h = m.history.filter(x=>x.t!==null && isFinite(x.in));
        if(h.length < 2) continue;
        // find last entry <= now, and earliest entry >= ts
        const last = h[h.length-1];
        // find oldest entry after ts (closest to ts)
        let base = null;
        for(let i=h.length-1; i>=0; i--){
          if(h[i].t >= ts) base = h[i];
          else break;
        }
        if(base && isFinite(last.in) && isFinite(base.in)){
          sum += (last.in - base.in);
        }
      }
      return sum;
    }

    const body = el("div");
    const k = el("div",{className:"kpi"});
    k.append(
      kpiBox("Giocato 24h", fmtEUR(sumDeltaSince(dayAgo)), "stima da contatori IN"),
      kpiBox("Giocato 7gg", fmtEUR(sumDeltaSince(weekAgo)), "stima da contatori IN"),
      kpiBox("Giocato 30gg", fmtEUR(sumDeltaSince(monthAgo)), "stima da contatori IN"),
      kpiBox("PDA", String(byPda.size), "gruppi MACADDRESS")
    );
    body.appendChild(k);

    // Render groups
    for(const [pda, list] of byPda.entries()){
      const c = el("div",{className:"card", style:"margin-top:12px"});
      c.appendChild(el("div",{className:"card-head", innerHTML:`<div><div class="card-title">PDA: ${escapeHtml(pda)}</div><div class="card-sub">Macchine collegate a questo PDA</div></div>`}));
      const cb = el("div",{className:"card-body"});
      const tw = el("div",{className:"tablewrap"});
      const t = el("table",{style:"min-width: 980px"});
      t.innerHTML = `<thead><tr>
        <th>Modello</th><th>CODEID</th><th>Ultima lettura</th><th>IN</th><th>OUT</th><th>Prob. pagamento</th><th>Stato</th>
      </tr></thead>`;
      const tb = el("tbody");
      for(const m of list){
        const h = m.history.filter(x=>x.t!==null);
        const last = h.length ? h[h.length-1] : null;
        let pos = null;
        if(m.ciclo && last && isFinite(last.in) && isFinite(last.out)){
          pos = Math.max(0,(last.in-last.out)) % m.ciclo;
        }
        const pay = paymentScore(m, pos);

        const tr = el("tr");
        tr.append(
          tdLink(m.modello||"—", ()=>openMachine(m.codeid)),
          tdMono(m.codeid),
          tdMono(last?.iso ? last.iso.replace("T"," ").slice(0,16) : "—"),
          tdNum(last?.in),
          tdNum(last?.out),
          tdPay(pay.score, pay.label),
          tdTagState(m.stato)
        );
        tb.appendChild(tr);
      }
      t.appendChild(tb);
      tw.appendChild(t);
      cb.appendChild(tw);
      c.appendChild(cb);
      body.appendChild(c);
    }

    $("#lBody").innerHTML = "";
    $("#lBody").appendChild(body);
    $("#modalList").classList.add("show");
  }

  // ---------- A.W.I.S.E. Assistant ----------
  const A = {
    acronym: {
      "PDA":"MACADDRESS del modem/terminalino collegato alla rete. Un locale può avere più PDA.",
      "PDV":"Punto vendita AAMS: codice pratica/proprietario/struttura.",
      "NOE":"Nullaosta di messa in esercizio (codice).",
      "E/M":"Esercizio o Magazzino.",
      "CNTTOTIN":"Contatore totale IN (euro introdotti). Nel sinottico gli ultimi 2 zeri sono centesimi.",
      "CNTTOTOT":"Contatore totale OUT (euro pagati). Anche qui ultimi 2 zeri sono centesimi.",
      "DATA ULTIMA LETTURA":"Timestamp reale dei contatori: è la chiave per lo storico corretto.",
      "GG DECADENZA":"Giorni in magazzino. A 90 il nullaosta decade.",
      "M.S. / FERIE":"Stato manutenzione/ferie (locale chiuso o macchina non trasmette)."
    }
  };

  function awiseHello(){
    const log = $("#chatLog");
    if(log.dataset.init==="1") return;
    log.dataset.init="1";
    addBot(`Ciao ${S.session?.user || ""}! Sono A.W.I.S.E.\n\nPosso:
• dirti quali macchine hanno probabilità alta di pagamento\n• aprire schede macchina/locale/PDA/comune\n• spiegare acronimi del sinottico\n\nEsempi: “quando paga la MARIM FIRE al Bar Fortini?” oppure “spiegami NOE”.`);
  }

  $("#chatSend").addEventListener("click", onChatSend);
  $("#chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") onChatSend(); });

  function addMe(text){
    const node = el("div",{className:"msg me"});
    node.appendChild(el("div",{className:"bubble", textContent:text}));
    $("#chatLog").appendChild(node);
    $("#chatLog").scrollTop = $("#chatLog").scrollHeight;
  }
  function addBot(text){
    const node = el("div",{className:"msg bot"});
    node.appendChild(el("div",{className:"bubble", textContent:text}));
    $("#chatLog").appendChild(node);
    $("#chatLog").scrollTop = $("#chatLog").scrollHeight;
  }

  function onChatSend(){
    const t = ($("#chatInput").value||"").trim();
    if(!t) return;
    $("#chatInput").value="";
    addMe(t);
    const reply = awiseReply(t);
    addBot(reply.text);
    if(reply.openMachine) openMachine(reply.openMachine);
    if(reply.openLocale) openLocale(reply.openLocale);
  }

  function awiseReply(text){
    const q = text.toLowerCase();

    // If no data loaded yet, guide
    if(!S.machineList.length && !q.includes("spiega") && !q.includes("acronim")){
      return {text:"Prima devo avere i dati: premi “Analizza tutti i sinottici”. Poi posso rispondere usando lo storico delle macchine."};
    }

    // explain acronyms
    const acr = Object.keys(A.acronym).find(k => q.includes(k.toLowerCase()));
    if(q.includes("spiega") || q.includes("cosa vuol dire") || q.includes("significa")){
      if(acr){
        return {text:`${acr}: ${A.acronym[acr]}`};
      }
      // try match any acronym token
      const token = (text.match(/[A-Z]{2,5}/g) || [])[0];
      if(token && A.acronym[token]){
        return {text:`${token}: ${A.acronym[token]}`};
      }
      return {text:"Dimmi l’acronimo preciso (es. PDA, PDV, NOE, E/M, CNTTOTIN, CNTTOTOT) e te lo spiego."};
    }

    // "quali sono in pagamento"
    if(q.includes("quali") && (q.includes("pag") || q.includes("in pagamento"))){
      // optional filter by comune/provincia/locale
      const foundPlace = extractPlace(text);
      let list = S.machineList.filter(x=>x.payScore>=0.72);
      if(foundPlace){
        list = list.filter(x=>{
          return (x.comune||"").toLowerCase().includes(foundPlace) ||
                 (x.provincia||"").toLowerCase().includes(foundPlace) ||
                 (x.locale||"").toLowerCase().includes(foundPlace);
        });
      }
      if(!list.length) return {text:"Non vedo macchine con probabilità alta (o il filtro è troppo stretto). Prova senza specificare luogo."};
      const top = list.slice(0,8).map(x=>`• ${x.modello} @ ${x.locale} (${x.comune}) → ${Math.round(x.payScore*100)}%`).join("\n");
      return {text:`Ecco le migliori candidate:\n${top}\n\nSe vuoi apro una macchina: dimmi “apri CODEID …” oppure scrivi il modello+locale.`};
    }

    // "quando paga questa macchina"
    if(q.includes("quando") && q.includes("pag")){
      const match = findMachineFromText(text);
      if(!match){
        return {text:"Dimmi quale macchina: puoi scrivere CODEID, oppure modello + nome locale (es. “MARIM FIRE Bar Fortini”)."};
      }
      const m = match.machine;
      const h = m.history.filter(x=>x.t!==null);
      const last = h.length ? h[h.length-1] : null;
      const ciclo = m.ciclo;
      let pos=null;
      if(ciclo && last && isFinite(last.in) && isFinite(last.out)){
        pos = Math.max(0,(last.in-last.out)) % ciclo;
      }
      const pay = paymentScore(m, pos);

      let eta = "";
      if(ciclo && pos!==null){
        const left = ciclo - pos;
        // stima rozza: usa delta IN medio per lettura (se disponibile)
        const avg = avgDeltaInPerRead(m);
        if(avg>0){
          const readsNeeded = Math.ceil(left / avg);
          eta = `\nStima rozza: mancano ~${fmtEUR(left)} di “posizione ciclo”. Con media ΔIN≈${fmtEUR(avg)} per lettura, potrebbero servire ~${readsNeeded} letture.`;
        }else{
          eta = `\nPosizione ciclo: ${fmtEUR(pos)} / ${fmtEUR(ciclo)} (mancano ~${fmtEUR(left)}).`;
        }
      }else{
        eta = "\nNon ho il ciclo per questo modello oppure mancano contatori validi.";
      }

      return {
        text:`Per ${m.modello} @ ${m.locale}:\nProbabilità pagamento: ${pay.label} (${Math.round(pay.score*100)}%).${eta}\n\nVuoi che apro la scheda macchina?`,
        openMachine: m.codeid
      };
    }

    // open locale
    if(q.startsWith("scheda locale") || q.includes("apri locale")){
      const name = text.split(":").pop().trim();
      if(!name) return {text:"Scrivi: “scheda locale: NOME LOCALE”"};
      return {text:`Ok, apro la scheda del locale “${name}”.`, openLocale:name};
    }

    // generic help
    return {text:"Posso aiutarti su: analisi pagamento, schede macchina/locale/PDA, e spiegazione campi del sinottico.\n\nEsempi:\n• “quali sono in pagamento a Sanremo?”\n• “quando paga CODEID 123…”\n• “spiegami CNTTOTIN”"};
  }

  function extractPlace(text){
    // very simple: last word after "a/in" etc
    const m = text.toLowerCase().match(/\b(a|in|su)\s+([a-zàèéìòù' ]{3,})$/i);
    if(!m) return null;
    return m[2].trim().toLowerCase();
  }

  function findMachineFromText(text){
    const t = text.toLowerCase();

    // try CODEID
    const id = (text.match(/\b\d{8,}\b/) || [])[0]; // codeid often long digits
    if(id && S.byCodeId.has(id)) return {machine: S.byCodeId.get(id), reason:"codeid"};

    // try match by locale + modello words
    // score candidate by word overlap
    const words = t.replace(/[^\wàèéìòù]+/g," ").split(/\s+/).filter(w=>w.length>=3);
    let best = null;
    let bestScore = 0;

    for(const m of S.byCodeId.values()){
      const hay = `${m.modello||""} ${m.locale||""} ${m.comune||""}`.toLowerCase();
      let score = 0;
      for(const w of words){
        if(hay.includes(w)) score++;
      }
      // prefer exact locale hit
      if(m.locale && t.includes(m.locale.toLowerCase())) score += 2;
      if(score > bestScore){
        bestScore = score;
        best = m;
      }
    }
    if(best && bestScore >= 3) return {machine: best, reason:"match"};
    return null;
  }

  function avgDeltaInPerRead(machine){
    const h = machine.history.filter(x=>x.t!==null && isFinite(x.in));
    if(h.length < 3) return 0;
    const diffs = [];
    for(let i=1;i<h.length;i++){
      const d = h[i].in - h[i-1].in;
      if(isFinite(d) && d>=0) diffs.push(d);
    }
    if(diffs.length < 2) return 0;
    diffs.sort((a,b)=>a-b);
    // median
    return diffs[Math.floor(diffs.length/2)];
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ---------- Boot ----------
  showLogin();
  boot();

})();
</script>
</body>
</html>
