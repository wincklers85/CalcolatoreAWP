<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AWP Lab | Analisi Pagamento</title>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --accent:#2563eb; /* default: blue */
      --accent2:#0ea5e9;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:14px;
      --radius2:10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1400px 600px at 20% 0%, rgba(37,99,235,.08), transparent 60%),
                  radial-gradient(1200px 600px at 80% 0%, rgba(14,165,233,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1280px; margin:0 auto; padding:22px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
      padding:14px 16px;
      background: rgba(255,255,255,.75);
      border:1px solid rgba(226,232,240,.9);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 50;
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand b{font-size:14px; letter-spacing:.2px}
    .brand small{color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius: 999px;
      background:#fff;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:999px; background:var(--warn)}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}

    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      color:var(--text);
      transition: transform .06s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .btn:hover{border-color:#cbd5e1; box-shadow: 0 8px 22px rgba(2,6,23,.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(180deg, rgba(37,99,235,.10), rgba(37,99,235,.06));
    }
    .btn.danger{
      border-color: rgba(220,38,38,.25);
      background: linear-gradient(180deg, rgba(220,38,38,.10), rgba(220,38,38,.06));
    }
    .btn[disabled]{opacity:.55; cursor:not-allowed; box-shadow:none}

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(226,232,240,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(226,232,240,.85);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .card .head h3{margin:0; font-size:14px}
    .card .head small{color:var(--muted)}
    .card .body{padding:14px}

    .loginWrap{
      display:flex; min-height: calc(100vh - 60px);
      align-items:center; justify-content:center;
      padding: 24px;
    }
    .loginCard{
      width:min(440px, 100%);
      padding:18px;
    }
    .field{display:flex; flex-direction:column; gap:8px; margin-top:12px}
    .field label{font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.2px}
    .field input{
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    .field input:focus{border-color: rgba(37,99,235,.45); box-shadow: 0 0 0 4px rgba(37,99,235,.10)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row.between{justify-content:space-between}
    .hint{color:var(--muted); font-size:12px; line-height:1.4}
    .err{
      margin-top:12px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(220,38,38,.25);
      background: rgba(220,38,38,.06);
      color:#7f1d1d;
      font-size:13px;
      display:none;
    }
    .ok{
      margin-top:12px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(22,163,74,.25);
      background: rgba(22,163,74,.06);
      color:#14532d;
      font-size:13px;
      display:none;
    }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:12px 14px;
      border-bottom:1px solid rgba(226,232,240,.85);
      background: rgba(255,255,255,.65);
    }
    .toolbar input, .toolbar select{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      font-size:13px;
      background:#fff;
      outline:none;
    }
    .toolbar input:focus, .toolbar select:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10)
    }

    .table{
      width:100%;
      border-collapse: collapse;
    }
    .table thead th{
      position: sticky;
      top: 0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(226,232,240,.95);
      font-size:11px;
      text-transform: uppercase;
      letter-spacing:.08em;
      color: var(--muted);
      padding:10px;
      text-align:left;
      z-index: 2;
    }
    .table tbody td{
      border-bottom: 1px solid rgba(226,232,240,.70);
      padding:10px;
      font-size:13px;
      vertical-align: top;
    }
    .table tbody tr:hover{background: rgba(37,99,235,.06); cursor:pointer}
    .scroll{
      max-height: 64vh;
      overflow:auto;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius: 999px;
      font-size:12px;
      border:1px solid var(--line);
      color:var(--muted);
      background:#fff;
      white-space:nowrap;
    }
    .badge strong{color:var(--text)}
    .score{
      font-weight:800;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(226,232,240,.9);
      background:#fff;
      font-size:12px;
      display:inline-flex;
      align-items:center; gap:8px;
      white-space:nowrap;
    }
    .bar{
      width:72px; height:8px; border-radius:999px;
      background: rgba(226,232,240,.9);
      overflow:hidden;
    }
    .bar > i{display:block; height:100%; width:0%; background: var(--accent)}
    .mono{font-family:var(--mono)}

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .split{grid-template-columns:1fr} }

    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:8px 12px;
      align-items:start;
      margin-top:8px;
      font-size:13px;
    }
    .kv b{color:var(--muted); font-weight:700}
    .kv div{color:var(--text)}
    .kv .mono{font-size:12px; color:#0b1220}

    .prog{
      height:10px; border-radius:999px;
      background: rgba(226,232,240,.9);
      overflow:hidden; border:1px solid rgba(226,232,240,.9);
      width: 220px;
    }
    .prog > i{display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent2))}
    .log{
      font-family: var(--mono);
      font-size:12px;
      color:#0b1220;
      background: rgba(2,6,23,.03);
      border:1px solid rgba(226,232,240,.9);
      border-radius: 12px;
      padding:10px;
      height: 120px;
      overflow:auto;
      white-space: pre-wrap;
    }

    .chat{
      display:flex; flex-direction:column; gap:10px;
      height: 360px;
    }
    .chatBox{
      flex:1;
      border:1px solid rgba(226,232,240,.9);
      border-radius: 12px;
      background:#fff;
      padding:10px;
      overflow:auto;
    }
    .msg{
      display:flex;
      gap:10px;
      margin:10px 0;
      align-items:flex-start;
    }
    .avatar{
      width:30px; height:30px; border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:12px;
      border:1px solid rgba(226,232,240,.9);
      background: rgba(37,99,235,.08);
      color: #0b1220;
      flex:0 0 auto;
    }
    .bubble{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(226,232,240,.9);
      background: rgba(2,6,23,.02);
      max-width: 80%;
      font-size:13px;
      line-height:1.45;
      white-space: pre-wrap;
    }
    .msg.me{justify-content:flex-end}
    .msg.me .avatar{background: rgba(14,165,233,.10)}
    .msg.me .bubble{background: rgba(14,165,233,.06)}
    .chatSend{
      display:flex; gap:10px;
    }
    .chatSend input{
      flex:1;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:13px;
      outline:none;
    }
    .chatSend input:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10)
    }

    .mini{
      font-size:12px; color:var(--muted);
    }

    .accentPicker{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .swatch{
      width:20px; height:20px; border-radius: 8px;
      border:1px solid rgba(226,232,240,.9);
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(2,6,23,.08);
    }
    .swatch.active{outline:3px solid rgba(37,99,235,.25)}
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    /**********************
     * Config
     **********************/
    const DATA_DIR = "Dati"; // D maiuscola, come da tuo repo
    const FILES = {
      users: `${DATA_DIR}/users.json`,
      manifest: `${DATA_DIR}/manifest.json`,
      cicloslot: `${DATA_DIR}/cicloslot.json`,
    };

    // N.E.R.O. – acronimo IA
    const AI_NAME = "N.E.R.O.";
    const AI_FULL = "Neural Extractor for Revenue & Odds";

    // Cache (solo impostazioni UI in localStorage)
    const CACHE_KEY = "awpLab.settings.v1";

    /**********************
     * State
     **********************/
    const state = {
      user: null, // {user, level, expires}
      settings: {
        accent: "#2563eb",
      },
      users: [],
      cicloslot: [],
      cicloMap: new Map(), // codiceModello => ciclo
      manifest: [],
      latestSnapshotByCodeId: new Map(), // CODEID => record
      historyByCodeId: new Map(), // CODEID => [{t, inE, outE, residuoE, file, ...}]
      allLoaded: false,
      selectedCodeId: null,
      tableRows: [],
      filters: {
        q: "",
        comune: "",
        provincia: "",
        modello: "",
        sede: "",
        onlyLikely: false,
        minScore: 0,
      },
      ui: {
        status: "idle", // idle/loading/ready/error
        log: "",
        progress: { on:false, done:0, total:0 },
      },
      chart: null,
      chartRange: "30", // 7/30/90/all
      ai: {
        messages: []
      }
    };

    /**********************
     * Utils
     **********************/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function logLine(s){
      const ts = new Date().toLocaleTimeString();
      state.ui.log += `[${ts}] ${s}\n`;
      const el = $("#logBox");
      if(el){ el.textContent = state.ui.log; el.scrollTop = el.scrollHeight; }
      const pill = $("#statusPillText");
      if(pill) pill.textContent = s.slice(0, 80);
    }

    function setProgress(on, done=0, total=0){
      state.ui.progress = {on, done, total};
      const bar = $("#progBar");
      const label = $("#progLabel");
      if(bar && label){
        if(!on){ bar.style.width = "0%"; label.textContent = "—"; return; }
        const pct = total ? Math.round((done/total)*100) : 0;
        bar.style.width = pct + "%";
        label.textContent = `${done}/${total} (${pct}%)`;
      }
    }

    function safeParseDateTimeIT(s){
      // atteso: "29/12/2025 06:59:39" oppure "29/12/2025"
      if(!s) return null;
      const str = String(s).trim();
      const parts = str.split(" ");
      const d = parts[0]?.split("/");
      if(!d || d.length !== 3) return null;
      const day = Number(d[0]), mon = Number(d[1]), year = Number(d[2]);
      let hh=0, mm=0, ss=0;
      if(parts[1]){
        const t = parts[1].split(":").map(x=>Number(x));
        hh=t[0]||0; mm=t[1]||0; ss=t[2]||0;
      }
      const dt = new Date(year, mon-1, day, hh, mm, ss);
      if(Number.isNaN(dt.getTime())) return null;
      return dt;
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function eurFromCounters(v){
      // contatori hanno ultimi 2 zeri (centesimi)
      const n = Number(String(v).replace(",", "."));
      if(!Number.isFinite(n)) return null;
      return Math.round((n / 100) * 100) / 100; // 2 decimali
    }

    function fmtEUR(n){
      if(n === null || n === undefined || !Number.isFinite(n)) return "—";
      return n.toLocaleString("it-IT", {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function fmtPct(n){
      if(n === null || n === undefined || !Number.isFinite(n)) return "—";
      return (n*100).toFixed(1) + "%";
    }

    function normalizeKey(k){
      return String(k||"")
        .trim()
        .toLowerCase()
        .replace(/\s+/g," ")
        .replace(/[.\-_/]/g," ")
        .replace(/\s+/g," ")
        .trim();
    }

    function encodePath(path){
      // encode solo il nome file (segmento)
      // es: Dati/Sinottico-...-14:30.xlsx => Dati/Sinottico-...-14%3A30.xlsx
      const parts = path.split("/");
      return parts.map((p,i)=> i===0 ? p : encodeURIComponent(p)).join("/");
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s && s.accent) state.settings.accent = s.accent;
      }catch(e){}
      applyAccent(state.settings.accent);
    }

    function saveSettings(){
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify(state.settings));
      }catch(e){}
    }

    function applyAccent(color){
      state.settings.accent = color;
      document.documentElement.style.setProperty("--accent", color);
      // seconda tinta (accent2) derivata semplice
      document.documentElement.style.setProperty("--accent2", color);
      saveSettings();
      $$(".swatch").forEach(s=>s.classList.toggle("active", s.dataset.color===color));
    }

    /**********************
     * Fetch helpers
     **********************/
    async function fetchJSON(url){
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error(`HTTP ${res.status} su ${url}`);
      return await res.json();
    }

    async function fetchXLSX(url){
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error(`HTTP ${res.status} su ${url}`);
      const buf = await res.arrayBuffer();
      return buf;
    }

    function ensureXLSX(){
      if(typeof XLSX === "undefined"){
        throw new Error("Libreria XLSX non caricata (XLSX undefined). Controlla lo script SheetJS.");
      }
    }

    /**********************
     * Parsing XLSX
     **********************/
    function parseSinotticoArrayBuffer(buf){
      ensureXLSX();

      const wb = XLSX.read(buf, {type:"array"});
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      // defval: "" evita undefined
      const rows = XLSX.utils.sheet_to_json(ws, {defval:""});
      if(!rows || !rows.length) return [];

      // Mappa colonne attese (basata sui tuoi nomi reali)
      // (usiamo normalizeKey per robustezza)
      const want = {
        codeid: ["codeid"],
        codeidProvv: ["codeid provv"],
        stato: ["descr stato"],
        dataAttivazione: ["data attivazione"],
        dataUltimoColleg: ["data ultimo collegamento"],
        ggMancato: ["gg mancato collegamento"],
        ggDecadenza: ["gg decadenza"],
        dataUltimaLettura: ["data ultima lettura val"],
        cntIn: ["cnttotin"],
        cntOut: ["cnttotot"],
        msFerie: ["m s ferie", "m s  ferie", "m s / ferie", "m s  / ferie"],
        macPda: ["macaddress pda"],
        codiceSede: ["codice sede"],
        codicePdv: ["codice pdv aams"],
        denomSede: ["denomin sede"],
        indirizzo: ["indirizzo"],
        provincia: ["provincia"],
        comune: ["comune"],
        codiceEsercente: ["codice is esercente"],
        pratica: ["pratica amministrativa"],
        statoPratica: ["stato pratica"],
        dataRilascioNoe: ["data rilascio n o e", "data rilascio n o e "],
        codiceModello: ["codice modello"],
        modello: ["modello"],
        pctOut: ["% out", " out"],
        em: ["e m"],
        noe: ["noe"],
        incassoGiornaliero: ["incasso giornaliero"],
        mediaIncasso: ["media incasso gg esercizio"],
        warning: ["warning"],
      };

      // costruisci dizionario header normalizzati -> header originale
      const sample = rows[0];
      const headers = Object.keys(sample);
      const mapNormToOrig = new Map();
      for(const h of headers){
        mapNormToOrig.set(normalizeKey(h), h);
      }

      function pick(row, keys){
        for(const k of keys){
          const orig = mapNormToOrig.get(normalizeKey(k));
          if(orig && orig in row) return row[orig];
        }
        // fallback: prova match "contains" (per casi strani)
        const candidates = Array.from(mapNormToOrig.entries());
        for(const [nk, orig] of candidates){
          for(const k of keys){
            if(nk.includes(normalizeKey(k))) return row[orig];
          }
        }
        return "";
      }

      const out = rows.map(r=>{
        const codeid = String(pick(r, want.codeid)).trim();
        const modello = String(pick(r, want.modello)).trim();
        const codiceModello = String(pick(r, want.codiceModello)).trim();
        const denomSede = String(pick(r, want.denomSede)).trim();
        const comune = String(pick(r, want.comune)).trim();
        const provincia = String(pick(r, want.provincia)).trim();

        const cntInE = eurFromCounters(pick(r, want.cntIn));
        const cntOutE = eurFromCounters(pick(r, want.cntOut));

        const pctOutStr = String(pick(r, want.pctOut)).trim();
        const pctOut = pctOutStr ? (Number(pctOutStr.replace(",", "."))/100) : 0.65;

        const t = safeParseDateTimeIT(pick(r, want.dataUltimaLettura)) ||
                  safeParseDateTimeIT(pick(r, want.dataUltimoColleg)) ||
                  null;

        return {
          CODEID: codeid,
          "CODEID PROVV": String(pick(r, want.codeidProvv)).trim(),
          "DESCR. STATO": String(pick(r, want.stato)).trim(),
          "DATA ATTIVAZIONE": String(pick(r, want.dataAttivazione)).trim(),
          "DATA ULTIMO COLLEGAMENTO": String(pick(r, want.dataUltimoColleg)).trim(),
          "GG MANCATO COLLEGAMENTO": Number(String(pick(r, want.ggMancato)).replace(",", ".")) || 0,
          "GG DECADENZA": Number(String(pick(r, want.ggDecadenza)).replace(",", ".")) || 0,
          "DATA ULTIMA LETTURA VAL.": String(pick(r, want.dataUltimaLettura)).trim(),
          "CNTTOTIN_EUR": cntInE,
          "CNTTOTOT_EUR": cntOutE,
          "M.S./FERIE": String(pick(r, want.msFerie)).trim(),
          "MACADDRESS PDA": String(pick(r, want.macPda)).trim(),
          "CODICE SEDE": String(pick(r, want.codiceSede)).trim(),
          "CODICE PDV AAMS": String(pick(r, want.codicePdv)).trim(),
          "DENOMIN. SEDE": denomSede,
          "INDIRIZZO": String(pick(r, want.indirizzo)).trim(),
          "PROVINCIA": provincia,
          "COMUNE": comune,
          "CODICE IS ESERCENTE": String(pick(r, want.codiceEsercente)).trim(),
          "PRATICA AMMINISTRATIVA": String(pick(r, want.pratica)).trim(),
          "STATO PRATICA": String(pick(r, want.statoPratica)).trim(),
          "DATA RILASCIO N.O.E.": String(pick(r, want.dataRilascioNoe)).trim(),
          "CODICE MODELLO": codiceModello,
          "MODELLO": modello,
          "PCT_OUT": (Number.isFinite(pctOut) && pctOut>0 && pctOut<1) ? pctOut : 0.65,
          "E/M": String(pick(r, want.em)).trim(),
          "NOE": String(pick(r, want.noe)).trim(),
          "INCASSO GIORNALIERO": String(pick(r, want.incassoGiornaliero)).trim(),
          "MEDIA INCASSO GG ESERCIZIO": String(pick(r, want.mediaIncasso)).trim(),
          "WARNING": String(pick(r, want.warning)).trim(),
          _t: t ? t.getTime() : null,
        };
      }).filter(x => x.CODEID && x["DENOMIN. SEDE"] && x["MODELLO"]);

      return out;
    }

    /**********************
     * Scoring / “AI”
     **********************/
    function computeFeatures(record){
      const inE = record["CNTTOTIN_EUR"];
      const outE = record["CNTTOTOT_EUR"];
      const pct = record["PCT_OUT"] ?? 0.65;

      const codiceModello = record["CODICE MODELLO"];
      const ciclo = state.cicloMap.get(String(codiceModello)) || null;

      let residuo = null;
      if(Number.isFinite(inE) && Number.isFinite(outE)){
        // residuo teorico: quanto OUT "dovrebbe" essere per rispettare pct
        residuo = (inE * pct) - outE; // >0 => sotto payout teorico (potenzialmente “deve”)
      }

      let cyclePos = null;
      let cycleProgress = null;
      if(ciclo && Number.isFinite(inE)){
        cyclePos = ((inE % ciclo) + ciclo) % ciclo;
        cycleProgress = ciclo ? (cyclePos / ciclo) : null;
      }

      return {ciclo, residuo, cyclePos, cycleProgress};
    }

    function computeTrendPenalty(codeId, pct=0.65){
      // usa gli ultimi delta: deltaOut - pct*deltaIn
      const hist = state.historyByCodeId.get(codeId);
      if(!hist || hist.length < 3) return {trend:0, details:null};
      const last = hist.slice(-8); // ultimi punti
      let acc = 0;
      let n = 0;
      for(let i=1;i<last.length;i++){
        const a = last[i-1], b = last[i];
        const dIn = b.inE - a.inE;
        const dOut = b.outE - a.outE;
        if(dIn <= 0 || dOut < 0) continue;
        const d = (pct*dIn) - dOut; // positivo => out sotto teorico nel periodo
        acc += d;
        n++;
      }
      if(!n) return {trend:0, details:null};
      const avg = acc/n;
      // normalizza su un range “ragionevole”
      const trend = clamp(avg / 60, 0, 1); // 60€ medi di “mancanza payout” => 1
      return {trend, details:{avgMissingEUR:avg, n}};
    }

    function computePaymentScore(record){
      // Score 0..100
      const {ciclo, residuo, cycleProgress} = computeFeatures(record);
      const pct = record["PCT_OUT"] ?? 0.65;

      // base components
      let sResid = 0;
      if(Number.isFinite(residuo)){
        // se residuo>0 cresce, se negativo -> 0
        // scala: 0.. (ciclo*pct*0.6) ~ “molto”
        const scale = (ciclo ? (ciclo*pct*0.60) : 12000); // fallback
        sResid = clamp(residuo / scale, 0, 1);
      }

      let sCycle = 0;
      if(Number.isFinite(cycleProgress)){
        // più vicino a fine ciclo => più alto
        sCycle = clamp((cycleProgress - 0.45) / 0.55, 0, 1); // parte da 45%
      }

      const {trend} = computeTrendPenalty(record.CODEID, pct);

      // pesi
      const score = Math.round(100 * (0.42*sResid + 0.38*sCycle + 0.20*trend));
      return clamp(score, 0, 100);
    }

    function explainScore(record){
      const f = computeFeatures(record);
      const score = computePaymentScore(record);
      const pct = record["PCT_OUT"] ?? 0.65;

      const resid = Number.isFinite(f.residuo) ? f.residuo : null;
      const cp = Number.isFinite(f.cycleProgress) ? f.cycleProgress : null;

      const trend = computeTrendPenalty(record.CODEID, pct);

      const lines = [];
      lines.push(`Indice Pagamento: ${score}/100`);
      if(f.ciclo) lines.push(`Ciclo associato: ${f.ciclo.toLocaleString("it-IT")} € (da cicloslot)`);
      else lines.push(`Ciclo associato: non trovato in cicloslot (CODICE MODELLO: ${record["CODICE MODELLO"] || "—"})`);

      if(resid !== null){
        const tag = resid > 0 ? "OUT sotto teorico" : "OUT sopra teorico";
        lines.push(`Residuo teorico: ${fmtEUR(resid)} € (${tag}, target ${(pct*100).toFixed(0)}%)`);
      }else{
        lines.push(`Residuo teorico: —`);
      }

      if(cp !== null && f.ciclo){
        lines.push(`Avanzamento ciclo: ${(cp*100).toFixed(1)}% (posizione: ${fmtEUR(f.cyclePos)} su ${f.ciclo.toLocaleString("it-IT")})`);
      }else{
        lines.push(`Avanzamento ciclo: —`);
      }

      if(trend.details){
        lines.push(`Trend recente: media “mancanza OUT” ≈ ${fmtEUR(trend.details.avgMissingEUR)} € (ultimi ${trend.details.n} intervalli)`);
      }else{
        lines.push(`Trend recente: —`);
      }

      lines.push("");
      lines.push("Nota: è una stima statistica (non magia), basata su ciclo, residuo teorico e trend storico.");

      return lines.join("\n");
    }

    /**********************
     * Login
     **********************/
    async function loadUsers(){
      const url = encodePath(FILES.users);
      state.users = await fetchJSON(url);
      return state.users;
    }

    function validateLogin(user, pin){
      const u = state.users.find(x => String(x.user).toLowerCase() === String(user).trim().toLowerCase());
      if(!u) return {ok:false, msg:"Utente non trovato."};
      if(String(u.pin) !== String(pin)) return {ok:false, msg:"PIN errato."};

      if(u.expires){
        const exp = safeParseDateTimeIT(String(u.expires).includes("/") ? u.expires : `01/01/1970`) || null;
        // expires nel tuo file è YYYY-MM-DD
        const m = String(u.expires).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        let expDate = null;
        if(m){
          expDate = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 23,59,59);
        }
        if(expDate && Date.now() > expDate.getTime()){
          return {ok:false, msg:`Abbonamento scaduto (${u.expires}).`};
        }
      }
      return {ok:true, user:u};
    }

    /**********************
     * Data loading
     **********************/
    async function loadCicloslot(){
      const url = encodePath(FILES.cicloslot);
      const arr = await fetchJSON(url);
      state.cicloslot = Array.isArray(arr) ? arr : [];
      state.cicloMap = new Map();
      for(const it of state.cicloslot){
        if(!it) continue;
        const k = String(it.codiceModello || "").trim();
        const c = Number(it.ciclo);
        if(k && Number.isFinite(c)) state.cicloMap.set(k, c);
      }
    }

    async function loadManifest(){
      const url = encodePath(FILES.manifest);
      const obj = await fetchJSON(url);
      const list = obj?.sinottici;
      state.manifest = Array.isArray(list) ? list : [];
      return state.manifest;
    }

    function buildSinotticoURL(fileName){
      // fileName viene dal manifest, e può contenere ":" ecc
      const path = `${DATA_DIR}/${fileName}`;
      return encodePath(path);
    }

    async function loadLatestOnly(){
      state.latestSnapshotByCodeId.clear();
      state.tableRows = [];
      state.historyByCodeId.clear();
      state.allLoaded = false;

      await loadCicloslot();
      await loadManifest();

      if(!state.manifest.length){
        throw new Error("manifest.json non contiene sinottici.");
      }

      // Prendi l'ultimo della lista (come tuo sistema v1.11)
      const latestFile = state.manifest[state.manifest.length - 1];
      logLine(`Ultimo sinottico da manifest: ${latestFile}`);

      const url = buildSinotticoURL(latestFile);
      const buf = await fetchXLSX(url);
      const rows = parseSinotticoArrayBuffer(buf);

      if(!rows.length){
        throw new Error("Sinottico letto ma nessuna riga valida (mapping colonne fallito?).");
      }

      for(const r of rows){
        state.latestSnapshotByCodeId.set(r.CODEID, r);
      }

      // Crea tabella
      state.tableRows = rows.map(r=>{
        const score = computePaymentScore(r);
        const f = computeFeatures(r);

        return {
          codeid: r.CODEID,
          sede: r["DENOMIN. SEDE"],
          comune: r["COMUNE"],
          provincia: r["PROVINCIA"],
          modello: r["MODELLO"],
          codiceModello: r["CODICE MODELLO"],
          pda: r["MACADDRESS PDA"],
          pdv: r["CODICE PDV AAMS"],
          sedeCode: r["CODICE SEDE"],
          stato: r["DESCR. STATO"],
          em: r["E/M"],
          t: r._t,
          inE: r["CNTTOTIN_EUR"],
          outE: r["CNTTOTOT_EUR"],
          pct: r["PCT_OUT"] ?? 0.65,
          residuo: f.residuo,
          ciclo: f.ciclo,
          cycleProgress: f.cycleProgress,
          score,
        };
      });

      state.tableRows.sort((a,b)=> b.score - a.score);
      state.selectedCodeId = state.tableRows[0]?.codeid || null;
      state.ui.status = "ready";
      logLine(`Letto: ${rows.length} macchine dal sinottico più recente.`);
    }

    async function analyzeAllSinottici(){
      // solo Abbonato/Admin
      if(!state.user) return;
      const level = String(state.user.level || "").toLowerCase();
      const allowed = (level === "abbonato" || level === "admin");
      if(!allowed) throw new Error("Permesso negato: Analisi completa disponibile solo per Abbonato/Admin.");

      await loadCicloslot();
      await loadManifest();

      if(!state.manifest.length) throw new Error("manifest.json non contiene sinottici.");

      state.historyByCodeId.clear();
      setProgress(true, 0, state.manifest.length);
      logLine(`Analisi completa: ${state.manifest.length} sinottici…`);

      for(let i=0;i<state.manifest.length;i++){
        const file = state.manifest[i];
        const url = buildSinotticoURL(file);

        try{
          const buf = await fetchXLSX(url);
          const rows = parseSinotticoArrayBuffer(buf);

          for(const r of rows){
            const inE = r["CNTTOTIN_EUR"];
            const outE = r["CNTTOTOT_EUR"];
            if(!Number.isFinite(inE) || !Number.isFinite(outE)) continue;

            const pct = r["PCT_OUT"] ?? 0.65;
            const residuo = (inE * pct) - outE;

            const t = r._t || null;
            const item = {
              t: t || (Date.now() + i), // fallback
              inE,
              outE,
              residuoE: residuo,
              file,
              sede: r["DENOMIN. SEDE"],
              comune: r["COMUNE"],
              provincia: r["PROVINCIA"],
              modello: r["MODELLO"],
              codiceModello: r["CODICE MODELLO"],
              pdv: r["CODICE PDV AAMS"],
              sedeCode: r["CODICE SEDE"],
              pda: r["MACADDRESS PDA"],
              stato: r["DESCR. STATO"],
              em: r["E/M"],
              pct
            };

            if(!state.historyByCodeId.has(r.CODEID)) state.historyByCodeId.set(r.CODEID, []);
            state.historyByCodeId.get(r.CODEID).push(item);
          }

          if(i % 10 === 0) logLine(`Analizzati ${i+1}/${state.manifest.length}…`);
        }catch(e){
          logLine(`ERRORE su ${file}: ${e.message}`);
        }

        setProgress(true, i+1, state.manifest.length);
      }

      // sort histories by time
      for(const [k, arr] of state.historyByCodeId.entries()){
        arr.sort((a,b)=> a.t - b.t);
      }

      state.allLoaded = true;
      logLine("Analisi completa terminata. Storici disponibili per grafici e trend.");
    }

    /**********************
     * UI Rendering
     **********************/
    function render(){
      loadSettings();

      if(!state.user){
        renderLogin();
      }else{
        renderDashboard();
      }
    }

    function renderLogin(){
      const app = $("#app");
      app.innerHTML = `
        <div class="loginWrap">
          <div class="card loginCard">
            <div class="head">
              <div>
                <h3>Calcolatore AWP | Analisi Pagamento</h3>
                <small>Accesso riservato</small>
              </div>
              <span class="badge"><span class="dot"></span> Offline-ready (RAM)</span>
            </div>
            <div class="body">
              <div class="field">
                <label>Utente</label>
                <input id="loginUser" autocomplete="username" placeholder="es. user" value="user" />
              </div>
              <div class="field">
                <label>PIN</label>
                <input id="loginPin" type="password" inputmode="numeric" autocomplete="current-password" placeholder="es. 0000" value="0000" />
              </div>

              <div class="row between" style="margin-top:14px;">
                <div class="hint">Dati letti da <span class="mono">/${DATA_DIR}/users.json</span></div>
                <button class="btn primary" id="btnLogin">Entra</button>
              </div>

              <div class="err" id="loginErr"></div>
              <div class="ok" id="loginOk"></div>

              <div style="margin-top:16px;">
                <div class="mini">Accento interfaccia</div>
                <div class="accentPicker" style="margin-top:8px;">
                  ${accentSwatchesHTML()}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      $("#btnLogin").onclick = async () => {
        const err = $("#loginErr");
        const ok = $("#loginOk");
        err.style.display = "none";
        ok.style.display = "none";
        try{
          state.ui.log = "";
          logLine("Carico users.json…");
          await loadUsers();

          const u = $("#loginUser").value.trim();
          const p = $("#loginPin").value.trim();

          const v = validateLogin(u, p);
          if(!v.ok){
            err.textContent = v.msg;
            err.style.display = "block";
            return;
          }
          state.user = v.user;
          ok.textContent = `Benvenuto ${state.user.user} (${state.user.level}).`;
          ok.style.display = "block";

          // entra
          setTimeout(()=>{
            render();
            // auto load latest
            bootAfterLogin();
          }, 250);
        }catch(e){
          err.textContent = e.message;
          err.style.display = "block";
        }
      };

      hookSwatches();
    }

    function accentSwatchesHTML(){
      const colors = [
        {name:"Blue", c:"#2563eb"},
        {name:"Amber", c:"#f59e0b"},
        {name:"Lime", c:"#84cc16"},
        {name:"Teal", c:"#14b8a6"},
        {name:"Violet", c:"#7c3aed"},
        {name:"Rose", c:"#f43f5e"},
      ];
      return colors.map(x=>`
        <div class="swatch ${state.settings.accent===x.c?'active':''}" title="${x.name}" data-color="${x.c}" style="background:${x.c}"></div>
      `).join("");
    }

    function hookSwatches(){
      $$(".swatch").forEach(s=>{
        s.onclick = ()=> applyAccent(s.dataset.color);
      });
    }

    async function bootAfterLogin(){
      try{
        state.ui.status = "loading";
        renderDashboardStatus();
        logLine("Self-test: controllo XLSX…");
        ensureXLSX();
        logLine("OK: XLSX pronto.");

        logLine("Carico sinottico più recente…");
        await loadLatestOnly();
        renderDashboard();

        // init selection
        if(state.selectedCodeId) selectMachine(state.selectedCodeId, true);

        // primo messaggio N.E.R.O.
        aiSay(`Ciao, sono ${AI_NAME} (${AI_FULL}).\nPuoi chiedermi:\n• "quale macchina è in pagamento"\n• "quando paga questa macchina"\n• "cerca MARIM FIRE"\n• "top 10 in pagamento"\nSe mi chiedi cose fuori dal programma, ti riporto ai comandi utili.`);
      }catch(e){
        state.ui.status = "error";
        logLine(`BOOT ERROR: ${e.message}`);
        renderDashboard();
      }
    }

    function renderDashboardStatus(){
      // se dashboard già montata, aggiorna pill/log/prog
      const dot = $("#statusDot");
      if(dot){
        dot.classList.remove("good","bad");
        if(state.ui.status === "ready") dot.classList.add("good");
        if(state.ui.status === "error") dot.classList.add("bad");
      }
    }

    function renderDashboard(){
      const app = $("#app");
      const user = state.user;

      app.innerHTML = `
        <div class="wrap">
          <div class="topbar">
            <div class="brand">
              <b>AWP Lab</b>
              <small>Analisi sinottici e previsione pagamento (RAM)</small>
            </div>

            <div class="row" style="justify-content:flex-end;">
              <span class="pill" title="Stato sistema">
                <span id="statusDot" class="dot ${state.ui.status==='ready'?'good':(state.ui.status==='error'?'bad':'')}"></span>
                <span id="statusPillText">Pronto</span>
              </span>
              <span class="pill" title="Utente">
                <span class="mono">${escapeHtml(user.user)}</span>
                <span>•</span>
                <b>${escapeHtml(user.level || "—")}</b>
              </span>
              <button class="btn" id="btnLogout">Esci</button>
            </div>
          </div>

          <div class="grid">
            <div class="card">
              <div class="head">
                <div>
                  <h3>Macchine (ultimo sinottico)</h3>
                  <small>Fonte: <span class="mono">/${DATA_DIR}/manifest.json</span> → ultimo file</small>
                </div>
                <div class="row">
                  <button class="btn primary" id="btnReloadLatest">Ricarica</button>
                </div>
              </div>

              <div class="toolbar">
                <input id="q" placeholder="Cerca (sede, comune, modello, CODEID…)" />
                <select id="minScore">
                  <option value="0">Score ≥ 0</option>
                  <option value="40">Score ≥ 40</option>
                  <option value="55">Score ≥ 55</option>
                  <option value="70">Score ≥ 70</option>
                  <option value="85">Score ≥ 85</option>
                </select>
                <button class="btn" id="btnTop10">Top 10</button>
              </div>

              <div class="scroll">
                <table class="table" id="machinesTable">
                  <thead>
                    <tr>
                      <th>Score</th>
                      <th>Sede</th>
                      <th>Comune</th>
                      <th>Modello</th>
                      <th>IN</th>
                      <th>OUT</th>
                    </tr>
                  </thead>
                  <tbody id="machinesBody"></tbody>
                </table>
              </div>
            </div>

            <div class="card">
              <div class="head">
                <div>
                  <h3>Dettaglio & Storico</h3>
                  <small id="selSub">Seleziona una macchina</small>
                </div>
                <div class="row">
                  <button class="btn" id="btnAnalyzeAll">Analizza tutti i sinottici</button>
                  <span class="pill" title="Progresso analisi">
                    <span class="mono" id="progLabel">—</span>
                    <span class="prog"><i id="progBar"></i></span>
                  </span>
                </div>
              </div>

              <div class="body">
                <div class="split">
                  <div>
                    <div class="row between">
                      <span class="badge"><strong>Indice Pagamento</strong> <span id="scoreVal">—</span></span>
                      <div class="accentPicker">
                        ${accentSwatchesHTML()}
                      </div>
                    </div>

                    <div class="kv" id="kvBox" style="margin-top:10px;"></div>

                    <div style="margin-top:12px;">
                      <div class="row between">
                        <span class="badge"><strong>Grafico</strong> <span class="mini">(range)</span></span>
                        <select id="chartRange">
                          <option value="7">7 giorni</option>
                          <option value="30" selected>30 giorni</option>
                          <option value="90">90 giorni</option>
                          <option value="all">Tutto</option>
                        </select>
                      </div>
                      <div style="margin-top:10px;">
                        <canvas id="chart" height="120"></canvas>
                      </div>
                      <div class="mini" style="margin-top:8px;">
                        Suggerimento: per “Tutto”, il grafico fa downsampling per restare leggibile.
                      </div>
                    </div>

                    <div style="margin-top:12px;">
                      <div class="badge"><strong>Spiegazione Score</strong></div>
                      <pre class="log" id="scoreExplain" style="height:140px; margin-top:8px;"></pre>
                    </div>
                  </div>

                  <div>
                    <div class="badge"><strong>${AI_NAME}</strong> <span class="mini">${AI_FULL}</span></div>
                    <div class="chat" style="margin-top:10px;">
                      <div class="chatBox" id="chatBox"></div>
                      <div class="chatSend">
                        <input id="chatInput" placeholder='Es: "quale macchina è in pagamento?"' />
                        <button class="btn primary" id="chatSendBtn">Invia</button>
                      </div>
                    </div>

                    <div style="margin-top:12px;">
                      <div class="badge"><strong>Log</strong></div>
                      <pre class="log" id="logBox" style="margin-top:8px;"></pre>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      `;

      $("#btnLogout").onclick = ()=>{
        state.user = null;
        state.latestSnapshotByCodeId.clear();
        state.historyByCodeId.clear();
        state.tableRows = [];
        state.selectedCodeId = null;
        if(state.chart){ try{state.chart.destroy()}catch(e){} state.chart=null; }
        render();
      };

      $("#btnReloadLatest").onclick = async ()=>{
        try{
          state.ui.log = "";
          logLine("Ricarico sinottico più recente…");
          await loadLatestOnly();
          renderDashboard();
          if(state.selectedCodeId) selectMachine(state.selectedCodeId, true);
        }catch(e){
          logLine(`Errore reload: ${e.message}`);
        }
      };

      $("#btnAnalyzeAll").onclick = async ()=>{
        try{
          await analyzeAllSinottici();
          // dopo analisi, aggiorna score (trend migliora)
          renderMachinesTable();
          if(state.selectedCodeId) selectMachine(state.selectedCodeId, true);
        }catch(e){
          logLine(e.message);
        }
      };

      $("#q").oninput = ()=>{ state.filters.q = $("#q").value.trim(); renderMachinesTable(); };
      $("#minScore").onchange = ()=>{ state.filters.minScore = Number($("#minScore").value)||0; renderMachinesTable(); };

      $("#btnTop10").onclick = ()=>{
        state.filters.q = "";
        $("#q").value = "";
        state.filters.minScore = 0;
        $("#minScore").value = "0";
        // mostra top 10 semplicemente scrollando e mettendo evidenza
        const body = $("#machinesBody");
        if(body) body.scrollIntoView({behavior:"smooth", block:"start"});
      };

      $("#chartRange").onchange = ()=>{
        state.chartRange = $("#chartRange").value;
        if(state.selectedCodeId) updateChartForSelected();
      };

      // chat
      $("#chatSendBtn").onclick = ()=> onChatSend();
      $("#chatInput").addEventListener("keydown", (e)=>{
        if(e.key === "Enter") onChatSend();
      });

      hookSwatches();

      // log
      $("#logBox").textContent = state.ui.log;

      renderDashboardStatus();
      renderMachinesTable();

      // enable/disable analyze button by level
      const lvl = String(state.user.level||"").toLowerCase();
      const allowed = (lvl==="abbonato" || lvl==="admin");
      $("#btnAnalyzeAll").disabled = !allowed;
      $("#btnAnalyzeAll").title = allowed ? "Analizza tutti i sinottici" : "Solo Abbonato/Admin";

      // progress refresh
      setProgress(state.ui.progress.on, state.ui.progress.done, state.ui.progress.total);

      // chat render
      renderChat();
    }

    function renderMachinesTable(){
      const body = $("#machinesBody");
      if(!body) return;

      const q = (state.filters.q||"").toLowerCase();
      const minScore = state.filters.minScore || 0;

      const rows = state.tableRows.filter(r=>{
        if(r.score < minScore) return false;
        if(!q) return true;
        const hay = `${r.sede} ${r.comune} ${r.provincia} ${r.modello} ${r.codeid} ${r.codiceModello} ${r.pdv} ${r.sedeCode}`.toLowerCase();
        return hay.includes(q);
      });

      body.innerHTML = rows.slice(0, 800).map(r=>{
        const pct = clamp(r.score, 0, 100);
        return `
          <tr data-codeid="${escapeAttr(r.codeid)}">
            <td>
              <span class="score">
                ${r.score}
                <span class="bar"><i style="width:${pct}%"></i></span>
              </span>
            </td>
            <td><b>${escapeHtml(r.sede)}</b><div class="mini mono">${escapeHtml(r.codeid)}</div></td>
            <td>${escapeHtml(r.comune)}<div class="mini">${escapeHtml(r.provincia)}</div></td>
            <td>${escapeHtml(r.modello)}<div class="mini mono">${escapeHtml(r.codiceModello || "—")}</div></td>
            <td class="mono">${fmtEUR(r.inE)}</td>
            <td class="mono">${fmtEUR(r.outE)}</td>
          </tr>
        `;
      }).join("");

      $$("#machinesBody tr").forEach(tr=>{
        tr.onclick = ()=>{
          const id = tr.dataset.codeid;
          selectMachine(id, false);
        };
      });
    }

    function selectMachine(codeId, silent){
      state.selectedCodeId = codeId;
      const rec = state.latestSnapshotByCodeId.get(codeId);
      if(!rec){
        if(!silent) logLine("Macchina non trovata nel sinottico corrente.");
        return;
      }

      const score = computePaymentScore(rec);
      $("#selSub").textContent = `${rec["DENOMIN. SEDE"]} • ${rec["MODELLO"]}`;
      $("#scoreVal").textContent = `${score}/100`;
      $("#scoreExplain").textContent = explainScore(rec);

      const f = computeFeatures(rec);

      const kv = [
        ["CODEID", `<span class="mono">${escapeHtml(rec.CODEID)}</span>`],
        ["Sede", escapeHtml(rec["DENOMIN. SEDE"] || "—")],
        ["Comune / Prov.", `${escapeHtml(rec["COMUNE"]||"—")} (${escapeHtml(rec["PROVINCIA"]||"—")})`],
        ["Indirizzo", escapeHtml(rec["INDIRIZZO"] || "—")],
        ["CODICE SEDE", `<span class="mono">${escapeHtml(rec["CODICE SEDE"]||"—")}</span>`],
        ["PDV AAMS", `<span class="mono">${escapeHtml(rec["CODICE PDV AAMS"]||"—")}</span>`],
        ["PDA (MAC)", `<span class="mono">${escapeHtml(rec["MACADDRESS PDA"]||"—")}</span>`],
        ["Stato", escapeHtml(rec["DESCR. STATO"] || "—")],
        ["E/M", escapeHtml(rec["E/M"] || "—")],
        ["Ultima lettura", escapeHtml(rec["DATA ULTIMA LETTURA VAL."] || "—")],
        ["IN totale", `<span class="mono">${fmtEUR(rec["CNTTOTIN_EUR"])}</span>`],
        ["OUT totale", `<span class="mono">${fmtEUR(rec["CNTTOTOT_EUR"])}</span>`],
        ["% OUT", `${((rec["PCT_OUT"]??0.65)*100).toFixed(0)}%`],
        ["Ciclo (da modeloslot)", f.ciclo ? `${f.ciclo.toLocaleString("it-IT")} €` : "—"],
        ["Avanzamento ciclo", (Number.isFinite(f.cycleProgress) && f.ciclo) ? `${(f.cycleProgress*100).toFixed(1)}%` : "—"],
        ["Residuo teorico", Number.isFinite(f.residuo) ? `<span class="mono">${fmtEUR(f.residuo)} €</span>` : "—"],
      ];

      $("#kvBox").innerHTML = kv.map(([k,v])=>`
        <b>${k}</b><div>${v}</div>
      `).join("");

      // aggiorna grafico
      updateChartForSelected();

      // ai hint
      if(!silent){
        aiSay(`Se vuoi: "quando paga questa macchina" oppure "perché score ${score}?"`);
      }
    }

    function downsampleSeries(points, maxPoints=350){
      if(points.length <= maxPoints) return points;
      const step = Math.ceil(points.length / maxPoints);
      const out = [];
      for(let i=0;i<points.length;i+=step) out.push(points[i]);
      return out;
    }

    function updateChartForSelected(){
      const codeId = state.selectedCodeId;
      const rec = state.latestSnapshotByCodeId.get(codeId);
      if(!rec) return;

      // se non ho analisi completa, provo almeno 1 punto (l'attuale)
      let hist = state.historyByCodeId.get(codeId) || null;
      if(!hist || hist.length < 2){
        hist = [{
          t: rec._t || Date.now(),
          inE: rec["CNTTOTIN_EUR"] ?? 0,
          outE: rec["CNTTOTOT_EUR"] ?? 0,
          residuoE: ((rec["CNTTOTIN_EUR"] ?? 0) * (rec["PCT_OUT"] ?? 0.65)) - (rec["CNTTOTOT_EUR"] ?? 0),
        }];
      }

      const range = state.chartRange;
      const now = Date.now();
      let filtered = hist;

      if(range !== "all"){
        const days = Number(range);
        const cutoff = now - days*24*3600*1000;
        filtered = hist.filter(p => p.t >= cutoff);
        if(!filtered.length) filtered = hist.slice(-Math.min(hist.length, 60));
      }

      filtered = downsampleSeries(filtered, range==="all" ? 420 : 320);

      const labels = filtered.map(p=>{
        const d = new Date(p.t);
        return d.toLocaleDateString("it-IT", {day:"2-digit", month:"2-digit"}) + " " + d.toLocaleTimeString("it-IT", {hour:"2-digit", minute:"2-digit"});
      });

      const dataIn = filtered.map(p=> p.inE);
      const dataOut = filtered.map(p=> p.outE);
      const dataRes = filtered.map(p=> p.residuoE);

      const ctx = $("#chart").getContext("2d");
      if(state.chart){ try{state.chart.destroy()}catch(e){} state.chart=null; }

      state.chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {label:"IN (totale €)", data: dataIn, borderWidth:2, pointRadius:0, tension:0.18},
            {label:"OUT (totale €)", data: dataOut, borderWidth:2, pointRadius:0, tension:0.18},
            {label:"Residuo teorico (€)", data: dataRes, borderWidth:2, pointRadius:0, tension:0.18},
          ]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{display:true, labels:{boxWidth:14, boxHeight:14}},
            tooltip:{mode:"index", intersect:false}
          },
          interaction:{mode:"index", intersect:false},
          scales:{
            x:{ticks:{maxRotation:0, autoSkip:true, maxTicksLimit:8}},
            y:{ticks:{callback:(v)=> Number(v).toLocaleString("it-IT")}}
          }
        }
      });
    }

    /**********************
     * Chat (N.E.R.O.)
     **********************/
    function aiSay(text){
      state.ai.messages.push({who:"ai", text});
      renderChat();
    }
    function meSay(text){
      state.ai.messages.push({who:"me", text});
      renderChat();
    }

    function renderChat(){
      const box = $("#chatBox");
      if(!box) return;
      box.innerHTML = state.ai.messages.map(m=>{
        const isMe = m.who === "me";
        const avatar = isMe ? "ME" : AI_NAME;
        return `
          <div class="msg ${isMe?'me':''}">
            <div class="avatar">${escapeHtml(avatar)}</div>
            <div class="bubble">${escapeHtml(m.text)}</div>
          </div>
        `;
      }).join("");
      box.scrollTop = box.scrollHeight;
    }

    function onChatSend(){
      const inp = $("#chatInput");
      if(!inp) return;
      const text = inp.value.trim();
      if(!text) return;
      inp.value = "";
      meSay(text);
      aiHandle(text);
    }

    function aiHandle(text){
      const t = text.toLowerCase();

      const isProgramRelated =
        /(pag|pagament|paga|in pagamento|slot|awp|sinottic|ciclo|residuo|score|codice|sede|comune|modello|pdv|pda)/i.test(t);

      if(!isProgramRelated){
        aiSay(`Capisco, ma questa richiesta non sembra legata ai dati AWP del programma.\nProva con:\n• "quale macchina è in pagamento"\n• "top 10 in pagamento"\n• "cerca <testo>"\n• "quando paga questa macchina" (dopo aver selezionato una riga)`);
        return;
      }

      // intent: cerca
      const mCerca = t.match(/cerca\s+(.+)/i);
      if(mCerca){
        const q = mCerca[1].trim();
        state.filters.q = q;
        const qEl = $("#q");
        if(qEl) qEl.value = q;
        renderMachinesTable();
        aiSay(`Ok. Ho filtrato la lista per: "${q}". Seleziona una macchina per i dettagli.`);
        return;
      }

      // intent: top N
      if(/top\s*\d+/.test(t) || /top\s*10/.test(t) || /piu in pagamento|più in pagamento|quale macchina è in pagamento|in pagamento/.test(t)){
        const n = (t.match(/top\s*(\d+)/)?.[1]) ? Number(t.match(/top\s*(\d+)/)[1]) : 10;
        const list = [...state.tableRows].sort((a,b)=>b.score-a.score).slice(0, clamp(n,1,30));
        const lines = list.map((r,i)=>`${i+1}) ${r.score}/100 • ${r.sede} • ${r.comune} • ${r.modello} • ${r.codeid}`);
        aiSay(`Top ${list.length} per Indice Pagamento:\n` + lines.join("\n") + `\n\nVuoi che selezioni la #1? Scrivi: "seleziona 1"`);
        return;
      }

      // intent: seleziona N
      const mSel = t.match(/seleziona\s+(\d+)/i);
      if(mSel){
        const idx = Number(mSel[1]) - 1;
        const list = [...state.tableRows].sort((a,b)=>b.score-a.score).slice(0, 30);
        const pick = list[idx];
        if(!pick){
          aiSay("Numero non valido. Prova: seleziona 1 oppure seleziona 2.");
          return;
        }
        selectMachine(pick.codeid, false);
        aiSay(`Fatto. Ho selezionato ${pick.modello} in ${pick.sede} (${pick.comune}).`);
        return;
      }

      // intent: quando paga questa macchina
      if(/quando\s+paga|quando\s+deve\s+pagare|quando\s+pag/.test(t)){
        if(!state.selectedCodeId){
          aiSay("Seleziona prima una macchina dalla lista, poi riprova.");
          return;
        }
        const rec = state.latestSnapshotByCodeId.get(state.selectedCodeId);
        const score = computePaymentScore(rec);
        const f = computeFeatures(rec);

        let msg = `Per la macchina selezionata:\nIndice Pagamento: ${score}/100.\n`;
        if(f.ciclo && Number.isFinite(f.cycleProgress)){
          const remaining = (1 - f.cycleProgress) * f.ciclo;
          msg += `Avanzamento ciclo: ${(f.cycleProgress*100).toFixed(1)}%.\nMancano circa ${fmtEUR(remaining)} € per completare il ciclo (stima su IN).\n`;
        }else{
          msg += `Non posso stimare “quanto manca” perché non ho un ciclo associato (cicloslot).\n`;
        }
        msg += `Suggerimento: premi "Analizza tutti i sinottici" per migliorare la previsione con trend storico.`;
        aiSay(msg);
        return;
      }

      // intent: perché score
      if(/perch[eé].*score|spiega|dettagli/.test(t)){
        if(!state.selectedCodeId){
          aiSay("Seleziona prima una macchina dalla lista, poi chiedimi di spiegare lo score.");
          return;
        }
        const rec = state.latestSnapshotByCodeId.get(state.selectedCodeId);
        aiSay(explainScore(rec));
        return;
      }

      // fallback program-related
      aiSay(`Ok. Posso aiutarti su:\n• ricerca ("cerca <testo>")\n• top ("top 10 in pagamento")\n• stima ("quando paga questa macchina")\n• spiegazione ("spiega score")`);
    }

    /**********************
     * HTML escaping
     **********************/
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

    /**********************
     * Boot
     **********************/
    render();
  </script>
</body>
</html>
