<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>SinotticoLab</title>

  <!-- Libraries (CDN). Works on GitHub Pages. -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a30;
      --card2:#0c1528;
      --text:#e7eefc;
      --muted:#a7b5d8;
      --line:rgba(255,255,255,.09);
      --good:#19d18b;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --accent:#77a8ff;
      --accent2:#b06bff;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(119,168,255,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(176,107,255,.16), transparent 60%),
        radial-gradient(800px 600px at 50% 100%, rgba(25,209,139,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    a{color:inherit}
    .app{max-width:1400px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:22px;box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:conic-gradient(from 200deg, var(--accent), var(--accent2), var(--good), var(--accent));
      box-shadow:0 10px 25px rgba(119,168,255,.2);
    }
    .brand h1{font-size:16px;line-height:1.1;margin:0}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .row{display:grid;grid-template-columns: 420px 1fr; gap:14px; margin-top:14px}
    @media (max-width: 1100px){ .row{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--r); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px 14px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .card .hd h2{margin:0;font-size:14px}
    .card .hd .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .card .bd{padding:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:600px){ .grid2,.grid3{grid-template-columns:1fr} }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:600;
      cursor:pointer;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn:active{transform:scale(.98)}
    .btn.primary{
      border-color:rgba(119,168,255,.35);
      background:linear-gradient(180deg, rgba(119,168,255,.18), rgba(119,168,255,.10));
    }
    .btn.danger{
      border-color:rgba(255,92,122,.35);
      background:linear-gradient(180deg, rgba(255,92,122,.18), rgba(255,92,122,.10));
    }
    .btn.small{padding:8px 10px;font-size:12px;border-radius:12px}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .input, select{
      width:100%;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      outline:none;
    }
    .input::placeholder{color:rgba(167,181,216,.7)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .kpi{
      padding:12px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .kpi .v{font-size:18px;font-weight:800}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:4px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .tablewrap{overflow:auto;border-radius:16px;border:1px solid var(--line);background:rgba(0,0,0,.12)}
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:12px;vertical-align:top}
    th{position:sticky;top:0;background:rgba(12,21,40,.92);backdrop-filter: blur(8px);text-align:left}
    tr:hover td{background:rgba(255,255,255,.03)}
    .mono{font-family:var(--mono)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:6px 8px;border-radius:999px;font-size:11px;color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted);display:inline-block}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .score{
      font-weight:800; font-size:12px;
      padding:6px 10px;border-radius:999px;
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line); background:rgba(255,255,255,.03);
    }
    .score.good{border-color:rgba(25,209,139,.35); background:rgba(25,209,139,.10)}
    .score.warn{border-color:rgba(255,204,102,.35); background:rgba(255,204,102,.10)}
    .score.bad{border-color:rgba(255,92,122,.35); background:rgba(255,92,122,.10)}
    .footer{
      color:var(--muted);font-size:12px;margin:18px 4px 6px 4px;line-height:1.4
    }

    /* Login */
    .loginWrap{
      display:flex;justify-content:center;align-items:center;
      min-height:calc(100vh - 36px);
      padding:18px;
    }
    .loginCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:24px; box-shadow:var(--shadow);
      padding:18px;
    }
    .loginTitle{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .loginTitle h1{margin:0;font-size:18px}
    .loginTitle .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:18px;z-index:99;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.65);backdrop-filter: blur(8px);
      color:var(--text); font-size:12px;
      box-shadow:var(--shadow);
      max-width:min(720px, calc(100vw - 24px));
      display:none;
    }

    /* Chat */
    .chat{
      display:flex;flex-direction:column;gap:10px;
    }
    .chatlog{
      height:320px; overflow:auto;
      border-radius:16px;border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      padding:10px;
    }
    .msg{display:flex;gap:10px;margin:10px 0}
    .bubble{
      padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      max-width:90%;
      font-size:13px;line-height:1.35;
      white-space:pre-wrap;
    }
    .me .bubble{background:rgba(119,168,255,.10);border-color:rgba(119,168,255,.25);margin-left:auto}
    .bot .bubble{background:rgba(176,107,255,.08);border-color:rgba(176,107,255,.22)}
    .avatar{
      width:28px;height:28px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:900;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      flex:0 0 auto;
    }
    .bot .avatar{background:rgba(176,107,255,.12);border-color:rgba(176,107,255,.22)}
    .me .avatar{background:rgba(119,168,255,.12);border-color:rgba(119,168,255,.22);margin-left:auto}
    .chatbar{display:flex;gap:10px}
  </style>
</head>
<body>

<div id="loginView" class="loginWrap" hidden>
  <div class="loginCard">
    <div class="loginTitle">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>SinotticoLab</h1>
        <div class="sub">Analisi sinottici AWP in locale (tutto in RAM) + assistente N.O.R.A.</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid2">
      <div>
        <label class="hint">Username</label>
        <input id="loginUser" class="input" autocomplete="username" placeholder="es. admin"/>
      </div>
      <div>
        <label class="hint">Password</label>
        <input id="loginPass" class="input" autocomplete="current-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid2">
      <button id="btnLogin" class="btn primary">Entra</button>
      <button id="btnLogoutAll" class="btn danger">Pulisci sessione</button>
    </div>

    <div class="hint">
      Le credenziali e le scadenze sono lette da <span class="mono">users.json</span>. Nessun dato viene inviato online.
    </div>
  </div>
</div>

<div id="appView" class="app" hidden>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>SinotticoLab</h1>
        <div class="sub" id="subline">Pronto</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <div class="pill"><span class="dot good"></span>Utente: <b id="who"></b> <span id="whoRole"></span></div>
      <div class="pill">Sinottici: <b id="kSinottici">0</b></div>
      <div class="pill">Macchine: <b id="kMacchine">0</b></div>
      <button id="btnLogout" class="btn small">Esci</button>
    </div>
  </div>

  <div class="row">
    <!-- Left column -->
    <div class="card">
      <div class="hd">
        <div>
          <h2>Caricamento</h2>
          <div class="meta">Legge <span class="mono">manifest.json</span> e analizza i sinottici in <span class="mono">Dati/</span>.</div>
        </div>
      </div>
      <div class="bd">
        <div class="grid2">
          <button id="btnLoadManifest" class="btn">Ricarica manifest</button>
          <button id="btnAnalyzeAll" class="btn primary">Analizza tutti</button>
        </div>

        <div class="sep"></div>

        <label class="hint">Seleziona un sinottico (per debug o analisi singola)</label>
        <select id="selSinottico"></select>

        <div class="grid2" style="margin-top:10px">
          <button id="btnAnalyzeOne" class="btn">Analizza selezionato</button>
          <button id="btnClearRAM" class="btn danger">Svuota RAM</button>
        </div>

        <div class="sep"></div>

        <div class="grid3">
          <div class="kpi">
            <div class="v" id="kSnapshots">0</div>
            <div class="l">Snapshot (righe) in RAM</div>
          </div>
          <div class="kpi">
            <div class="v" id="kStorici">0</div>
            <div class="l">Macchine con storico</div>
          </div>
          <div class="kpi">
            <div class="v" id="kLast">‚Äî</div>
            <div class="l">Ultimo file caricato</div>
          </div>
        </div>

        <div class="hint" id="statusBox" style="margin-top:12px">
          Suggerimento: se non vedi macchine, quasi sempre √® un problema di intestazioni Excel. Qui facciamo ‚Äúauto-mapping‚Äù delle colonne pi√π comuni.
        </div>
      </div>
    </div>

    <!-- Right column -->
    <div class="card">
      <div class="hd">
        <div>
          <h2>Macchine</h2>
          <div class="meta">Filtro + lista. Clicca una riga per i dettagli e il grafico.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <span class="tag"><span class="dot warn"></span>payout score = stima, non certezza</span>
        </div>
      </div>
      <div class="bd">
        <div class="grid3">
          <input id="q" class="input" placeholder="Cerca: codice / esercente / comune / ubicazione / modello‚Ä¶"/>
          <select id="selComune"></select>
          <select id="selEsercente"></select>
        </div>

        <div class="grid2" style="margin-top:10px">
          <select id="selTime">
            <option value="all">Grafico: tutto lo storico</option>
            <option value="365">Grafico: ultimi 365 giorni</option>
            <option value="90">Grafico: ultimi 90 giorni</option>
            <option value="30">Grafico: ultimi 30 giorni</option>
          </select>
          <select id="selSort">
            <option value="score_desc">Ordina: payout score (‚Üì)</option>
            <option value="score_asc">Ordina: payout score (‚Üë)</option>
            <option value="net_desc">Ordina: NET (‚Üì)</option>
            <option value="in_desc">Ordina: CNTTOTIN (‚Üì)</option>
            <option value="out_desc">Ordina: CNTTOTOT (‚Üì)</option>
            <option value="alpha">Ordina: A-Z</option>
          </select>
        </div>

        <div class="sep"></div>

        <div class="tablewrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>Score</th>
                <th>Codice</th>
                <th>Comune</th>
                <th>Esercente</th>
                <th>Ubicazione</th>
                <th>Modello</th>
                <th>Ciclo</th>
                <th class="mono">IN</th>
                <th class="mono">OUT</th>
                <th class="mono">NET</th>
                <th>% OUT</th>
                <th>Ultimo</th>
              </tr>
            </thead>
            <tbody id="tb"></tbody>
          </table>
        </div>

        <div class="sep"></div>

        <div class="card" style="background:rgba(0,0,0,.10)">
          <div class="hd">
            <div>
              <h2>Dettaglio macchina</h2>
              <div class="meta" id="detailMeta">Seleziona una macchina dalla tabella.</div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
              <button id="btnCopyId" class="btn small" disabled>Copia codice</button>
              <button id="btnOpenChat" class="btn small">Chiedi a N.O.R.A.</button>
            </div>
          </div>
          <div class="bd">
            <div class="grid3" id="detailKPIs" style="margin-bottom:10px">
              <div class="kpi"><div class="v" id="dScore">‚Äî</div><div class="l">Payout score</div></div>
              <div class="kpi"><div class="v mono" id="dNet">‚Äî</div><div class="l">NET (IN-OUT)</div></div>
              <div class="kpi"><div class="v" id="dOutPct">‚Äî</div><div class="l">% OUT</div></div>
            </div>
            <canvas id="chart" height="130"></canvas>
            <div class="hint" id="chartHint" style="margin-top:8px"></div>

            <div class="sep"></div>

            <div class="tablewrap">
              <table id="tblHist">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th class="mono">IN</th>
                    <th class="mono">OUT</th>
                    <th class="mono">NET</th>
                    <th>% OUT</th>
                    <th>PDV</th>
                    <th>PDA</th>
                    <th>Schedule</th>
                  </tr>
                </thead>
                <tbody id="tbHist"></tbody>
              </table>
            </div>

            <div class="hint" style="margin-top:10px">
              Colonne estratte se disponibili: PDV/PDA, Schedule ID/data, ecc. Se un sinottico non le contiene, appare ‚Äú‚Äî‚Äù.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="row" style="grid-template-columns: 1fr 420px">
    <div class="card">
      <div class="hd">
        <div>
          <h2>Diagnostica</h2>
          <div class="meta">Se qualcosa non carica, qui trovi i motivi (CORS, percorso, intestazioni, ecc.).</div>
        </div>
      </div>
      <div class="bd">
        <div class="tablewrap" style="min-height:220px">
          <table>
            <thead>
              <tr><th>Momento</th><th>Evento</th><th>Dettaglio</th></tr>
            </thead>
            <tbody id="tbLog"></tbody>
          </table>
        </div>
        <div class="hint" style="margin-top:10px">
          Nota GitHub Pages: i nomi cartella sono case-sensitive. Se la tua cartella √® <span class="mono">dati</span> e non <span class="mono">Dati</span>, cambia la voce in <span class="mono">manifest.json</span> (o rinomina).
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h2>Chat N.O.R.A.</h2>
          <div class="meta">Neural Operational Report Assistant (offline). Usa i dati in RAM.</div>
        </div>
      </div>
      <div class="bd">
        <div class="chat">
          <div class="chatlog" id="chatlog"></div>
          <div class="chatbar">
            <input id="chatIn" class="input" placeholder="Es: quale macchina √® in pagamento? / quando paga 123456?"/>
            <button id="btnChat" class="btn primary">Invia</button>
          </div>
          <div class="hint">
            Esempi: ‚ÄúTop 10 in pagamento a Molini‚Äù, ‚Äústorico macchina 123‚Ä¶‚Äù, ‚Äúquando paga questa?‚Äù (se hai selezionato la macchina).
            Se chiedi cose fuori dal programma, N.O.R.A. ti riporta sui binari.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div><b>Importante:</b> la stima ‚Äúin pagamento‚Äù √® un <i>indicatore</i> basato su ciclo + andamento IN/OUT. Non √® un oracolo, ma aiuta a decidere dove guardare prima. üß†‚öôÔ∏è</div>
    <div style="margin-top:8px">Salvataggi: solo preferenze UI e sessione in <span class="mono">localStorage</span>.</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(() => {
  'use strict';

  // ------------------------------
  // Utilities
  // ------------------------------
  const $ = (q) => document.querySelector(q);
  const esc = (s) => (s ?? '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const nowISO = () => new Date().toISOString();
  const fmtDT = (d) => {
    try {
      const x = (d instanceof Date) ? d : new Date(d);
      return x.toLocaleString('it-IT', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    } catch { return String(d); }
  };
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  const toast = (msg) => {
    const t = $('#toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(toast._h);
    toast._h = setTimeout(() => (t.style.display='none'), 3200);
  };

  const log = (ev, detail='') => {
    const tb = $('#tbLog');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="mono">${esc(fmtDT(new Date()))}</td><td>${esc(ev)}</td><td>${esc(detail)}</td>`;
    tb.prepend(tr);
  };

  // ------------------------------
  // Config / Paths
  // ------------------------------
  const DEFAULT_DATA_FOLDER = 'Dati';   // fallback if manifest doesn't specify
  const PATH = {
    manifest: './manifest.json',
    users: './users.json',
    ciclos: './cicloslot.json'
  };

  // ------------------------------
  // App State (RAM-only)
  // ------------------------------
  const RAM = {
    user: null,          // {username, role, level, expiresAt}
    accessLevel: 0,
    dataFolder: DEFAULT_DATA_FOLDER,
    manifest: null,      // parsed manifest
    ciclos: [],          // cicloslot.json list
    cicloByModel: new Map(), // modelCode -> {ciclo, nomeModello}
    sinottici: [],       // filenames
    snapshots: 0,        // total rows ingested
    machines: new Map(), // machineId -> machineObject (last snapshot + static info)
    history: new Map(),  // machineId -> [{date,file, in,out,outPct, pdv,pda,scheduleId,scheduleDate, net, rawRow}]
    selectedId: null,
    chart: null
  };

  // ------------------------------
  // Login
  // ------------------------------
  const SESSION_KEY = 'sinotticolab_session_v1';

  async function loadUsers(){
    const res = await fetch(PATH.users, {cache:'no-store'});
    if(!res.ok) throw new Error(`users.json non trovato (${res.status})`);
    return await res.json();
  }

  function parseDateLoose(s){
    if(!s) return null;
    const str = String(s).trim();
    // common formats: YYYY-MM-DD, DD/MM/YYYY, etc.
    let d = new Date(str);
    if(!isNaN(d)) return d;
    const m = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(m) return new Date(`${m[3]}-${m[2]}-${m[1]}T00:00:00`);
    return null;
  }

  function saveSession(session){
    localStorage.setItem(SESSION_KEY, JSON.stringify(session));
  }
  function loadSession(){
    try { return JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); }
    catch { return null; }
  }
  function clearSession(){
    localStorage.removeItem(SESSION_KEY);
  }

  function sessionValid(sess){
    if(!sess || !sess.username) return false;
    if(sess.expiresAt){
      const d = new Date(sess.expiresAt);
      if(!isNaN(d) && new Date() > d) return false;
    }
    return true;
  }

  async function doLogin(){
    const u = $('#loginUser').value.trim();
    const p = $('#loginPass').value;
    if(!u || !p){ toast('Inserisci username e password'); return; }

    let users;
    try { users = await loadUsers(); }
    catch(e){ log('LOGIN_ERR', e.message); toast(e.message); return; }

    const found = (users||[]).find(x => String(x.username).toLowerCase() === u.toLowerCase());
    if(!found){ toast('Utente non trovato'); return; }
    if(String(found.password) !== p){ toast('Password errata'); return; }

    const exp = parseDateLoose(found.expiresAt);
    if(exp && new Date() > exp){
      toast('Account scaduto'); return;
    }

    RAM.user = {
      username: found.username,
      role: found.role || 'user',
      level: Number(found.level || 1),
      expiresAt: exp ? exp.toISOString() : null
    };
    RAM.accessLevel = RAM.user.level;

    saveSession(RAM.user);
    log('LOGIN_OK', `${RAM.user.username} (${RAM.user.role}, lvl ${RAM.user.level})`);
    toast('Accesso effettuato');
    showApp();
  }

  function doLogout(){
    RAM.user = null;
    RAM.accessLevel = 0;
    clearSession();
    toast('Sessione chiusa');
    showLogin();
  }

  function showLogin(){
    $('#appView').hidden = true;
    $('#loginView').hidden = false;
    $('#loginPass').value = '';
  }
  function showApp(){
    $('#loginView').hidden = true;
    $('#appView').hidden = false;

    $('#who').textContent = RAM.user?.username || '‚Äî';
    $('#whoRole').textContent = RAM.user?.role ? `(${RAM.user.role})` : '';
    $('#subline').textContent = 'Carica manifest e analizza i sinottici quando vuoi.';
  }

  // ------------------------------
  // Manifest & cicloslot
  // ------------------------------
  async function loadManifest(){
    const res = await fetch(PATH.manifest, {cache:'no-store'});
    if(!res.ok) throw new Error(`manifest.json non trovato (${res.status})`);
    return await res.json();
  }

  async function loadCiclos(){
    const res = await fetch(PATH.ciclos, {cache:'no-store'});
    if(!res.ok) throw new Error(`cicloslot.json non trovato (${res.status})`);
    return await res.json();
  }

  function buildCicloIndex(list){
    RAM.cicloByModel.clear();
    (list||[]).forEach(x => {
      const code = String(x.codiceModello || '').trim();
      if(!code) return;
      RAM.cicloByModel.set(code, { ciclo: Number(x.ciclo || 0), nome: x.nomeModello || '' });
    });
  }

  function setStatus(msg){
    $('#statusBox').textContent = msg;
  }

  function refreshSinotticiSelect(){
    const sel = $('#selSinottico');
    sel.innerHTML = '';
    (RAM.sinottici || []).forEach(fn => {
      const opt = document.createElement('option');
      opt.value = fn;
      opt.textContent = fn;
      sel.appendChild(opt);
    });
    $('#kSinottici').textContent = String(RAM.sinottici.length);
  }

  async function cmdLoadManifest(){
    try{
      setStatus('Carico manifest e cicloslot‚Ä¶');
      log('MANIFEST_LOAD', 'start');

      const [m, c] = await Promise.all([loadManifest(), loadCiclos()]);
      RAM.manifest = m;
      RAM.ciclos = c;
      buildCicloIndex(c);

      // data folder
      RAM.dataFolder = (m?.dati_folder || m?.datiFolder || m?.dataFolder || DEFAULT_DATA_FOLDER).toString().trim() || DEFAULT_DATA_FOLDER;
      RAM.sinottici = (m?.sinottici || m?.files || []).slice();

      refreshSinotticiSelect();
      setStatus(`Manifest OK. Trovati ${RAM.sinottici.length} sinottici. Cartella dati: ${RAM.dataFolder}/`);
      log('MANIFEST_OK', `${RAM.sinottici.length} files, folder=${RAM.dataFolder}`);

      hydrateFilters();
    }catch(e){
      setStatus(`Errore manifest: ${e.message}`);
      log('MANIFEST_ERR', e.message);
      toast('Errore nel caricamento manifest/cicli');
    }
  }

  // ------------------------------
  // XLSX parsing (robusto)
  // ------------------------------
  function parseDateFromFilename(fn){
    // Examples:
    // Sinottico-2025-12-27-0845.xlsx
    // Sinottico-2025-10-10-14:30.xlsx
    // Sinottico-2025-10-07.xlsx
    const base = String(fn || '');
    const m = base.match(/(\d{4})-(\d{2})-(\d{2})(?:-([0-9]{2})(?::?([0-9]{2}))?)?/);
    if(!m) return new Date();
    const Y=m[1], M=m[2], D=m[3];
    const hh=m[4] ?? '00';
    const mm=m[5] ?? '00';
    return new Date(`${Y}-${M}-${D}T${hh}:${mm}:00`);
  }

  function normalizeKey(k){
    return String(k||'')
      .trim()
      .toUpperCase()
      .replace(/\s+/g,' ')
      .replace(/[._-]+/g,' ')
      .replace(/[√†√°√¢√§]/g,'A')
      .replace(/[√®√©√™√´]/g,'E')
      .replace(/[√¨√≠√Æ√Ø]/g,'I')
      .replace(/[√≤√≥√¥√∂]/g,'O')
      .replace(/[√π√∫√ª√º]/g,'U');
  }

  // Column aliasing: map whatever header you find into canonical keys
  const COLMAP = [
    {canon:'id',     any:['CODICE', 'CODICE AWP', 'ID AWP', 'IDAWP', 'AWP', 'COD']},
    {canon:'cp',     any:['CPROD','CODICE MODELLO','MODEL CODE','CODICE PRODOTTO']},
    {canon:'comune', any:['COMUNE','CITTA','PAESE']},
    {canon:'eserc',  any:['ESERCENTE','GESTORE','INTESTATARIO','RAGIONE SOCIALE']},
    {canon:'ubic',   any:['UBICAZIONE','INDIRIZZO','LOCALITA','VIA']},
    {canon:'esercizio', any:['ESERCIZIO','PUNTO VENDITA','PV','PDV']},
    {canon:'cntIn',  any:['CNTTOTIN','TOT IN','TOTALE IN','CONTIN','IN']},
    {canon:'cntOut', any:['CNTTOTOT','TOT OUT','TOTALE OUT','CONTOUT','OUT']},
    {canon:'outPct', any:['% OUT','OUT %','PERCENTUALE OUT','PERC OUT']},
    {canon:'incasso',any:['INCASSO','INCASSI','NET','NETTO']},
    {canon:'pda',    any:['PDA','CODICE PDA']},
    {canon:'pdv',    any:['PDV','CODICE PDV','PUNTO VENDITA']},
    {canon:'schedId',any:['SCHEDULE ID','ID SCHEDULE','SCHEDULE']},
    {canon:'schedDate',any:['DATA SCHEDULE','SCHEDULE DATE','DATA']},
  ];

  function buildHeaderMap(headers){
    const map = new Map(); // canon -> actual header
    const normToActual = new Map();
    headers.forEach(h => normToActual.set(normalizeKey(h), h));

    for(const rule of COLMAP){
      for(const alias of rule.any){
        const hit = normToActual.get(normalizeKey(alias));
        if(hit){ map.set(rule.canon, hit); break; }
      }
    }
    return map;
  }

  function pickFirstSheet(workbook){
    const names = workbook.SheetNames || [];
    // prefer Sheet0/Foglio1/something with data
    for(const n of names){
      const ws = workbook.Sheets[n];
      if(!ws) continue;
      const range = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
      const rows = range.e.r - range.s.r + 1;
      const cols = range.e.c - range.s.c + 1;
      if(rows >= 2 && cols >= 5) return n;
    }
    return names[0];
  }

  function toNumber(x){
    if(x === null || x === undefined || x === '') return null;
    if(typeof x === 'number') return x;
    const s = String(x).replace(/\./g,'').replace(',', '.').replace('%','').trim();
    const n = Number(s);
    return isNaN(n) ? null : n;
  }

  async function fetchXlsx(filename){
    const url = `./${RAM.dataFolder}/${encodeURIComponent(filename)}`;
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(`Fetch XLSX fallito (${res.status}) ${url}`);
    const buf = await res.arrayBuffer();
    return buf;
  }

  function ingestRows(rows, fileDate, filename){
    if(!rows || !rows.length) return 0;

    // build header map from first row keys
    const headers = Object.keys(rows[0] || {});
    const hm = buildHeaderMap(headers);

    const h = (canon) => hm.get(canon) || null;

    let ingested = 0;

    for(const r of rows){
      // identify machine id
      const idRaw = h('id') ? r[h('id')] : (r['CODICE'] ?? r['ID AWP'] ?? r['CODICE AWP']);
      const id = String(idRaw || '').trim();
      if(!id) continue;

      const cp = h('cp') ? String(r[h('cp')]||'').trim() : '';
      const comune = h('comune') ? String(r[h('comune')]||'').trim() : '';
      const eserc = h('eserc') ? String(r[h('eserc')]||'').trim() : '';
      const ubic = h('ubic') ? String(r[h('ubic')]||'').trim() : '';
      const pdv = h('pdv') ? String(r[h('pdv')]||'').trim() : '';
      const pda = h('pda') ? String(r[h('pda')]||'').trim() : '';
      const schedId = h('schedId') ? String(r[h('schedId')]||'').trim() : '';
      const schedDate = h('schedDate') ? String(r[h('schedDate')]||'').trim() : '';

      const cntIn = toNumber(h('cntIn') ? r[h('cntIn')] : null);
      const cntOut = toNumber(h('cntOut') ? r[h('cntOut')] : null);
      const outPct = toNumber(h('outPct') ? r[h('outPct')] : null);
      // if outPct is in 0..100 or already 0..1? normalize:
      const outPctNorm = (outPct !== null && outPct !== undefined)
        ? (outPct > 1.2 ? outPct : outPct * 100)
        : null;

      // derive net from in/out if incasso not reliable
      const net = (cntIn !== null && cntOut !== null) ? (cntIn - cntOut) : (toNumber(h('incasso') ? r[h('incasso')] : null));

      // update last snapshot
      const existing = RAM.machines.get(id) || { id, cp, comune, eserc, ubic, pdv, pda };
      existing.id = id;
      existing.cp = cp || existing.cp || '';
      existing.comune = comune || existing.comune || '';
      existing.eserc = eserc || existing.eserc || '';
      existing.ubic = ubic || existing.ubic || '';
      existing.pdv = pdv || existing.pdv || '';
      existing.pda = pda || existing.pda || '';
      existing.last = {
        date: fileDate,
        file: filename,
        cntIn, cntOut, net, outPct: outPctNorm,
        schedId, schedDate
      };
      RAM.machines.set(id, existing);

      // append to history (unique per date/file)
      const arr = RAM.history.get(id) || [];
      arr.push({
        date: fileDate,
        file: filename,
        cntIn, cntOut, net, outPct: outPctNorm,
        pdv, pda, schedId, schedDate,
        raw: r
      });
      RAM.history.set(id, arr);

      ingested++;
    }
    return ingested;
  }

  function finalizeHistory(){
    // sort and dedupe by date+file, and compute scores
    for(const [id, arr] of RAM.history){
      arr.sort((a,b) => a.date - b.date);
      const dedup = [];
      const seen = new Set();
      for(const x of arr){
        const k = `${x.date.toISOString()}|${x.file}`;
        if(seen.has(k)) continue;
        seen.add(k);
        dedup.push(x);
      }
      RAM.history.set(id, dedup);
    }
  }

  // ------------------------------
  // Payout prediction ("more neural" but offline)
  // ------------------------------
  function cicloForMachine(m){
    const code = String(m.cp || '').trim();
    if(!code) return {ciclo:0, nome:''};
    const hit = RAM.cicloByModel.get(code);
    if(hit) return hit;
    return {ciclo:0, nome:''};
  }

  function computeScore(m){
    const hist = RAM.history.get(m.id) || [];
    const last = hist[hist.length-1] || m.last;
    if(!last) return {score:0, reason:'Nessun dato'};

    const {ciclo, nome} = cicloForMachine(m);
    const inV = (last.cntIn ?? null);
    const outV = (last.cntOut ?? null);
    const netV = (last.net ?? ((inV!==null && outV!==null) ? (inV-outV) : null));
    const outPct = last.outPct;

    // feature 1: cycle proximity
    let fCycle = 0, distToCycle = null, pos = null;
    if(ciclo && inV !== null){
      pos = ((inV % ciclo) + ciclo) % ciclo;
      distToCycle = ciclo - pos;
      // closer to end -> higher
      const frac = 1 - (distToCycle / ciclo);
      fCycle = clamp(frac, 0, 1);
    }

    // feature 2: recent trend (delta IN vs delta OUT)
    let fTrend = 0;
    if(hist.length >= 2){
      const a = hist[hist.length-2], b = hist[hist.length-1];
      const dIn = (b.cntIn ?? 0) - (a.cntIn ?? 0);
      const dOut = (b.cntOut ?? 0) - (a.cntOut ?? 0);
      // More IN than OUT recently can indicate "charging up" (heuristic)
      const denom = Math.max(1, Math.abs(dIn) + Math.abs(dOut));
      fTrend = clamp((dIn - dOut) / denom * 0.5 + 0.5, 0, 1);
    }

    // feature 3: out percentage compared to expected (very heuristic)
    let fOutPct = 0.5;
    if(outPct !== null){
      // lower out% => potentially more "due" (heuristic)
      // range 60..100 => map to 1..0
      fOutPct = clamp(1 - ((outPct - 60) / 40), 0, 1);
    }

    // feature 4: net size (normalized)
    let fNet = 0.5;
    if(netV !== null){
      const scale = 5000; // tune
      fNet = clamp((netV / scale) * 0.5 + 0.5, 0, 1);
    }

    // Weighted sum
    const w1=0.38, w2=0.22, w3=0.20, w4=0.20;
    const raw = (w1*fCycle + w2*fTrend + w3*fOutPct + w4*fNet);
    const score = Math.round(raw * 100);

    // Explain
    const parts = [];
    if(ciclo && distToCycle !== null) parts.push(`distanza ciclo ~${Math.round(distToCycle)}/${ciclo}`);
    if(hist.length>=2){
      const a = hist[hist.length-2], b = hist[hist.length-1];
      const dIn = (b.cntIn ?? 0) - (a.cntIn ?? 0);
      const dOut = (b.cntOut ?? 0) - (a.cntOut ?? 0);
      parts.push(`ŒîIN ${Math.round(dIn)}, ŒîOUT ${Math.round(dOut)}`);
    }
    if(outPct !== null) parts.push(`OUT% ${outPct.toFixed(1)}`);
    if(netV !== null) parts.push(`NET ${Math.round(netV)}`);

    return {score, ciclo, nome, distToCycle, pos, netV, outPct, reason: parts.join(' | ')};
  }

  function scoreClass(score){
    if(score >= 72) return 'good';
    if(score >= 45) return 'warn';
    return 'bad';
  }

  // ------------------------------
  // Analysis commands
  // ------------------------------
  async function analyzeFile(filename){
    const fileDate = parseDateFromFilename(filename);
    setStatus(`Carico ${filename}‚Ä¶`);
    log('XLSX_LOAD', filename);

    const buf = await fetchXlsx(filename);
    const wb = XLSX.read(buf, {type:'array'});
    const sheetName = pickFirstSheet(wb);
    if(!sheetName) throw new Error('Nessun foglio trovato nel file');
    const ws = wb.Sheets[sheetName];

    const rows = XLSX.utils.sheet_to_json(ws, {defval:null});
    const n = ingestRows(rows, fileDate, filename);
    RAM.snapshots += n;

    $('#kLast').textContent = filename;
    $('#kSnapshots').textContent = String(RAM.snapshots);

    log('XLSX_OK', `${filename} righe=${rows.length}, ingest=${n}, sheet=${sheetName}`);
    setStatus(`OK: ${filename} (righe: ${rows.length}, importate: ${n}).`);
  }

  async function cmdAnalyzeOne(){
    const filename = $('#selSinottico').value;
    if(!filename){ toast('Nessun sinottico selezionato'); return; }
    try{
      await analyzeFile(filename);
      finalizeHistory();
      rebuildMachinesAndUI();
      toast('Analisi completata');
    }catch(e){
      setStatus(`Errore: ${e.message}`);
      log('ANALYZE_ONE_ERR', e.message);
      toast('Errore analisi');
    }
  }

  async function cmdAnalyzeAll(){
    if(!RAM.sinottici.length){ toast('Manifest vuoto: caricalo prima'); return; }

    // simple guard for huge loads on mobile
    const total = RAM.sinottici.length;
    setStatus(`Analisi di ${total} sinottici‚Ä¶ (pu√≤ essere pesante su telefono)`);
    log('ANALYZE_ALL', `files=${total}`);

    const btn = $('#btnAnalyzeAll');
    btn.disabled = true;

    try{
      // Analyze in chronological order to build clean history
      const files = RAM.sinottici.slice().sort((a,b)=>parseDateFromFilename(a)-parseDateFromFilename(b));
      let i=0;
      for(const fn of files){
        i++;
        $('#subline').textContent = `Analisi ${i}/${total}: ${fn}`;
        await analyzeFile(fn);
        // yield UI thread
        if(i % 3 === 0) await sleep(20);
      }
      finalizeHistory();
      rebuildMachinesAndUI();
      toast('Analisi completa di tutti i sinottici');
      $('#subline').textContent = `Analisi completa: ${total} sinottici.`;
    }catch(e){
      setStatus(`Errore: ${e.message}`);
      log('ANALYZE_ALL_ERR', e.message);
      toast('Errore analisi globale');
    }finally{
      btn.disabled = false;
    }
  }

  function cmdClearRAM(){
    RAM.snapshots = 0;
    RAM.machines.clear();
    RAM.history.clear();
    RAM.selectedId = null;

    $('#kSnapshots').textContent = '0';
    $('#kStorici').textContent = '0';
    $('#kLast').textContent = '‚Äî';
    $('#kMacchine').textContent = '0';
    $('#tb').innerHTML = '';
    $('#tbHist').innerHTML = '';
    $('#detailMeta').textContent = 'Seleziona una macchina dalla tabella.';
    $('#btnCopyId').disabled = true;

    if(RAM.chart){ RAM.chart.destroy(); RAM.chart=null; }
    setStatus('RAM svuotata.');
    log('RAM_CLEAR', 'ok');
    toast('RAM svuotata');
    hydrateFilters();
  }

  // ------------------------------
  // UI: filters, table, detail
  // ------------------------------
  function hydrateFilters(){
    const selComune = $('#selComune');
    const selEsercente = $('#selEsercente');

    const comuni = new Set();
    const eserc = new Set();

    for(const m of RAM.machines.values()){
      if(m.comune) comuni.add(m.comune);
      if(m.eserc) eserc.add(m.eserc);
    }

    const fill = (sel, items, label) => {
      const prev = sel.value;
      sel.innerHTML = '';
      const o0 = document.createElement('option');
      o0.value = '';
      o0.textContent = label;
      sel.appendChild(o0);
      [...items].sort((a,b)=>a.localeCompare(b)).forEach(v => {
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v;
        sel.appendChild(o);
      });
      if([...sel.options].some(o=>o.value===prev)) sel.value = prev;
    };

    fill(selComune, comuni, 'Tutti i comuni');
    fill(selEsercente, eserc, 'Tutti gli esercenti');
  }

  function machineRow(m, scoreObj){
    const last = m.last || {};
    const score = scoreObj.score;
    const cls = scoreClass(score);
    const cicloLabel = scoreObj.ciclo ? String(scoreObj.ciclo) : '‚Äî';
    const modelloLabel = (scoreObj.nome || m.cp || '‚Äî');
    const outPctLabel = (scoreObj.outPct !== null && scoreObj.outPct !== undefined) ? `${scoreObj.outPct.toFixed(1)}%` : '‚Äî';
    const inLabel = (last.cntIn ?? '‚Äî');
    const outLabel = (last.cntOut ?? '‚Äî');
    const netLabel = (last.net ?? ((last.cntIn!=null && last.cntOut!=null) ? (last.cntIn-last.cntOut) : '‚Äî'));

    return `
      <tr data-id="${esc(m.id)}" style="cursor:pointer">
        <td><span class="score ${cls}"><span class="dot ${cls}"></span>${score}</span></td>
        <td class="mono">${esc(m.id)}</td>
        <td>${esc(m.comune||'')}</td>
        <td>${esc(m.eserc||'')}</td>
        <td>${esc(m.ubic||'')}</td>
        <td>${esc(modelloLabel)}</td>
        <td class="mono">${esc(cicloLabel)}</td>
        <td class="mono">${esc(inLabel)}</td>
        <td class="mono">${esc(outLabel)}</td>
        <td class="mono">${esc(netLabel)}</td>
        <td>${esc(outPctLabel)}</td>
        <td>${esc(fmtDT(last.date || ''))}</td>
      </tr>
    `;
  }

  function rebuildMachinesAndUI(){
    // recompute last snapshots based on history sorting
    for(const [id, arr] of RAM.history){
      const m = RAM.machines.get(id);
      if(!m) continue;
      const last = arr[arr.length-1];
      m.last = {
        date:last.date, file:last.file,
        cntIn:last.cntIn, cntOut:last.cntOut, net:last.net, outPct:last.outPct,
        schedId:last.schedId, schedDate:last.schedDate
      };
      RAM.machines.set(id, m);
    }

    $('#kMacchine').textContent = String(RAM.machines.size);
    $('#kStorici').textContent = String(RAM.history.size);

    hydrateFilters();
    renderTable();

    // if selected machine still exists, refresh detail
    if(RAM.selectedId && RAM.machines.has(RAM.selectedId)){
      openMachine(RAM.selectedId);
    }
  }

  function getFilteredMachines(){
    const q = $('#q').value.trim().toLowerCase();
    const comune = $('#selComune').value;
    const eserc = $('#selEsercente').value;

    const list = [];
    for(const m of RAM.machines.values()){
      if(comune && m.comune !== comune) continue;
      if(eserc && m.eserc !== eserc) continue;

      if(q){
        const hay = `${m.id} ${m.comune||''} ${m.eserc||''} ${m.ubic||''} ${m.cp||''}`.toLowerCase();
        if(!hay.includes(q)) continue;
      }
      const sc = computeScore(m);
      list.push({m, sc});
    }
    return list;
  }

  function sortList(list){
    const mode = $('#selSort').value;
    const by = {
      score_desc: (a,b)=>b.sc.score - a.sc.score,
      score_asc: (a,b)=>a.sc.score - b.sc.score,
      net_desc: (a,b)=> (b.sc.netV??-1e18) - (a.sc.netV??-1e18),
      in_desc: (a,b)=> ((b.m.last?.cntIn??-1e18) - (a.m.last?.cntIn??-1e18)),
      out_desc:(a,b)=> ((b.m.last?.cntOut??-1e18) - (a.m.last?.cntOut??-1e18)),
      alpha:    (a,b)=> String(a.m.id).localeCompare(String(b.m.id))
    };
    list.sort(by[mode] || by.score_desc);
    return list;
  }

  function renderTable(){
    const list = sortList(getFilteredMachines());
    const tb = $('#tb');
    tb.innerHTML = list.map(x => machineRow(x.m, x.sc)).join('');

    tb.querySelectorAll('tr').forEach(tr => {
      tr.addEventListener('click', () => {
        const id = tr.getAttribute('data-id');
        if(id) openMachine(id);
      });
    });

    log('TABLE_RENDER', `rows=${list.length}`);
  }

  // Downsample to keep chart readable on huge histories
  function downsample(points, maxPoints=450){
    if(points.length <= maxPoints) return points;
    const step = points.length / maxPoints;
    const out = [];
    for(let i=0;i<maxPoints;i++){
      out.push(points[Math.floor(i*step)]);
    }
    // ensure last point
    out[out.length-1] = points[points.length-1];
    return out;
  }

  function openMachine(id){
    const m = RAM.machines.get(id);
    if(!m) return;

    RAM.selectedId = id;
    $('#btnCopyId').disabled = false;

    const sc = computeScore(m);
    $('#detailMeta').innerHTML = `<span class="mono">${esc(m.id)}</span> ¬∑ ${esc(m.comune||'')} ¬∑ ${esc(m.eserc||'')} ¬∑ ${esc(m.ubic||'')}`;
    $('#dScore').textContent = String(sc.score);
    $('#dNet').textContent = (sc.netV !== null && sc.netV !== undefined) ? String(Math.round(sc.netV)) : '‚Äî';
    $('#dOutPct').textContent = (sc.outPct !== null && sc.outPct !== undefined) ? `${sc.outPct.toFixed(1)}%` : '‚Äî';

    const hist = (RAM.history.get(id) || []).slice();
    const timeMode = $('#selTime').value;
    let filtered = hist;
    if(timeMode !== 'all'){
      const days = Number(timeMode);
      const cut = new Date();
      cut.setDate(cut.getDate() - days);
      filtered = hist.filter(x => x.date >= cut);
    }

    // build chart points
    const points = filtered.map(x => ({
      t: x.date,
      in: x.cntIn ?? null,
      out: x.cntOut ?? null,
      net: x.net ?? ((x.cntIn!=null && x.cntOut!=null) ? (x.cntIn-x.cntOut) : null)
    }));
    const ds = downsample(points);

    // chart
    const ctx = $('#chart');
    if(RAM.chart){ RAM.chart.destroy(); RAM.chart=null; }
    RAM.chart = new Chart(ctx, {
      type:'line',
      data:{
        labels: ds.map(p => p.t),
        datasets:[
          {label:'NET (IN-OUT)', data: ds.map(p => p.net), tension:0.25, pointRadius:0},
          {label:'IN', data: ds.map(p => p.in), tension:0.25, pointRadius:0},
          {label:'OUT', data: ds.map(p => p.out), tension:0.25, pointRadius:0},
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'index', intersect:false},
        plugins:{
          legend:{labels:{color:'#e7eefc'}},
          tooltip:{
            callbacks:{
              title:(items)=> items?.[0]?.label ? fmtDT(items[0].label) : ''
            }
          }
        },
        scales:{
          x:{
            ticks:{color:'#a7b5d8', maxRotation:0, autoSkip:true},
            grid:{color:'rgba(255,255,255,.06)'}
          },
          y:{
            ticks:{color:'#a7b5d8'},
            grid:{color:'rgba(255,255,255,.06)'}
          }
        }
      }
    });

    // hint
    const {ciclo, distToCycle, nome} = sc;
    let hint = `Modello: ${nome || (m.cp || '‚Äî')}. `;
    if(ciclo && distToCycle != null){
      hint += `Ciclo ${ciclo}: distanza stimata al giro ~${Math.round(distToCycle)} conteggi. `;
    } else {
      hint += `Ciclo non trovato per CPROD=${m.cp||'‚Äî'} (aggiorna cicloslot.json). `;
    }
    hint += `Dettagli: ${sc.reason}`;
    $('#chartHint').textContent = hint;

    // history table
    const tb = $('#tbHist');
    tb.innerHTML = '';
    const rows = filtered.slice().reverse(); // newest first
    for(const x of rows){
      const net = x.net ?? ((x.cntIn!=null && x.cntOut!=null) ? (x.cntIn-x.cntOut) : null);
      const outPct = (x.outPct != null) ? `${x.outPct.toFixed(1)}%` : '‚Äî';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(fmtDT(x.date))}<div class="hint mono" style="margin-top:3px">${esc(x.file)}</div></td>
        <td class="mono">${esc(x.cntIn ?? '‚Äî')}</td>
        <td class="mono">${esc(x.cntOut ?? '‚Äî')}</td>
        <td class="mono">${esc(net ?? '‚Äî')}</td>
        <td>${esc(outPct)}</td>
        <td class="mono">${esc(x.pdv || '‚Äî')}</td>
        <td class="mono">${esc(x.pda || '‚Äî')}</td>
        <td class="mono">${esc(x.schedId || '‚Äî')}<div class="hint mono" style="margin-top:3px">${esc(x.schedDate || '')}</div></td>
      `;
      tb.appendChild(tr);
    }

    log('OPEN_MACHINE', id);
  }

  // ------------------------------
  // Clipboard
  // ------------------------------
  async function copySelectedId(){
    if(!RAM.selectedId) return;
    try{
      await navigator.clipboard.writeText(RAM.selectedId);
      toast('Codice copiato');
    }catch{
      toast('Clipboard non disponibile');
    }
  }

  // ------------------------------
  // N.O.R.A. Chat (offline assistant)
  // ------------------------------
  function chatAdd(role, text){
    const logEl = $('#chatlog');
    const wrap = document.createElement('div');
    wrap.className = `msg ${role}`;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'me' ? 'ME' : 'NORA';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;

    if(role === 'me'){
      wrap.appendChild(bubble);
      wrap.appendChild(avatar);
    }else{
      wrap.appendChild(avatar);
      wrap.appendChild(bubble);
    }
    logEl.appendChild(wrap);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function noraHelp(){
    return [
      "Posso aiutarti solo con i dati del programma. Prova una di queste:",
      "‚Ä¢ ‚Äúquale macchina √® in pagamento?‚Äù",
      "‚Ä¢ ‚Äútop 10 in pagamento a <comune>‚Äù",
      "‚Ä¢ ‚Äústorico macchina <codice>‚Äù",
      "‚Ä¢ ‚Äúquando paga questa macchina?‚Äù (se hai selezionato una macchina)"
    ].join('\\n');
  }

  function findMachineIdInText(t){
    // try exact code match by scanning tokens and checking RAM.machines keys
    const tokens = (t.match(/[A-Za-z0-9]+/g) || []).map(x=>x.trim());
    // prefer longer tokens
    tokens.sort((a,b)=>b.length-a.length);
    for(const tok of tokens){
      if(RAM.machines.has(tok)) return tok;
    }
    // try partial: if user pasted with prefixes, search includes
    if(tokens.length){
      const tok = tokens[0];
      for(const id of RAM.machines.keys()){
        if(String(id).includes(tok)) return id;
      }
    }
    return null;
  }

  function topMachines({limit=10, comune=null}={}){
    let list = sortList(getFilteredMachines());
    if(comune){
      list = list.filter(x => (x.m.comune||'').toLowerCase() === comune.toLowerCase());
    }
    return list.slice(0, limit);
  }

  function estimateWhenPays(id){
    const m = RAM.machines.get(id);
    if(!m) return null;
    const sc = computeScore(m);
    const hist = RAM.history.get(id) || [];
    let rate = null;

    if(hist.length >= 2){
      // use last interval per day
      const a = hist[hist.length-2], b = hist[hist.length-1];
      const dIn = (b.cntIn ?? 0) - (a.cntIn ?? 0);
      const dtDays = Math.max(0.01, (b.date - a.date) / (1000*60*60*24));
      rate = dIn / dtDays;
    }

    if(!sc.ciclo || sc.distToCycle == null){
      return {text:`Per questa macchina non ho il ciclo (CPROD=${m.cp||'‚Äî'}). Aggiorna cicloslot.json e riprova.`};
    }

    let eta = '';
    if(rate && rate > 0){
      const days = sc.distToCycle / rate;
      const d = Math.round(days*10)/10;
      eta = `Con il ritmo recente (‚âà${Math.round(rate)} IN/giorno), stimo ~${d} giorni.`;
    } else {
      eta = `Non riesco a stimare i tempi (manca ritmo IN tra due snapshot).`;
    }

    const scoreLine = `Score ${sc.score}/100 (distanza ciclo ~${Math.round(sc.distToCycle)} su ${sc.ciclo}).`;
    return {text:`${scoreLine}\n${eta}\nNota: √® una stima, non una certezza.`};
  }

  function noraRespond(userText){
    const t = userText.toLowerCase().trim();
    if(!t) return;

    // If no data, guide
    if(RAM.machines.size === 0){
      return "Prima devo avere dati in RAM. Premi ‚ÄúRicarica manifest‚Äù, poi ‚ÄúAnalizza tutti‚Äù (o almeno un sinottico).";
    }

    // intents
    const wantsTop = /(top|miglior|in pagamento|pagamento|quale macchina)/i.test(t);
    const wantsWhen = /(quando.*paga|quando paga|tra quanto|fra quanto)/i.test(t);
    const wantsStorico = /(storico|grafico|andamento)/i.test(t);

    // optional comune
    let comune = null;
    const comuni = [...new Set([...RAM.machines.values()].map(m=>m.comune).filter(Boolean))];
    for(const c of comuni){
      if(t.includes(c.toLowerCase())){ comune = c; break; }
    }

    // machine id extraction
    const idInText = findMachineIdInText(userText);

    if(wantsTop){
      const m = t.match(/top\s*(\d{1,2})/i);
      const limit = m ? clamp(Number(m[1]), 1, 30) : 10;
      const list = topMachines({limit, comune});
      if(!list.length) return `Non ho trovato macchine${comune ? ' a ' + comune : ''} con i filtri attuali.`;

      const lines = list.map((x,i)=>`${i+1}) ${x.m.id} ¬∑ ${x.m.comune||''} ¬∑ ${x.m.eserc||''} ¬∑ score ${x.sc.score}`);
      return `Ecco le top ${limit}${comune ? ' a ' + comune : ''}:\n` + lines.join('\n') + `\n\nVuoi che apra lo storico di una? Scrivi: ‚Äústorico macchina <codice>‚Äù.`;
    }

    if(wantsWhen){
      const id = idInText || RAM.selectedId;
      if(!id) return "Dimmi il codice macchina (oppure cliccala in tabella) e poi chiedimi: ‚Äúquando paga questa macchina?‚Äù";
      const est = estimateWhenPays(id);
      return est?.text || "Non riesco a stimare: mi mancano dati sufficienti.";
    }

    if(wantsStorico){
      const id = idInText || RAM.selectedId;
      if(!id) return "Scrivi: ‚Äústorico macchina <codice>‚Äù (oppure clicca una macchina e poi chiedimelo).";
      if(!RAM.machines.has(id)) return `Non trovo la macchina ${id}. Controlla il codice.`;
      openMachine(id);
      return `Aperto lo storico per ${id}. Se vuoi, dimmi: ‚Äúquando paga questa macchina?‚Äù`;
    }

    // fallback: keep user on-track
    return noraHelp();
  }

  function cmdChat(){
    const text = $('#chatIn').value.trim();
    if(!text) return;
    $('#chatIn').value = '';
    chatAdd('me', text);

    const ans = noraRespond(text);
    chatAdd('bot', ans || noraHelp());
  }

  // ------------------------------
  // Wiring
  // ------------------------------
  function wire(){
    $('#btnLogin').addEventListener('click', doLogin);
    $('#btnLogoutAll').addEventListener('click', () => { clearSession(); toast('Sessione pulita'); });
    $('#btnLogout').addEventListener('click', doLogout);

    $('#btnLoadManifest').addEventListener('click', cmdLoadManifest);
    $('#btnAnalyzeOne').addEventListener('click', cmdAnalyzeOne);
    $('#btnAnalyzeAll').addEventListener('click', cmdAnalyzeAll);
    $('#btnClearRAM').addEventListener('click', cmdClearRAM);

    $('#q').addEventListener('input', () => renderTable());
    $('#selComune').addEventListener('change', () => renderTable());
    $('#selEsercente').addEventListener('change', () => renderTable());
    $('#selSort').addEventListener('change', () => renderTable());
    $('#selTime').addEventListener('change', () => { if(RAM.selectedId) openMachine(RAM.selectedId); });

    $('#btnCopyId').addEventListener('click', copySelectedId);
    $('#btnOpenChat').addEventListener('click', () => {
      $('#chatIn').focus();
      if(RAM.selectedId){
        chatAdd('bot', `Ok. Hai selezionato ${RAM.selectedId}. Chiedimi: ‚Äúquando paga questa macchina?‚Äù oppure ‚Äúspiegami perch√© √® in pagamento‚Äù.`);
      }else{
        chatAdd('bot', 'Seleziona una macchina in tabella, oppure chiedimi ‚Äútop 10 in pagamento‚Äù.');
      }
    });

    $('#btnChat').addEventListener('click', cmdChat);
    $('#chatIn').addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){ e.preventDefault(); cmdChat(); }
    });
  }

  // ------------------------------
  // Boot
  // ------------------------------
  async function boot(){
    wire();

    // attempt session restore
    const sess = loadSession();
    if(sessionValid(sess)){
      RAM.user = sess;
      RAM.accessLevel = Number(sess.level || 1);
      showApp();
      chatAdd('bot', `Ciao ${RAM.user.username}! Sono N.O.R.A. Se vuoi partire subito: premi ‚ÄúRicarica manifest‚Äù e poi ‚ÄúAnalizza tutti‚Äù.`);
      // auto load manifest to reduce friction
      await cmdLoadManifest();
    }else{
      showLogin();
      chatAdd('bot', 'Benvenuto! Accedi per usare SinotticoLab.');
    }
  }

  window.addEventListener('error', (e) => log('JS_ERR', e.message || ''));
  window.addEventListener('unhandledrejection', (e) => log('PROMISE_ERR', e.reason?.message || String(e.reason||'')));

  // Wait for libs
  async function waitForLibs(){
    for(let i=0;i<200;i++){
      if(window.XLSX && window.Chart) return;
      await sleep(25);
    }
    throw new Error('Librerie XLSX/Chart non caricate (controlla rete o CDN).');
  }

  (async () => {
    try{
      await waitForLibs();
      await boot();
    }catch(e){
      log('BOOT_ERR', e.message);
      toast(e.message);
      showLogin();
    }
  })();
})();
</script>
</body>
</html>
