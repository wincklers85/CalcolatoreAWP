<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sinottico Analyzer + S.A.G.A.</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111827;
      --card2:#0f172a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --line:#223043;
      --chip:#0b1220;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 20% 10%, #0f2a2a 0%, transparent 50%),
                  radial-gradient(900px 700px at 80% 20%, #1a1a3a 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(11,15,20,.65);
      border-bottom:1px solid rgba(34,48,67,.65);
    }
    .wrap{max-width:1220px; margin:0 auto; padding:16px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(59,130,246,.85));
      box-shadow: 0 10px 30px rgba(34,197,94,.18);
      display:grid; place-items:center;
      font-weight:900;
    }
    .brand h1{font-size:16px; margin:0; letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn, .chip, input, select{
      border:1px solid rgba(34,48,67,.8);
      background: rgba(15,23,42,.65);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
    }
    .btn{
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(34,197,94,.55)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.45)}
    .btn.danger{background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.45)}
    .btn.ghost{background: rgba(148,163,184,.07)}
    main .wrap{padding-top:18px; padding-bottom:28px}
    .grid{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width: 1020px){
      .grid{grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(17,24,39,.9), rgba(15,23,42,.85));
      border:1px solid rgba(34,48,67,.75);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(34,48,67,.6);
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      flex-wrap:wrap;
    }
    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .title h2{margin:0; font-size:14px}
    .title small{color:var(--muted)}
    .card .bd{padding:14px}
    .kpis{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    @media(max-width: 700px){ .kpis{grid-template-columns: repeat(2,1fr)} }
    .kpi{
      background: rgba(2,6,23,.35);
      border:1px solid rgba(34,48,67,.55);
      border-radius: 16px;
      padding:12px;
    }
    .kpi .v{font-size:18px; font-weight:800}
    .kpi .l{font-size:12px; color:var(--muted); margin-top:2px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex: 0 0 auto}
    input[type="text"]{min-width: 250px}
    .muted{color:var(--muted)}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid rgba(34,48,67,.55);
      background: rgba(2,6,23,.25);
    }
    thead th{
      position:sticky; top:0;
      background: rgba(15,23,42,.9);
      border-bottom:1px solid rgba(34,48,67,.7);
      text-align:left;
      padding:10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(34,48,67,.35);
      padding:10px;
      font-size:13px;
      vertical-align:middle;
    }
    tbody tr:hover{background: rgba(34,197,94,.06)}
    .tag{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(34,48,67,.65);
      background: rgba(2,6,23,.35);
      display:inline-flex;
      align-items:center;
      gap:6px;
      color: var(--text);
      white-space:nowrap;
    }
    .tag.good{border-color: rgba(34,197,94,.5); background: rgba(34,197,94,.11)}
    .tag.warn{border-color: rgba(245,158,11,.5); background: rgba(245,158,11,.10)}
    .tag.bad{border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.10)}
    .mono{font-family:var(--mono)}
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .detail{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .detail .box{
      background: rgba(2,6,23,.35);
      border:1px solid rgba(34,48,67,.55);
      border-radius: 16px;
      padding:12px;
    }
    canvas{width:100%; height:90px; display:block}
    .chat{
      height: 360px;
      overflow:auto;
      padding:12px;
      background: rgba(2,6,23,.35);
      border:1px solid rgba(34,48,67,.55);
      border-radius: 16px;
    }
    .msg{margin:0 0 10px; display:flex; gap:10px}
    .bubble{
      max-width: 92%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(34,48,67,.6);
      background: rgba(15,23,42,.7);
      line-height:1.35;
      font-size:13px;
    }
    .me .bubble{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.45)}
    .ai .bubble{background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.35)}
    .who{
      width:30px; height:30px; border-radius:12px;
      display:grid; place-items:center;
      font-weight:900; font-size:12px;
      background: rgba(148,163,184,.12);
      border:1px solid rgba(34,48,67,.65);
      flex: 0 0 auto;
    }
    .me .who{background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.4)}
    .ai .who{background: rgba(59,130,246,.14); border-color: rgba(59,130,246,.35)}
    .chatbar{display:flex; gap:10px; margin-top:10px}
    .chatbar input{flex:1 1 auto; min-width:0}
    .small{font-size:12px}
    .right{justify-content:flex-end}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(34,48,67,.55);
      background: rgba(2,6,23,.30);
      font-size:12px; color:var(--muted);
    }
    .divider{height:1px; background: rgba(34,48,67,.6); margin:12px 0}
    .warnbox{
      background: rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.35);
      border-radius: 16px;
      padding:12px;
    }
    .okbox{
      background: rgba(34,197,94,.10);
      border:1px solid rgba(34,197,94,.35);
      border-radius: 16px;
      padding:12px;
    }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">SA</div>
        <div>
          <h1>Sinottico Analyzer + <span class="mono">S.A.G.A.</span></h1>
          <p class="muted">Tutto in RAM. Import XLSX. Storico in memoria. Impostazioni in cache. üîß</p>
        </div>
      </div>
      <div class="actions">
        <label class="btn ghost">
          Importa Sinottico XLSX
          <input id="file" type="file" accept=".xlsx,.xls" style="display:none" />
        </label>
        <button id="btnDemo" class="btn ghost">Modalit√† test (fake storico)</button>
        <button id="btnClear" class="btn danger">Svuota RAM</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">

      <!-- LEFT: dashboard -->
      <section class="card">
        <div class="hd">
          <div class="title">
            <h2>Macchine</h2>
            <small id="status" class="muted">Nessun sinottico caricato.</small>
          </div>

          <div class="row">
            <input id="q" type="text" placeholder="Cerca: bar, comune, modello, CODEID‚Ä¶" />
            <select id="sort">
              <option value="scoreDesc">Ordina: Score payout ‚Üì</option>
              <option value="scoreAsc">Ordina: Score payout ‚Üë</option>
              <option value="pctDesc">Ordina: % OUT ‚Üì</option>
              <option value="pctAsc">Ordina: % OUT ‚Üë</option>
              <option value="incDesc">Ordina: Incasso giorn. ‚Üì</option>
              <option value="incAsc">Ordina: Incasso giorn. ‚Üë</option>
              <option value="bar">Ordina: Esercente A-Z</option>
              <option value="model">Ordina: Modello A-Z</option>
            </select>
            <select id="filterPay">
              <option value="all">Filtro: Tutte</option>
              <option value="hot">In pagamento (alta)</option>
              <option value="warm">In pagamento (media)</option>
              <option value="cold">Non in pagamento</option>
            </select>
          </div>
        </div>

        <div class="bd">
          <div class="kpis">
            <div class="kpi"><div class="v" id="kMachines">0</div><div class="l">macchine (valide)</div></div>
            <div class="kpi"><div class="v" id="kUploads">0</div><div class="l">sinottici in RAM</div></div>
            <div class="kpi"><div class="v" id="kHot">0</div><div class="l">hot payout</div></div>
            <div class="kpi"><div class="v" id="kIssues">0</div><div class="l">righe scartate</div></div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <span class="pill">Soglia HOT: <span class="mono" id="pillHot">80</span></span>
            <span class="pill">Soglia WARM: <span class="mono" id="pillWarm">60</span></span>
            <span class="pill">Min storico: <span class="mono" id="pillMinHist">2</span></span>
            <button class="btn ghost" id="btnSettings">Impostazioni</button>
          </div>

          <div style="margin-top:12px; overflow:auto; max-height: 520px; border-radius:16px;">
            <table>
              <thead>
                <tr>
                  <th>Score</th>
                  <th>CODEID</th>
                  <th>Esercente</th>
                  <th>Modello</th>
                  <th>% OUT</th>
                  <th>Inc. giorn.</th>
                  <th>Storico</th>
                  <th>Stato</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="hint">
            <b>Nota:</b> lo storico si costruisce caricando pi√π sinottici nel tempo. √à tutto in RAM: se ricarichi la pagina si azzera (tranne impostazioni).<br>
            Se vuoi ‚Äúallenare‚Äù meglio l‚Äôalgoritmo, carica sinottici di giorni diversi e poi usa la chat: S.A.G.A. confronter√† trend e deviazioni.
          </div>
        </div>
      </section>

      <!-- RIGHT: detail + chat -->
      <aside class="split">
        <section class="card">
          <div class="hd">
            <div class="title">
              <h2>Dettaglio macchina</h2>
              <small class="muted" id="detailHint">Seleziona una riga dalla tabella.</small>
            </div>
          </div>
          <div class="bd">
            <div class="detail" id="detail"></div>
          </div>
        </section>

        <section class="card">
          <div class="hd">
            <div class="title">
              <h2>Chat con <span class="mono">S.A.G.A.</span></h2>
              <small class="muted">Chiedi cose sul programma: payout, top macchine, dettagli, confronti.</small>
            </div>
          </div>
          <div class="bd">
            <div class="chat" id="chat"></div>
            <div class="chatbar">
              <input id="chatIn" type="text" placeholder="Es: Quale macchina √® in pagamento oggi?" />
              <button id="chatSend" class="btn primary">Invia</button>
            </div>
            <div class="hint" style="margin-top:10px">
              Esempi: ‚ÄúQuando paga la <b>CODEID 12345</b>?‚Äù ‚Ä¢ ‚ÄúMostrami <b>Marim Fire</b> al <b>Bar Fortini</b>‚Äù ‚Ä¢ ‚ÄúTop 10 in pagamento‚Äù
            </div>
          </div>
        </section>
      </aside>

    </div>
  </div>
</main>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===========================
   State (RAM only)
=========================== */
const RAM = {
  uploads: [],        // {id, name, date, rowsTotal, rowsValid, rowsDropped, machinesSnapshot: Map(codeId -> row)}
  machines: new Map(),// codeId -> { meta..., history: [{date, pctOut, totIn, totOut, incDay, mediaInc, raw}], groupKey }
  selected: null,
  droppedTotal: 0
};

const SETTINGS_KEY = "sinottico_settings_v3";
const Settings = loadSettings();

/* ===========================
   Utilities
=========================== */
function loadSettings(){
  const def = { hot: 80, warm: 60, minHist: 2, pctNeutral: 0.60, debug: false };
  try{
    const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY));
    return Object.assign(def, saved || {});
  }catch(e){ return def; }
}
function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(Settings)); }

function normKey(k){
  return String(k||"")
    .trim()
    .toUpperCase()
    .replace(/[^A-Z0-9]/g,"");
}
function normalizeRow(row){
  const out = {};
  for(const [k,v] of Object.entries(row)){
    out[normKey(k)] = v;
  }
  return out;
}
function parseItNumber(v){
  if(v===null || v===undefined || v==="") return null;
  if(typeof v==="number") return Number.isFinite(v)? v : null;
  const s = String(v).trim()
    .replace(/\s/g,"")
    .replace(/\./g,"")
    .replace(",",".");
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function safeStr(v){ return (v===null || v===undefined) ? "" : String(v).trim(); }

function guessDateFromFilename(name){
  // prova: Sinottico-2025-12-27-0845.xlsx
  const m = name.match(/(\d{4})[-_\.](\d{2})[-_\.](\d{2})/);
  if(m) return new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`);
  return new Date(); // fallback: oggi
}
function fmtDate(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function sigmoid(x){ return 1/(1+Math.exp(-x)); }
function median(arr){
  const a = arr.filter(x=>Number.isFinite(x)).slice().sort((x,y)=>x-y);
  if(!a.length) return null;
  const mid = Math.floor(a.length/2);
  return (a.length%2)? a[mid] : (a[mid-1]+a[mid])/2;
}
function percentile(arr, p){
  const a = arr.filter(x=>Number.isFinite(x)).slice().sort((x,y)=>x-y);
  if(!a.length) return null;
  const idx = (a.length-1)*p;
  const lo = Math.floor(idx), hi = Math.ceil(idx);
  if(lo===hi) return a[lo];
  return a[lo] + (a[hi]-a[lo])*(idx-lo);
}
function stdev(arr){
  const a = arr.filter(x=>Number.isFinite(x));
  if(a.length<2) return 0;
  const mean = a.reduce((s,x)=>s+x,0)/a.length;
  const v = a.reduce((s,x)=>s+(x-mean)*(x-mean),0)/(a.length-1);
  return Math.sqrt(v);
}
function last(arr){ return arr && arr.length ? arr[arr.length-1] : null; }

function tagForScore(score){
  if(score>=Settings.hot) return {cls:"good", label:"HOT"};
  if(score>=Settings.warm) return {cls:"warn", label:"WARM"};
  return {cls:"bad", label:"COLD"};
}

/* ===========================
   Parsing: XLSX row -> machine snapshot
=========================== */
function toMachineSnapshot(rowRaw){
  const r = normalizeRow(rowRaw);

  // alias fondamentali
  const codeId = safeStr(r.CODEID);
  if(!codeId) return null;

  const modello = safeStr(r.MODELLO);
  const sede = safeStr(r.DENOMINSEDE);
  const comune = safeStr(r.COMUNE);
  const provincia = safeStr(r.PROVINCIA);
  const stato = safeStr(r.DESCRSTATO || r.STATO || r.STATUS);

  const totIn  = parseItNumber(r.CNTTOTIN);
  // nel tuo file: CNTTOTOT √® TOT OUT (colonna ‚ÄúTotale Out‚Äù)
  const totOut = parseItNumber(r.CNTTOTOUT ?? r.CNTTOTOT ?? r.TOTALEOUT ?? r.TOTOUT);

  // % OUT nel file arriva come ‚Äú% OUT‚Äù => chiave normalizzata ‚ÄúOUT‚Äù
  const pctOut = parseItNumber(
    r.OUT ?? r.PCTOUT ?? r.PERCENTOUT ?? r.PEROUT ?? r.PERCENTUALEOUT
  );

  const incDay = parseItNumber(r.INCASSOGIORNALIERO ?? r.INCASSOGIORNAL);
  const mediaInc = parseItNumber(r.MEDIAINCASSOGGESERCIZIO ?? r.MEDIAINCASSO);

  // Se il foglio ha righe header/spazzatura, qui le scartiamo
  // Non pretendiamo pctOut per essere valida, ma almeno uno tra totIn/totOut/incDay deve esserci
  const hasSignal = Number.isFinite(totIn) || Number.isFinite(totOut) || Number.isFinite(incDay) || Number.isFinite(pctOut);
  if(!hasSignal) return null;

  // pctOut: se nel file √® tipo 168,04 significa 168.04% -> convertiamo in frazione
  let pctFrac = null;
  if(Number.isFinite(pctOut)){
    pctFrac = pctOut > 3 ? (pctOut/100) : pctOut; // 1.68 o 168 -> gestito
    if(pctFrac>5) pctFrac = pctFrac/100; // safety (in caso di 16804)
  }

  return {
    codeId, modello, sede, comune, provincia, stato,
    totIn, totOut, pctOutFrac: pctFrac,
    incDay, mediaInc,
    raw: rowRaw
  };
}

/* ===========================
   Model: add upload + update history
=========================== */
function upsertMachine(snapshot, dateObj){
  const codeId = snapshot.codeId;
  const groupKey = `${(snapshot.modello||"").toUpperCase().slice(0,48)}`;

  if(!RAM.machines.has(codeId)){
    RAM.machines.set(codeId, {
      codeId,
      modello: snapshot.modello,
      sede: snapshot.sede,
      comune: snapshot.comune,
      provincia: snapshot.provincia,
      stato: snapshot.stato,
      groupKey,
      history: []
    });
  }
  const m = RAM.machines.get(codeId);

  // aggiorna meta ‚Äúpi√π recente‚Äù se manca
  m.modello = snapshot.modello || m.modello;
  m.sede = snapshot.sede || m.sede;
  m.comune = snapshot.comune || m.comune;
  m.provincia = snapshot.provincia || m.provincia;
  m.stato = snapshot.stato || m.stato;
  m.groupKey = groupKey || m.groupKey;

  const d = fmtDate(dateObj);
  // evita doppioni stesso giorno
  const exists = m.history.find(h => h.date === d);
  const entry = {
    date: d,
    pct: snapshot.pctOutFrac,
    totIn: snapshot.totIn,
    totOut: snapshot.totOut,
    incDay: snapshot.incDay,
    mediaInc: snapshot.mediaInc,
    raw: snapshot.raw
  };
  if(exists){
    Object.assign(exists, entry);
  }else{
    m.history.push(entry);
    m.history.sort((a,b)=>a.date.localeCompare(b.date));
  }
}

function computeGlobalStats(){
  // normalizziamo usando percentili, cos√¨ non esplode per outlier
  const inc = [];
  const med = [];
  const pct = [];
  for(const m of RAM.machines.values()){
    const h = last(m.history);
    if(!h) continue;
    if(Number.isFinite(h.incDay)) inc.push(h.incDay);
    if(Number.isFinite(h.mediaInc)) med.push(h.mediaInc);
    if(Number.isFinite(h.pct)) pct.push(h.pct);
  }
  return {
    inc95: percentile(inc, 0.95) || 1,
    med95: percentile(med, 0.95) || 1,
    pctMed: median(pct) ?? Settings.pctNeutral
  };
}

function computeGroupStats(){
  // stats per modello (groupKey): mediana pct e stdev pct sugli ultimi valori
  const groups = new Map();
  for(const m of RAM.machines.values()){
    const h = last(m.history);
    if(!h) continue;
    if(!groups.has(m.groupKey)) groups.set(m.groupKey, []);
    if(Number.isFinite(h.pct)) groups.get(m.groupKey).push(h.pct);
  }
  const out = new Map();
  for(const [k, arr] of groups.entries()){
    out.set(k, { pctMed: median(arr) ?? Settings.pctNeutral, pctStd: stdev(arr) });
  }
  return out;
}

/* ===========================
   "Neural-ish" payout score (robusto, usando storico)
   Idea:
   - segnale 1: %OUT (distanza da mediana globale e mediana del modello)
   - segnale 2: trend (pendenza ultimi punti)
   - segnale 3: volatilit√† (stdev): se cresce velocemente, spesso avvicina evento
   - segnale 4: incasso relativo (se gioca tanto e %OUT √® basso -> aumenta chance di payout a breve)
   - segnale 5: anomaly: deviazione dal modello (zscore)
=========================== */
function slopeLastN(points, n=4){
  const a = points.filter(p=>Number.isFinite(p));
  if(a.length<2) return 0;
  const use = a.slice(-n);
  if(use.length<2) return 0;
  // regressione lineare semplice su x=0..k-1
  const k = use.length;
  let sx=0, sy=0, sxx=0, sxy=0;
  for(let i=0;i<k;i++){
    const x=i, y=use[i];
    sx+=x; sy+=y; sxx+=x*x; sxy+=x*y;
  }
  const denom = (k*sxx - sx*sx) || 1;
  return (k*sxy - sx*sy)/denom;
}

function payoutScore(machine, gStats, groupStatsMap){
  const hist = machine.history;
  const hLast = last(hist);
  if(!hLast) return 0;

  const pctSeries = hist.map(h=>h.pct).filter(x=>Number.isFinite(x));
  const pctNow = Number.isFinite(hLast.pct) ? hLast.pct : null;

  const incNow = Number.isFinite(hLast.incDay) ? hLast.incDay : null;

  const groupStats = groupStatsMap.get(machine.groupKey) || { pctMed: gStats.pctMed, pctStd: 0.04 };
  const pctMedGroup = groupStats.pctMed ?? gStats.pctMed;
  const pctStdGroup = (groupStats.pctStd && groupStats.pctStd>0) ? groupStats.pctStd : 0.06;

  const haveHist = pctSeries.length;

  // trend e volatilit√† da storico
  const tr = slopeLastN(pctSeries, 5);         // pendenza %
  const vol = stdev(pctSeries.slice(-7));      // volatilit√† recente

  // distanza da ‚Äútarget‚Äù payout (intorno al 100% o sopra, dipende dalle regole reali)
  // Qui usiamo 1.00 come centro, ma facciamo flessibile: se il modello mediamente lavora a 1.68 (168%), non puniamo.
  const target = Math.max(0.95, Math.min(1.10, pctMedGroup)); // target ‚Äúlocale‚Äù
  const distToTarget = (pctNow===null) ? 0 : (target - pctNow); // se %OUT sotto target -> pi√π ‚Äútensione elastica‚Äù
  const below = (pctNow===null) ? 0 : clamp01(distToTarget / 0.35); // scala

  // zscore vs gruppo modello
  const z = (pctNow===null) ? 0 : (pctNow - pctMedGroup) / (pctStdGroup || 0.06);
  const anomaly = clamp01(Math.abs(z)/3); // 0..1

  // incasso: normalizza
  const incN = (incNow===null) ? 0 : clamp01(incNow / gStats.inc95);

  // ‚Äúcarico‚Äù payout: se incasso alto e %OUT sotto target, aumenta
  const load = clamp01(incN * below);

  // storico: pi√π punti => pi√π affidabile
  const histBoost = clamp01((haveHist - Settings.minHist) / 10);

  // rete ‚Äúfinta ma credibile‚Äù: mix non lineare
  // Nota: volutamente evita di sparare 100 con poco storico
  const x =
    (+2.3 * (below - 0.35)) +      // pi√π sotto target -> pi√π probabile payout
    (+1.2 * (load - 0.18)) +       // incasso alto mentre sotto target -> ‚Äúpressione‚Äù
    (+0.9 * (tr * 3.2)) +          // trend (se sale)
    (+0.7 * (vol - 0.04)) +        // volatilit√†
    (+0.6 * (anomaly - 0.25)) +    // anomalia rispetto modello
    (+0.8 * (histBoost - 0.12));   // affidabilit√†

  let base = 100 * sigmoid(x);

  // penalizza se poco storico
  if(haveHist < Settings.minHist) base *= 0.72;

  // se non abbiamo pct, score prudente basato su incasso
  if(pctNow===null){
    base = 35 + 40*incN;
    if(haveHist < Settings.minHist) base *= 0.85;
  }

  return Math.round(Math.max(0, Math.min(100, base)));
}

function etaToPayout(machine, score){
  // stima ‚Äúquando paga‚Äù: euristica.
  // non √® magia: se non hai storico, S.A.G.A. lo dice chiaramente.
  const h = machine.history;
  const lastH = last(h);
  const pctNow = lastH?.pct;

  if(h.filter(x=>Number.isFinite(x.pct)).length < Settings.minHist){
    return { txt: "Serve pi√π storico (carica pi√π sinottici di giorni diversi).", confidence:"bassa" };
  }

  // se score alto: breve; se medio: 1-3 giorni; se basso: pi√π incerto
  if(score >= Settings.hot){
    return { txt: "Probabile a breve (entro 24-48h) se il gioco resta simile.", confidence:"media" };
  }
  if(score >= Settings.warm){
    return { txt: "Possibile nei prossimi giorni (2-5 giorni), dipende dal volume di gioco.", confidence:"media-bassa" };
  }
  // se %OUT gi√† oltre target e score basso, potrebbe aver gi√† pagato o essere ‚Äústabile‚Äù
  if(Number.isFinite(pctNow) && pctNow >= 1.1){
    return { txt: "Non sembra ‚Äúin tensione‚Äù: potrebbe aver gi√† scaricato payout di recente.", confidence:"bassa" };
  }
  return { txt: "Non imminente con i dati attuali. Monitorare con nuovi sinottici.", confidence:"bassa" };
}

/* ===========================
   UI Rendering
=========================== */
const el = (id)=>document.getElementById(id);

function refreshPills(){
  el("pillHot").textContent = Settings.hot;
  el("pillWarm").textContent = Settings.warm;
  el("pillMinHist").textContent = Settings.minHist;
}
refreshPills();

function setStatus(msg){ el("status").textContent = msg; }

function machineLabel(m){
  const parts = [];
  if(m.modello) parts.push(m.modello);
  if(m.sede) parts.push(m.sede);
  if(m.comune) parts.push(m.comune);
  return parts.join(" ‚Ä¢ ");
}

function fmtPct(p){
  if(!Number.isFinite(p)) return "‚Äî";
  return (p*100).toFixed(2).replace(".", ",") + "%";
}
function fmtNum(n){
  if(!Number.isFinite(n)) return "‚Äî";
  // formato IT con separatori
  return n.toLocaleString("it-IT", {maximumFractionDigits:2});
}

function getVisibleMachines(){
  const q = el("q").value.trim().toLowerCase();
  const filter = el("filterPay").value;
  const sort = el("sort").value;

  const gStats = computeGlobalStats();
  const groupStats = computeGroupStats();

  let list = Array.from(RAM.machines.values()).map(m=>{
    const score = payoutScore(m, gStats, groupStats);
    return { m, score };
  });

  // filter text
  if(q){
    list = list.filter(({m})=>{
      const blob = [
        m.codeId, m.modello, m.sede, m.comune, m.provincia, m.stato
      ].map(x=>safeStr(x).toLowerCase()).join(" ");
      return blob.includes(q);
    });
  }

  // filter pay state
  list = list.filter(({score})=>{
    if(filter==="hot") return score >= Settings.hot;
    if(filter==="warm") return score >= Settings.warm && score < Settings.hot;
    if(filter==="cold") return score < Settings.warm;
    return true;
  });

  // sorting
  const byStr = (a,b,fn)=>fn(a).localeCompare(fn(b));
  list.sort((A,B)=>{
    const a=A.m, b=B.m;
    const sa=A.score, sb=B.score;
    const ha=last(a.history)||{}, hb=last(b.history)||{};
    switch(sort){
      case "scoreAsc": return sa-sb;
      case "pctDesc": return ( (hb.pct??-1) - (ha.pct??-1) );
      case "pctAsc":  return ( (ha.pct??-1) - (hb.pct??-1) );
      case "incDesc": return ( (hb.incDay??-1) - (ha.incDay??-1) );
      case "incAsc":  return ( (ha.incDay??-1) - (hb.incDay??-1) );
      case "bar": return byStr(A,B, x=>safeStr(x.m.sede).toUpperCase());
      case "model": return byStr(A,B, x=>safeStr(x.m.modello).toUpperCase());
      default: return sb-sa;
    }
  });

  return { list, gStats, groupStats };
}

function renderTable(){
  const { list } = getVisibleMachines();
  const tb = el("tbody");
  tb.innerHTML = "";

  const hotCount = list.filter(x=>x.score>=Settings.hot).length;

  el("kMachines").textContent = RAM.machines.size;
  el("kUploads").textContent = RAM.uploads.length;
  el("kHot").textContent = hotCount;
  el("kIssues").textContent = RAM.droppedTotal;

  for(const {m, score} of list){
    const h = last(m.history) || {};
    const tag = tagForScore(score);

    const tr = document.createElement("tr");
    tr.style.cursor="pointer";
    tr.addEventListener("click", ()=>{
      RAM.selected = m.codeId;
      renderDetail(m.codeId);
      // evidenzia selezione (quick)
      [...tb.querySelectorAll("tr")].forEach(x=>x.style.outline="none");
      tr.style.outline = "2px solid rgba(34,197,94,.45)";
      tr.style.outlineOffset = "-2px";
    });

    tr.innerHTML = `
      <td><span class="tag ${tag.cls}"><b>${score}</b><span class="muted">/100</span> ${tag.label}</span></td>
      <td class="mono">${m.codeId}</td>
      <td>${safeStr(m.sede) || "‚Äî"}</td>
      <td>${safeStr(m.modello) || "‚Äî"}</td>
      <td>${fmtPct(h.pct)}</td>
      <td>${fmtNum(h.incDay)}</td>
      <td><span class="tag">${m.history.length} pt</span></td>
      <td><span class="tag">${safeStr(m.stato) || "‚Äî"}</span></td>
    `;
    tb.appendChild(tr);
  }
}

function drawSparkline(canvas, values){
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.clientWidth * devicePixelRatio;
  const h = canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,w,h);

  const v = values.filter(x=>Number.isFinite(x));
  if(v.length<2){
    ctx.globalAlpha=0.8;
    ctx.fillText("Storico insufficiente", 12*devicePixelRatio, 18*devicePixelRatio);
    return;
  }
  const min = Math.min(...v);
  const max = Math.max(...v);
  const pad = 10*devicePixelRatio;

  const scaleX = (i)=> pad + (w-2*pad) * (i/(values.length-1));
  const scaleY = (x)=> {
    const t = (x - min) / ((max-min) || 1);
    return (h-pad) - t*(h-2*pad);
  };

  // grid line
  ctx.globalAlpha = 0.35;
  ctx.strokeStyle = "rgba(148,163,184,.35)";
  ctx.beginPath();
  ctx.moveTo(pad, h-pad);
  ctx.lineTo(w-pad, h-pad);
  ctx.stroke();

  // line
  ctx.globalAlpha = 0.95;
  ctx.strokeStyle = "rgba(34,197,94,.9)";
  ctx.lineWidth = 2.2*devicePixelRatio;
  ctx.beginPath();
  values.forEach((x,i)=>{
    if(!Number.isFinite(x)) return;
    const X = scaleX(i);
    const Y = scaleY(x);
    if(i===0) ctx.moveTo(X,Y);
    else ctx.lineTo(X,Y);
  });
  ctx.stroke();

  // last point
  const lastV = values.map((x,i)=>({x,i})).filter(o=>Number.isFinite(o.x)).slice(-1)[0];
  const X = scaleX(lastV.i);
  const Y = scaleY(lastV.x);
  ctx.fillStyle = "rgba(59,130,246,.95)";
  ctx.beginPath(); ctx.arc(X,Y,4.5*devicePixelRatio,0,Math.PI*2); ctx.fill();
}

function renderDetail(codeId){
  const box = el("detail");
  const m = RAM.machines.get(codeId);
  if(!m){ box.innerHTML = ""; el("detailHint").textContent = "Seleziona una riga dalla tabella."; return; }

  const gStats = computeGlobalStats();
  const groupStats = computeGroupStats();
  const score = payoutScore(m, gStats, groupStats);
  const eta = etaToPayout(m, score);
  const tag = tagForScore(score);

  el("detailHint").textContent = machineLabel(m) || `CODEID ${m.codeId}`;

  const h = last(m.history) || {};
  const pctSeries = m.history.map(x=>x.pct);
  const incSeries = m.history.map(x=>x.incDay);

  box.innerHTML = `
    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small muted">CODEID</div>
          <div class="mono" style="font-size:14px; font-weight:800">${m.codeId}</div>
        </div>
        <div><span class="tag ${tag.cls}"><b>${score}</b>/100 ${tag.label}</span></div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <span class="tag">Modello: <b>${safeStr(m.modello)||"‚Äî"}</b></span>
        <span class="tag">Esercente: <b>${safeStr(m.sede)||"‚Äî"}</b></span>
        <span class="tag">Comune: <b>${safeStr(m.comune)||"‚Äî"}</b></span>
      </div>
      <div class="divider"></div>
      <div class="${score>=Settings.warm ? "okbox":"warnbox"}">
        <b>Stima payout:</b> ${eta.txt}<br>
        <span class="muted">Confidenza: ${eta.confidence}. Storico: ${m.history.length} punti.</span>
      </div>
    </div>

    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small muted">% OUT (storico)</div>
          <div style="font-weight:800">${fmtPct(h.pct)}</div>
        </div>
        <div class="muted small">Ultimo giorno: <span class="mono">${h.date||"‚Äî"}</span></div>
      </div>
      <div style="margin-top:8px">
        <canvas id="sparkPct"></canvas>
      </div>
      <div class="hint">Suggerimento: pi√π sinottici = trend pi√π affidabile.</div>
    </div>

    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small muted">Incasso giornaliero (storico)</div>
          <div style="font-weight:800">${fmtNum(h.incDay)}</div>
        </div>
        <div class="muted small">OUT tot: <span class="mono">${fmtNum(h.totOut)}</span> ‚Ä¢ IN tot: <span class="mono">${fmtNum(h.totIn)}</span></div>
      </div>
      <div style="margin-top:8px">
        <canvas id="sparkInc"></canvas>
      </div>
    </div>
  `;

  // draw sparklines after insert
  drawSparkline(document.getElementById("sparkPct"), pctSeries.map(x=>Number.isFinite(x)? x*100 : null));
  drawSparkline(document.getElementById("sparkInc"), incSeries);

  // update selected highlight quickly
  RAM.selected = codeId;
}

/* ===========================
   Import XLSX
=========================== */
async function handleFile(file){
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array"});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];

  // raw rows
  const rows = XLSX.utils.sheet_to_json(ws, {defval:"", raw:true});

  const dateObj = guessDateFromFilename(file.name);

  let valid=0, dropped=0;
  const snap = new Map();

  for(const r of rows){
    const s = toMachineSnapshot(r);
    if(!s){ dropped++; continue; }
    valid++;
    snap.set(s.codeId, s);
    upsertMachine(s, dateObj);
  }

  RAM.uploads.push({
    id: crypto.randomUUID(),
    name: file.name,
    date: fmtDate(dateObj),
    rowsTotal: rows.length,
    rowsValid: valid,
    rowsDropped: dropped,
    machinesSnapshot: snap
  });
  RAM.droppedTotal += dropped;

  setStatus(`Caricato: ${file.name} ‚Ä¢ ${fmtDate(dateObj)} ‚Ä¢ righe: ${rows.length} ‚Ä¢ valide: ${valid} ‚Ä¢ scartate: ${dropped}`);
  renderTable();

  // auto-select top machine
  const { list } = getVisibleMachines();
  if(list.length){
    renderDetail(list[0].m.codeId);
  }

  sagaSay(`Sinottico importato ‚úÖ (${file.name}). Ho trovato ${valid} macchine valide. Se vuoi, chiedimi: ‚ÄúTop 10 in pagamento‚Äù oppure ‚ÄúQuando paga la CODEID 12345?‚Äù`);
}

/* ===========================
   Demo generator (fake history)
=========================== */
function demoData(){
  RAM.uploads = [];
  RAM.machines.clear();
  RAM.droppedTotal = 0;

  const names = [
    ["Bar Fortini","Molini di Triora","IM","Marim Fire"],
    ["Bar Centrale","Triora","IM","VLT Nova"],
    ["Birreria Sette","Taggia","IM","Marim Fire"],
    ["Caff√® Aurora","Sanremo","IM","Lucky X"],
    ["Bar Alpino","Molini di Triora","IM","Lucky X"]
  ];

  const start = new Date();
  start.setDate(start.getDate()-12);

  for(let d=0; d<10; d++){
    const dateObj = new Date(start); dateObj.setDate(start.getDate()+d);
    const fileName = `Sinottico-${fmtDate(dateObj)}.xlsx`;
    let total=0, valid=0, dropped=0;
    const snap = new Map();

    for(let i=0;i<75;i++){
      const pick = names[i%names.length];
      const codeId = String(10000+i);
      // crea pattern diversi per ‚Äúpayout tension‚Äù
      const basePct = (i%7===0) ? 0.72 : (i%9===0 ? 1.25 : 0.92);
      const drift = (i%7===0) ? (d*0.03) : (d*0.01);
      const noise = (Math.random()-0.5)*0.08;
      const pct = Math.max(0.35, Math.min(1.85, basePct + drift + noise));

      const inc = Math.max(0, (Math.random()*450) + (i%7===0? 160: 60));
      const s = {
        codeId,
        sede: pick[0],
        comune: pick[1],
        provincia: pick[2],
        modello: pick[3],
        stato: "ATTIVA",
        totIn: 10000 + d*200 + i*20,
        totOut: 9800 + d*200 + i*19,
        pctOutFrac: pct,
        incDay: inc,
        mediaInc: inc*0.75,
        raw:{}
      };
      total++; valid++;
      snap.set(codeId, s);
      upsertMachine(s, dateObj);
    }

    RAM.uploads.push({
      id: crypto.randomUUID(),
      name: fileName,
      date: fmtDate(dateObj),
      rowsTotal: total,
      rowsValid: valid,
      rowsDropped: dropped,
      machinesSnapshot: snap
    });
  }

  setStatus("Modalit√† test attiva: creato storico finto (10 sinottici).");
  renderTable();
  const { list } = getVisibleMachines();
  if(list.length) renderDetail(list[0].m.codeId);
  sagaSay("Ho generato uno storico di test üß™. Prova: ‚ÄúQuale macchina √® in pagamento?‚Äù oppure ‚ÄúMostrami Marim Fire al Bar Fortini‚Äù.");
}

/* ===========================
   S.A.G.A. Chat (rule-based + data-driven)
=========================== */
const chatEl = el("chat");

function addMsg(role, text){
  const row = document.createElement("div");
  row.className = `msg ${role}`;
  row.innerHTML = `
    <div class="who">${role==="me" ? "TU" : "SA"}</div>
    <div class="bubble">${text}</div>
  `;
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function sagaSay(text){ addMsg("ai", text); }

function helpText(){
  return `
  Posso aiutarti solo su dati del sinottico e funzioni del programma. Prova con:
  <ul>
    <li><b>‚ÄúQuale macchina √® in pagamento?‚Äù</b> (o ‚ÄúTop 10 in pagamento‚Äù)</li>
    <li><b>‚ÄúQuando paga CODEID 12345?‚Äù</b></li>
    <li><b>‚ÄúMostrami Marim Fire al Bar Fortini‚Äù</b></li>
    <li><b>‚ÄúConfronta Marim Fire‚Äù</b> (modello) o <b>‚ÄúConfronta Molini di Triora‚Äù</b> (comune)</li>
  </ul>
  `;
}

function findMachineByText(text){
  text = text.toLowerCase();

  // 1) CODEID diretto
  const mCode = text.match(/\bcodeid\s*([0-9]{3,})\b/i) || text.match(/\b([0-9]{4,})\b/);
  if(mCode){
    const id = mCode[1];
    if(RAM.machines.has(id)) return RAM.machines.get(id);
  }

  // 2) match su modello + esercente/comune
  const candidates = [];
  for(const m of RAM.machines.values()){
    const blob = [m.codeId,m.modello,m.sede,m.comune].map(x=>safeStr(x).toLowerCase()).join(" ");
    let score=0;
    if(m.modello && text.includes(m.modello.toLowerCase())) score+=3;
    if(m.sede && text.includes(m.sede.toLowerCase())) score+=3;
    if(m.comune && text.includes(m.comune.toLowerCase())) score+=2;
    // fallback fuzzy: parole in comune
    const words = text.split(/\s+/).filter(w=>w.length>=4);
    for(const w of words){
      if(blob.includes(w)) score+=1;
    }
    if(score>0) candidates.push({m, score});
  }
  candidates.sort((a,b)=>b.score-a.score);
  return candidates[0]?.m || null;
}

function topMachines(n=10){
  const { list } = getVisibleMachines();
  return list.slice(0,n);
}

function compareByModel(modelName){
  const name = modelName.toLowerCase();
  const group = [];
  for(const m of RAM.machines.values()){
    if(safeStr(m.modello).toLowerCase().includes(name)) group.push(m);
  }
  return group;
}

function compareByComune(comuneName){
  const name = comuneName.toLowerCase();
  const group = [];
  for(const m of RAM.machines.values()){
    if(safeStr(m.comune).toLowerCase().includes(name)) group.push(m);
  }
  return group;
}

function sagaAnswer(userText){
  const t = userText.trim();
  const low = t.toLowerCase();

  if(RAM.machines.size===0){
    sagaSay(`Non ho dati in RAM ancora. Importa un sinottico XLSX e poi chiedimi. ${helpText()}`);
    return;
  }

  const gStats = computeGlobalStats();
  const groupStats = computeGroupStats();

  const intents = {
    whichPay: /quale.*(pag|in\s+pagamento)|in\s+pagamento|top\s*\d*/i.test(t),
    whenPay: /quando.*(pag|paga)|tra\s+quanto.*(pag|paga)|prevede.*pag/i.test(t),
    show: /mostra|dettaglio|info|apr/i.test(t),
    compare: /confronta|paragona|metti\s+a\s+confronto/i.test(t),
    clear: /svuota|reset|cancella\s+ram/i.test(t)
  };

  if(intents.clear){
    RAM.uploads=[]; RAM.machines.clear(); RAM.droppedTotal=0; RAM.selected=null;
    renderTable(); el("detail").innerHTML=""; setStatus("RAM svuotata.");
    sagaSay("Fatto. RAM svuotata üßπ. Ora importa un sinottico XLSX.");
    return;
  }

  // TOP payout
  if(intents.whichPay){
    const mTop = topMachines(10);
    const lines = mTop.map(({m,score},i)=>{
      const tag = tagForScore(score);
      const h = last(m.history)||{};
      return `${i+1}) <b>${score}</b> ${tag.label} ‚Ä¢ <span class="mono">${m.codeId}</span> ‚Ä¢ ${safeStr(m.sede)||"‚Äî"} ‚Ä¢ ${safeStr(m.modello)||"‚Äî"} ‚Ä¢ %OUT ${fmtPct(h.pct)}`;
    }).join("<br>");
    sagaSay(`Ecco le <b>Top 10</b> pi√π ‚Äúin pagamento‚Äù (score payout):<br><br>${lines}<br><br>Vuoi che apra il dettaglio di una? Dimmi ‚ÄúApri CODEID 12345‚Äù.`);
    return;
  }

  // WHEN payout per macchina
  if(intents.whenPay){
    const m = findMachineByText(t);
    if(!m){
      sagaSay(`Mi serve una macchina precisa (CODEID o nome modello + esercente). Esempio: ‚ÄúQuando paga <b>CODEID 12345</b>?‚Äù oppure ‚ÄúQuando paga <b>Marim Fire</b> al <b>Bar Fortini</b>?‚Äù`);
      return;
    }
    const score = payoutScore(m, gStats, groupStats);
    const eta = etaToPayout(m, score);
    renderDetail(m.codeId);
    sagaSay(`Per <b>${safeStr(m.modello)||"macchina"}</b> (${safeStr(m.sede)||"‚Äî"}, <span class="mono">${m.codeId}</span>):<br>
      ‚Ä¢ Score payout: <b>${score}</b>/100 (${tagForScore(score).label})<br>
      ‚Ä¢ Stima: <b>${eta.txt}</b><br>
      <span class="muted">Confidenza: ${eta.confidence}. Storico: ${m.history.length}.</span>`);
    return;
  }

  // SHOW detail
  if(intents.show){
    const m = findMachineByText(t);
    if(!m){
      sagaSay(`Dimmi quale: ‚ÄúApri <b>CODEID 12345</b>‚Äù oppure ‚ÄúMostra <b>Marim Fire</b> al <b>Bar Fortini</b>‚Äù.`);
      return;
    }
    renderDetail(m.codeId);
    const score = payoutScore(m, gStats, groupStats);
    sagaSay(`Aperto dettaglio per <span class="mono">${m.codeId}</span> ‚Ä¢ ${safeStr(m.sede)||"‚Äî"} ‚Ä¢ ${safeStr(m.modello)||"‚Äî"}.
      Score payout attuale: <b>${score}</b>/100.`);
    return;
  }

  // COMPARE
  if(intents.compare){
    // prova a capire se √® un modello o un comune
    // se contiene "modello" assume modello, se contiene "comune" assume comune, altrimenti tenta entrambe
    let group = [];
    let label = "";

    const mm = t.match(/confronta\s+(.*)$/i);
    const key = mm ? mm[1].trim() : t.replace(/confronta/i,"").trim();

    if(/comune/i.test(low)){
      group = compareByComune(key);
      label = `Comune: ${key}`;
    }else if(/modello/i.test(low)){
      group = compareByModel(key);
      label = `Modello: ${key}`;
    }else{
      const byModel = compareByModel(key);
      const byComune = compareByComune(key);
      group = (byModel.length >= byComune.length) ? byModel : byComune;
      label = (byModel.length >= byComune.length) ? `Modello: ${key}` : `Comune: ${key}`;
    }

    if(group.length<2){
      sagaSay(`Non trovo abbastanza elementi per confrontare ‚Äú${key}‚Äù. Prova con un modello esatto o un comune presente nei dati.`);
      return;
    }

    // calcola medie score
    const scored = group.map(m=>({m, score: payoutScore(m, gStats, groupStats)}))
                        .sort((a,b)=>b.score-a.score);
    const top5 = scored.slice(0,5).map((x,i)=>{
      return `${i+1}) <b>${x.score}</b> ‚Ä¢ <span class="mono">${x.m.codeId}</span> ‚Ä¢ ${safeStr(x.m.sede)||"‚Äî"} ‚Ä¢ ${safeStr(x.m.modello)||"‚Äî"}`;
    }).join("<br>");

    const avg = Math.round(scored.reduce((s,x)=>s+x.score,0)/scored.length);

    sagaSay(`<b>Confronto</b> (${label})<br>
      ‚Ä¢ Elementi: <b>${scored.length}</b><br>
      ‚Ä¢ Score medio payout: <b>${avg}</b>/100<br><br>
      Top 5:<br>${top5}<br><br>
      Vuoi che evidenzi solo i ‚ÄúHOT‚Äù? Dimmi: ‚ÄúQuale macchina √® in pagamento‚Äù.`);
    return;
  }

  // fallback: prova comunque a trovare macchina e dare qualcosa di utile
  const maybe = findMachineByText(t);
  if(maybe){
    const score = payoutScore(maybe, gStats, groupStats);
    renderDetail(maybe.codeId);
    sagaSay(`Ho capito che parli di <span class="mono">${maybe.codeId}</span>. Score payout: <b>${score}</b>/100. Se vuoi: ‚ÄúQuando paga?‚Äù oppure ‚ÄúMostra dettagli‚Äù.`);
    return;
  }

  sagaSay(`Questa richiesta non sembra collegata ai dati del sinottico. ${helpText()}`);
}

/* ===========================
   Settings UI (simple prompt)
=========================== */
function openSettings(){
  const hot = Number(prompt("Soglia HOT (0-100):", Settings.hot));
  if(Number.isFinite(hot)) Settings.hot = Math.max(0, Math.min(100, hot));

  const warm = Number(prompt("Soglia WARM (0-100):", Settings.warm));
  if(Number.isFinite(warm)) Settings.warm = Math.max(0, Math.min(100, warm));

  const minHist = Number(prompt("Min storico (punti) per score affidabile:", Settings.minHist));
  if(Number.isFinite(minHist)) Settings.minHist = Math.max(1, Math.min(30, minHist));

  saveSettings();
  refreshPills();
  renderTable();
  sagaSay("Impostazioni aggiornate ‚úÖ. (Ricorda: solo le impostazioni restano in cache, i dati rimangono in RAM).");
}

/* ===========================
   Wire events
=========================== */
el("file").addEventListener("change", (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  handleFile(f).catch(err=>{
    console.error(err);
    sagaSay("Ho avuto un errore importando il file. Se vuoi, dimmi che colonne vedi nel foglio o incollami uno screenshot delle intestazioni.");
  }).finally(()=>{
    e.target.value = "";
  });
});

["q","sort","filterPay"].forEach(id=>{
  el(id).addEventListener("input", renderTable);
  el(id).addEventListener("change", renderTable);
});

el("btnClear").addEventListener("click", ()=>{
  RAM.uploads=[]; RAM.machines.clear(); RAM.droppedTotal=0; RAM.selected=null;
  renderTable();
  el("detail").innerHTML="";
  setStatus("RAM svuotata.");
  sagaSay("RAM svuotata üßπ. Importa un sinottico XLSX per ripartire.");
});

el("btnDemo").addEventListener("click", demoData);

el("btnSettings").addEventListener("click", openSettings);

el("chatSend").addEventListener("click", ()=>{
  const v = el("chatIn").value.trim();
  if(!v) return;
  addMsg("me", v);
  el("chatIn").value="";
  sagaAnswer(v);
});
el("chatIn").addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    el("chatSend").click();
  }
});

// first greet
sagaSay(`Ciao! Sono <b>S.A.G.A.</b> (Slot Analysis & Guidance Assistant). Importa un sinottico XLSX e poi chiedimi: ‚ÄúQuale macchina √® in pagamento?‚Äù üôÇ`);

renderTable();
</script>
</body>
</html>
