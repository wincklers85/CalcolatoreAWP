<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AWP Fine Ciclo ¬∑ Analyzer Pro</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#f6f8fc;--ink:#0b1220;--muted:#5a6885;--card:#fff;--border:#e7ecf5;
  --accent:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;
  --thead:#f8fafc;--hover:#f3f7ff;--zebra:#fbfdff;--overlay:rgba(0,0,0,.35);
  --glow:0 0 20px rgba(37,99,235,.35),0 0 40px rgba(37,99,235,.2);
}
html[data-theme=dark]{--bg:#0f1220;--ink:#eef1ff;--muted:#9aa3c7;--card:#161a2b;--border:#273057;--accent:#5b8cff;--ok:#2bd576;--warn:#ffd24a;--bad:#ff8c8c;--thead:#1a2040;--hover:#121735;--zebra:#12162e;--overlay:rgba(0,0,0,.55);--glow:0 0 20px rgba(91,140,255,.35),0 0 40px rgba(71,108,255,.2)}
html[data-theme=mint]{--bg:#f2fbf7;--ink:#072018;--muted:#4c7a69;--card:#fff;--border:#d7efe4;--accent:#10b981;--ok:#0ea5a5;--warn:#f59e0b;--bad:#ef4444;--thead:#ecfdf5;--hover:#e6fff5;--zebra:#f6fffb;--overlay:rgba(0,0,0,.25);--glow:0 0 20px rgba(16,185,129,.35),0 0 40px rgba(16,185,129,.2)}
html[data-theme=amber]{--bg:#fffaf2;--ink:#201508;--muted:#8b6a3a;--card:#fff;--border:#f1e3c8;--accent:#f59e0b;--ok:#22c55e;--warn:#d97706;--bad:#ef4444;--thead:#fff4e0;--hover:#fff0d4;--zebra:#fff8ea;--overlay:rgba(0,0,0,.25);--glow:0 0 20px rgba(245,158,11,.35),0 0 40px rgba(245,158,11,.2)}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.app{max-width:1350px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
h1{margin:0 0 6px}.muted{color:var(--muted)}.hidden{display:none!important}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:12px}
.stat{border:1px dashed var(--border);border-radius:12px;padding:8px 12px;font-size:13px}
.tabs{display:flex;gap:8px;margin:10px 0 0}
.tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;cursor:pointer;background:var(--card)}
.tab.active{outline:2px solid var(--accent);box-shadow:var(--glow)}
.themebar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{border:1px solid var(--border);background:var(--card);color:var(--ink);padding:8px 12px;border-radius:999px;cursor:pointer}
.search{border:1px solid var(--border);border-radius:999px;padding:8px 12px;width:320px}
.badge{padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--border)}
.badge.base{background:#fff0;color:#6b7280}.badge.sub{background:#e7f6ed;color:#0b7a42;border-color:#bfe8d2}.badge.admin{background:#eef2ff;color:#3730a3;border-color:#c7d2fe}
.table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--border)}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
thead th{position:sticky;top:0;z-index:2;background:var(--thead);text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);border-bottom:1px solid var(--border);padding:8px;cursor:pointer;user-select:none}
tbody td{padding:8px;border-bottom:1px solid var(--border)}
tbody tr:nth-child(odd) td{background:var(--zebra)}
tbody tr:hover td{background:var(--hover)}
.tag{padding:4px 9px;border-radius:999px;font-size:12px;font-weight:700;display:inline-block}
.tag.good{background:color-mix(in oklab,var(--ok) 15%,transparent);color:var(--ok);border:1px solid color-mix(in oklab,var(--ok) 40%,transparent)}
.tag.mid{background:color-mix(in oklab,var(--warn) 15%,transparent);color:var(--warn);border:1px solid color-mix(in oklab,var(--warn) 40%,transparent)}
.tag.bad{background:color-mix(in oklab,var(--bad) 15%,transparent);color:var(--bad);border:1px solid color-mix(in oklab,var(--bad) 40%,transparent)}
.progress{margin-top:10px;border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--card)}
.progress-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
.progress-track{height:8px;background:var(--thead);border-radius:999px;overflow:hidden}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#60a5fa);transition:width .2s ease}
/* Splash/Login */
.splash{position:fixed;inset:0;display:grid;place-items:center;overflow:hidden;background:radial-gradient(1200px 700px at 50% 0%,var(--thead) 0,var(--bg) 60%,var(--bg) 100%);z-index:5}
.login-card{position:relative;text-align:center;max-width:680px;width:min(94vw,680px);padding:26px 22px 18px;border-radius:20px;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.75));box-shadow:0 10px 40px rgba(0,0,0,.12),var(--glow);border:1px solid var(--border)}
.brand{font-weight:900;font-size:clamp(30px,6vw,52px);letter-spacing:.3px;color:var(--ink);text-shadow:var(--glow)}
.subtitle{color:var(--muted);margin-top:4px}
.pinbox{margin-top:16px;display:grid;gap:10px;justify-items:center}
.pinbox input{width:280px;text-align:center;letter-spacing:2px;font-size:18px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card)}
.btn{border:0;padding:10px 14px;border-radius:12px;background:var(--accent);color:#fff;cursor:pointer;font-weight:800;letter-spacing:.3px}
.btn:hover{filter:brightness(1.05);box-shadow:var(--glow)}
.error{color:var(--bad);font-weight:700;margin-top:6px;text-align:center}
.float{position:absolute;font-size:42px;opacity:.13;filter:drop-shadow(0 2px 6px rgba(0,0,0,.2));animation:floaty 12s ease-in-out infinite}
.f1{top:6%;left:8%}.f2{top:22%;right:8%}.f3{bottom:12%;left:12%}.f4{bottom:18%;right:18%}
@keyframes floaty{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-18px) rotate(6deg)}}
.login-footer{margin-top:12px;font-size:12px;color:var(--muted)}.version{font-weight:800}
/* Mobile */
@media (max-width: 860px){
  .app{padding:10px}
  .search{width:100%}
  .toolbar{gap:8px}
  .stat{font-size:12px}
  table{min-width:980px;font-size:13px}
  thead th{font-size:11px}
}
</style>
</head>
<body>
<script type="application/json" id="cicloslot-json">[]</script>

<!-- Splash / Login -->
<div class="splash" id="splash">
  <div class="float f1">üé∞</div><div class="float f2">üìä</div><div class="float f3">üí∏</div><div class="float f4">üßÆ</div>
  <div class="login-card">
    <div class="brand">AWP Fine Ciclo</div>
    <div class="subtitle">Analyzer Pro ¬∑ Accesso riservato</div>
    <div class="pinbox">
      <input type="text" id="user" placeholder="User" autocomplete="off"/>
      <input type="password" id="pin" maxlength="16" placeholder="PIN" autocomplete="off"/>
      <button class="btn" id="enterBtn" type="button">Entra</button>
    </div>
    <div id="pinMsg" class="error" style="display:none;">Credenziali errate o non abilitate</div>
    <div class="login-footer">Versione: <span class="version" id="version"></span></div>
  </div>
</div>

<!-- App -->
<div class="app hidden" id="app">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <div>
        <h1>Analisi Fine Ciclo</h1>
        <div class="muted">Payout default: <b>65%</b> ¬∑ Formato date: <b>DD-MM-YYYY</b></div>
        <div id="lastRead" class="muted" style="margin-top:4px;"></div>
        <div id="staleWarn" class="error hidden" style="margin-top:6px;">Attenzione: alcune macchine non sono aggiornate a oggi.</div>
        <div class="tabs" id="tabs" style="margin-top:10px;">
          <button class="tab active" data-tab="dashboard">Dashboard</button>
          <button class="tab" data-tab="nonaggiornate">Non aggiornate oggi</button>
          <button class="tab" data-tab="aggregati">Aggregati</button>
          <button class="tab" data-tab="impostazioni">Impostazioni</button>
        </div>
      </div>
      <div style="text-align:right;">
        <div class="themebar">
          <span class="muted" style="font-size:12px;">Tema:</span>
          <button class="pill" data-theme="light">Chiaro</button>
          <button class="pill" data-theme="dark">Scuro</button>
          <button class="pill" data-theme="mint">Mint</button>
          <button class="pill" data-theme="amber">Ambra</button>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:8px;">
          <input id="search" class="search" placeholder='Cerca (es: provincia:VE modello:"novo matic")...'/>
        </div>
        <div id="who" style="margin-top:8px;font-size:13px;"></div>
        <div id="expireWarn" class="error hidden">Abbonamento scaduto: accesso in modalit√† Base.</div>
        <div id="adminBar" class="row" style="justify-content:flex-end;margin-top:8px;display:none;">
          <button class="pill" id="btnExportCSV" type="button">Esporta CSV</button>
          <button class="pill" id="btnExportXLSX" type="button">Esporta XLSX</button>
          <button class="pill" id="btnUnmapped" type="button">Codici non mappati</button>
        </div>
      </div>
    </div>

    <div class="toolbar" id="statsBar">
      <div class="stat" id="statStatus">Stato: in attesa dati‚Ä¶</div>
      <div class="stat" id="statCount">Macchine: 0</div>
      <div class="stat" id="statGood">Top (OUT&gt;IN): 0</div>
      <div class="stat" id="statWarn">Equilibrate (¬±10%): 0</div>
      <div class="stat" id="statAI">IA: ‚Äî</div>
      <div class="stat" id="statMap">Mappate/scartate: 0/0</div>
    </div>

    <div class="progress hidden" id="loadProgress">
      <div class="progress-meta">
        <span id="loadText">Caricamento sinottici‚Ä¶</span>
        <span id="loadPct">0%</span>
      </div>
      <div class="progress-track"><div class="progress-bar" id="loadBar"></div></div>
    </div>

    <!-- DASHBOARD -->
    <div id="view-dashboard">
      <div class="table-wrap">
        <table id="resultTable">
          <thead>
            <tr>
              <th data-k="flag" class="col-calc">‚öë</th>
              <th data-k="perc_cycle" class="col-calc">Percentuale Ciclo</th>
              <th data-k="cycle_idx" class="col-calc">Ciclo Corrente</th>
              <th data-k="resid_in" class="col-calc">Residuo IN</th>
              <th data-k="resid_out" class="col-calc">Residuo OUT</th>
              <th data-k="need65" class="col-calc">Residuo al 65%</th>
              <th data-k="forecast_date" class="col-calc">Fine Ciclo Stimata</th>
              <th data-k="ID">CODEID</th>
              <th data-k="MODELLO">MODELLO</th>
              <th data-k="DENOMIN_SEDE">DENOMIN. SEDE</th>
              <th data-k="SEDE">SEDE</th>
              <th data-k="INDIRIZZO" class="optcol">INDIRIZZO</th>
              <th data-k="PROVINCIA" class="optcol">PROVINCIA</th>
              <th data-k="_stato">Stato</th>
              <th data-k="_ts_str">Ultima Lettura</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" id="footNote" style="margin-top:8px;">Residuo OUT negativo ‚Üí <b>‚Ç¨0</b>. IN/OUT divisi per <b>100</b>. Timestamp da <b>‚ÄúDATA ULTIMA LETTURA VAL.‚Äù</b>.</div>
    </div>

    <!-- NON AGGIORNATE -->
    <div id="view-nonaggiornate" class="hidden" style="margin-top:10px;">
      <div class="table-wrap">
        <table id="staleTable">
          <thead><tr><th>CODEID</th><th>MODELLO</th><th>DENOMIN. SEDE</th><th>SEDE</th><th>INDIRIZZO</th><th>PROVINCIA</th><th>Ultima Lettura</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- AGGREGATI -->
    <div id="view-aggregati" class="hidden" style="margin-top:10px;">
      <div class="row" style="gap:10px;">
        <label>Raggruppa per:</label>
        <select id="aggField" class="pill">
          <option value="DENOMIN_SEDE">DENOMIN. SEDE</option>
          <option value="SEDE">SEDE (Comune)</option>
          <option value="PROVINCIA">PROVINCIA</option>
          <option value="MODELLO">MODELLO</option>
        </select>
        <button class="pill" id="btnAggExport">Esporta aggregati (CSV)</button>
      </div>
      <div class="table-wrap" style="margin-top:8px;">
        <table id="aggTable">
          <thead><tr><th>Gruppo</th><th>Macchine</th><th>IN tot</th><th>OUT tot</th><th>Payout medio</th><th>Residuo IN medio</th><th>Residuo OUT medio</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- IMPOSTAZIONI -->
    <div id="view-impostazioni" class="hidden" style="margin-top:10px;">
      <div class="row" style="gap:10px;align-items:center;">
        <label>Soglia ‚Äúbuone‚Äù (Œî OUT-IN) ‚Ç¨:</label><input id="thrAbs" type="number" step="10" class="pill" style="width:120px"/>
        <label>oppure % su residuo IN:</label><input id="thrPct" type="number" step="1" class="pill" style="width:100px"/>
        <label>Giorni per avviso dati vecchi:</label><input id="staleDays" type="number" step="1" class="pill" style="width:90px"/>
        <label><input type="checkbox" class="colToggle" data-col="INDIRIZZO" checked/> Indirizzo</label>
        <label><input type="checkbox" class="colToggle" data-col="PROVINCIA" checked/> Provincia</label>
        <button class="pill" id="btnSaveSettings">Salva</button>
        <button class="pill" id="btnResetSettings">Reset</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal scheda -->
<div class="hidden" id="modal" style="position:fixed;inset:0;background:var(--overlay);display:flex;align-items:center;justify-content:center;z-index:10;">
  <div class="panel" style="width:min(900px,95vw);background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;">
    <button class="pill" id="closeModal" style="float:right">Chiudi</button>
    <h3 id="m_title" style="margin:0 0 8px;">Scheda macchina</h3>
    <div class="row" style="gap:20px;align-items:flex-start;flex-wrap:wrap;">
      <div style="flex:1;min-width:260px;">
        <div><b>CODEID</b>: <span id="m_id"></span></div>
        <div><b>Codice Modello</b>: <span id="m_code" style="font-family:ui-monospace,Menlo,Consolas,monospace;"></span></div>
        <div><b>Modello</b>: <span id="m_model"></span></div>
        <div><b>Locale</b>: <span id="m_locale"></span></div>
        <div><b>Indirizzo</b>: <span id="m_addr"></span></div>
        <div><b>Comune/Prov.</b>: <span id="m_city"></span></div>
        <div><b>Ciclo</b>: <span id="m_cycle"></span> ¬∑ <b>Payout</b>: <span id="m_payout">65%</span></div>
        <div><b>Residuo IN</b>: <span id="m_resid_in"></span> ¬∑ <b>Residuo OUT</b>: <span id="m_resid_out"></span></div>
        <div><b>Percentuale Ciclo</b>: <span id="m_perc"></span> ¬∑ <b>Fine Ciclo Stimata</b>: <span id="m_forecast"></span></div>
        <div><b>Confidenza IA</b>: <span id="m_ai"></span></div>
      </div>
      <div style="flex:1;min-width:320px;">
        <canvas id="m_chart" width="640" height="240"></canvas>
      </div>
    </div>
    <h4 style="margin-top:12px;">Storico letture</h4>
    <div id="m_history" style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px;"></div>
  </div>
</div>

<script>
/* ====== Versione ====== */
document.getElementById('version').textContent="v1.12.0 ‚Äî caricamento progressivo + IA";

/* ====== Utility ====== */
const norm=s=>(s??"").toString().trim();
const lowerKeys=o=>{const r={};for(const k in o)r[norm(k).toLowerCase()]=o[k];return r};
const normalize=s=>(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim();
const euro=n=>new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n||0);
const fmtDMY=iso=>{if(!iso)return'‚Äî';const d=new Date(iso);if(isNaN(d))return'‚Äî';const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yy=d.getFullYear();return`${dd}-${mm}-${yy}`};
const todayIso=()=>new Date().toISOString().slice(0,10);
const daysDiff=iso=>{if(!iso)return null;const t=new Date(iso);if(isNaN(t))return null;const ms=new Date().setHours(0,0,0,0)-new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime();return Math.max(0,Math.round(ms/86400000))}
function toast(m){const d=document.createElement('div');d.textContent=m;d.style.cssText='position:fixed;bottom:12px;left:12px;right:12px;padding:10px 14px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:10px;z-index:9999;font-weight:700';document.body.appendChild(d);setTimeout(()=>d.remove(),4500)}
function escapeHTML(s){return(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}

/* ====== Tema ====== */
document.querySelectorAll('.pill[data-theme]').forEach(b=>b.onclick=()=>{document.documentElement.setAttribute('data-theme',b.dataset.theme);localStorage.setItem('awp_theme',b.dataset.theme)});
const savedTheme=localStorage.getItem('awp_theme');if(savedTheme)document.documentElement.setAttribute('data-theme',savedTheme);

/* ====== Login ====== */
let CURRENT_USER=null;
document.getElementById('enterBtn').onclick=auth;
document.getElementById('pin').addEventListener('keydown',e=>{if(e.key==='Enter')auth()});
function badgeHTML(l){l=(l||'Base').toLowerCase();return l==='admin'?'<span class="badge admin">Admin</span>':(l==='abbonato'?'<span class="badge sub">Abbonato</span>':'<span class="badge base">Base</span>')}
async function sha256Hex(s){const enc=new TextEncoder().encode(s);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')}
function loginErr(){const m=document.getElementById('pinMsg');m.style.display='block';setTimeout(()=>m.style.display='none',1500)}
async function auth(){
  const u=norm(document.getElementById('user').value).toLowerCase(),p=norm(document.getElementById('pin').value);
  let list=[];try{const r=await fetch('Dati/users.json',{cache:'no-store'});if(!r.ok)throw 0;list=await r.json()}catch{toast('Errore lettura Dati/users.json');return}
  const rec=list.find(x=>String(x.user||'').toLowerCase()===u);if(!rec)return loginErr();
  let ok=false;if(rec.pin_hash){ok=(await sha256Hex(p)).toLowerCase()===String(rec.pin_hash).toLowerCase()}else if(rec.pin){ok=String(rec.pin)===p}
  if(!ok)return loginErr();
  let level=(rec.level||'Base').trim();const exp=rec.expires?String(rec.expires):null;const now=todayIso();const expired=!!(exp && exp<now);if(expired)level='Base';
  CURRENT_USER={user:rec.user,level,expires:exp,expiredFlag:expired};
  document.getElementById('splash').classList.add('hidden');document.getElementById('app').classList.remove('hidden');
  document.getElementById('who').innerHTML=`Utente: <b>${CURRENT_USER.user}</b> ¬∑ ${badgeHTML(level)} ¬∑ Scadenza: <b>${CURRENT_USER.expires||'‚Äî'}</b>`;
  document.getElementById('expireWarn').classList.toggle('hidden',!expired);
  const pro=(level.toLowerCase()==='abbonato'||level.toLowerCase()==='admin');
  document.querySelectorAll('.col-calc').forEach(el=>el.style.display=pro?'':'none');
  document.getElementById('statsBar').style.display=pro?'flex':'none';
  document.getElementById('footNote').style.display=pro?'block':'none';
  document.getElementById('adminBar').style.display=(level.toLowerCase()==='admin')?'flex':'none';
  initAuto();
}

/* ====== Tabs ====== */
function showTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
  for(const id of ['dashboard','nonaggiornate','aggregati','impostazioni'])
    document.getElementById('view-'+id).classList.toggle('hidden',id!==name);
  if(name==='aggregati')renderAggregati();
  if(name==='nonaggiornate')renderStale();
}
document.getElementById('tabs').addEventListener('click',e=>{
  const b=e.target.closest('button.tab');if(!b)return;showTab(b.dataset.tab);
});

/* ====== Ciclo Slot ====== */
let CICLOSLOT=[];try{const el=document.getElementById('cicloslot-json');if(el&&el.textContent.trim())CICLOSLOT=JSON.parse(el.textContent)}catch{}
const cleanCode=s=>(s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').replace(/^0+/,'');
const cleanID=s=>(s||'').trim();
function parsePayout(v){if(v==null||v==='')return null;let s=String(v).replace('%','').trim();let n=parseFloat(s);if(isNaN(n))return null;if(n>1)n/=100;return Math.max(0,Math.min(1,n))}
function buildCicloMaps(arr){const byModelCode=new Map(),payoutByModelCode=new Map(),cicloByModelName=new Map(),payoutByModelName=new Map();
  arr.forEach(x=>{
    const mc=cleanCode(x.code||x['codice modello']||x['CODICE MODELLO']);
    const mdl=norm(x.model||x.modello||x['MODELLO']||'');
    const cyc=+x.cycle||+x.ciclo||+x['CICLO'];
    const py=parsePayout(x['PAYOUT %']??x['PAYOUT']??x['payout']);
    if(mc&&cyc){byModelCode.set(mc,cyc);if(py!=null)payoutByModelCode.set(mc,py)}
    const mkey=normalize(mdl);if(mkey&&cyc)cicloByModelName.set(mkey,cyc);if(mkey&&py!=null)payoutByModelName.set(mkey,py)
  });return{byModelCode,payoutByModelCode,cicloByModelName,payoutByModelName}
}
let CYCLE=buildCicloMaps(CICLOSLOT);

/* ====== Lettura XLS/XLSX ====== */
async function fetchXLSX(url){
  const res=await fetch(url,{cache:'no-store'});if(!res.ok)throw new Error('fetch '+url);
  const buf=await res.arrayBuffer();const wb=XLSX.read(buf,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];
  const json=XLSX.utils.sheet_to_json(ws,{defval:'',raw:false,blankrows:false,skipHidden:false});
  return json.map(lowerKeys);
}

/* colonne del sinottico (in minuscolo) */
function pickCols(map){
  const keys=Object.keys(map); const pick=a=>a.find(k=>keys.includes(k));
  return{
    idKey: pick(['codeid','id','id awp','id macchina','matricola','codiceid'])||null,
    modelCodeKey: keys.includes('codice modello')? 'codice modello': null,
    inKey: keys.includes('cnttotin')? 'cnttotin': null,
    outKey: keys.includes('cnttotot')? 'cnttotot': null,
    modelloKey: pick(['modello','descrizione modello','model','desc modello','descr. modello']),
    denomSedeKey: pick(['denomin. sede','denominazione sede','denom. sede','denominazione','denonim. sede']),
    sedeKey: pick(['sede','comune','localit√†','localita','citt√†','citta','city']),
    indirKey: pick(['indirizzo','indirizzo sede','via','via/piazza','indir.','address']),
    provKey: pick(['provincia','prov.','prov','sigla provincia']),
    /* Timestamp REALE per riga */
    validKey: pick(['data ultima lettura val.','data ultima lettura val','data ultima lettura','ultima lettura val.','ultima lettura']),
    timeKey: pick(['ora lettura','ora','time','orario']) /* se esistono campi separati */
  };
}

/* parse contatori (√∑100) */
const parseCnt=v=>{if(typeof v==='number')return v/100;let s=(v||'').toString().trim();if(!s)return 0;s=s.replace(/\s+/g,'');if(s.includes('.')&&s.includes(','))s=s.replace(/\./g,'').replace(',', '.');else if(s.includes(','))s=s.replace('.', '').replace(',', '.');const n=parseFloat(s);return isNaN(n)?0:n/100};

/* parse data/ora dal valore della colonna validKey
   supporta: DD-MM-YYYY HH:mm, DD/MM/YYYY HH:mm,  YYYY-MM-DDTHH:mm:ss, ecc. */
function parseTSValue(val, fallbackISO){
  if(!val){ return fallbackISO; }
  const s = String(val).trim();
  // formati comuni italiani
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){
    const dd=m[1].padStart(2,'0'),mm=m[2].padStart(2,'0'),yy=(m[3].length===2?('20'+m[3]):m[3]);
    const HH=(m[4]??'00').padStart(2,'0'), MM=(m[5]??'00').padStart(2,'0'), SS=(m[6]??'00').padStart(2,'0');
    return `${yy}-${mm}-${dd}T${HH}:${MM}:${SS}`;
  }
  // ISO-like
  if(/^\d{4}-\d{2}-\d{2}T/.test(s) || /^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(s)){
    return s.replace(' ','T').replace(/(\d{2}:\d{2})(?!:)/,'$1:00');
  }
  // solo data
  let m2 = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if(m2){
    const dd=m2[1].padStart(2,'0'),mm=m2[2].padStart(2,'0'),yy=(m2[3].length===2?('20'+m2[3]):m2[3]);
    return `${yy}-${mm}-${dd}T00:00:00`;
  }
  return fallbackISO;
}

/* fallback quando il file non ha la colonna valida */
function parseStampFromName(name){
  const d=name.match(/(\d{4})-(\d{2})-(\d{2})(?:[_\s\-T]?(\d{2})[:\-]?(\d{2}))?/);
  if(!d) return new Date().toISOString();
  const[,Y,M,D,h,m]=d; return `${Y}-${M}-${D}T${h??'00'}:${m??'00'}:00`;
}

/* ====== Storico ====== */
const payoutDefault=0.65, HIST_KEY='awp_history_by_id_v1';
let history={}; try{ history=JSON.parse(localStorage.getItem(HIST_KEY)||'{}'); }catch{ history={}; }
function pushHistory(ID,ts,IN,OUT,meta){
  ID = cleanID(ID); if(!ID) return;
  if(!history[ID]) history[ID]=[];
  const arr=history[ID];
  if(arr.some(r=> r.ts===ts)) return; // stessa "ultima lettura valida" -> evita doppione
  arr.push({ts,IN,OUT,meta});
  arr.sort((a,b)=> new Date(a.ts)-new Date(b.ts));
}
function getLatestStateForAll(){
  const out=[];
  for(const ID in history){
    const arr=history[ID]; if(!arr?.length) continue;
    const last=arr[arr.length-1], m=last.meta||{};
    out.push({ ID, IN:last.IN, OUT:last.OUT, MODELLO:m.MODELLO||'', MODEL_CODE:m.MODEL_CODE||'', DENOMIN_SEDE:m.DENOMIN_SEDE||'', SEDE:m.SEDE||'',
               INDIRIZZO:m.INDIRIZZO||'', PROVINCIA:m.PROVINCIA||'', _ts:last.ts });
  }
  return out;
}
function forecastDate(ID, resid_in){
  const h=history[ID]||[]; if(h.length<2) return '‚Äî';
  const last=h.slice(-6);
  let sumIn=0, sumHrs=0;
  for(let i=1;i<last.length;i++){
    const t1=new Date(last[i-1].ts), t2=new Date(last[i].ts);
    const dtHrs=Math.max(1,(t2-t1)/36e5); const dIn=Math.max(0,last[i].IN - last[i-1].IN);
    sumIn+=dIn; sumHrs+=dtHrs;
  }
  const avg = sumHrs>0 ? sumIn/sumHrs : 0;
  if(avg<=0 || resid_in<=0) return '‚Äî';
  const hrs = Math.ceil(resid_in/avg);
  const est=new Date(); est.setHours(est.getHours()+hrs);
  return fmtDMY(est.toISOString());
}

function aiForecastInfo(ID, resid_in){
  const h=history[ID]||[]; if(h.length<3 || resid_in<=0) return {date:null, confidence:null};
  const series=h.slice(-10);
  const t0=+new Date(series[0].ts);
  const pts=series.map(p=>({x:(+new Date(p.ts)-t0)/36e5, y:p.IN}));
  const n=pts.length;
  let sumX=0,sumY=0,sumXX=0,sumXY=0;
  for(const p of pts){ sumX+=p.x; sumY+=p.y; sumXX+=p.x*p.x; sumXY+=p.x*p.y; }
  const denom=(n*sumXX - sumX*sumX);
  if(denom===0) return {date:null, confidence:null};
  const slope=(n*sumXY - sumX*sumY)/denom;
  const intercept=(sumY - slope*sumX)/n;
  if(!isFinite(slope) || slope<=0) return {date:null, confidence:null};
  const target=pts[pts.length-1].y + resid_in;
  const tTarget=(target - intercept)/slope;
  if(!isFinite(tTarget) || tTarget < pts[pts.length-1].x) return {date:null, confidence:null};
  const estimate=new Date(t0 + tTarget*36e5);
  const meanY=sumY/n;
  let ssTot=0, ssRes=0;
  for(const p of pts){
    const yHat=intercept + slope*p.x;
    ssTot += (p.y-meanY)**2;
    ssRes += (p.y-yHat)**2;
  }
  const r2=ssTot>0 ? Math.max(0,Math.min(1,1-(ssRes/ssTot))) : null;
  return {date: fmtDMY(estimate.toISOString()), confidence: r2};
}

/* ====== Calcoli riga ====== */
function getCicloPayout(modelCode,modelName){
  const mc=cleanCode(modelCode);
  const byCode=CYCLE.byModelCode.get(mc);
  const byName=CYCLE.cicloByModelName.get(normalize(modelName||''));
  const ciclo=byCode||byName||null;
  const py=CYCLE.payoutByModelCode.get(mc) ?? CYCLE.payoutByModelName.get(normalize(modelName||'')) ?? payoutDefault;
  return {ciclo, payout:py};
}
function rowFlag(delta,resid_in){
  const cfg=JSON.parse(localStorage.getItem('awp_cfg_v3')||'{}');
  const abs=Number(cfg.thrAbs||200), pct=Number(cfg.thrPct||0);
  const passAbs=abs>0 && delta>=abs;
  const passPct=pct>0 && resid_in>0 && delta>=(pct/100)*resid_in;
  return (passAbs||passPct)?'‚≠ê':'';
}
function computeRow(r){
  const pro=(CURRENT_USER?.level||'Base').toLowerCase();
  const show=(pro==='abbonato'||pro==='admin');
  const {ciclo:C,payout:P}=getCicloPayout(r.MODEL_CODE,r.MODELLO);
  const I=r.IN,V=r.OUT;
  const isToday=(r._ts||'').slice(0,10)===todayIso(); const tsDays=daysDiff(r._ts);

  const arr=(history[r.ID]||[]).slice(-2);
  const stato = !arr.length ? {label:'‚Äî',badge:''}
               : ((arr[arr.length-1].ts.slice(0,10)!==todayIso()) ? {label:'Non aggiornata',badge:'‚è∏Ô∏è'}
                  : (arr.length<2 ? {label:'Aggiornata',badge:'‚úÖ'}
                    : ((arr[arr.length-1].IN===arr[arr.length-2].IN && arr[arr.length-1].OUT===arr[arr.length-2].OUT) ? {label:'Invariata',badge:'Ôºù'} : {label:'Aggiornata',badge:'‚úÖ'})));

  if(!C || !show){
    return {...r,_cycle:C||null,_payout:P||payoutDefault,perc_cycle:null,cycle_idx:null,resid_in:null,resid_out:null,need65:null,forecast_date:'',
            _delta:0,flag:'',_ts_str:fmtDMY(r._ts)+(isToday?'':(tsDays!=null?` (${tsDays} gg)`:'')),_stato:`${stato.badge} ${stato.label}`,_oggi:isToday,_I:I,_V:V,_ai_conf:null};
  }

  const cycles_done=Math.floor(I/C);
  const in_cycle=I - cycles_done*C;
  const target_prev=cycles_done*(P*C);
  let paid_cycle=V - target_prev; if(paid_cycle<0) paid_cycle=0;
  const resid_in=in_cycle>0? (C-in_cycle):C;
  let resid_out=(P*C)-paid_cycle; if(resid_out<0) resid_out=0;
  const perc_cycle=in_cycle>0? (paid_cycle/in_cycle)*100 : 0;
  const cycle_idx=cycles_done+1;
  const need65=(in_cycle>0 && perc_cycle<65) ? Math.max(0, (0.65*in_cycle) - paid_cycle) : null;
  const ai=aiForecastInfo(r.ID,resid_in);
  const fDate=ai.date ? `${ai.date} (IA)` : forecastDate(r.ID,resid_in);
  const delta=resid_out-resid_in;
  const flag=rowFlag(delta,resid_in);
  return {...r,_cycle:C,_payout:P,perc_cycle,cycle_idx,resid_in,resid_out,need65,forecast_date:fDate,_delta:delta,flag,
          _ts_str:fmtDMY(r._ts)+(isToday?'':(tsDays!=null?` (${tsDays} gg)`:'')),_stato:`${stato.badge} ${stato.label}`,_oggi:isToday,_I:I,_V:V,_ai_conf:ai.confidence};
}

/* ====== Stato globale / rendering ====== */
const STORE='awp_cfg_v3';
const defCfg={thrAbs:200,thrPct:0,staleDays:0,showCols:{INDIRIZZO:true,PROVINCIA:true}};
let CFG=defCfg;try{CFG=Object.assign({},defCfg,JSON.parse(localStorage.getItem(STORE)||'{}'))}catch{}
let latestSnapshot='‚Äî', lastUnmapped=[], fullRows=[], staleRows=[];
let SORT_KEY=null, SORT_DIR=1;

function filterByQuery(rows){
  const q=norm(document.getElementById('search').value).toLowerCase();
  if(!q) return rows;
  const parts=q.match(/(?:[^\s"]+|"[^"]*")+/g)||[];
  let free=[], keyed=[];
  parts.forEach(p=>{
    if(p.includes(':')){ const [k,...rest]=p.split(':'); const v=rest.join(':').replaceAll('"',''); keyed.push({k:k.toLowerCase(), v:v.toLowerCase()}); }
    else free.push(p.replaceAll('"',''));
  });
  return rows.filter(r=>{
    const blob=`${r.ID} ${r.MODELLO} ${r.DENOMIN_SEDE} ${r.SEDE} ${r.INDIRIZZO} ${r.PROVINCIA}`.toLowerCase();
    if(free.some(t=>!blob.includes(t))) return false;
    for(const kv of keyed){ const val=String(r[kv.k?.toUpperCase()]||r[kv.k]||'').toLowerCase(); if(!val.includes(kv.v)) return false; }
    return true;
  });
}
function getValForSort(r,k){
  const v=r[k]; if(v==null) return '';
  if(k==='perc_cycle'||k==='cycle_idx'||k==='resid_in'||k==='resid_out'||k==='need65') return +v;
  if(k==='forecast_date'){ if(!v||v==='‚Äî') return ''; const clean=v.replace(' (IA)',''); const [d,m,y]=clean.split('-'); return `${y}-${m}-${d}`; }
  if(k==='_ts_str'){ return r._ts||''; }
  return String(v).toLowerCase();
}
function render(rows){
  const pro=(CURRENT_USER?.level||'Base').toLowerCase(); const show=(pro==='abbonato'||pro==='admin');
  let view=filterByQuery(rows);
  if(SORT_KEY){ view.sort((a,b)=>{const va=getValForSort(a,SORT_KEY),vb=getValForSort(b,SORT_KEY); if(va<vb) return -1*SORT_DIR; if(va>vb) return 1*SORT_DIR; return 0; }); }
  else{ if(show){ view.sort((a,b)=>(b._delta-a._delta)||(b.resid_out-a.resid_out)); } else { view.sort((a,b)=> String(a.DENOMIN_SEDE||a.SEDE||a.MODELLO).localeCompare(String(b.DENOMIN_SEDE||b.SEDE||b.MODELLO))); } }
  const tb=document.querySelector('#resultTable tbody'); tb.innerHTML='';
  for(const r of view){
    const tr=document.createElement('tr');
    const calc = r._cycle!=null && show;
    const tagClass = (calc && (r.resid_out>r.resid_in)) ? 'good' : (calc && Math.abs((r.resid_out||0)-(r.resid_in||0)) <= 0.1*((r.resid_in||1)) ? 'mid' : 'bad');
    tr.innerHTML=`
      <td class="col-calc">${calc?(r.flag||''):''}</td>
      <td class="col-calc">${calc? `<span class="tag ${tagClass}">${r.perc_cycle!=null ? r.perc_cycle.toFixed(2) : '0.00'}%</span>` : ''}</td>
      <td class="col-calc">${calc?(r.cycle_idx ?? ''):''}</td>
      <td class="col-calc">${calc?(r.resid_in!=null ? euro(r.resid_in) : ''):''}</td>
      <td class="col-calc">${calc?(r.resid_out!=null ? euro(r.resid_out) : ''):''}</td>
      <td class="col-calc">${calc?((r.need65!=null) ? euro(r.need65) : '‚Äî'):''}</td>
      <td class="col-calc">${calc?(r.forecast_date || '‚Äî'):''}</td>
      <td>${escapeHTML(r.ID||'')}</td>
      <td>${escapeHTML(r.MODELLO||'')}</td>
      <td>${escapeHTML(r.DENOMIN_SEDE||'')}</td>
      <td>${escapeHTML(r.SEDE||'')}</td>
      <td class="col-INDIRIZZO">${escapeHTML(r.INDIRIZZO||'')}</td>
      <td class="col-PROVINCIA">${escapeHTML(r.PROVINCIA||'')}</td>
      <td>${escapeHTML(r._stato||'')}</td>
      <td>${r._oggi ? '<span class="tag good">Oggi</span>' : escapeHTML(r._ts_str||'')}</td>
    `;
    tr.addEventListener('click', ()=> openModal(r.ID, r));
    tb.appendChild(tr);
  }
  document.getElementById('statCount').textContent='Macchine: '+view.length;
  if(!show){ document.getElementById('statGood').textContent='Top: ‚Äî'; document.getElementById('statWarn').textContent='Equilibrate: ‚Äî'; document.getElementById('statAI').textContent='IA: ‚Äî'; }
  else {
    const good=view.filter(r=> (r._cycle!=null && r.resid_out>r.resid_in)).length;
    const warn=view.filter(r=> (r._cycle!=null && Math.abs((r.resid_out||0)-(r.resid_in||0)) <= 0.1*(r.resid_in||1))).length;
    const aiRows=view.filter(r=> typeof r._ai_conf==='number');
    const aiAvg=aiRows.length ? Math.round((aiRows.reduce((s,r)=>s+r._ai_conf,0)/aiRows.length)*100) : 0;
    document.getElementById('statGood').textContent='Top (OUT>IN): '+good;
    document.getElementById('statWarn').textContent='Equilibrate (¬±10%): '+warn;
    document.getElementById('statAI').textContent=aiRows.length ? `IA: ${aiAvg}%` : 'IA: ‚Äî';
  }
  document.querySelectorAll('.col-INDIRIZZO').forEach(td=> td.style.display = CFG.showCols.INDIRIZZO ? '' : 'none');
  document.querySelectorAll('.col-PROVINCIA').forEach(td=> td.style.display = CFG.showCols.PROVINCIA ? '' : 'none');
}
document.querySelector('#resultTable thead').addEventListener('click', (e)=>{
  const th=e.target.closest('th'); if(!th) return;
  const key=th.dataset.k; if(!key) return;
  if(SORT_KEY===key){ SORT_DIR*=-1; } else { SORT_KEY=key; SORT_DIR=1; }
  render(fullRows);
});

/* ====== Non aggiornate ====== */
function findStale(){
  const today = todayIso();
  const all = getLatestStateForAll();
  staleRows = all.filter(x=> (x._ts||'').slice(0,10) !== today).map(s=> ({...s, _ts_str: fmtDMY(s._ts), _days: daysDiff(s._ts)}));
  document.getElementById('staleWarn').classList.toggle('hidden', staleRows.length===0);
}
function renderStale(){
  const tb=document.querySelector('#staleTable tbody'); tb.innerHTML='';
  for(const r of staleRows){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(r.ID||'')}</td>
      <td>${escapeHTML(r.MODELLO||'')}</td>
      <td>${escapeHTML(r.DENOMIN_SEDE||'')}</td>
      <td>${escapeHTML(r.SEDE||'')}</td>
      <td>${escapeHTML(r.INDIRIZZO||'')}</td>
      <td>${escapeHTML(r.PROVINCIA||'')}</td>
      <td>${escapeHTML(r._ts_str||'')} ${r._days!=null? `(${r._days} gg)`: ''}</td>
    `;
    tb.appendChild(tr);
  }
}

/* ====== Aggregati ====== */
function renderAggregati(){
  const pro=(CURRENT_USER?.level||'Base').toLowerCase(); const show=(pro==='abbonato'||pro==='admin');
  const field=document.getElementById('aggField').value;
  const src=filterByQuery(fullRows);
  const map=new Map();
  for(const r of src){
    const key = r[field] || '‚Äî';
    let o = map.get(key); if(!o) o={k:key, n:0, in:0, out:0, rin:0, rout:0};
    o.n++; o.in += (r._I||0); o.out += (r._V||0);
    if(show){ o.rin += (r.resid_in||0); o.rout += (r.resid_out||0); }
    map.set(key,o);
  }
  const arr=[...map.values()].sort((a,b)=> (b.rout-b.rin)-(a.rout-a.rin) || (b.out-b.in)-(a.out-a.in) || b.n-a.n);
  const tb=document.querySelector('#aggTable tbody'); tb.innerHTML='';
  for(const g of arr){
    const payout = g.in>0 ? (g.out/g.in)*100 : 0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${escapeHTML(g.k)}</td><td>${g.n}</td><td>${euro(g.in)}</td><td>${euro(g.out)}</td><td>${payout.toFixed(2)}%</td><td>${euro(g.rin/g.n||0)}</td><td>${euro(g.rout/g.n||0)}</td>`;
    tb.appendChild(tr);
  }
}

/* ====== Export ====== */
function exportCSV(rows, filename){
  const cols=['flag','perc_cycle','cycle_idx','resid_in','resid_out','need65','forecast_date','ID','MODELLO','DENOMIN_SEDE','SEDE','INDIRIZZO','PROVINCIA','_stato','_ts_str'];
  const lines=[cols.join(';')];
  rows.forEach(r=>{
    const o={...r}; o.perc_cycle = (o.perc_cycle!=null)? o.perc_cycle.toFixed(2)+'%':''; 
    o.resid_in = (o.resid_in!=null)? o.resid_in.toFixed(2):''; o.resid_out=(o.resid_out!=null)? o.resid_out.toFixed(2):'';
    o.need65=(o.need65!=null)? o.need65.toFixed(2):'';
    lines.push(cols.map(c=> String(o[c]??'').replace(/;/g,',')).join(';'));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}
function exportXLSX(rows, filename){
  const data = rows.map(r=>({
    flag:r.flag||'','Percentuale Ciclo': r.perc_cycle!=null? r.perc_cycle.toFixed(2)+'%':'',
    'Ciclo Corrente': r.cycle_idx??'','Residuo IN': r.resid_in!=null? r.resid_in.toFixed(2):'',
    'Residuo OUT': r.resid_out!=null? r.resid_out.toFixed(2):'','Residuo al 65%': r.need65!=null? r.need65.toFixed(2):'',
    'Fine Ciclo Stimata': r.forecast_date||'', CODEID:r.ID||'', MODELLO:r.MODELLO||'',
    'DENOMIN. SEDE':r.DENOMIN_SEDE||'', SEDE:r.SEDE||'', INDIRIZZO:r.INDIRIZZO||'', PROVINCIA:r.PROVINCIA||'',
    Stato:r._stato||'', 'Ultima Lettura': r._oggi? 'Oggi' : (r._ts_str||'')
  }));
  const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'dati'); XLSX.writeFile(wb, filename);
}
document.getElementById('btnExportCSV').onclick=()=>exportCSV(filterByQuery(fullRows), `awp_${latestSnapshot||'export'}.csv`);
document.getElementById('btnExportXLSX').onclick=()=>exportXLSX(filterByQuery(fullRows), `awp_${latestSnapshot||'export'}.xlsx`);
document.getElementById('btnAggExport').onclick=()=>{
  const tb = document.querySelector('#aggTable tbody');
  const rows = [...tb.querySelectorAll('tr')].map(tr=> {
    const t = tr.querySelectorAll('td');
    return { gruppo: t[0].innerText, macchine: t[1].innerText, in_tot: t[2].innerText,
      out_tot: t[3].innerText, payout_medio: t[4].innerText, residuo_in_medio: t[5].innerText, residuo_out_medio: t[6].innerText };
  });
  const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'aggregati'); XLSX.writeFile(wb, `aggregati_${todayIso()}.xlsx`);
};
document.getElementById('btnUnmapped').onclick=()=>{
  const lines = ['CODICE MODELLO;MODELLO']; lastUnmapped.forEach(x=> lines.push(`${x.modelCode};${(x.modello||'').replace(/;/g,',')}`));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`non_mappati_${latestSnapshot||todayIso()}.csv`; a.click();
};

/* ====== Impostazioni ====== */
function loadSettingsUI(){document.getElementById('thrAbs').value=CFG.thrAbs;document.getElementById('thrPct').value=CFG.thrPct;document.getElementById('staleDays').value=CFG.staleDays;document.querySelectorAll('.colToggle').forEach(ch=>ch.checked=!!CFG.showCols[ch.dataset.col])}
document.getElementById('btnSaveSettings').onclick=()=>{CFG.thrAbs=+document.getElementById('thrAbs').value||0;CFG.thrPct=+document.getElementById('thrPct').value||0;CFG.staleDays=+document.getElementById('staleDays').value||0;document.querySelectorAll('.colToggle').forEach(ch=>CFG.showCols[ch.dataset.col]=!!ch.checked);localStorage.setItem(STORE,JSON.stringify(CFG));render(fullRows);renderAggregati();renderStale();toast('Impostazioni salvate')};
document.getElementById('btnResetSettings').onclick=()=>{CFG=JSON.parse(JSON.stringify({thrAbs:200,thrPct:0,staleDays:0,showCols:{INDIRIZZO:true,PROVINCIA:true}}));localStorage.setItem(STORE,JSON.stringify(CFG));loadSettingsUI();render(fullRows);renderAggregati();renderStale()};

/* ====== Modale & grafico ====== */
const modal=document.getElementById('modal'); document.getElementById('closeModal').onclick=()=>modal.classList.add('hidden');
function drawChart(canvas, series){
  const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  if(series.length<2){ ctx.fillStyle='var(--muted)'; ctx.font='12px system-ui'; ctx.fillText('Dati insufficienti',10,20); return; }
  const pad=30, x0=pad, x1=W-pad, y0=H-pad, y1=pad;
  const minT = +new Date(series[0].ts), maxT = +new Date(series[series.length-1].ts);
  let minV=Infinity, maxV=-Infinity; series.forEach(p=>{ minV=Math.min(minV,p.IN,p.OUT); maxV=Math.max(maxV,p.IN,p.OUT); });
  if(minV===maxV){ minV=0; }
  const x = t => x0 + ( (t-minT)/(maxT-minT||1) )*(x1-x0);
  const y = v => y0 - ( (v-minV)/(maxV-minV||1) )*(y0-y1);
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y0); ctx.moveTo(x0,y0); ctx.lineTo(x0,y1); ctx.stroke();
  ctx.beginPath(); series.forEach((p,i)=>{ const X=x(+new Date(p.ts)), Y=y(p.IN); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
  ctx.strokeStyle='#0b6'; ctx.lineWidth=2; ctx.stroke();
  ctx.beginPath(); series.forEach((p,i)=>{ const X=x(+new Date(p.ts)), Y=y(p.OUT); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
  ctx.strokeStyle='#666'; ctx.lineWidth=2; ctx.stroke();
}
function openModal(ID,row){
  const pro=(CURRENT_USER?.level||'Base').toLowerCase(); if(!(pro==='abbonato'||pro==='admin')) return;
  modal.classList.remove('hidden');
  document.getElementById('m_title').textContent='Scheda macchina ‚Äì '+ID;
  document.getElementById('m_id').textContent=ID;
  document.getElementById('m_code').textContent=row.MODEL_CODE||'';
  document.getElementById('m_model').textContent=row.MODELLO||'';
  document.getElementById('m_locale').textContent=row.DENOMIN_SEDE||'';
  document.getElementById('m_addr').textContent=row.INDIRIZZO||'';
  document.getElementById('m_city').textContent=(row.SEDE||'')+(row.PROVINCIA?' ('+row.PROVINCIA+')':'');
  document.getElementById('m_cycle').textContent=(row._cycle||'')+' partite';
  document.getElementById('m_payout').textContent=((row._payout||payoutDefault)*100).toFixed(2)+'%';
  document.getElementById('m_resid_in').textContent=row.resid_in!=null?euro(row.resid_in):'‚Äî';
  document.getElementById('m_resid_out').textContent=row.resid_out!=null?euro(row.resid_out):'‚Äî';
  document.getElementById('m_perc').textContent=(row.perc_cycle!=null?row.perc_cycle.toFixed(2):'‚Äî')+'%';
  document.getElementById('m_forecast').textContent=row.forecast_date || '‚Äî';
  document.getElementById('m_ai').textContent=(row._ai_conf!=null)? `${Math.round(row._ai_conf*100)}%` : '‚Äî';
  const h=(history[ID]||[]).slice().sort((a,b)=> new Date(a.ts)-new Date(b.ts));
  let html='<table style="width:100%;border-collapse:collapse;"><thead><tr>'
    +'<th style="text-align:left;border-bottom:1px solid var(--border);padding:6px;">Data/ora</th>'
    +'<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">IN</th>'
    +'<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">OUT</th>'
    +'<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">ŒîIN</th>'
    +'<th style="text-align:right;border-bottom:1px solid var(--border);padding:6px;">ŒîOUT</th>'
    +'</tr></thead><tbody>';
  for(let i=0;i<h.length;i++){
    const prev=h[i-1]; const dIn=i? (h[i].IN-(prev?.IN||0)):0; const dOut=i? (h[i].OUT-(prev?.OUT||0)):0;
    html+=`<tr><td style="padding:6px;">${fmtDMY(h[i].ts)} ${h[i].ts.slice(11,16)}</td><td style="padding:6px;text-align:right;">${euro(h[i].IN)}</td><td style="padding:6px;text-align:right;">${euro(h[i].OUT)}</td><td style="padding:6px;text-align:right;">${euro(dIn)}</td><td style="padding:6px;text-align:right;">${euro(dOut)}</td></tr>`;
  }
  html+='</tbody></table>';
  document.getElementById('m_history').innerHTML=html;
  drawChart(document.getElementById('m_chart'), h.map(x=>({ts:x.ts, IN:x.IN, OUT:x.OUT})));
}

function updateLatestSnapshot(ts){
  if(!ts) return;
  if(latestSnapshot==='‚Äî' || new Date(ts) > new Date(latestSnapshot)){
    latestSnapshot = ts;
  }
}
function setProgress(done,total,label){
  const el=document.getElementById('loadProgress');
  if(total<=0){ el.classList.add('hidden'); return; }
  el.classList.remove('hidden');
  const pct=Math.min(100,Math.round((done/total)*100));
  document.getElementById('loadBar').style.width=`${pct}%`;
  document.getElementById('loadPct').textContent=`${pct}%`;
  document.getElementById('loadText').textContent=label;
  if(done>=total){
    setTimeout(()=> el.classList.add('hidden'), 900);
  }
}

function refreshViews(){
  const latestStates=getLatestStateForAll();
  fullRows = latestStates.map(s=> computeRow(s)).filter(Boolean);
  render(fullRows);
  findStale(); renderStale();
  document.getElementById('staleWarn').classList.toggle('hidden', staleRows.length===0);
}

async function processFiles(files, state){
  for(const f of files){
    try{
      state.status(`Leggo ${f.name} ‚Ä¶`);
      const data=await fetchXLSX('Dati/'+f.name);
      state.lastName=f.name; state.lastRowsTotal=data.length; if(!data.length){
        state.doneFiles++; setProgress(state.doneFiles,state.totalFiles,state.label);
        continue;
      }
      const cols=pickCols(data[0]);
      if(!cols.idKey||!cols.modelCodeKey||!cols.inKey||!cols.outKey){
        toast(`Colonne mancanti in ${f.name} (servono: CODEID, CODICE MODELLO, CNTTOTIN, CNTTOTOT, DATA ULTIMA LETTURA VAL.)`);
        state.doneFiles++; setProgress(state.doneFiles,state.totalFiles,state.label);
        continue;
      }
      const fallbackTS=parseStampFromName(f.name);
      for(const r of data){
        const rec={
          ID: cleanID(r[cols.idKey]),
          MODEL_CODE: cleanCode(r[cols.modelCodeKey]),
          IN: parseCnt(r[cols.inKey]),
          OUT: parseCnt(r[cols.outKey]),
          MODELLO: cols.modelloKey ? norm(r[cols.modelloKey]) : '',
          DENOMIN_SEDE: cols.denomSedeKey ? norm(r[cols.denomSedeKey]) : '',
          SEDE: cols.sedeKey ? norm(r[cols.sedeKey]) : (norm(r['comune'])||''),
          INDIRIZZO: cols.indirKey ? norm(r[cols.indirKey]) : '',
          PROVINCIA: cols.provKey ? norm(r[cols.provKey]) : ''
        };
        if(!rec.ID) continue;
        const tsVal = cols.validKey ? r[cols.validKey] : '';
        const ts = parseTSValue(tsVal, fallbackTS);

        const {ciclo}=getCicloPayout(rec.MODEL_CODE,rec.MODELLO);
        if(!ciclo){ state.lastUnmapped.push({modelCode:rec.MODEL_CODE, modello:rec.MODELLO}); }

        pushHistory(rec.ID, ts, rec.IN, rec.OUT, {
          MODEL_CODE:rec.MODEL_CODE, MODELLO:rec.MODELLO, DENOMIN_SEDE:rec.DENOMIN_SEDE, SEDE:rec.SEDE, INDIRIZZO:rec.INDIRIZZO, PROVINCIA:rec.PROVINCIA
        });
        state.totalPushed++;
        updateLatestSnapshot(ts);
      }
      state.doneFiles++;
      setProgress(state.doneFiles,state.totalFiles,state.label);
    }catch(err){
      console.error('Errore su file', f.name, err);
      toast(`Errore leggendo ${f.name}`);
      state.doneFiles++;
      setProgress(state.doneFiles,state.totalFiles,state.label);
      continue;
    }
  }
}

/* ====== Init: lettura da /Dati + timestamp per riga ====== */
async function initAuto(){
  const status=m=>document.getElementById('statStatus').textContent=m;

  /* 1) cicloslot */
  if(CICLOSLOT.length===0){
    try{
      const cicloRes=await fetch('Dati/cicloslot.json',{cache:'no-store'});
      if(cicloRes.ok){
        const cicloJson=await cicloRes.json();
        const rows=Array.isArray(cicloJson)?cicloJson:(cicloJson.data||[]);
        CYCLE=buildCicloMaps(rows);
      } else {
        throw new Error('missing json');
      }
    }catch{
      try{
        const cicloRows=await fetchXLSX('Dati/cicloslot.xlsx');
        const mapped=cicloRows.map(r=>({code:r['codice modello']||r.code||r['CODICE MODELLO'],model:r.modello||r.model||r['MODELLO']||'',ciclo:r.ciclo||r.cycle||r['CICLO'],payout:r['payout %']||r['payout']||r['PAYOUT %']||r['PAYOUT']})).filter(x=>x.code&&+x.ciclo>0);
        CYCLE=buildCicloMaps(mapped);
      }catch(e){ toast('Impossibile leggere /Dati/cicloslot.json o /Dati/cicloslot.xlsx'); return; }
    }
  } else { CYCLE=buildCicloMaps(CICLOSLOT); }

  /* 2) manifest */
  status('Carico manifest‚Ä¶');
  let lista=[]; try{ const r=await fetch('Dati/manifest.json',{cache:'no-store'}); if(r.ok){ const j=await r.json(); lista=Array.isArray(j.sinottici)?j.sinottici:[]; } }catch{}
  if(!lista.length){ status('Manifest mancante (Dati/manifest.json)'); return; }

  /* 3) leggi i sinottici in ordine temporale */
  const files=lista.map(name=>({name,ts:parseStampFromName(name)})).sort((a,b)=>new Date(a.ts)-new Date(b.ts));
  const recent=files.slice(-3);
  const rest=files.slice(0,-3);
  const state={
    status,
    lastUnmapped,
    lastName:'',
    lastRowsTotal:0,
    totalPushed:0,
    doneFiles:0,
    totalFiles:files.length,
    label:'Caricamento sinottici‚Ä¶'
  };

  setProgress(0,state.totalFiles,'Caricamento rapido (ultimi 3 sinottici)‚Ä¶');
  await processFiles(recent,state);
  status(`Caricati ${recent.length} sinottici recenti, avvio analisi‚Ä¶`);
  localStorage.setItem(HIST_KEY, JSON.stringify(history));
  refreshViews();

  document.getElementById('lastRead').innerHTML = `Ultima lettura: <b>${fmtDMY(latestSnapshot)}</b>`;
  document.getElementById('statStatus').textContent = `Ultimo file: ${state.lastName||'‚Äî'} ‚Äî righe: ${state.lastRowsTotal} ‚Äî importate: ${state.totalPushed}`;
  document.getElementById('statMap').textContent = `Mappate/scartate: ‚Äî/${lastUnmapped.length}`;

  if(rest.length){
    setProgress(state.doneFiles,state.totalFiles,'Caricamento completo in background‚Ä¶');
    setTimeout(async ()=>{
      await processFiles(rest,state);
      localStorage.setItem(HIST_KEY, JSON.stringify(history));
      refreshViews();
      document.getElementById('lastRead').innerHTML = `Ultima lettura: <b>${fmtDMY(latestSnapshot)}</b>`;
      document.getElementById('statStatus').textContent = `Ultimo file: ${state.lastName||'‚Äî'} ‚Äî righe: ${state.lastRowsTotal} ‚Äî importate: ${state.totalPushed}`;
      document.getElementById('statMap').textContent = `Mappate/scartate: ‚Äî/${lastUnmapped.length}`;
    }, 120);
  }

  const savedQ=localStorage.getItem('awp_q'); if(savedQ) document.getElementById('search').value=savedQ;
  document.getElementById('search').addEventListener('input', ()=> { localStorage.setItem('awp_q', document.getElementById('search').value); render(fullRows); });

  // Impostazioni UI
  document.getElementById('thrAbs').value=CFG.thrAbs; document.getElementById('thrPct').value=CFG.thrPct; document.getElementById('staleDays').value=CFG.staleDays;
  document.querySelectorAll('.colToggle').forEach(ch=> ch.checked = !!CFG.showCols[ch.dataset.col]);
  document.querySelectorAll('.colToggle').forEach(ch=> ch.onchange=()=>{ CFG.showCols[ch.dataset.col]=!!ch.checked; localStorage.setItem(STORE, JSON.stringify(CFG)); render(fullRows); });
}
</script>
</body>
</html>
