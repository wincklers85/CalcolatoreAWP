<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AWP Manager ‚Äî Dashboard</title>

<!-- Font moderno -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Chart.js per grafici animati -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- SheetJS per leggere XLSX in RAM -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

<style>
  :root{
    /* Palette base (verranno rimpiazzate dai temi) */
    --bg:#f5f7fa; --fg:#1b1b1b; --muted:#5d6b7a; --card:#ffffff; --border:#dfe3ea;
    --acc:#007bff; --acc-2:#00bfff; --ok:#2ea043; --warn:#f59e0b; --bad:#ef4444;
    --table-head:#eef2f7;
  }

  /* Temi AWP */
  body.theme-light { --bg:#f5f7fa; --fg:#1b1b1b; --muted:#5d6b7a; --card:#ffffff; --border:#dfe3ea; --acc:#007bff; --acc-2:#00bfff; --table-head:#eef2f7; }
  body.theme-dark  { --bg:#121417; --fg:#e4e7ec; --muted:#9aa3af; --card:#181b20; --border:#2a2f36; --acc:#3399ff; --acc-2:#6fd3ff; --table-head:#1c2128; }
  body.theme-blue  { --bg:#e9f5ff; --fg:#002b4d; --muted:#335d7a; --card:#ffffff; --border:#cfe6fb; --acc:#0066cc; --acc-2:#1aa3ff; --table-head:#d9eeff; }
  body.theme-contrast { --bg:#000000; --fg:#ffff00; --muted:#ffe766; --card:#0b0b0b; --border:#333333; --acc:#ff3333; --acc-2:#ffea00; --table-head:#111111; }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;transition:background .25s ease,color .25s ease}

  /* Navbar sticky */
  .navbar{
    position:sticky; top:0; z-index:20;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 16px; background:var(--card); border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
  }
  .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--fg)}
  .brand img{height:28px; width:auto; display:block; filter: drop-shadow(0 0 6px rgba(0,0,0,.15))}
  .brand strong{font-weight:700; letter-spacing:.2px}
  .navlinks a{
    color:var(--fg); text-decoration:none; margin:0 8px; padding:6px 10px; border-radius:8px;
    transition: background .2s ease, color .2s ease;
  }
  .navlinks a:hover{ background:var(--table-head) }
  .right{
    display:flex; align-items:center; gap:8px;
  }
  select,button{
    background:var(--card); color:var(--fg); border:1px solid var(--border);
    border-radius:10px; padding:8px 12px; font-weight:600;
  }
  button.primary{ background:var(--acc); color:#fff; border-color:var(--acc); }
  button.primary:hover{ filter:brightness(.95) }

  main{padding:18px; max-width:1200px; margin:0 auto;}
  .grid{
    display:grid; gap:14px; grid-template-columns:repeat(12,1fr);
  }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px;
    padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.06);
    animation: fadeIn .35s ease;
  }
  .card h3{margin:0 0 6px 0; font-size:15px; color:var(--muted)}
  .big{
    font-size:34px; font-weight:700; line-height:1.15; letter-spacing:.2px;
    text-shadow: 0 0 0 rgba(0,0,0,0);
    transition: color .2s ease;
  }
  .kpi-row{ display:flex; align-items:baseline; gap:8px; }
  .kpi-note{ font-size:13px; color:var(--muted) }

  .span-3{grid-column: span 3}
  .span-6{grid-column: span 6}
  .span-12{grid-column: span 12}

  /* Tabella compatta */
  table{ width:100%; border-collapse:collapse }
  th,td{ padding:10px 12px; border-bottom:1px solid var(--border) }
  th{ background:var(--table-head); text-align:left }
  tr:hover td{ background:rgba(0,0,0,.03) }

  /* KPI colori */
  .ok{ color: var(--ok) }
  .warn{ color: var(--warn) }
  .bad{ color: var(--bad) }

  /* Pulse (logo svg gi√† ha il suo pulse, qui lo usiamo per piccoli badge) */
  @keyframes fadeIn { from{ opacity:0; transform: translateY(6px) } to{ opacity:1; transform:none } }
  @keyframes countPulse { 0%{ text-shadow:0 0 0 var(--acc-2) } 50%{ text-shadow:0 0 16px var(--acc-2) } 100%{ text-shadow:0 0 0 var(--acc-2) } }

  /* Meta info */
  .meta{ margin:6px 0 0; font-size:12px; color:var(--muted) }
  .pill{
    display:inline-block; padding:3px 8px; border:1px solid var(--border); border-radius:999px; background:var(--card);
    margin-right:6px;
  }

  /* Footer */
  footer{ text-align:center; padding:20px; color:var(--muted) }
</style>
</head>
<body>
  <!-- Navbar sticky -->
  <div class="navbar">
    <a class="brand" href="./dashboard.html" aria-label="AWP Manager Home">
      <img src="./logo-awp.svg" alt="AWP Manager logo">
      <strong>AWP Manager</strong>
    </a>
    <nav class="navlinks">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./letture.html">Letture</a>
      <a href="./manutenzione.html">Manutenzione</a>
      <a href="./anagrafica.html">Anagrafica</a>
    </nav>
    <div class="right">
      <label for="themeSel" style="font-size:13px;color:var(--muted);">Tema</label>
      <select id="themeSel" title="Seleziona tema">
        <option value="theme-light">‚òÄÔ∏è Chiaro AWP</option>
        <option value="theme-dark">üåô Scuro AWP</option>
        <option value="theme-blue">üå§Ô∏è Azzurro AWP</option>
        <option value="theme-contrast">‚ö´ Alto Contrasto</option>
      </select>
      <button id="btnRefresh" class="primary">üîÑ Aggiorna dati</button>
    </div>
  </div>

  <main>
    <!-- KPI cards -->
    <div class="grid">
      <div class="card span-3">
        <h3>Totale macchine (attive)</h3>
        <div class="kpi-row">
          <div id="kpiTot" class="big">‚Äî</div>
        </div>
        <div class="meta">
          <span class="pill" id="metaSinottico">Sinottico: ‚Äî</span>
        </div>
      </div>

      <div class="card span-3">
        <h3>Aggiornate oggi</h3>
        <div class="kpi-row">
          <div id="kpiOk" class="big ok">‚Äî</div>
          <div id="kpiOkPerc" class="kpi-note">‚Äî%</div>
        </div>
        <div class="meta">Letture con data = oggi</div>
      </div>

      <div class="card span-3">
        <h3>Mancate letture</h3>
        <div class="kpi-row">
          <div id="kpiBad" class="big bad">‚Äî</div>
          <div id="kpiBadPerc" class="kpi-note">‚Äî%</div>
        </div>
        <div class="meta">Escluse ferie e manutenzione</div>
      </div>

      <div class="card span-3">
        <h3>Ferie & Manutenzione</h3>
        <div class="kpi-row">
          <div id="kpiFerie" class="big">‚Äî</div>
          <div id="kpiMan" class="kpi-note">/ <span>‚Äî manut.</span></div>
        </div>
        <div class="meta">DESCR.STATO: ‚ÄúBlocco Amministrativo‚Äù / ‚Äú724 in corso‚Äù</div>
      </div>

      <div class="card span-12">
        <h3>Percentuale aggiornate per Esattore</h3>
        <canvas id="chartEsattori" height="120"></canvas>
        <div class="meta">Mostra la quota di macchine lette oggi sul totale per ciascun esattore</div>
      </div>

      <!-- Tabella riassuntiva top criticit√† -->
      <div class="card span-12">
        <h3>Top criticit√† (esattori con pi√π mancate letture)</h3>
        <div style="overflow:auto;">
          <table id="tblTop">
            <thead>
              <tr>
                <th>ESATTORE</th>
                <th>Totale attive</th>
                <th>Aggiornate oggi</th>
                <th>Mancate letture</th>
                <th>% Aggiornate</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="meta">Esclusi i PDV in ferie o in manutenzione</div>
      </div>
    </div>
  </main>

  <footer>¬© <span id="year"></span> AWP Manager ‚Äî Dashboard</footer>

<script>
/* ==============================
   Tema (4 varianti) con persistenza
   ============================== */
const THEME_KEY = 'awp_theme';
const themeSel = document.getElementById('themeSel');

function applyTheme(t){
  document.body.classList.remove('theme-light','theme-dark','theme-blue','theme-contrast');
  document.body.classList.add(t);
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY) || 'theme-light';
  applyTheme(saved);
  themeSel.value = saved;
}
themeSel.addEventListener('change', () => {
  const v = themeSel.value;
  applyTheme(v);
  localStorage.setItem(THEME_KEY, v);
});

/* ==============================
   Utils: lettura file XLSX e JSON
   ============================== */
async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('Errore caricamento: ' + url);
  return r.json();
}
async function fetchXLSX(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('Errore caricamento: ' + url);
  const ab = await r.arrayBuffer();
  const wb = XLSX.read(ab, { type: 'array' });
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, { defval: null });
}

/* ==============================
   Parse date flessibile (gg/mm/aaaa, aaaa-mm-gg, ecc.)
   ============================== */
function parseDateFlexible(s){
  if(!s) return null;
  const str = String(s).trim();
  // Prova ISO
  let d = new Date(str);
  if(!isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  // Prova dd/mm/yyyy
  const m1 = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1){
    const [_,dd,mm,yyyy] = m1;
    return new Date(Number(yyyy), Number(mm)-1, Number(dd));
  }
  // Prova yyyy-mm-dd
  const m2 = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if(m2){
    const [_,yyyy,mm,dd] = m2;
    return new Date(Number(yyyy), Number(mm)-1, Number(dd));
  }
  return null;
}
function daysDiffFromToday(d){
  if(!d) return Infinity;
  const today = new Date(); today.setHours(0,0,0,0);
  const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diff = (today - t) / (1000*60*60*24);
  return Math.floor(diff);
}

/* ==============================
   Selettori KPI e tabella
   ============================== */
const elTot = document.getElementById('kpiTot');
const elOk = document.getElementById('kpiOk');
const elOkPerc = document.getElementById('kpiOkPerc');
const elBad = document.getElementById('kpiBad');
const elBadPerc = document.getElementById('kpiBadPerc');
const elFerie = document.getElementById('kpiFerie');
const elMan = document.getElementById('kpiMan');
const elMetaSin = document.getElementById('metaSinottico');
const tblTopBody = document.querySelector('#tblTop tbody');

/* ==============================
   Animazione numeri
   ============================== */
function animateNumber(el, target, duration=700){
  const start = Number(el.textContent.replace(/[^\d]/g,'')) || 0;
  const startTime = performance.now();
  function frame(now){
    const p = Math.min(1, (now - startTime) / duration);
    const val = Math.round(start + (target - start) * p);
    el.textContent = val.toLocaleString('it-IT');
    if(p < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

/* ==============================
   Chart.js istanza
   ============================== */
let chart;
function renderChart(labels, percValues){
  const ctx = document.getElementById('chartEsattori').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: '% aggiornate oggi',
        data: percValues,
        borderWidth: 1
      }]
    },
    options: {
      animation: {
        duration: 800,
        easing: 'easeOutQuart'
      },
      scales: {
        y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y.toFixed(1)}%`
          }
        }
      }
    }
  });
}

/* ==============================
   Pipeline dati:
   - leggi manifest.json -> ultimo sinottico
   - leggi PDV-e-ESATTORI.xlsx (mappa sede‚Üíesattore)
   - leggi sinottico .xlsx
   - computa KPI e grafico
   ============================== */
async function loadAll(){
  // 1) Manifest
  const manifest = await fetchJSON('./Dati/manifest.json');
  if(!manifest || !Array.isArray(manifest.sinottici) || manifest.sinottici.length === 0){
    throw new Error('manifest.json non valido: chiave "sinottici" mancante o vuota.');
  }
  const latest = manifest.sinottici[manifest.sinottici.length - 1];
  elMetaSin.textContent = 'Sinottico: ' + latest;

  // 2) Map esattori
  const pdv = await fetchXLSX('./Dati/PDV-e-ESATTORI.xlsx');
  const sedeToEs = new Map();
  for(const r of pdv){
    const sede = String(r['DENOMINAZIONE SEDE'] ?? '').trim().toUpperCase();
    const esattore = String(r['ESATTORE'] ?? '').trim().toUpperCase();
    if(sede) sedeToEs.set(sede, esattore || '‚Äî');
  }

  // 3) Sinottico
  const sin = await fetchXLSX('./Dati/' + latest);
  // Normalizza righe utili
  const normRows = sin.map(r => {
    const locale = String(r['DENOMIN.SEDE'] ?? r['DENOMINAZIONE SEDE'] ?? '').trim();
    const comune = String(r['COMUNE'] ?? '').trim();
    const modello = String(r['MODELLO'] ?? '').trim();
    const stato  = String(r['DESCR.STATO'] ?? '').trim();
    const dataUltStr = String(r['DATA ULTIMA LETTURA VAL.'] ?? r['DATA ULTIMA LETTURA'] ?? r['ULTIMA LETTURA'] ?? '').trim();
    const awp = String(r['AWP'] ?? r['MATRICOLA AWP'] ?? r['MATRICOLA'] ?? r['SERIALE'] ?? '').trim();
    const pda = String(r['PDA'] ?? r['ID PDA'] ?? r['MATRICOLA PDA'] ?? '').trim();
    const giorni = daysDiffFromToday(parseDateFlexible(dataUltStr));
    const esattore = sedeToEs.get(locale.toUpperCase()) ?? '‚Äî';
    return { LOCALE:locale, COMUNE:comune, MODELLO:modello, STATO:stato, DATA:dataUltStr, AWP:awp, PDA:pda, GIORNI:giorni, ESATTORE:esattore };
  });

  // 4) Classificazioni
  const inManut = normRows.filter(r => r.STATO.toUpperCase().includes('724 IN CORSO'));
  const inFerie = normRows.filter(r => r.STATO.toUpperCase().includes('BLOCCO AMMINISTRATIVO'));
  const attive = normRows.filter(r =>
    !r.STATO.toUpperCase().includes('724 IN CORSO') &&
    !r.STATO.toUpperCase().includes('BLOCCO AMMINISTRATIVO')
  );

  // 5) KPI
  const tot = attive.length;
  const ok = attive.filter(r => r.GIORNI === 0).length;
  const bad = attive.filter(r => r.GIORNI > 0 || !isFinite(r.GIORNI)).length;
  const ferie = inFerie.length;
  const manut = inManut.length;

  // 6) KPI animati
  animateNumber(elTot, tot);
  animateNumber(elOk, ok);
  elOkPerc.textContent = (tot ? (ok*100/tot).toFixed(1) : '0.0') + '%';
  animateNumber(elBad, bad);
  elBadPerc.textContent = (tot ? (bad*100/tot).toFixed(1) : '0.0') + '%';
  animateNumber(elFerie, ferie);
  elMan.innerHTML = '/ <span>' + manut.toLocaleString('it-IT') + ' manut.</span>';

  // 7) Per esattore ‚Üí percentuali e top criticit√†
  const byEs = new Map(); // esattore -> {tot, ok}
  for(const r of attive){
    const es = r.ESATTORE || '‚Äî';
    if(!byEs.has(es)) byEs.set(es, {tot:0, ok:0});
    const a = byEs.get(es);
    a.tot += 1;
    if(r.GIORNI === 0) a.ok += 1;
  }
  const labels = Array.from(byEs.keys()).sort();
  const perc = labels.map(es => {
    const a = byEs.get(es); return a.tot ? (a.ok*100/a.tot) : 0;
  });
  renderChart(labels, perc);

  // 8) Tabella top criticit√† (ordina per pi√π mancate)
  const rows = labels.map(es => {
    const a = byEs.get(es);
    const bad = a.tot - a.ok;
    const p = a.tot ? (a.ok*100/a.tot) : 0;
    return { ESATTORE: es, TOT:a.tot, OK:a.ok, BAD:bad, PERC: p };
  }).sort((A,B) => B.BAD - A.BAD);

  tblTopBody.innerHTML = '';
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.ESATTORE}</td>
      <td>${r.TOT}</td>
      <td class="ok">${r.OK}</td>
      <td class="bad">${r.BAD}</td>
      <td>${r.PERC.toFixed(1)}%</td>
    `;
    tblTopBody.appendChild(tr);
  }
}

/* ==============================
   Init
   ============================== */
document.getElementById('year').textContent = new Date().getFullYear();
initTheme();
loadAll().catch(err => alert(err.message));
document.getElementById('btnRefresh').addEventListener('click', () => {
  // ricarica tutto
  loadAll().catch(err => alert(err.message));
});
</script>
</body>
</html>
