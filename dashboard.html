<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AWP Manager ‚Äî Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f5f7fa; --fg:#1b1b1b; --muted:#5d6b7a; --card:#ffffff; --border:#dfe3ea;
    --acc:#007bff; --acc-2:#00bfff; --ok:#2ea043; --warn:#f59e0b; --bad:#ef4444;
    --table-head:#eef2f7; --shadow:0 8px 22px rgba(0,0,0,.06);
  }
  body.theme-light { --bg:#f5f7fa; --fg:#1b1b1b; --muted:#5d6b7a; --card:#fff; --border:#dfe3ea; --acc:#007bff; --acc-2:#00bfff; --table-head:#eef2f7; --shadow:0 10px 26px rgba(0,0,0,.08) }
  body.theme-dark  { --bg:#121417; --fg:#e4e7ec; --muted:#9aa3af; --card:#181b20; --border:#2a2f36; --acc:#3399ff; --acc-2:#6fd3ff; --table-head:#1c2128; --shadow:0 10px 30px rgba(0,0,0,.35) }
  body.theme-blue  { --bg:#e9f5ff; --fg:#002b4d; --muted:#335d7a; --card:#ffffff; --border:#cfe6fb; --acc:#0066cc; --acc-2:#1aa3ff; --table-head:#d9eeff; --shadow:0 12px 28px rgba(0,80,160,.15) }
  body.theme-contrast { --bg:#000; --fg:#ff0; --muted:#ffe766; --card:#0b0b0b; --border:#333; --acc:#ff3333; --acc-2:#ffea00; --table-head:#111; --shadow:0 10px 26px rgba(255,255,0,.12) }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;transition:background .25s ease,color .25s ease}

  .navbar{
    position:sticky; top:0; z-index:30;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 16px; background:var(--card); border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
  }
  .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--fg)}
  .brand img{height:28px; width:auto; filter: drop-shadow(0 0 6px rgba(0,0,0,.15))}
  .brand strong{font-weight:700}
  .nav-mid{display:flex; align-items:center; gap:10px;}
  .navlinks a{ color:var(--fg); text-decoration:none; margin:0 8px; padding:6px 10px; border-radius:8px }
  .navlinks a:hover{ background:var(--table-head) }
  .right{display:flex; align-items:center; gap:8px}
  select,button{ background:var(--card); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-weight:600 }
  button.primary{ background:var(--acc); color:#fff; border-color:var(--acc) }
  button.primary:hover{ filter:brightness(.95) }

  .badge{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--border); background:var(--card) }
  .badge.ok{ border-color:var(--ok); color:var(--ok) }
  .badge.warn{ border-color:var(--warn); color:var(--warn) }
  .badge.danger{ border-color:var(--bad); color:var(--bad) }

  main{ padding:18px; max-width:1200px; margin:0 auto }
  .grid{ display:grid; gap:14px; grid-template-columns:repeat(12,1fr) }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow); animation:fadeIn .35s ease }
  .card h3{ margin:0 0 6px; font-size:14px; color:var(--muted) }
  .kpi{ display:flex; align-items:center; justify-content:space-between }
  .k-num{ font-size:34px; font-weight:800 }
  .ok{ color:var(--ok) } .warn{ color:var(--warn) } .bad{ color:var(--bad) }
  .span-3{grid-column:span 3} .span-12{grid-column:span 12}
  @media (max-width:980px){ .span-3{grid-column:span 6} .span-12{grid-column:span 12} }

  table{ width:100%; border-collapse:collapse }
  th,td{ padding:10px 12px; border-bottom:1px solid var(--border) }
  th{ background:var(--table-head); text-align:left }
  tr:hover td{ background:rgba(0,0,0,.03) }
  .meta{ margin-top:6px; font-size:12px; color:var(--muted) }
  .pill{ display:inline-block; padding:3px 8px; border:1px solid var(--border); border-radius:999px; background:var(--card); margin-right:6px }

  @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

  #loader{ position:fixed; inset:0; background:rgba(0,0,0,.08); backdrop-filter:blur(2px); display:none; align-items:center; justify-content:center; z-index:40 }
  .spinner{ width:54px; height:54px; border-radius:50%; border:5px solid rgba(0,0,0,.15); border-top-color:var(--acc); animation:spin .9s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }
</style>
</head>
<body>
  <div class="navbar">
    <a class="brand" href="./dashboard.html">
      <img src="./logo-awp.svg" alt="AWP Manager">
      <strong>AWP Manager</strong>
    </a>

    <div class="nav-mid">
      <span id="taxBadge" class="badge">‚Äî</span>
      <nav class="navlinks">
        <a href="./dashboard.html" style="font-weight:700; text-decoration:underline;">Dashboard</a>
        <a href="./letture.html">Letture</a>
        <a href="./manutenzione.html">Manutenzione</a>
        <a href="./anagrafica.html">Anagrafica</a>
      </nav>
    </div>

    <div class="right">
      <label for="themeSel" style="font-size:13px;color:var(--muted);">Tema</label>
      <select id="themeSel">
        <option value="theme-light">‚òÄÔ∏è Chiaro AWP</option>
        <option value="theme-dark">üåô Scuro AWP</option>
        <option value="theme-blue">üå§Ô∏è Azzurro AWP</option>
        <option value="theme-contrast">‚ö´ Alto Contrasto</option>
      </select>
      <button id="btnRefresh" class="primary">üîÑ Aggiorna dati</button>
    </div>
  </div>

  <main>
    <div class="grid">
      <div class="card span-3">
        <h3>Totale macchine (attive)</h3>
        <div class="kpi"><div id="kpiTot" class="k-num">‚Äî</div></div>
        <div class="meta"><span class="pill" id="metaSinottico">Sinottico: ‚Äî</span></div>
      </div>
      <div class="card span-3">
        <h3>Aggiornate oggi</h3>
        <div class="kpi">
          <div id="kpiOk" class="k-num ok">‚Äî</div>
          <div id="kpiOkPerc" class="meta">‚Äî%</div>
        </div>
        <div class="meta">Letture con data = oggi</div>
      </div>
      <div class="card span-3">
        <h3>Mancate letture</h3>
        <div class="kpi">
          <div id="kpiBad" class="k-num bad">‚Äî</div>
          <div id="kpiBadPerc" class="meta">‚Äî%</div>
        </div>
        <div class="meta">Escluse ferie e manutenzione</div>
      </div>
      <div class="card span-3">
        <h3>Ferie &amp; Manutenzione</h3>
        <div class="kpi">
          <div id="kpiFerie" class="k-num">‚Äî</div>
          <div id="kpiMan" class="meta">/ <span>‚Äî manut.</span></div>
        </div>
        <div class="meta">DESCR.STATO: ‚ÄúBlocco Amministrativo‚Äù / ‚Äú724 in corso‚Äù</div>
      </div>

      <div class="card span-12">
        <h3>% aggiornate per Esattore (oggi)</h3>
        <canvas id="chartEsattori" height="120"></canvas>
        <div class="meta">Quota di macchine lette oggi sul totale per ciascun esattore</div>
      </div>

      <div class="card span-12">
        <h3>Top criticit√† (esattori con pi√π mancate letture)</h3>
        <div style="overflow:auto;">
          <table id="tblTop">
            <thead>
              <tr>
                <th>ESATTORE</th>
                <th>Totale attive</th>
                <th>Aggiornate oggi</th>
                <th>Mancate letture</th>
                <th>% Aggiornate</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="meta">Esclusi i PDV in ferie o in manutenzione</div>
      </div>
    </div>
  </main>

  <footer>¬© <span id="year"></span> AWP Manager ‚Äî Dashboard</footer>

  <div id="loader"><div class="spinner" aria-label="Caricamento"></div></div>

  <script>
  (function(){
    const urls = {
      xlsx: [
        './libs/xlsx.full.min.js',
        'https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js',
        'https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'
      ],
      chart: [
        './libs/chart.umd.min.js',
        'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js',
        'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'
      ]
    };

    function loadOne(url){
      return new Promise((resolve, reject)=>{
        const s=document.createElement('script');
        s.src=url; s.async=false;
        s.onload=()=>resolve(url);
        s.onerror=()=>reject(new Error(url));
        document.head.appendChild(s);
      });
    }
    async function loadWithFallback(list, testFn){
      let lastErr=null;
      for(const u of list){
        try{ await loadOne(u); if(testFn()) return u; }catch(e){ lastErr=e; }
      }
      try{ // tentativo finale forzato
        await loadOne('https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js');
        if(testFn()) return 'https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js';
      }catch(e){ lastErr=e; }
      throw lastErr || new Error('XLSX non caricato');
    }

    function showLoader(v){ document.getElementById('loader').style.display = v?'flex':'none' }

    async function boot(){
      try{
        showLoader(true);
        await loadWithFallback(urls.xlsx, ()=>!!window.XLSX);
        await loadWithFallback(urls.chart, ()=>!!window.Chart);
        startApp();
      }catch(e){
        alert('Impossibile caricare libreria: '+(e && e.message ? e.message : 'sconosciuta')+
              '\nControlla la connessione o verifica i file in /libs/');
        showLoader(false);
      }
    }

    // ===================== APP =====================
    function startApp(){
      // Temi
      const THEME_KEY='awp_theme';
      const themeSel=document.getElementById('themeSel');
      function applyTheme(t){ document.body.className=t; }
      function initTheme(){ const t=localStorage.getItem(THEME_KEY)||'theme-light'; applyTheme(t); themeSel.value=t; }
      themeSel.addEventListener('change', ()=>{ applyTheme(themeSel.value); localStorage.setItem(THEME_KEY, themeSel.value); });

      // Helpers fetch
      async function fetchJSON(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('Errore: '+url); return r.json(); }
      async function fetchXLSX(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('Errore: '+url); const ab=await r.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; return XLSX.utils.sheet_to_json(ws,{defval:null}); }

      // Parser data per "GG-MM-AAAA HH:MM:SS" + seriali Excel
      function parseDateIT(value){
        if (value == null || value === '') return null;

        if (typeof value === 'number' || /^[0-9]+$/.test(String(value).trim())) {
          const n = Number(value);
          if (!Number.isNaN(n) && n > 0 && n < 2958465) {
            const base = new Date(Date.UTC(1899, 11, 30));
            const d = new Date(base.getTime() + n * 86400000);
            return new Date(d.getFullYear(), d.getMonth(), d.getDate());
          }
        }
        const s = String(value).trim().replace(/[\/\.]/g, '-');
        const m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
        if (m) { const [, gg, mm, yyyy] = m; return new Date(+yyyy, +mm - 1, +gg); }

        const d = new Date(s);
        if (!isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        return null;
      }
      function daysDiffFromToday(d){
        if (!d) return Infinity;
        const today = new Date(); today.setHours(0,0,0,0);
        const only  = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        return Math.floor((today - only) / 86400000);
      }

      // Normalizzazione sede per match esattore
      function normalizeSede(s){
        return String(s||'')
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
          .replace(/\s+/g,' ')
          .replace(/[^\w\s\-&']/g,'')
          .trim().toUpperCase();
      }

      // Solo AWP / slot
      const ACCEPT_MODELS = ['AWP','SLOT','AMA','AMUSEMENT WITH PRIZE'];
      function isAwbModel(model){
        const m = String(model||'').toUpperCase();
        return ACCEPT_MODELS.some(k => m.includes(k));
      }

      // Badge 15/ultimo
      function isLastDayOfMonth(d){ const probe=new Date(d.getFullYear(), d.getMonth()+1, 0); return d.getDate()===probe.getDate(); }
      function daysUntil(a,b){ const t0=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const t1=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.round((t1-t0)/86400000); }
      function nextTaxDay(from){ const y=from.getFullYear(), m=from.getMonth(); const d15=new Date(y,m,15); const last=new Date(y,m+1,0); if(from.getDate()<=15) return d15; if(from.getDate()<last.getDate()) return last; return new Date(y,m+1,15); }
      function updateTaxBadge(){
        const el=document.getElementById('taxBadge'); if(!el) return;
        const today=new Date(); today.setHours(0,0,0,0);
        if(today.getDate()===15 || isLastDayOfMonth(today)){ el.textContent='‚ö†Ô∏è Oggi lettura obbligatoria'; el.className='badge danger'; return; }
        const target=nextTaxDay(today); const diff=daysUntil(today,target);
        el.className='badge ' + (diff<=2?'warn':'ok');
        el.textContent = `‚è≥ Mancano ${diff} gg ‚Äî ${target.getDate()===15?'15 del mese':'Ultimo del mese'}`;
      }

      // DOM refs
      const elTot=document.getElementById('kpiTot');
      const elOk=document.getElementById('kpiOk');
      const elOkPerc=document.getElementById('kpiOkPerc');
      const elBad=document.getElementById('kpiBad');
      const elBadPerc=document.getElementById('kpiBadPerc');
      const elFerie=document.getElementById('kpiFerie');
      const elMan=document.getElementById('kpiMan');
      const elMetaSin=document.getElementById('metaSinottico');
      const tblTopBody=document.querySelector('#tblTop tbody');

      function animateNumber(el, target, duration=700){
        const start=Number(el.textContent.replace(/[^\d]/g,''))||0;
        const t0=performance.now();
        function tick(now){ const p=Math.min(1,(now-t0)/duration); el.textContent=Math.round(start+(target-start)*p).toLocaleString('it-IT'); if(p<1) requestAnimationFrame(tick); }
        requestAnimationFrame(tick);
      }

      let chart;
      function renderChart(labels, percValues){
        const ctx=document.getElementById('chartEsattori').getContext('2d');
        if(chart) chart.destroy();
        chart=new Chart(ctx,{
          type:'bar',
          data:{ labels, datasets:[{ label:'% aggiornate oggi', data:percValues, borderWidth:1 }]},
          options:{ animation:{ duration:900, easing:'easeOutQuart' },
            scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%' } } },
            plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:c=>c.parsed.y.toFixed(1)+'%' } } }
          }
        });
      }

      async function loadAll(){
        try{
          showLoader(true);
          const manifest=await fetchJSON('./Dati/manifest.json');
          if(!manifest || !Array.isArray(manifest.sinottici) || manifest.sinottici.length===0) throw new Error('manifest.json non valido');
          const latest=manifest.sinottici[manifest.sinottici.length-1];
          elMetaSin.textContent='Sinottico: '+latest;

          const pdv=await fetchXLSX('./Dati/PDV-e-ESATTORI.xlsx');
          const sedeToEs=new Map();
          for(const r of pdv){
            const sede=normalizeSede(r['DENOMINAZIONE SEDE']);
            const esa =String(r['ESATTORE']??'').trim().toUpperCase() || '‚Äî';
            if(sede) sedeToEs.set(sede, esa);
          }

          const sin=await fetchXLSX('./Dati/'+latest);
          const rowsRaw = sin.map(r=>{
            const locale = String(r['DENOMIN.SEDE'] ?? r['DENOMINAZIONE SEDE'] ?? '').trim();
            const stato  = String(r['DESCR.STATO'] ?? '').trim();
            const modello= String(r['MODELLO'] ?? '').trim();
            const dataStr= String(r['DATA ULTIMA LETTURA VAL.'] ?? r['DATA ULTIMA LETTURA'] ?? r['ULTIMA LETTURA'] ?? '').trim();
            const data   = parseDateIT(dataStr);
            const giorni = daysDiffFromToday(data);
            const esatt  = sedeToEs.get(normalizeSede(locale)) ?? '‚Äî';
            return { LOCALE:locale, STATO:stato, MODELLO:modello, DATA:dataStr, GIORNI:giorni, ESATTORE:esatt };
          });

          const inManut = rowsRaw.filter(r => /724\s*IN\s*CORSO/i.test(r.STATO));
          const inFerie = rowsRaw.filter(r => /BLOCCO\s*AMMINISTRATIVO/i.test(r.STATO));
          const attiveAwb = rowsRaw.filter(r =>
            isAwbModel(r.MODELLO) &&
            !/724\s*IN\s*CORSO/i.test(r.STATO) &&
            !/BLOCCO\s*AMMINISTRATIVO/i.test(r.STATO)
          );

          const tot=attiveAwb.length;
          const ok =attiveAwb.filter(r=>r.GIORNI===0).length;
          const bad=attiveAwb.filter(r=>r.GIORNI>0 || !isFinite(r.GIORNI)).length;

          animateNumber(elTot, tot);
          animateNumber(elOk, ok);
          elOkPerc.textContent = (tot? (ok*100/tot).toFixed(1):'0.0')+'%';
          animateNumber(elBad, bad);
          elBadPerc.textContent = (tot? (bad*100/tot).toFixed(1):'0.0')+'%';
          animateNumber(elFerie, inFerie.length);
          elMan.innerHTML = '/ <span>'+inManut.length.toLocaleString('it-IT')+' manut.</span>';

          const byEs=new Map();
          for(const r of attiveAwb){
            const es=r.ESATTORE||'‚Äî';
            if(!byEs.has(es)) byEs.set(es,{tot:0, ok:0});
            const a=byEs.get(es); a.tot++; if(r.GIORNI===0) a.ok++;
          }
          const labels=Array.from(byEs.keys()).sort();
          const perc=labels.map(es=>{ const a=byEs.get(es); return a.tot? (a.ok*100/a.tot) : 0; });
          renderChart(labels, perc);

          const tb=tblTopBody; tb.innerHTML='';
          labels.map(es=>{
            const a=byEs.get(es); const xbad=a.tot-a.ok; const p=a.tot?(a.ok*100/a.tot):0;
            return {ESATTORE:es, TOT:a.tot, OK:a.ok, BAD:xbad, PERC:p};
          }).sort((A,B)=>B.BAD-A.BAD).forEach(r=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${r.ESATTORE}</td><td>${r.TOT}</td><td class="ok">${r.OK}</td><td class="bad">${r.BAD}</td><td>${r.PERC.toFixed(1)}%</td>`;
            tb.appendChild(tr);
          });
        } finally { showLoader(false); }
      }

      document.getElementById('year').textContent=new Date().getFullYear();
      initTheme();
      updateTaxBadge();
      loadAll().catch(e=>alert(e.message));
      document.getElementById('btnRefresh').addEventListener('click', ()=>{ updateTaxBadge(); loadAll().catch(e=>alert(e.message)); });
    }

    window.addEventListener('load', boot);
  })();
  </script>
</body>
</html>
