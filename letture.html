<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AWP Manager ‚Äî Letture</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f7f8fb;--fg:#111;--mut:#667085;--card:#fff;--border:#e5e7eb;--acc:#0d6efd;--bad:#ef4444;--ok:#16a34a;--warn:#f59e0b;--thead:#eef2f7}
body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.nav{position:sticky;top:0;z-index:20;display:flex;gap:10px;align-items:center;justify-content:space-between;background:var(--card);border-bottom:1px solid var(--border);padding:10px 12px}
.nav .brand{display:flex;gap:8px;align-items:center;font-weight:800}
main{max-width:1200px;margin:0 auto;padding:14px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
select,button,input{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600}
button.primary{background:var(--acc);color:#fff;border-color:var(--acc)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
.pills{display:flex;gap:6px;flex-wrap:wrap}
.pill{font-size:12px;color:#334155;border:1px solid var(--border);padding:3px 8px;border-radius:999px;background:#fff}
#debug{display:none}
#debug pre{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#fff9f9;border:1px dashed #fca5a5;border-radius:8px;padding:8px;color:#7a0000}
.err{display:none;background:#fff1f1;border:1px solid #ffb3b3;border-radius:10px;padding:10px;color:#7a0000;margin-bottom:10px}
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
table{border-collapse:collapse;min-width:820px;width:100%}
th,td{padding:10px;border-bottom:1px solid var(--border)}
th{background:var(--thead);text-align:left;position:sticky;top:0;z-index:1}
td.days{color:var(--bad);font-weight:800}
.meta{font-size:12px;color:var(--mut)}
.spinner{width:52px;height:52px;border:4px solid #e5e7eb;border-top-color:var(--acc);border-radius:50%;animation:spin .9s linear infinite;margin:20px auto}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:700px){table{min-width:680px}}
</style>
</head>
<body>
<div class="nav">
  <div class="brand">üìü <span>AWP Manager ‚Äî Letture</span></div>
  <div style="display:flex;gap:8px;align-items:center">
    <label style="font-size:13px;display:flex;gap:6px;align-items:center">
      <input type="checkbox" id="toggleDebug"> Debug
    </label>
    <button id="btnRefresh" class="primary">üîÑ Aggiorna</button>
  </div>
</div>

<main>
  <div class="err" id="errBox"></div>

  <div class="card">
    <div class="controls">
      <label>Esattore:
        <select id="selEs"><option value="">‚Äî Tutti ‚Äî</option></select>
      </label>
      <label>Giorni arretrati:
        <select id="selDays">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="7">7</option>
          <option value="10">10</option>
        </select>
      </label>
      <button id="btnApply" class="primary">Applica</button>
      <button id="btnXlsx">‚¨áÔ∏è XLSX</button>
      <button id="btnTxt">‚¨áÔ∏è TXT</button>
      <button id="btnWA">üü¢ WhatsApp</button>
    </div>
    <div class="pills">
      <span class="pill" id="pManifest">manifest: ‚Äî</span>
      <span class="pill" id="pLatest">ultimo xlsx: ‚Äî</span>
      <span class="pill" id="pPdv">PDV righe: ‚Äî</span>
      <span class="pill" id="pRows">Sinottico righe: ‚Äî</span>
      <span class="pill" id="pActive">Attive: ‚Äî</span>
      <span class="pill" id="pSel">Selezione: ‚Äî</span>
      <span class="pill" id="pXlsx">XLSX: ‚Äî</span>
    </div>
    <div class="meta">Filtro: <b>DESCR. STATO = Attiva</b> ‚Ä¢ Join su <b>DENOMIN. SEDE</b> ‚Üí <b>ESATTORE</b> ‚Ä¢ Data: <b>DATA ULTIMA LETTURA VAL.</b> (GG-MM-AAAA HH:MM[:SS] o seriale) ‚Üí giorni</div>
  </div>

  <div id="debug" class="card">
    <h3>Debug</h3>
    <pre id="dbg"></pre>
  </div>

  <div class="card table-wrap" id="tblWrap" style="display:none">
    <table id="tbl">
      <thead>
        <tr><th>ESATTORE</th><th>LOCALE</th><th>AWP</th><th>MODELLO</th><th>PDA</th><th>GIORNI</th><th>COMUNE</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="loading" style="text-align:center"><div class="spinner"></div><div class="meta">Carico file‚Ä¶</div></div>
</main>

<!-- SheetJS: loader ROBUSTO (fetch + inject, con fallback CDN) -->
<script>
(async()=>{
  const urls = [
    './libs/xlsx.full.min.js',
    'https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js',
    'https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'
  ];
  async function loadXlsxForce(){
    for(const url of urls){
      try{
        const res = await fetch(url,{cache:'no-store'});
        if(!res.ok) { console.warn('XLSX fetch fail',url,res.status); continue; }
        const js = await res.text();
        const s = document.createElement('script');
        s.text = js;
        document.head.appendChild(s);
        if(window.XLSX){ document.getElementById('pXlsx').textContent='XLSX: OK ('+url+')'; return true; }
      }catch(e){ console.warn('XLSX error',url,e); }
    }
    document.getElementById('pXlsx').textContent='XLSX: KO';
    return false;
  }
  await loadXlsxForce();
})();
</script>

<script>
const $=s=>document.querySelector(s);
const errBox=$('#errBox'); const dbg=$('#dbg');
const state={manifestList:[], latestName:'', sedeToEs:new Map(), esattori:[], rows:[], active:[], filtered:[]};

function showErr(msg){errBox.textContent=msg;errBox.style.display='block';log('ERROR',msg);}
function clearErr(){errBox.textContent='';errBox.style.display='none';}
function log(tag,...args){dbg.textContent += `[${tag}] `+args.map(a=>typeof a==='string'?a:JSON.stringify(a,null,2)).join(' ')+'\n';}

function normKey(k){return String(k).toLowerCase().replace(/\s+/g,'').replace(/\./g,'');}
function getField(row, names){
  const variants=Array.isArray(names)?names:[names];
  for(const n of variants){ if(row[n]!=null && row[n]!=='' ) return row[n]; }
  const keys=Object.keys(row); const wanted=variants.map(v=>normKey(v));
  for(const k of keys){ if(wanted.includes(normKey(k)) && row[k]!=null && row[k]!=='' ) return row[k]; }
  return '';
}
function pickCodeId(row){
  const ks=Object.keys(row), N=k=>k&&String(k).toUpperCase().replace(/[^A-Z0-9]/g,'');
  let k=ks.find(k=>N(k)==='CODEID'); if(k) return String(row[k]??'').trim();
  k=ks.find(k=>/COD(ICE)?ID/i.test(k)); if(k) return String(row[k]??'').trim();
  k=ks.find(k=>/(SERIALE|MATRICOLA|AWP)/i.test(k)); return k?String(row[k]??'').trim():'';
}
function parseDateITDateTime(v){
  if(v==null||v==='')return null;
  if(typeof v==='number'||/^[0-9]+(\.[0-9]+)?$/.test(String(v).trim())){
    const n=Number(v); if(n>0&&n<2958465){ const base=new Date(Date.UTC(1899,11,30)); const ms=Math.round(n*86400000); return new Date(base.getTime()+ms); }
  }
  const s=String(v).trim().replace(/[\/\.]/g,'-');
  const m=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){const[,gg,mm,yy,HH='0',MM='0',SS='0']=m; return new Date(+yy,+mm-1,+gg,+HH,+MM,+SS);}
  const d=new Date(s); if(!isNaN(d)) return d;
  return null;
}
function daysFromToday(d){ if(!d) return Infinity; const t=new Date(); t.setHours(0,0,0,0); const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); return Math.floor((t-x)/86400000); }
function fmtDate(d){ if(!d) return ''; return String(d.getDate()).padStart(2,'0')+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+d.getFullYear(); }
function chooseLatestXlsx(list){
  const onlyXlsx=list.filter(n=>/\.xlsx$/i.test(n));
  if(!onlyXlsx.length) return null;
  const parseTs=(name)=>{
    const m=String(name).match(/Sinottico-(\d{4})-(\d{2})-(\d{2})(?:-(\d{2}):?(\d{2}))?\.xlsx$/i);
    if(!m) return 0; const [,_Y,_M,_D,_h='00',_m='00']=m; return new Date(+_Y,+_M-1,+_D,+_h,+_m,0).getTime();
  };
  onlyXlsx.sort((a,b)=>(parseTs(a)||0)-(parseTs(b)||0));
  return onlyXlsx[onlyXlsx.length-1];
}
function normalizeSede(s){return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').replace(/[^\w\s\-&']/g,'').trim().toUpperCase();}
function populateEsattoriSelect(list){
  const sel=$('#selEs'); sel.innerHTML='<option value="">‚Äî Tutti ‚Äî</option>'+list.map(e=>`<option value="${e}">${e}</option>`).join('');
}
function renderTable(rows){
  const tb=$('#tbl tbody'); tb.innerHTML='';
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.ESATTORE||'‚Äî'}</td><td>${r.SEDE||''}</td><td>${r.CODEID||''}</td><td>${r.MODELLO||''}</td><td>${r.PDA||''}</td><td class="days">${r.GIORNI}</td><td>${r.COMUNE||''}</td>`;
    tb.appendChild(tr);
  }
  $('#tblWrap').style.display='block';
  $('#pSel').textContent='Selezione: '+rows.length;
}
function filterApply(){
  const N=Number($('#selDays').value||2);
  const es=($('#selEs').value||'').toUpperCase();
  let list=state.active.filter(r=>r.GIORNI>=N);
  if(es) list=list.filter(r=>(r.ESATTORE||'').toUpperCase()===es);
  list.sort((a,b)=>{const d=(a.ESATTORE||'').localeCompare(b.ESATTORE||''); if(d!==0)return d; return (b.GIORNI||0)-(a.GIORNI||0);});
  state.filtered=list;
  renderTable(list);
}

/* ====== IO ====== */
async function getJSON(u){const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(u+' '+r.status); return r.json();}
async function getXLSX(u){
  if(!window.XLSX) throw new Error('XLSX non caricato');
  const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(u+' '+r.status);
  const ab=await r.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'});
  let best=null, rows=[], len=0, heads={};
  for(const n of wb.SheetNames){
    const ws=wb.Sheets[n];
    const arr=XLSX.utils.sheet_to_json(ws,{defval:null});
    if(arr.length>len){ len=arr.length; rows=arr; best=n; }
  }
  const sample = rows.slice(0,20).reduce((s,r)=>{Object.keys(r).forEach(k=>s.add(k));return s;},new Set());
  heads = Array.from(sample);
  return {rows, sheetName:best||wb.SheetNames[0], headers:heads};
}

/* ===== MAIN LOAD ===== */
async function loadAll(){
  clearErr(); $('#loading').style.display='block'; $('#tblWrap').style.display='none'; $('#debug').style.display=$('#toggleDebug').checked?'block':'none'; dbg.textContent='';
  try{
    // XLSX presente?
    if(!window.XLSX){ throw new Error('XLSX non caricato: controlla ./libs/xlsx.full.min.js o la rete'); }

    // 1) manifest
    const manifest=await getJSON('./Dati/manifest.json');
    const list=Array.isArray(manifest.sinottici)?manifest.sinottici:[];
    $('#pManifest').textContent='manifest: '+list.length+' file';
    log('manifest',list);
    const latest=chooseLatestXlsx(list);
    if(!latest) throw new Error('Nessun .xlsx nel manifest. Esporta da Numbers a .xlsx e aggiorna manifest.json');
    state.manifestList=list.filter(n=>/\.xlsx$/i.test(n)); state.latestName=latest;
    $('#pLatest').textContent='ultimo xlsx: '+latest;

    // 2) PDV & ESATTORI
    let pdv; 
    try{ pdv=await getXLSX('./Dati/PDV-e-ESATTORI.xlsx'); }
    catch(e){ log('pdv','errore',String(e)); pdv={rows:[],headers:[]}; }
    $('#pPdv').textContent='PDV righe: '+pdv.rows.length;
    log('pdv headers',pdv.headers);

    const sedeToEs=new Map();
    for(const r of pdv.rows){
      const sede = r['DENOMIN. SEDE'] ?? r['DENOMIN.SEDE'] ?? r['DENOMINAZIONE SEDE'];
      const es   = (r['ESATTORE']??'').toString().trim().toUpperCase();
      if(sede){ sedeToEs.set(normalizeSede(sede), es||'‚Äî'); }
    }
    state.sedeToEs=sedeToEs;

    let esattori = Array.from(new Set(Array.from(sedeToEs.values()).filter(Boolean)));
    try{
      const esjson=await getJSON('./Dati/esattori.json');
      if(Array.isArray(esjson)&&esjson.length){ esattori = Array.from(new Set(esjson.map(x=>String(x).toUpperCase()))); }
    }catch(_){}
    if(!esattori.length){ esattori=['ALESSANDRO','MATTIA','STEPHAN','MATTEO','LUCA','MAGAZZINO']; }
    state.esattori=esattori.sort();
    populateEsattoriSelect(state.esattori);
    log('esattori',state.esattori);

    // 3) SINOTTICO (ultimo)
    const sn = await getXLSX('./Dati/'+latest);
    $('#pRows').textContent='Sinottico righe: '+sn.rows.length;
    log('sinottico sheet',sn.sheetName);
    log('sinottico headers (sample)',sn.headers);

    // 4) COSTRUISCI RIGHE ATTIVE
    const active=[];
    let countAll=0, countAttive=0;
    for(const row of sn.rows){
      countAll++;
      const status = (getField(row,['DESCR. STATO','DESCR.STATO','STATO'])||'').toString().toLowerCase();
      if(!status.includes('attiva')) continue;
      countAttive++;

      const codeid = pickCodeId(row);
      const sede   = getField(row,['DENOMIN. SEDE','DENOMIN.SEDE','DENOMINAZIONE SEDE']);
      const modello= getField(row,'MODELLO');
      const pda    = getField(row,['PDA','COD.PDA','IDPDA']);
      const comune = getField(row,['COMUNE','CITTA','CITT√Ä','LOCALITA']);

      const dUltDT = parseDateITDateTime( getField(row, ['DATA ULTIMA LETTURA VAL.','DATA ULTIMA LETTURA','ULTIMA LETTURA','DATA']) );
      const dUlt   = dUltDT ? new Date(dUltDT.getFullYear(),dUltDT.getMonth(),dUltDT.getDate()) : null;
      const giorni = daysFromToday(dUlt);

      const es = state.sedeToEs.get(normalizeSede(sede)) ?? '‚Äî';

      active.push({ESATTORE:es, SEDE:sede, CODEID:codeid, MODELLO:modello, PDA:pda, GIORNI:giorni, COMUNE:comune, DATA:dUlt});
    }
    state.rows=sn.rows; state.active=active;
    $('#pActive').textContent='Attive: '+countAttive+' / '+countAll;

    // 5) APPLICA FILTRO
    filterApply();

  }catch(e){
    showErr(e.message||String(e));
  }finally{
    $('#loading').style.display='none';
  }
}

/* ===== EXPORT ===== */
function exportXLSX(){
  if(!window.XLSX){ alert('XLSX non disponibile'); return; }
  const headers=['ESATTORE','LOCALE','AWP','MODELLO','PDA','GIORNI','COMUNE'];
  const data=state.filtered.map(r=>[r.ESATTORE||'',r.SEDE||'',r.CODEID||'',r.MODELLO||'',r.PDA||'',isFinite(r.GIORNI)?r.GIORNI:'',r.COMUNE||'']);
  const ws=XLSX.utils.aoa_to_sheet([headers,...data]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Letture');
  XLSX.writeFile(wb,'Letture.xlsx');
}
function exportTXT(){
  const lines=state.filtered.map(r=>`${r.SEDE} - ${r.MODELLO||r.CODEID}${r.GIORNI>3?` _${fmtDate(r.DATA)}_`:''}`);
  const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Letture.txt'; a.click(); URL.revokeObjectURL(a.href);
}
function openWA(){
  const text = state.filtered.map(r=>`${r.SEDE} - ${r.MODELLO||r.CODEID}${r.GIORNI>3?` _${fmtDate(r.DATA)}_`:''}`).join('\n\n');
  const url='https://wa.me/?text='+encodeURIComponent(text||'');
  window.open(url,'_blank');
}

/* ===== UI ===== */
$('#btnRefresh').onclick=loadAll;
$('#btnApply').onclick=filterApply;
$('#btnXlsx').onclick=exportXLSX;
$('#btnTxt').onclick=exportTXT;
$('#btnWA').onclick=openWA;
$('#toggleDebug').onchange=()=>{$('#debug').style.display=$('#toggleDebug').checked?'block':'none';};

window.addEventListener('load',loadAll);
</script>
</body>
</html>
