<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AWP Manager ‚Äî Letture</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f7fa; --fg:#1b1b1b; --muted:#5d6b7a; --card:#ffffff; --border:#dfe3ea;
  --acc:#007bff; --ok:#2ea043; --warn:#f59e0b; --bad:#ef4444;
  --table-head:#eef2f7; --shadow:0 10px 26px rgba(0,0,0,.08);
}
body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
body.theme-light{}
body.theme-dark{ --bg:#121417; --fg:#e4e7ec; --muted:#9aa3af; --card:#181b20; --border:#2a2f36; --acc:#3399ff; --table-head:#1c2128; --shadow:0 10px 30px rgba(0,0,0,.35) }
body.theme-blue{ --bg:#e9f5ff; --fg:#002b4d; --muted:#335d7a; --card:#ffffff; --border:#cfe6fb; --acc:#0066cc; --table-head:#d9eeff; --shadow:0 12px 28px rgba(0,80,160,.15) }
body.theme-contrast{ --bg:#000; --fg:#ff0; --muted:#ffe766; --card:#0b0b0b; --border:#333; --acc:#ff3333; --table-head:#111; --shadow:0 10px 26px rgba(255,255,0,.12) }

.navbar{position:sticky;top:0;z-index:30;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--fg)}
.brand img{height:28px}
.navlinks a{color:var(--fg);text-decoration:none;margin:0 8px;padding:6px 10px;border-radius:8px}
.navlinks a[aria-current="page"]{font-weight:700;text-decoration:underline}
.right{display:flex;align-items:center;gap:8px}
select,button,input{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600}
button.primary{background:var(--acc);color:#fff;border-color:var(--acc)}

main{padding:18px;max-width:1280px;margin:0 auto}
.grid{display:grid;grid-template-columns:1.3fr .7fr;gap:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-bottom:14px}
.card h3{margin:0 0 12px;font-size:16px}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.pill{display:inline-block;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:var(--card);margin-right:6px;font-size:12px;color:var(--muted)}

.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.stat .label{color:var(--muted);font-size:12px}
.stat .value{font-size:20px;font-weight:800}
.stat.ok .value{color:var(--ok)}
.stat.warn .value{color:var(--warn)}
.stat.bad .value{color:var(--bad)}
.flash{animation:flash 1.2s ease-in-out 1}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(46,160,67,.5)}60%{box-shadow:0 0 0 12px rgba(46,160,67,0)}100%{box-shadow:none}}

table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid var(--border)}
th{background:var(--table-head);text-align:left}
tr:hover td{background:rgba(0,0,0,.03)}
td.bad{color:var(--bad);font-weight:700}
tr.clickable{cursor:pointer}

.meta{margin-top:6px;font-size:12px;color:var(--muted)}

#loader{position:fixed;inset:0;background:rgba(0,0,0,.08);display:none;align-items:center;justify-content:center;z-index:40}
.spinner{width:54px;height:54px;border-radius:50%;border:5px solid rgba(0,0,0,.15);border-top-color:var(--acc);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#errorBox{max-width:1280px;margin:10px auto 0;background:#ffecec;border:1px solid #ffb3b3;color:#7a0000;padding:10px 14px;border-radius:10px;display:none}
footer{padding:14px;text-align:center;color:var(--muted)}

/* Modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:min(900px,92vw);max-height:86vh;overflow:auto;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}
.modal h3{margin:0 0 6px}
.modal .muted{color:var(--muted);font-size:12px;margin-bottom:8px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;margin:10px 0}
.kv b{font-weight:700}
.tag{display:inline-block;border:1px solid var(--border);padding:4px 8px;border-radius:999px;margin-right:6px;margin-bottom:6px}
.timeline{border-left:3px solid var(--border);margin-left:8px;padding-left:12px}
.tl-item{margin:10px 0}
.tl-item .when{font-weight:700}
.tl-item .meta{font-size:12px;color:var(--muted)}
</style>
</head>
<body class="theme-light">
  <div class="navbar">
    <a class="brand" href="./dashboard.html"><img src="./logo-awp.svg" alt="AWP"><strong>AWP Manager</strong></a>
    <nav class="navlinks">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./letture.html" aria-current="page">Letture</a>
      <a href="./manutenzione.html">Manutenzione</a>
      <a href="./anagrafica.html">Anagrafica</a>
    </nav>
    <div class="right">
      <label for="themeSel" style="font-size:13px;color:var(--muted)">Tema</label>
      <select id="themeSel">
        <option value="theme-light">‚òÄÔ∏è Chiaro AWP</option>
        <option value="theme-dark">üåô Scuro AWP</option>
        <option value="theme-blue">üå§Ô∏è Azzurro AWP</option>
        <option value="theme-contrast">‚ö´ Alto Contrasto</option>
      </select>
      <button id="btnRefresh" class="primary">üîÑ Aggiorna</button>
    </div>
  </div>

  <div id="errorBox"></div>

  <main>
    <div class="card">
      <h3>Filtri</h3>
      <div class="controls">
        <label>Esattore:
          <select id="selEsattore"><option value="">‚Äî Tutti ‚Äî</option></select>
        </label>
        <label>Giorni arretrati:
          <select id="selDays">
            <option value="1">1 (ieri)</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="7">7</option>
            <option value="10">10</option>
            <option value="custom">Personalizzato‚Ä¶</option>
          </select>
        </label>
        <input type="number" id="daysCustom" min="1" step="1" placeholder="giorni" style="width:100px;display:none">
        <label style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="chkCompact" checked>
          <span>Compatta (max 4 modelli/locale)</span>
        </label>
        <button id="btnApply" class="primary">Applica</button>
        <button id="btnDownload">‚¨áÔ∏è XLSX</button>
        <button id="btnDownloadTxt">‚¨áÔ∏è TXT</button>
        <button id="btnWhatsapp">üü¢ WhatsApp</button>
        <span class="pill" id="pillSin">Sinottico: ‚Äî</span>
        <span class="pill" id="pillFoglio">Foglio: ‚Äî</span>
        <span class="pill" id="pillCount">Selezione: ‚Äî</span>
      </div>
      <div class="meta">
        Mostra solo righe con <strong>DESCR. STATO = "Attiva"</strong> e <strong>mancata lettura ‚â•</strong> <strong id="metaDays">2</strong> giorni. Join su <strong>DENOMIN. SEDE</strong>.
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Macchine da leggere</h3>
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th class="col-es">ESATTORE</th>
                <th>LOCALE</th>
                <th>AWP</th>
                <th>MODELLO</th>
                <th>PDA</th>
                <th>GIORNI</th>
                <th>COMUNE</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="meta">Clicca una riga per aprire la scheda con storico e dettagli.</div>
      </div>

      <div class="card">
        <h3>Statistiche</h3>
        <div class="stats">
          <div class="stat"><div class="label">Totale attive</div><div class="value" id="stTot">‚Äî</div></div>
          <div class="stat bad"><div class="label">Da leggere (‚â•N)</div><div class="value" id="stArretr">‚Äî</div></div>
          <div class="stat ok" id="stOkBox"><div class="label">In regola (&lt; N)</div><div class="value" id="stOk">‚Äî</div></div>
          <div class="stat warn"><div class="label">Media giorni</div><div class="value" id="stAvg">‚Äî</div></div>
          <div class="stat"><div class="label">Max giorni</div><div class="value" id="stMax">‚Äî</div></div>
        </div>
        <div class="meta" id="stEsMeta" style="margin-top:8px"></div>
      </div>
    </div>
  </main>

  <footer>¬© <span id="year"></span> AWP Manager ‚Äî Letture</footer>

  <div id="loader"><div class="spinner"></div></div>

  <!-- MODAL -->
  <div class="modal-back" id="mb">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="mTitle">AWP</h3>
        <button id="mClose">‚úñ</button>
      </div>
      <div class="muted" id="mSubtitle">‚Äî</div>
      <div class="kv" id="mKV"></div>
      <div class="flex" style="gap:8px;margin:8px 0 14px">
        <span class="tag" id="mTagEs">ESATTORE</span>
        <span class="tag" id="mTagSede">SEDE</span>
        <span class="tag" id="mTagComune">COMUNE</span>
      </div>
      <h3>Storico letture</h3>
      <div class="timeline" id="mTL"><div class="tl-item">Caricamento storico‚Ä¶</div></div>
      <div class="flex" style="margin-top:10px">
        <button id="mCsv">‚¨áÔ∏è Esporta CSV</button>
        <button id="mTxt">‚¨áÔ∏è Esporta TXT</button>
        <button id="mWA">üü¢ WhatsApp (locale)</button>
      </div>
    </div>
  </div>

  <!-- XLSX -->
  <script>
  (function(){
    const urls=['./libs/xlsx.full.min.js','https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js','https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js','https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'];
    function loadOne(u){return new Promise((ok,ko)=>{const s=document.createElement('script');s.src=u;s.onload=ok;s.onerror=ko;document.head.appendChild(s);});}
    (async()=>{for(const u of urls){try{await loadOne(u);if(window.XLSX)break;}catch(_){}} if(!window.XLSX) alert('Impossibile caricare la libreria XLSX');})();
  })();
  </script>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const byId=id=>document.getElementById(id);
  const loader=byId('loader'); const errBox=byId('errorBox');

  /* THEME */
  function applyTheme(t){ document.body.className=t; }
  function initTheme(){ const t=localStorage.getItem('awp_theme')||'theme-light'; applyTheme(t); $('#themeSel').value=t; }
  $('#themeSel').addEventListener('change',e=>{ applyTheme(e.target.value); localStorage.setItem('awp_theme',e.target.value); });

  /* HELPERS */
  function showLoader(v){ loader.style.display=v?'flex':'none'; }
  function showError(msg){ errBox.textContent=msg; errBox.style.display='block'; alert(msg); }
  function normalizeSede(s){return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').replace(/[^\w\s\-&']/g,'').trim().toUpperCase();}
  function pick(row, names){ for(const n of names){ if(row[n]!=null && row[n]!=='' ) return row[n]; } return ''; }
  function pickCodeId(row){ const ks=Object.keys(row); const f=k=>k&&String(k).toUpperCase().replace(/[^A-Z0-9]/g,'');
    let k=ks.find(k=>f(k)==='CODEID'); if(k) return String(row[k]??'').trim();
    k=ks.find(k=>/COD(ICE)?ID/i.test(k)); if(k) return String(row[k]??'').trim();
    k=ks.find(k=>/(SERIALE|MATRICOLA|AWP)/i.test(k)); return k?String(row[k]??'').trim():'';
  }
  function parseDateIT(v){
    if(v==null||v==='')return null;
    if(typeof v==='number'||/^[0-9]+$/.test(String(v).trim())){
      const n=Number(v); if(n>0&&n<2958465){const base=new Date(Date.UTC(1899,11,30));const d=new Date(base.getTime()+n*86400000);return new Date(d.getFullYear(),d.getMonth(),d.getDate());}
    }
    const s=String(v).trim().replace(/[\/\.]/g,'-'); const m=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})(?:[ T]\d{1,2}:\d{2}(?::\d{2})?)?$/);
    if(m){const[,gg,mm,yyyy]=m;return new Date(+yyyy,+mm-1,+gg);} const d=new Date(s); if(!isNaN(d)) return new Date(d.getFullYear(),d.getMonth(),d.getDate()); return null;
  }
  function daysDiffFromToday(d){ if(!d) return Infinity; const t=new Date(); t.setHours(0,0,0,0); const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); return Math.floor((t-x)/86400000); }
  function fmtDate(d){ if(!d) return ''; const g=String(d.getDate()).padStart(2,'0'); const m=String(d.getMonth()+1).padStart(2,'0'); return `${g}-${m}-${d.getFullYear()}`; }
  function pickPDA(r){ return pick(r,['PDA','COD.PDA','ID PDA','IDPDA','COD_PDA']); }
  function pickComune(r){ return pick(r,['COMUNE','CITTA','LOCALITA',"CITT√Ä"]); }
  function pickModello(r){ return pick(r,['MODELLO','MOD','MODEL','MODEL NAME']); }

  async function fetchJSON(u,label){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(`Caricamento ${label||u} fallito (${r.status})`); return r.json(); }
  async function fetchXLSX_largest(u,label){
    const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(`Caricamento ${label||u} fallito (${r.status})`);
    const ab=await r.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'});
    let best=null,rows=[],len=0; for(const n of wb.SheetNames){ const ws=wb.Sheets[n]; const arr=XLSX.utils.sheet_to_json(ws,{defval:null}); if(arr.length>len){len=arr.length;rows=arr;best=n;} }
    return {rows, sheetName:best||wb.SheetNames[0]};
  }

  /* STATE */
  let latestName=''; let rowsActive=[]; let sedeToEs=new Map(); let esattori=[];
  let manifestList=[]; // per storico
  const historyCache=new Map(); // CODEID -> array storico

  function readDaysSelection(){ const sel=$('#selDays').value; if(sel==='custom'){const n=parseInt($('#daysCustom').value,10); return isFinite(n)&&n>0?n:2;} return parseInt(sel,10); }

  function buildFilteredList(){
    const maxDays=readDaysSelection(); $('#metaDays').textContent=maxDays;
    let list = rowsActive.filter(r => r.GIORNI >= maxDays);
    const selEs = ($('#selEsattore').value||'').toUpperCase();
    if(selEs){
      list = list.filter(r => (r.ESATTORE||'‚Äî').toUpperCase()===selEs);
      document.querySelectorAll('.col-es').forEach(th=>th.style.display='none');
    }else{
      document.querySelectorAll('.col-es').forEach(th=>th.style.display='table-cell');
    }
    list.sort((a,b)=>{ if(!selEs){const d=(a.ESATTORE||'').localeCompare(b.ESATTORE||''); if(d!==0) return d;} return (isFinite(b.GIORNI)?b.GIORNI:-1)-(isFinite(a.GIORNI)?a.GIORNI:-1); });
    return list;
  }

  function updateStats(list){
    const N = readDaysSelection();
    const tot = rowsActive.length;
    const arretr = list.length;
    const ok = Math.max(tot - arretr, 0);
    const avg = rowsActive.length ? (rowsActive.reduce((s,r)=>s+(isFinite(r.GIORNI)?r.GIORNI:0),0)/rowsActive.length) : 0;
    const max = rowsActive.length ? Math.max(...rowsActive.map(r=>isFinite(r.GIORNI)?r.GIORNI:0)) : 0;

    $('#stTot').textContent = tot.toLocaleString('it-IT');
    $('#stArretr').textContent = arretr.toLocaleString('it-IT');
    $('#stOk').textContent = ok.toLocaleString('it-IT');
    $('#stAvg').textContent = isFinite(avg)?avg.toFixed(1):'‚Äî';
    $('#stMax').textContent = isFinite(max)?max:'‚Äî';

    // piccolo ‚Äúflash‚Äù verde quando aumentano gli "in regola"
    const box = $('#stOkBox');
    box.classList.remove('flash');
    void box.offsetWidth; // reflow
    if(ok>0) box.classList.add('flash');

    // meta per esattore
    const esSel = ($('#selEsattore').value||'').toUpperCase();
    if(esSel){
      const mineAll = rowsActive.filter(r=> (r.ESATTORE||'‚Äî').toUpperCase()===esSel);
      const mineAr  = list.filter(r=> (r.ESATTORE||'‚Äî').toUpperCase()===esSel);
      const mineOk  = Math.max(mineAll.length - mineAr.length,0);
      $('#stEsMeta').textContent = `Esattore ${esSel}: attive ${mineAll.length}, da leggere ${mineAr.length} (‚â•${N}), in regola ${mineOk}.`;
    }else{
      $('#stEsMeta').textContent = '‚Äî';
    }
  }

  function renderTable(list){
    const tb=$('#tbl tbody'); tb.innerHTML='';
    for(const r of list){
      const tr=document.createElement('tr'); tr.className='clickable';
      tr.dataset.codeid=r.CODEID; tr.dataset.sede=r.SEDE||''; tr.dataset.esattore=r.ESATTORE||'';
      tr.innerHTML=`<td class="col-es">${r.ESATTORE||'‚Äî'}</td>
        <td>${r.SEDE||''}</td><td>${r.CODEID||''}</td>
        <td>${r.MODELLO||''}</td><td>${r.PDA||''}</td>
        <td class="bad">${isFinite(r.GIORNI)?r.GIORNI:'‚Äî'}</td><td>${r.COMUNE||''}</td>`;
      if($('#selEsattore').value) tr.children[0].style.display='none';
      tr.addEventListener('click', ()=>openModal(r.CODEID, r));
      tb.appendChild(tr);
    }
    $('#pillCount').textContent = `Selezione: ${list.length.toLocaleString('it-IT')} macchine`;
    updateStats(list);
  }

  function downloadXLSX(list){
    const headers=['ESATTORE','LOCALE','AWP','MODELLO','PDA','GIORNI','COMUNE'];
    const data=list.map(r=>[r.ESATTORE||'',r.SEDE||'',r.CODEID||'',r.MODELLO||'',r.PDA||'',isFinite(r.GIORNI)?r.GIORNI:'',r.COMUNE||'']);
    const ws=XLSX.utils.aoa_to_sheet([headers, ...data]); const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Letture'); const es=$('#selEsattore').value||'TUTTI'; const d=readDaysSelection();
    XLSX.writeFile(wb,`Letture-${es}-${d}gg.xlsx`);
  }

  /* ===== WHATSAPP / TXT ===== */
  function buildGroupingMaps(allActiveRows, eligibleList){
    const activeCountBySede=new Map();
    for(const r of allActiveRows){
      const key=(r.ESATTORE||'‚Äî').toUpperCase()+'||'+(r.SEDE||'').toUpperCase();
      activeCountBySede.set(key,(activeCountBySede.get(key)||0)+1);
    }
    const eligibleBySede=new Map();
    for(const r of eligibleList){
      const esKey=(r.ESATTORE||'‚Äî').toUpperCase(); const key=esKey+'||'+(r.SEDE||'').toUpperCase();
      if(!eligibleBySede.has(key)) eligibleBySede.set(key,{esattore:esKey,sede:r.SEDE||'',models:new Set(),items:[]});
      const e=eligibleBySede.get(key); e.items.push(r);
      const name=(r.MODELLO&&String(r.MODELLO).trim())?String(r.MODELLO).trim():(r.CODEID||''); if(name) e.models.add(name);
    }
    return {activeCountBySede,eligibleBySede};
  }

  function generateWhatsappText(allActiveRows, eligibleList){
    const selEs=($('#selEsattore').value||'').toUpperCase(); const compact=$('#chkCompact').checked;
    const {activeCountBySede,eligibleBySede}=buildGroupingMaps(allActiveRows,eligibleList);
    const byEs=new Map();

    for(const [key,info] of eligibleBySede.entries()){
      const [esKey]=key.split('||'); const activeTot=activeCountBySede.get(key)||0; const eligTot=info.items.length; if(eligTot===0) continue;
      let italicDate=''; const maxG=Math.max(...info.items.map(x=>isFinite(x.GIORNI)?x.GIORNI:0));
      if(maxG>3){ let latest=null; for(const it of info.items){ if(it.DATA && (!latest||it.DATA>latest)) latest=it.DATA; } if(latest) italicDate=` _${fmtDate(latest)}_`; }
      let line;
      if(activeTot>0 && eligTot===activeTot){ line=`${info.sede} - PDA${italicDate}`; }
      else{ let models=Array.from(info.models); if(compact && models.length>4){ const extra=models.length-4; models=models.slice(0,4); models.push(`+${extra}`);} line=`${info.sede} - ${models.join(', ')}${italicDate}`; }
      if(!byEs.has(esKey)) byEs.set(esKey,[]); byEs.get(esKey).push(line);
    }
    for(const [k,a] of byEs) a.sort((x,y)=>x.localeCompare(y,'it',{sensitivity:'base'}));

    const blocks=[]; 
    if(selEs){ const lines=byEs.get(selEs)||[]; const header=`*${selEs}*`; blocks.push(header+'\n'); blocks.push(lines.length?lines.join('\n\n'):'Nessun locale con letture arretrate.'); }
    else{ const keys=[...byEs.keys()].sort(); if(!keys.length) return 'Nessun locale con letture arretrate.'; for(const k of keys){ const lines=byEs.get(k)||[]; if(!lines.length) continue; blocks.push(`*${k}*`+'\n'); blocks.push(lines.join('\n\n')); blocks.push(''); } if(blocks[blocks.length-1]==='') blocks.pop(); }
    return blocks.join('\n');
  }

  function downloadTXT(list){
    const text=generateWhatsappText(rowsActive,list);
    const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); const es=$('#selEsattore').value||'TUTTI'; const d=readDaysSelection();
    a.href=url; a.download=`Letture-${es}-${d}gg.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  async function sendWhatsapp(list){
    const text=generateWhatsappText(rowsActive,list); const url='https://wa.me/?text='+encodeURIComponent(text);
    if(url.length>2000){ try{ await navigator.clipboard.writeText(text); alert('Testo copiato negli appunti. Incollalo in WhatsApp.'); }catch(_){ const w=window.open('','_blank'); if(w){w.document.write('<pre style="white-space:pre-wrap;font-family:monospace">'+text.replace(/</g,'&lt;')+'</pre>');}} return;}
    window.open(url,'_blank');
  }

  /* ===== MODAL & STORICO ===== */
  function openModal(codeid, row){
    $('#mTitle').textContent = row.CODEID;
    $('#mSubtitle').textContent = (row.MODELLO||'') + (row.PDA?` ‚Ä¢ PDA ${row.PDA}`:'') + (row.DATA?` ‚Ä¢ Ultima: ${fmtDate(row.DATA)}`:'');
    const kv=$('#mKV'); kv.innerHTML='';
    kv.insertAdjacentHTML('beforeend', `<b>Esattore</b><span>${row.ESATTORE||'‚Äî'}</span>`);
    kv.insertAdjacentHTML('beforeend', `<b>Locale</b><span>${row.SEDE||''}</span>`);
    kv.insertAdjacentHTML('beforeend', `<b>Comune</b><span>${row.COMUNE||''}</span>`);
    kv.insertAdjacentHTML('beforeend', `<b>Giorni</b><span>${isFinite(row.GIORNI)?row.GIORNI:'‚Äî'}</span>`);
    kv.insertAdjacentHTML('beforeend', `<b>Stato</b><span>${row.STATO||'Attiva'}</span>`);

    $('#mTagEs').textContent = row.ESATTORE||'‚Äî';
    $('#mTagSede').textContent = row.SEDE||'';
    $('#mTagComune').textContent = row.COMUNE||'';

    $('#mb').style.display='flex';
    const tl=$('#mTL'); tl.innerHTML='<div class="tl-item">Carico storico‚Ä¶</div>';

    loadHistoryFor(codeid, row).then(hist=>{
      if(!hist.length){ tl.innerHTML='<div class="tl-item">Nessun dato storico disponibile.</div>'; return; }
      hist.sort((a,b)=>a.date-b.date);
      tl.innerHTML = hist.map(h=>(
        `<div class="tl-item">
          <div class="when">${fmtDate(h.date)}</div>
          <div class="meta">${h.status||''} ‚Ä¢ ${h.model||''} ${h.pda?('‚Ä¢ PDA '+h.pda):''} ‚Ä¢ ${h.sede||''}</div>
        </div>`
      )).join('');
      // pulsanti export/whatsapp locale
      $('#mCsv').onclick=()=>exportHistoryCSV(codeid, row, hist);
      $('#mTxt').onclick=()=>exportHistoryTXT(codeid, row, hist);
      $('#mWA').onclick=()=>waLocale(row, hist);
    }).catch(e=>{
      tl.innerHTML='<div class="tl-item">Errore nel caricamento storico.</div>';
      console.error(e);
    });
  }
  $('#mClose').addEventListener('click',()=>$('#mb').style.display='none');
  $('#mb').addEventListener('click',e=>{ if(e.target.id==='mb') $('#mb').style.display='none'; });

  async function loadHistoryFor(codeid, baseRow){
    if(historyCache.has(codeid)) return historyCache.get(codeid);
    const hist=[];
    for(const name of manifestList){ // in ordine cronologico
      try{
        const sn=await fetchXLSX_largest('./Dati/'+name, name);
        for(const row of sn.rows){
          const cid=pickCodeId(row); if(!cid || cid!==codeid) continue;
          const status = String(pick(row,['DESCR. STATO','DESCR.STATO','STATO'])||'').trim();
          // storicizziamo SOLO ATTIVA come richiesto in pagina, ma nello storico mostriamo lo status reale
          const date  = parseDateIT(pick(row,['DATA ULTIMA LETTURA VAL.','DATA ULTIMA LETTURA','ULTIMA LETTURA','DATA']));
          const pda   = pickPDA(row);
          const model = pickModello(row);
          const sede  = pick(row,['DENOMIN. SEDE','DENOMIN.SEDE','DENOMINAZIONE SEDE']);
          if(date) hist.push({date, status, pda, model, sede});
          break; // trovato nel foglio corrente
        }
      }catch(e){ console.warn('Storico: errore su', name, e); }
    }
    historyCache.set(codeid, hist);
    return hist;
  }

  function exportHistoryCSV(codeid, row, hist){
    const header = ['DATA','STATO','MODELLO','PDA','SEDE'];
    const data = hist.map(h=>[fmtDate(h.date), h.status||'', h.model||'', h.pda||'', h.sede||'']);
    const csv = [header.join(';')].concat(data.map(r=>r.join(';'))).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`Storico-${codeid}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function exportHistoryTXT(codeid, row, hist){
    const lines = hist.map(h=>`‚Ä¢ ${fmtDate(h.date)} ‚Äî ${h.status||''} ‚Äî ${h.model||''} ${h.pda?('‚Äî PDA '+h.pda):''} ‚Äî ${h.sede||''}`);
    const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`Storico-${codeid}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function waLocale(row, hist){
    const lines = [`*${row.SEDE||''}*`, `${row.CODEID} ‚Äî ${row.MODELLO||''} ${row.PDA?('‚Äî PDA '+row.PDA):''}`, ''];
    lines.push(...hist.slice(-5).map(h=>`‚Ä¢ ${fmtDate(h.date)} ‚Äî ${h.status||''}`)); // ultimi 5 eventi
    const text = lines.join('\n');
    const url = 'https://wa.me/?text=' + encodeURIComponent(text);
    if(url.length>2000){ navigator.clipboard.writeText(text).then(()=>alert('Testo copiato negli appunti.')); return; }
    window.open(url,'_blank');
  }

  /* ===== LOAD ===== */
  async function loadAll(){
    showLoader(true); errBox.style.display='none';
    try{
      const manifest=await fetchJSON('./Dati/manifest.json','manifest.json');
      if(!manifest.sinottici||!manifest.sinottici.length) throw new Error('manifest.json: lista sinottici vuota');
      manifestList = manifest.sinottici.slice(); // ordine cronologico
      latestName = manifestList[manifestList.length-1];
      $('#pillSin').textContent='Sinottico: '+latestName;

      try{ esattori=await fetchJSON('./Dati/esattori.json','esattori.json'); }catch(_){ esattori=[]; }
      $('#selEsattore').innerHTML='<option value="">‚Äî Tutti ‚Äî</option>'+esattori.map(e=>`<option value="${String(e).toUpperCase()}">${String(e).toUpperCase()}</option>`).join('');

      const pdv=await fetchXLSX_largest('./Dati/PDV-e-ESATTORI.xlsx','PDV-e-ESATTORI.xlsx'); 
      sedeToEs=new Map();
      for(const r of pdv.rows){ const sede=normalizeSede(r['DENOMIN. SEDE']); const es=(r['ESATTORE']??'').toString().trim().toUpperCase()||'‚Äî'; if(sede) sedeToEs.set(sede,es); }

      const sn=await fetchXLSX_largest('./Dati/'+latestName,latestName); $('#pillFoglio').textContent='Foglio: '+sn.sheetName;

      // SOLO "Attiva" dalla colonna DESCR. STATO (o DESCR.STATO)
      const byCode=new Map();
      for(const row of sn.rows){
        const codeid=pickCodeId(row); if(!codeid) continue;
        const descr = (pick(row,['DESCR. STATO','DESCR.STATO']) || '').toString().trim().toLowerCase();
        if (descr.replace(/\s+/g,'') !== 'attiva') continue; // solo Attiva
        const sede   = pick(row,['DENOMIN. SEDE','DENOMIN.SEDE','DENOMINAZIONE SEDE']);
        const data   = parseDateIT( pick(row,['DATA ULTIMA LETTURA VAL.','DATA ULTIMA LETTURA','ULTIMA LETTURA','DATA']) );
        const comune = pickComune(row);
        const pda    = pickPDA(row);
        const modello= pickModello(row);
        const prev=byCode.get(codeid);
        if(!prev || (data && prev.data && data>prev.data) || (!prev?.data && data)){
          byCode.set(codeid,{codeid,sede,descrStato:'Attiva',data,comune,pda,modello});
        }
      }

      const all=[];
      for(const {codeid,sede,data,comune,pda,modello} of byCode.values()){
        const es = sedeToEs.get(normalizeSede(sede)) ?? '‚Äî';
        const giorni = daysDiffFromToday(data);
        all.push({ CODEID:codeid, SEDE:sede, ESATTORE:es, STATO:'Attiva', DATA:data, GIORNI:giorni, COMUNE:comune, PDA:pda, MODELLO:modello });
      }
      rowsActive=all;

      renderTable( buildFilteredList() );

    }catch(e){ showError(e.message||'Errore sconosciuto'); }
    finally{ showLoader(false); }
  }

  /* UI */
  $('#selDays').addEventListener('change',e=>{ $('#daysCustom').style.display=(e.target.value==='custom')?'inline-block':'none'; });
  $('#btnApply').addEventListener('click',()=>{ renderTable(buildFilteredList()); });
  $('#btnDownload').addEventListener('click',()=>{ downloadXLSX(buildFilteredList()); });
  $('#btnDownloadTxt').addEventListener('click',()=>{ downloadTXT(buildFilteredList()); });
  $('#btnWhatsapp').addEventListener('click',async()=>{ await sendWhatsapp(buildFilteredList()); });
  $('#btnRefresh').addEventListener('click',loadAll);

  window.addEventListener('load',()=>{
    byId('year').textContent=new Date().getFullYear();
    const t=localStorage.getItem('awp_theme')||'theme-light';
    document.body.className=t; $('#themeSel').value=t;
    loadAll();
  });
})();
</script>
</body>
</html>
