<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AWP Manager ‚Äî Letture</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f7fa;--fg:#1b1b1b;--muted:#5d6b7a;--card:#fff;--border:#dfe3ea;--acc:#007bff;--ok:#2ea043;--bad:#ef4444;--table-head:#eef2f7;--shadow:0 8px 22px rgba(0,0,0,.06)}
body.theme-light{} body.theme-dark{--bg:#121417;--fg:#e4e7ec;--muted:#9aa3af;--card:#181b20;--border:#2a2f36;--acc:#3399ff;--table-head:#1c2128;--shadow:0 10px 30px rgba(0,0,0,.35)}
body.theme-blue{--bg:#e9f5ff;--fg:#002b4d;--muted:#335d7a;--card:#fff;--border:#cfe6fb;--acc:#0066cc;--table-head:#d9eeff;--shadow:0 12px 28px rgba(0,80,160,.15)}
body.theme-contrast{--bg:#000;--fg:#ff0;--muted:#ffe766;--card:#0b0b0b;--border:#333;--acc:#ff3333;--table-head:#111;--shadow:0 10px 26px rgba(255,255,0,.12)}
html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.navbar{position:sticky;top:0;z-index:30;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--fg)} .brand img{height:28px}
.navlinks a{color:var(--fg);text-decoration:none;margin:0 8px;padding:6px 10px;border-radius:8px}
.navlinks a[aria-current="page"]{font-weight:700;text-decoration:underline}
.right{display:flex;align-items:center;gap:8px}
select,button,input{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600}
button.primary{background:var(--acc);color:#fff;border-color:var(--acc)}
main{padding:18px;max-width:1200px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-bottom:14px}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.pill{display:inline-block;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:var(--card);margin-right:6px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid var(--border)}
th{background:var(--table-head);text-align:left}
tr:hover td{background:rgba(0,0,0,.03)}
.meta{font-size:12px;color:var(--muted);margin-top:6px}
#loader{position:fixed;inset:0;background:rgba(0,0,0,.08);display:none;align-items:center;justify-content:center;z-index:40}
.spinner{width:54px;height:54px;border-radius:50%;border:5px solid rgba(0,0,0,.15);border-top-color:var(--acc);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="navbar">
    <a class="brand" href="./dashboard.html"><img src="./logo-awp.svg" alt="AWP"><strong>AWP Manager</strong></a>
    <nav class="navlinks">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./letture.html" aria-current="page">Letture</a>
      <a href="./manutenzione.html">Manutenzione</a>
      <a href="./anagrafica.html">Anagrafica</a>
    </nav>
    <div class="right">
      <label for="themeSel" style="font-size:13px;color:var(--muted)">Tema</label>
      <select id="themeSel">
        <option value="theme-light">‚òÄÔ∏è Chiaro AWP</option>
        <option value="theme-dark">üåô Scuro AWP</option>
        <option value="theme-blue">üå§Ô∏è Azzurro AWP</option>
        <option value="theme-contrast">‚ö´ Alto Contrasto</option>
      </select>
      <button id="btnRefresh" class="primary">üîÑ Aggiorna</button>
    </div>
  </div>

  <main>
    <div class="card">
      <div class="controls">
        <label>Esattore:
          <select id="selEsattore">
            <option value="">Tutti</option>
          </select>
        </label>
        <label>Giorni arretrati:
          <input id="days" type="number" min="0" value="1" style="width:90px">
        </label>
        <button id="btnExport" class="primary">‚¨áÔ∏è Scarica lista</button>
        <span class="pill" id="metaSinottico">Sinottico: ‚Äî</span>
        <span class="pill" id="metaFoglio">Foglio: ‚Äî</span>
        <span class="pill" id="metaCount">Righe: ‚Äî</span>
      </div>
      <div class="meta">Nella lista **NON** compaiono PDV con ‚Äú724 in corso‚Äù o ‚ÄúBlocco Amministrativo‚Äù. Ordinata per esattore e poi per data (pi√π vecchie prima).</div>
    </div>

    <div class="card" style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>ESATTORE</th>
            <th>LOCALE</th>
            <th>AWP</th>
            <th>PDA</th>
            <th>GIORNI</th>
            <th>COMUNE</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="meta" id="note">‚Äî</div>
    </div>
  </main>

  <footer style="padding:14px;text-align:center">¬© <span id="year"></span> AWP Manager ‚Äî Letture</footer>
  <div id="loader"><div class="spinner" aria-label="Caricamento"></div></div>

<script>
(function(){
  // ---- loader librerie (locale -> CDN) ----
  const urls={ xlsx:['./libs/xlsx.full.min.js','https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js','https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js','https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'],
               chart:['./libs/chart.umd.min.js','https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js']};
  function loadOne(u){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=u;s.async=false;s.onload=()=>res(u);s.onerror=()=>rej(new Error(u));document.head.appendChild(s);});}
  async function loadWithFallback(list,test){for(const u of list){try{await loadOne(u);if(test())return u;}catch(e){}}throw new Error(list[0]);}
  function showLoader(v){document.getElementById('loader').style.display=v?'flex':'none';}

  // ---- tema ----
  function applyTheme(t){document.body.className=t;}
  function initTheme(){const t=localStorage.getItem('awp_theme')||'theme-light';applyTheme(t);document.getElementById('themeSel').value=t;}
  document.getElementById('themeSel').addEventListener('change',e=>{applyTheme(e.target.value);localStorage.setItem('awp_theme',e.target.value);});

  // ---- util ----
  async function fetchJSON(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error('Errore: '+u);return r.json();}
  async function fetchXLSX_largest(u){
    const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error('Errore: '+u);
    const ab=await r.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'});
    let bestName=null, bestRows=[], bestLen=0;
    for(const name of wb.SheetNames){
      const ws=wb.Sheets[name]; const rows=XLSX.utils.sheet_to_json(ws,{defval:null});
      if(rows.length>bestLen){bestLen=rows.length;bestRows=rows;bestName=name;}
    }
    return {rows:bestRows, sheetName:bestName||wb.SheetNames[0]};
  }
  function parseDateIT(v){
    if(v==null||v==='')return null;
    if(typeof v==='number'||/^[0-9]+$/.test(String(v).trim())){
      const n=Number(v); if(!Number.isNaN(n)&&n>0&&n<2958465){const base=new Date(Date.UTC(1899,11,30));const d=new Date(base.getTime()+n*86400000);return new Date(d.getFullYear(),d.getMonth(),d.getDate());}
    }
    const s=String(v).trim().replace(/[\/\.]/g,'-');
    const m=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})(?:[ T]\d{1,2}:\d{2}(?::\d{2})?)?$/);
    if(m){const[,gg,mm,yyyy]=m;return new Date(+yyyy,+mm-1,+gg);}
    const d=new Date(s); if(!isNaN(d)) return new Date(d.getFullYear(),d.getMonth(),d.getDate());
    return null;
  }
  function daysDiffFromToday(d){ if(!d) return Infinity; const t=new Date(); t.setHours(0,0,0,0); const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); return Math.floor((t-x)/86400000); }
  function normalizeSede(s){return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').replace(/[^\w\s\-&']/g,'').trim().toUpperCase();}

  // ---- colonne flessibili ----
  function pick(r, names){ for(const n of names){ if(r[n]!=null && r[n]!=='' ) return r[n]; } return ''; }

  // ---- stato obb. ----
  function isFerie(st){ return /BLOCCO\s*AMMINISTRATIVO/i.test(String(st)); }
  function isManut(st){ return /724\s*IN\s*CORSO/i.test(String(st)); }

  // ---- dataset ----
  let DATA = []; // righe normalizzate (attive)
  let ESATTORI = [];

  async function loadAll(){
    showLoader(true);
    try{
      const manifest=await fetchJSON('./Dati/manifest.json');
      const latest=manifest.sinottici[manifest.sinottici.length-1];
      document.getElementById('metaSinottico').textContent='Sinottico: '+latest;

      // esattori
      try{ ESATTORI = await fetchJSON('./Dati/esattori.json'); }catch(_){ ESATTORI=[]; }
      const selEs = document.getElementById('selEsattore');
      selEs.innerHTML = '<option value="">Tutti</option>' + ESATTORI.map(e=>`<option>${String(e).toUpperCase()}</option>`).join('');

      // mappa sede‚Üíesattore
      const pdv = await fetchXLSX_largest('./Dati/PDV-e-ESATTORI.xlsx');
      const sedeToEs=new Map();
      for(const r of pdv.rows){
        const sede=normalizeSede(r['DENOMINAZIONE SEDE']);
        const esa =String(r['ESATTORE']??'').trim().toUpperCase()||'‚Äî';
        if(sede) sedeToEs.set(sede,esa);
      }

      // sinottico (foglio pi√π grande)
      const sn = await fetchXLSX_largest('./Dati/'+latest);
      document.getElementById('metaFoglio').textContent='Foglio: '+sn.sheetName;

      // normalizza
      const rows = sn.rows.map(r=>{
        const locale = pick(r, ['DENOMIN.SEDE','DENOMINAZIONE SEDE','SEDE','LOCALE']);
        const comune = pick(r, ['COMUNE','LOCALITA','LOCALIT√Ä']);
        const modello= pick(r, ['MODELLO','MODEL']);
        const pda    = pick(r, ['PDA','COD.PDA','COD PDA','ID PDA']);
        const awp    = pick(r, ['AWP','COD.AWP','COD AWP','SERIALE','MATRICOLA']);
        const stato  = pick(r, ['DESCR.STATO','STATO']);
        const dataS  = pick(r, ['DATA ULTIMA LETTURA VAL.','DATA ULTIMA LETTURA','ULTIMA LETTURA','DATA']);
        const data   = parseDateIT(dataS);
        const giorni = daysDiffFromToday(data);
        const esatt  = sedeToEs.get(normalizeSede(locale)) ?? '‚Äî';
        return {ESATTORE:esatt, LOCALE:String(locale||'').trim(), AWP:String(awp||modello||'').trim(), PDA:String(pda||'').trim(), GIORNI:giorni, COMUNE:String(comune||'').trim(), STATO:stato, DATA:data};
      });

      // escludi ferie/manutenzione
      DATA = rows.filter(r => !isFerie(r.STATO) && !isManut(r.STATO));

      document.getElementById('metaCount').textContent = 'Righe: '+DATA.length.toLocaleString('it-IT');

      render();
    } finally { showLoader(false); }
  }

  function render(){
    const selEs = document.getElementById('selEsattore').value.trim().toUpperCase();
    const back  = Math.max(0, Number(document.getElementById('days').value||0)); // es. 2 ‚Üí mostra > 2 giorni

    // filtro arretrati: se back=0 ‚Üí tutte non aggiornate oggi; se 1 ‚Üí >1; se 2 ‚Üí >2; ecc.
    let rows = DATA.filter(r => r.GIORNI > back);

    // filtro esattore
    if(selEs) rows = rows.filter(r => (r.ESATTORE||'').toUpperCase() === selEs);

    // ordinamento
    if(!selEs){
      // tutti: per esattore, poi giorni decrescenti (pi√π arretrate in alto), poi locale
      rows.sort((a,b)=> (a.ESATTORE||'').localeCompare(b.ESATTORE||'') || b.GIORNI-a.GIORNI || a.LOCALE.localeCompare(b.LOCALE));
    }else{
      // un esattore: solo giorni decrescenti, poi locale
      rows.sort((a,b)=> b.GIORNI-a.GIORNI || a.LOCALE.localeCompare(b.LOCALE));
    }

    // render tabella
    const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.ESATTORE||'‚Äî'}</td><td>${r.LOCALE}</td><td>${r.AWP}</td><td>${r.PDA}</td><td>${isFinite(r.GIORNI)?r.GIORNI:'‚Äî'}</td><td>${r.COMUNE}</td>`;
      tb.appendChild(tr);
    }

    // nota
    document.getElementById('note').textContent = rows.length
      ? `Mostrate ${rows.length.toLocaleString('it-IT')} righe (arretrati > ${back} giorno/i${selEs?`, esattore: ${selEs}`:''}).`
      : 'Nessuna riga corrisponde ai filtri.';
  }

  // export XLSX della vista corrente
  function exportXLSX(){
    const headers=['ESATTORE','LOCALE','AWP','PDA','GIORNI','COMUNE'];
    const selEs = document.getElementById('selEsattore').value.trim().toUpperCase();
    const back  = Math.max(0, Number(document.getElementById('days').value||0));
    let rows = DATA.filter(r => r.GIORNI > back);
    if(selEs) rows = rows.filter(r => (r.ESATTORE||'').toUpperCase() === selEs);
    if(!selEs){ rows.sort((a,b)=> (a.ESATTORE||'').localeCompare(b.ESATTORE||'') || b.GIORNI-a.GIORNI || a.LOCALE.localeCompare(b.LOCALE)); }
    else{ rows.sort((a,b)=> b.GIORNI-a.GIORNI || a.LOCALE.localeCompare(b.LOCALE)); }
    const out = rows.map(r=>({ESATTORE:r.ESATTORE||'‚Äî', LOCALE:r.LOCALE, AWP:r.AWP, PDA:r.PDA, GIORNI:isFinite(r.GIORNI)?r.GIORNI:'', COMUNE:r.COMUNE}));
    const ws = XLSX.utils.json_to_sheet(out, {header:headers});
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Letture');
    const name = 'Letture'+(selEs?`-${selEs}`:'-Tutti')+`-arretrati>${back}.xlsx`;
    XLSX.writeFile(wb, name);
  }

  // badge 15/ultimo (come dashboard)
  function isLastDayOfMonth(d){const p=new Date(d.getFullYear(),d.getMonth()+1,0);return d.getDate()===p.getDate();}
  function daysUntil(a,b){const t0=new Date(a.getFullYear(),a.getMonth(),a.getDate());const t1=new Date(b.getFullYear(),b.getMonth(),b.getDate());return Math.round((t1-t0)/86400000);}
  function nextTaxDay(from){const y=from.getFullYear(),m=from.getMonth();const d15=new Date(y,m,15);const last=new Date(y,m+1,0);if(from.getDate()<=15)return d15;if(from.getDate()<last.getDate())return last;return new Date(y,m+1,15);}
  function updateTaxBadge(){const el=document.createElement('span');}

  // init
  window.addEventListener('load', async ()=>{
    document.getElementById('year').textContent=new Date().getFullYear();
    initTheme();
    showLoader(true);
    try{
      await loadWithFallback(urls.xlsx, ()=>!!window.XLSX);
      await loadAll();
    }catch(e){ alert('Errore caricamento: '+e.message); }
    showLoader(false);
  });

  document.getElementById('btnRefresh').addEventListener('click', ()=>loadAll().catch(err=>alert(err.message)));
  document.getElementById('selEsattore').addEventListener('change', render);
  document.getElementById('days').addEventListener('input', render);
  document.getElementById('btnExport').addEventListener('click', exportXLSX);
})();
</script>
</body>
</html>
